echo "🔍 运行 Pre-commit 代码质量门禁..."
echo ""

# 1. 运行 lint-staged（ESLint + Prettier + 安全扫描）
echo "📝 运行 ESLint 和代码格式化..."
npx lint-staged

# 检查 lint-staged 退出码
if [ $? -ne 0 ]; then
  echo ""
  echo "❌ ESLint 或安全扫描失败！"
  echo "请修复上述问题后再提交"
  echo ""
  echo "如需跳过验证（不推荐），使用: git commit --no-verify"
  exit 1
fi

echo "✅ ESLint 和代码格式化通过"
echo ""

# 2. 运行 TypeScript 类型检查
echo "🔷 运行 TypeScript 类型检查..."
node scripts/typecheck-staged.js

# 检查类型检查退出码
if [ $? -ne 0 ]; then
  echo ""
  echo "❌ TypeScript 类型检查失败！"
  echo "请修复上述类型错误后再提交"
  echo ""
  echo "如需跳过验证（不推荐），使用: git commit --no-verify"
  exit 1
fi

echo "✅ TypeScript 类型检查通过"
echo ""

# 3. 运行项目规则验证
echo "🔍 运行代码规则验证..."

# 进入 desktop-app-vue 目录运行验证
cd desktop-app-vue || exit 1

# 运行规则验证器
npm run validate:rules

# 检查退出码
if [ $? -ne 0 ]; then
  echo ""
  echo "❌ 代码规则验证失败！"
  echo "请修复上述问题后再提交，或查看 .chainlesschain/rules.md 了解编码规范"
  echo ""
  echo "如需跳过验证（不推荐），使用: git commit --no-verify"
  exit 1
fi

echo "✅ 代码规则验证通过"
echo ""

# 4. 运行单元测试（排除不稳定测试）
echo "🧪 运行单元测试..."
echo "   (排除: ocr-service, mcp/* - 环境依赖测试)"

# 使用 vitest 直接运行，排除不稳定的测试
npx vitest run tests/unit \
  --exclude="**/ocr-service.test.js" \
  --exclude="**/mcp/**"

# 检查测试退出码
if [ $? -ne 0 ]; then
  echo ""
  echo "❌ 单元测试失败！"
  echo "请修复测试错误后再提交"
  echo ""
  echo "如需跳过验证（不推荐），使用: git commit --no-verify"
  echo ""
  echo "💡 完整测试（含不稳定测试）: npm run test:unit"
  exit 1
fi

echo "✅ 单元测试通过"
