echo "ğŸ” è¿è¡Œ Pre-commit ä»£ç è´¨é‡é—¨ç¦..."
echo ""

# 1. è¿è¡Œ lint-stagedï¼ˆESLint + Prettier + å®‰å…¨æ‰«æï¼‰
echo "ğŸ“ è¿è¡Œ ESLint å’Œä»£ç æ ¼å¼åŒ–..."
npx lint-staged

# æ£€æŸ¥ lint-staged é€€å‡ºç 
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ ESLint æˆ–å®‰å…¨æ‰«æå¤±è´¥ï¼"
  echo "è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åå†æäº¤"
  echo ""
  echo "å¦‚éœ€è·³è¿‡éªŒè¯ï¼ˆä¸æ¨èï¼‰ï¼Œä½¿ç”¨: git commit --no-verify"
  exit 1
fi

echo "âœ… ESLint å’Œä»£ç æ ¼å¼åŒ–é€šè¿‡"
echo ""

# 2. è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥
echo "ğŸ”· è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥..."
node scripts/typecheck-staged.js

# æ£€æŸ¥ç±»å‹æ£€æŸ¥é€€å‡ºç 
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ TypeScript ç±»å‹æ£€æŸ¥å¤±è´¥ï¼"
  echo "è¯·ä¿®å¤ä¸Šè¿°ç±»å‹é”™è¯¯åå†æäº¤"
  echo ""
  echo "å¦‚éœ€è·³è¿‡éªŒè¯ï¼ˆä¸æ¨èï¼‰ï¼Œä½¿ç”¨: git commit --no-verify"
  exit 1
fi

echo "âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡"
echo ""

# 3. è¿è¡Œé¡¹ç›®è§„åˆ™éªŒè¯
echo "ğŸ” è¿è¡Œä»£ç è§„åˆ™éªŒè¯..."

# è¿›å…¥ desktop-app-vue ç›®å½•è¿è¡ŒéªŒè¯
cd desktop-app-vue || exit 1

# è¿è¡Œè§„åˆ™éªŒè¯å™¨
npm run validate:rules

# æ£€æŸ¥é€€å‡ºç 
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ ä»£ç è§„åˆ™éªŒè¯å¤±è´¥ï¼"
  echo "è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åå†æäº¤ï¼Œæˆ–æŸ¥çœ‹ .chainlesschain/rules.md äº†è§£ç¼–ç è§„èŒƒ"
  echo ""
  echo "å¦‚éœ€è·³è¿‡éªŒè¯ï¼ˆä¸æ¨èï¼‰ï¼Œä½¿ç”¨: git commit --no-verify"
  exit 1
fi

echo "âœ… ä»£ç è§„åˆ™éªŒè¯é€šè¿‡"
echo ""

# 4. è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆæ’é™¤ä¸ç¨³å®šæµ‹è¯•ï¼‰
echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
echo "   (ä»…è¿è¡Œç¨³å®šçš„æ ¸å¿ƒæµ‹è¯•)"

# ä½¿ç”¨ vitest ç›´æ¥è¿è¡Œï¼Œæ’é™¤ä¸ç¨³å®šçš„æµ‹è¯•
# è¿™äº›æµ‹è¯•éœ€è¦ç‰¹å®šç¯å¢ƒã€ç¡¬ä»¶æˆ–æœ‰å¤æ‚çš„ mock ä¾èµ–
# æ³¨æ„ï¼švitest 3.x åœ¨å¤§å‹æµ‹è¯•å¥—ä»¶ä¸­å¯èƒ½äº§ç”Ÿ "Timeout calling onTaskUpdate"
# çš„ worker RPC è¶…æ—¶é”™è¯¯ï¼Œå¯¼è‡´é€€å‡ºç ä¸º 1 å³ä½¿æ‰€æœ‰æµ‹è¯•é€šè¿‡ã€‚
# å› æ­¤æˆ‘ä»¬æ•è·è¾“å‡ºå¹¶æ£€æŸ¥æ˜¯å¦æœ‰å®é™…æµ‹è¯•å¤±è´¥ã€‚
# Temporarily disable exit-on-error so we can capture vitest exit code
# (husky runs with set -e, which would abort before our error handling)
set +e
TEST_OUTPUT=$(npx vitest run tests/unit \
  --exclude="**/tests/ai-engine/**" \
  --exclude="**/tests/cowork/**" \
  --exclude="**/tests/remote/**" \
  --exclude="**/tests/integration/**" \
  --exclude="**/tests/unit/integration/**" \
  --exclude="**/src/main/**/__tests__/**" \
  --exclude="**/src/renderer/**/__tests__/**" \
  --exclude="**/tests/unit/document/ppt-engine.test.js" 2>&1)
VITEST_EXIT=$?
set -e

echo "$TEST_OUTPUT"

# Check for actual test failures (not just vitest worker timeouts)
if echo "$TEST_OUTPUT" | grep -q "Test Files.*failed"; then
  echo ""
  echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥ï¼"
  echo "è¯·ä¿®å¤æµ‹è¯•é”™è¯¯åå†æäº¤"
  echo ""
  echo "å¦‚éœ€è·³è¿‡éªŒè¯ï¼ˆä¸æ¨èï¼‰ï¼Œä½¿ç”¨: git commit --no-verify"
  echo ""
  echo "ğŸ’¡ å®Œæ•´æµ‹è¯•ï¼ˆå«ä¸ç¨³å®šæµ‹è¯•ï¼‰: npm run test:unit"
  exit 1
fi

# If vitest exited non-zero but no tests failed, it's likely worker RPC timeouts
if [ $VITEST_EXIT -ne 0 ]; then
  echo ""
  echo "âš ï¸  Vitest é€€å‡ºç éé›¶ä½†æ— æµ‹è¯•å¤±è´¥ï¼ˆå¯èƒ½æ˜¯ worker RPC è¶…æ—¶ï¼Œå¯å®‰å…¨å¿½ç•¥ï¼‰"
fi

echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
