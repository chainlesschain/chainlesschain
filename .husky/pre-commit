echo "ğŸ” è¿è¡Œ Pre-commit ä»£ç è´¨é‡é—¨ç¦..."
echo ""

# 1. è¿è¡Œ lint-stagedï¼ˆESLint + Prettier + å®‰å…¨æ‰«æï¼‰
echo "ğŸ“ è¿è¡Œ ESLint å’Œä»£ç æ ¼å¼åŒ–..."
npx lint-staged

# æ£€æŸ¥ lint-staged é€€å‡ºç 
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ ESLint æˆ–å®‰å…¨æ‰«æå¤±è´¥ï¼"
  echo "è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åå†æäº¤"
  echo ""
  echo "å¦‚éœ€è·³è¿‡éªŒè¯ï¼ˆä¸æ¨èï¼‰ï¼Œä½¿ç”¨: git commit --no-verify"
  exit 1
fi

echo "âœ… ESLint å’Œä»£ç æ ¼å¼åŒ–é€šè¿‡"
echo ""

# 2. è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥
echo "ğŸ”· è¿è¡Œ TypeScript ç±»å‹æ£€æŸ¥..."
node scripts/typecheck-staged.js

# æ£€æŸ¥ç±»å‹æ£€æŸ¥é€€å‡ºç 
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ TypeScript ç±»å‹æ£€æŸ¥å¤±è´¥ï¼"
  echo "è¯·ä¿®å¤ä¸Šè¿°ç±»å‹é”™è¯¯åå†æäº¤"
  echo ""
  echo "å¦‚éœ€è·³è¿‡éªŒè¯ï¼ˆä¸æ¨èï¼‰ï¼Œä½¿ç”¨: git commit --no-verify"
  exit 1
fi

echo "âœ… TypeScript ç±»å‹æ£€æŸ¥é€šè¿‡"
echo ""

# 3. è¿è¡Œé¡¹ç›®è§„åˆ™éªŒè¯
echo "ğŸ” è¿è¡Œä»£ç è§„åˆ™éªŒè¯..."

# è¿›å…¥ desktop-app-vue ç›®å½•è¿è¡ŒéªŒè¯
cd desktop-app-vue || exit 1

# è¿è¡Œè§„åˆ™éªŒè¯å™¨
npm run validate:rules

# æ£€æŸ¥é€€å‡ºç 
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ ä»£ç è§„åˆ™éªŒè¯å¤±è´¥ï¼"
  echo "è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åå†æäº¤ï¼Œæˆ–æŸ¥çœ‹ .chainlesschain/rules.md äº†è§£ç¼–ç è§„èŒƒ"
  echo ""
  echo "å¦‚éœ€è·³è¿‡éªŒè¯ï¼ˆä¸æ¨èï¼‰ï¼Œä½¿ç”¨: git commit --no-verify"
  exit 1
fi

echo "âœ… ä»£ç è§„åˆ™éªŒè¯é€šè¿‡"
echo ""

# 4. è¿è¡Œå•å…ƒæµ‹è¯•ï¼ˆæ’é™¤ä¸ç¨³å®šæµ‹è¯•ï¼‰
echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
echo "   (ä»…è¿è¡Œç¨³å®šçš„æ ¸å¿ƒæµ‹è¯•)"

# ä½¿ç”¨ vitest ç›´æ¥è¿è¡Œï¼Œæ’é™¤ä¸ç¨³å®šçš„æµ‹è¯•
# è¿™äº›æµ‹è¯•éœ€è¦ç‰¹å®šç¯å¢ƒã€ç¡¬ä»¶æˆ–æœ‰å¤æ‚çš„ mock ä¾èµ–
npx vitest run tests/unit \
  --exclude="**/ocr-service.test.js" \
  --exclude="**/mcp/**" \
  --exclude="**/p2p/**" \
  --exclude="**/ukey/**" \
  --exclude="**/blockchain/**" \
  --exclude="**/components/**" \
  --exclude="**/import/**" \
  --exclude="**/extended-tools*.test.js" \
  --exclude="**/*-ipc.test.js" \
  --exclude="**/session-manager*.test.js" \
  --exclude="**/llm-performance.test.js" \
  --exclude="**/tool-manager.test.js" \
  --exclude="**/skill-manager.test.js" \
  --exclude="**/word-engine.test.js" \
  --exclude="**/image-engine.test.js" \
  --exclude="**/did-invitation.test.js" \
  --exclude="**/ipc-guard.test.js" \
  --exclude="**/permission-system.test.js" \
  --exclude="**/api/**" \
  --exclude="**/pages/**" \
  --exclude="**/stores/**" \
  --exclude="**/sync/**" \
  --exclude="**/builtin-tools.test.js"

# æ£€æŸ¥æµ‹è¯•é€€å‡ºç 
if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ å•å…ƒæµ‹è¯•å¤±è´¥ï¼"
  echo "è¯·ä¿®å¤æµ‹è¯•é”™è¯¯åå†æäº¤"
  echo ""
  echo "å¦‚éœ€è·³è¿‡éªŒè¯ï¼ˆä¸æ¨èï¼‰ï¼Œä½¿ç”¨: git commit --no-verify"
  echo ""
  echo "ğŸ’¡ å®Œæ•´æµ‹è¯•ï¼ˆå«ä¸ç¨³å®šæµ‹è¯•ï¼‰: npm run test:unit"
  exit 1
fi

echo "âœ… å•å…ƒæµ‹è¯•é€šè¿‡"
