echo "🚀 运行 Pre-push 检查门禁..."
echo ""

# 获取当前分支
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)
echo "📌 当前分支: $BRANCH"
echo ""

# 进入 desktop-app-vue 目录
cd desktop-app-vue || exit 1

# 1. 运行 TypeScript 类型检查
echo "🔷 运行 TypeScript 类型检查..."
npm run type-check

if [ $? -ne 0 ]; then
  echo ""
  echo "❌ TypeScript 类型检查失败！"
  echo "请修复类型错误后再推送"
  echo ""
  echo "如需跳过检查（不推荐），使用: git push --no-verify"
  exit 1
fi

echo "✅ TypeScript 类型检查通过"
echo ""

# 2. 运行数据库测试（核心功能）
echo "🗄️ 运行数据库测试..."
npm run test:db

if [ $? -ne 0 ]; then
  echo ""
  echo "❌ 数据库测试失败！"
  echo "请修复测试错误后再推送"
  echo ""
  echo "如需跳过测试（不推荐），使用: git push --no-verify"
  exit 1
fi

echo "✅ 数据库测试通过"
echo ""

# 3. 运行 MCP 单元测试（如果存在）
if [ -d "tests/unit/mcp" ]; then
  echo "🔌 运行 MCP 单元测试..."
  npm run test:mcp 2>/dev/null

  if [ $? -ne 0 ]; then
    echo "⚠️ MCP 测试失败（非阻塞警告）"
  else
    echo "✅ MCP 测试通过"
  fi
  echo ""
fi

echo "🎉 所有必要检查通过，允许推送！"
echo ""
echo "💡 提示: 完整单元测试请运行: cd desktop-app-vue && npm run test:unit"
