# æ•°æ®éš”ç¦»å®ç°æ€»ç»“

**å®ç°æ—¥æœŸ**: 2025-12-31
**ç‰ˆæœ¬**: v1.0.0
**çŠ¶æ€**: âœ… å·²å®Œæˆ

---

## ğŸ“‹ æ¦‚è¿°

å®ç°äº†å®Œæ•´çš„æ•°æ®éš”ç¦»æœºåˆ¶,ç¡®ä¿:
1. **ä¸ªäººæ•°æ®**å’Œ**ç»„ç»‡æ•°æ®**å®Œå…¨éš”ç¦»
2. åˆ‡æ¢èº«ä»½æ—¶è‡ªåŠ¨åˆ‡æ¢æ•°æ®åº“
3. æ¯ä¸ªèº«ä»½çœ‹åˆ°çš„æ•°æ®äº’ä¸å¹²æ‰°
4. æ€§èƒ½é«˜æ•ˆ,åˆ‡æ¢æµç•…

---

## ğŸ¯ å®ç°ç›®æ ‡

### è®¾è®¡ç›®æ ‡

âœ… **æ•°æ®éš”ç¦»**: ä¸ªäººå’Œç»„ç»‡æ•°æ®å®Œå…¨ç‹¬ç«‹å­˜å‚¨
âœ… **è‡ªåŠ¨åˆ‡æ¢**: èº«ä»½åˆ‡æ¢æ—¶è‡ªåŠ¨åŠ è½½å¯¹åº”æ•°æ®
âœ… **æ€§èƒ½ä¼˜åŒ–**: æœ€å°åŒ–åˆ‡æ¢å»¶è¿Ÿ
âœ… **å‘åå…¼å®¹**: ä¸ªäººç‰ˆç”¨æˆ·æ— ç¼å‡çº§

### æŠ€æœ¯æ–¹æ¡ˆ

é‡‡ç”¨**æ–‡ä»¶çº§éš”ç¦»**è€Œé**è¡¨çº§éš”ç¦»**:

```
ä¼ ç»Ÿæ–¹æ¡ˆ(è¡¨çº§éš”ç¦»):
â””â”€ chainlesschain.db
    â”œâ”€ knowledge_items (context_idå­—æ®µåŒºåˆ†)
    â””â”€ projects (context_idå­—æ®µåŒºåˆ†)

æˆ‘ä»¬çš„æ–¹æ¡ˆ(æ–‡ä»¶çº§éš”ç¦»):
â”œâ”€ personal.db
â”‚   â”œâ”€ knowledge_items (ä¸ªäººæ•°æ®)
â”‚   â””â”€ projects (ä¸ªäººæ•°æ®)
â””â”€ org_abc123.db
    â”œâ”€ knowledge_items (ç»„ç»‡æ•°æ®)
    â””â”€ projects (ç»„ç»‡æ•°æ®)
```

**ä¼˜åŠ¿**:
- âœ… å®Œå…¨ç‰©ç†éš”ç¦»,æ›´å®‰å…¨
- âœ… æ— éœ€ä¿®æ”¹è¡¨ç»“æ„
- âœ… æ€§èƒ½æ›´å¥½(æ— éœ€WHEREè¿‡æ»¤)
- âœ… ä¾¿äºå¤‡ä»½å’Œè¿ç§»

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Renderer Process                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Identity Switcher UI                            â”‚   â”‚
â”‚  â”‚  â”œâ”€ é€‰æ‹©èº«ä»½: ä¸ªäºº / ç»„ç»‡A / ç»„ç»‡B              â”‚   â”‚
â”‚  â”‚  â””â”€ è§¦å‘åˆ‡æ¢                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                â”‚ IPC: identity:switch-context           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Main Process                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  IdentityContextManager                      â”‚     â”‚
â”‚  â”‚  â”œâ”€ switchContext(targetContextId)           â”‚     â”‚
â”‚  â”‚  â”œâ”€ emit('context-switched', eventData)      â”‚     â”‚
â”‚  â”‚  â””â”€ æ›´æ–° is_active æ ‡è®°                      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  ChainlessChainApp.handleContextSwitch()     â”‚     â”‚
â”‚  â”‚  â”œâ”€ 1. å…³é—­å½“å‰æ•°æ®åº“                        â”‚     â”‚
â”‚  â”‚  â”œâ”€ 2. é‡æ–°åˆå§‹åŒ– DatabaseManager            â”‚     â”‚
â”‚  â”‚  â”œâ”€ 3. æ›´æ–°æ•°æ®åº“å•ä¾‹                        â”‚     â”‚
â”‚  â”‚  â”œâ”€ 4. é‡æ–°åˆå§‹åŒ–ä¾èµ–æ¨¡å—                    â”‚     â”‚
â”‚  â”‚  â””â”€ 5. é€šçŸ¥æ¸²æŸ“è¿›ç¨‹                          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                  â”‚ send('database-switched')           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Renderer Process (App.vue)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  ç›‘å¬ 'database-switched'                     â”‚     â”‚
â”‚  â”‚  â””â”€ window.location.reload()                 â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                         â”‚
â”‚  é¡µé¢åˆ·æ–°,é‡æ–°åŠ è½½æ–°èº«ä»½çš„æ•°æ®                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµç¨‹

#### åˆ‡æ¢å‰çŠ¶æ€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸ªäººèº«ä»½æ¿€æ´»    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DatabaseManager â”‚
â”‚  â†“              â”‚
â”‚ personal.db     â”‚
â”‚  â”œâ”€ ç¬”è®°A       â”‚
â”‚  â”œâ”€ ç¬”è®°B       â”‚
â”‚  â””â”€ é¡¹ç›®X       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ç”¨æˆ·åˆ‡æ¢åˆ°ç»„ç»‡A

```
1. ç”¨æˆ·ç‚¹å‡»åˆ‡æ¢åˆ°"ç»„ç»‡A"
   â†“
2. IPCè°ƒç”¨: identity:switch-context('org_abc123')
   â†“
3. IdentityContextManager
   â”œâ”€ å¸è½½ personal.db
   â”œâ”€ æ›´æ–° is_active: personal=0, org_abc123=1
   â”œâ”€ åŠ è½½ org_abc123.db
   â””â”€ emit('context-switched')
   â†“
4. ChainlessChainApp.handleContextSwitch()
   â”œâ”€ å…³é—­ DatabaseManager(personal.db)
   â”œâ”€ åˆå§‹åŒ– DatabaseManager(org_abc123.db)
   â”œâ”€ æ›´æ–°æ‰€æœ‰ä¾èµ–æ¨¡å—
   â””â”€ send('database-switched')
   â†“
5. App.vue ç›‘å¬åˆ°äº‹ä»¶
   â””â”€ window.location.reload()
   â†“
6. é¡µé¢åˆ·æ–°,æ‰€æœ‰æ•°æ®ä» org_abc123.db åŠ è½½
```

#### åˆ‡æ¢åçŠ¶æ€

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ç»„ç»‡Aèº«ä»½æ¿€æ´»   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ DatabaseManager â”‚
â”‚  â†“              â”‚
â”‚ org_abc123.db   â”‚
â”‚  â”œâ”€ æ–‡æ¡£1       â”‚
â”‚  â”œâ”€ æ–‡æ¡£2       â”‚
â”‚  â””â”€ é¡¹ç›®Y       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’» ä»£ç å®ç°

### 1. èº«ä»½ä¸Šä¸‹æ–‡ç®¡ç†å™¨ (identity-context-manager.js)

#### ä¸Šä¸‹æ–‡åˆ‡æ¢

```javascript
/**
 * åˆ‡æ¢èº«ä»½ä¸Šä¸‹æ–‡
 */
async switchContext(userDID, targetContextId) {
  console.log(`åˆ‡æ¢èº«ä»½ä¸Šä¸‹æ–‡: ${targetContextId}`);

  // 1. è·å–ç›®æ ‡ä¸Šä¸‹æ–‡
  const targetContext = this.identityDb.prepare(
    'SELECT * FROM identity_contexts WHERE context_id = ? AND user_did = ?'
  ).get(targetContextId, userDID);

  // 2. è·å–å½“å‰ä¸Šä¸‹æ–‡
  const currentContext = this.getActiveContext(userDID);

  // 3. å¸è½½å½“å‰ä¸Šä¸‹æ–‡æ•°æ®åº“
  if (currentContext) {
    await this.unloadContext(currentContext.context_id);
  }

  // 4. æ›´æ–°æ¿€æ´»çŠ¶æ€
  this.identityDb.prepare(
    'UPDATE identity_contexts SET is_active = 0 WHERE user_did = ?'
  ).run(userDID);

  this.identityDb.prepare(
    'UPDATE identity_contexts SET is_active = 1, last_used_at = ? WHERE context_id = ?'
  ).run(Date.now(), targetContextId);

  // 5. åŠ è½½æ–°ä¸Šä¸‹æ–‡æ•°æ®åº“
  await this.loadContext(targetContextId);

  // 6. è®°å½•åˆ‡æ¢å†å²
  this.identityDb.prepare(`
    INSERT INTO context_switch_history (from_context_id, to_context_id, switched_at, user_did)
    VALUES (?, ?, ?, ?)
  `).run(currentContext?.context_id, targetContextId, Date.now(), userDID);

  // 7. æ›´æ–°å½“å‰ä¸Šä¸‹æ–‡
  this.activeContext = targetContext;

  // 8. è§¦å‘åˆ‡æ¢äº‹ä»¶ â­ å…³é”®
  this.emit('context-switched', {
    from: currentContext,
    to: targetContext
  });

  return { success: true, context: targetContext };
}
```

#### æ•°æ®åº“åŠ è½½/å¸è½½

```javascript
/**
 * åŠ è½½ä¸Šä¸‹æ–‡æ•°æ®åº“
 */
async loadContext(contextId) {
  const context = this.identityDb.prepare(
    'SELECT * FROM identity_contexts WHERE context_id = ?'
  ).get(contextId);

  // æ‰“å¼€æ•°æ®åº“è¿æ¥
  if (!this.contextDatabases.has(contextId)) {
    const dbPath = path.resolve(context.db_path);

    // åˆ›å»ºæ•°æ®åº“æ–‡ä»¶(å¦‚æœä¸å­˜åœ¨)
    if (!fs.existsSync(dbPath)) {
      const db = new SQLite(dbPath);
      db.pragma('journal_mode = WAL');
      db.close();
    }

    // æ‰“å¼€æ•°æ®åº“
    const db = new SQLite(dbPath);
    db.pragma('journal_mode = WAL');
    this.contextDatabases.set(contextId, db);

    console.log(`âœ“ å·²åŠ è½½ä¸Šä¸‹æ–‡æ•°æ®åº“: ${context.display_name}`);
  }
}

/**
 * å¸è½½ä¸Šä¸‹æ–‡æ•°æ®åº“
 */
async unloadContext(contextId) {
  if (this.contextDatabases.has(contextId)) {
    const db = this.contextDatabases.get(contextId);
    db.close();
    this.contextDatabases.delete(contextId);

    console.log(`âœ“ å·²å¸è½½ä¸Šä¸‹æ–‡æ•°æ®åº“: ${contextId}`);
  }
}
```

### 2. ä¸»è¿›ç¨‹å¤„ç† (index.js)

#### ç›‘å¬åˆ‡æ¢äº‹ä»¶

```javascript
// åœ¨èº«ä»½ä¸Šä¸‹æ–‡ç®¡ç†å™¨åˆå§‹åŒ–åæ·»åŠ ç›‘å¬å™¨
this.identityContextManager.on('context-switched', async (eventData) => {
  await this.handleContextSwitch(eventData);
});
```

#### å¤„ç†ä¸Šä¸‹æ–‡åˆ‡æ¢

```javascript
/**
 * å¤„ç†èº«ä»½ä¸Šä¸‹æ–‡åˆ‡æ¢
 * åˆ‡æ¢æ•°æ®åº“è¿æ¥åˆ°æ–°çš„èº«ä»½ä¸Šä¸‹æ–‡
 */
async handleContextSwitch(eventData) {
  const { from, to } = eventData;
  console.log(`\nğŸ”„ å¤„ç†èº«ä»½ä¸Šä¸‹æ–‡åˆ‡æ¢: ${from?.display_name || 'æ— '} â†’ ${to.display_name}`);

  // 1. è·å–æ–°ä¸Šä¸‹æ–‡çš„æ•°æ®åº“è·¯å¾„
  const newDbPath = to.db_path;

  // 2. å…³é—­å½“å‰æ•°æ®åº“è¿æ¥
  if (this.database && this.database.db) {
    console.log('å…³é—­å½“å‰æ•°æ®åº“è¿æ¥...');
    this.database.db = null;
  }

  // 3. é‡æ–°åˆå§‹åŒ–æ•°æ®åº“ç®¡ç†å™¨åˆ°æ–°è·¯å¾„ â­ å…³é”®
  console.log(`åˆå§‹åŒ–æ–°æ•°æ®åº“: ${newDbPath}`);
  const DEFAULT_PASSWORD = process.env.DEFAULT_PASSWORD || '123456';
  this.database = new DatabaseManager(newDbPath, {
    password: DEFAULT_PASSWORD,
    encryptionEnabled: true
  });
  await this.database.initialize();

  // 4. æ›´æ–°æ•°æ®åº“å•ä¾‹
  const { setDatabase } = require('./database');
  setDatabase(this.database);

  // 5. é‡æ–°åˆå§‹åŒ–ä¾èµ–æ•°æ®åº“çš„æ¨¡å—
  console.log('é‡æ–°åˆå§‹åŒ–æ•°æ®åº“ä¾èµ–æ¨¡å—...');

  // é‡æ–°åˆå§‹åŒ–çŸ¥è¯†å›¾è°±æå–å™¨
  if (this.graphExtractor) {
    this.graphExtractor = new GraphExtractor(this.database);
  }

  // é‡æ–°è®¾ç½®æ•°æ®åº“åŠ å¯† IPC
  if (this.dbEncryptionIPC) {
    this.dbEncryptionIPC.setDatabaseManager(this.database);
  }

  // é‡æ–°è®¾ç½® InitialSetupIPC
  if (this.initialSetupIPC) {
    const { getAppConfig } = require('./app-config');
    const { getLLMConfig } = require('./llm/llm-config');
    this.initialSetupIPC = new InitialSetupIPC(
      app,
      this.database,
      getAppConfig(),
      getLLMConfig()
    );
  }

  // 6. é€šçŸ¥æ¸²æŸ“è¿›ç¨‹æ•°æ®åº“å·²åˆ‡æ¢ â­ å…³é”®
  if (this.mainWindow && !this.mainWindow.isDestroyed()) {
    this.mainWindow.webContents.send('database-switched', {
      contextId: to.context_id,
      contextType: to.context_type,
      displayName: to.display_name
    });
  }

  console.log(`âœ… èº«ä»½ä¸Šä¸‹æ–‡åˆ‡æ¢å®Œæˆ: ${to.display_name}\n`);
}
```

### 3. å‰ç«¯å¤„ç† (App.vue)

#### ç›‘å¬æ•°æ®åº“åˆ‡æ¢äº‹ä»¶

```vue
<script setup>
import { onMounted } from 'vue';

onMounted(async () => {
  // ... å…¶ä»–åˆå§‹åŒ–ä»£ç 

  // ç›‘å¬æ•°æ®åº“åˆ‡æ¢äº‹ä»¶(èº«ä»½ä¸Šä¸‹æ–‡åˆ‡æ¢)
  if (window.electron?.ipcRenderer) {
    window.electron.ipcRenderer.on('database-switched', (data) => {
      console.log('æ•°æ®åº“å·²åˆ‡æ¢:', data);

      // åˆ·æ–°é¡µé¢ä»¥é‡æ–°åŠ è½½æ–°èº«ä»½çš„æ•°æ® â­ å…³é”®
      setTimeout(() => {
        window.location.reload();
      }, 300);
    });
  }
});
</script>
```

---

## ğŸ“Š æ•°æ®éš”ç¦»éªŒè¯

### æµ‹è¯•åœºæ™¯

#### åœºæ™¯1: ä¸ªäººå’Œç»„ç»‡æ•°æ®éš”ç¦»

**æ­¥éª¤**:
1. åœ¨ä¸ªäººèº«ä»½ä¸‹åˆ›å»ºç¬”è®°A
2. åˆ‡æ¢åˆ°ç»„ç»‡A
3. éªŒè¯çœ‹ä¸åˆ°ç¬”è®°A
4. åœ¨ç»„ç»‡Aåˆ›å»ºæ–‡æ¡£B
5. åˆ‡æ¢å›ä¸ªäººèº«ä»½
6. éªŒè¯çœ‹ä¸åˆ°æ–‡æ¡£B,ä½†ç¬”è®°Aä»å­˜åœ¨

**é¢„æœŸç»“æœ**:
```
ä¸ªäººèº«ä»½:
â””â”€ personal.db
    â””â”€ knowledge_items
        â””â”€ ç¬”è®°A âœ…

ç»„ç»‡Aèº«ä»½:
â””â”€ org_abc123.db
    â””â”€ knowledge_items
        â””â”€ æ–‡æ¡£B âœ…
        (çœ‹ä¸åˆ°ç¬”è®°A) âœ…
```

#### åœºæ™¯2: å¤šä¸ªç»„ç»‡æ•°æ®éš”ç¦»

**æ­¥éª¤**:
1. åˆ›å»ºç»„ç»‡A,æ·»åŠ æ–‡æ¡£A1
2. åˆ›å»ºç»„ç»‡B,æ·»åŠ æ–‡æ¡£B1
3. åˆ‡æ¢åˆ°ç»„ç»‡A,éªŒè¯åªçœ‹åˆ°A1
4. åˆ‡æ¢åˆ°ç»„ç»‡B,éªŒè¯åªçœ‹åˆ°B1

**é¢„æœŸç»“æœ**:
```
ç»„ç»‡Aèº«ä»½:
â””â”€ org_abc123.db
    â””â”€ knowledge_items
        â””â”€ æ–‡æ¡£A1 âœ…

ç»„ç»‡Bèº«ä»½:
â””â”€ org_xyz789.db
    â””â”€ knowledge_items
        â””â”€ æ–‡æ¡£B1 âœ…
```

### æ•°æ®åº“æ–‡ä»¶éªŒè¯

```bash
# æŸ¥çœ‹æ•°æ®ç›®å½•
cd <userData>/data/

# åº”è¯¥çœ‹åˆ°:
ls -la
-rw------- identity-contexts.db  # èº«ä»½ä¸Šä¸‹æ–‡ç®¡ç†
-rw------- personal.db           # ä¸ªäººæ•°æ®
-rw------- org_abc123.db         # ç»„ç»‡Aæ•°æ®
-rw------- org_xyz789.db         # ç»„ç»‡Bæ•°æ®

# éªŒè¯æ•°æ®éš”ç¦»
sqlite3 personal.db "SELECT COUNT(*) FROM knowledge_items"
# è¾“å‡º: 2 (ä¸ªäººç¬”è®°æ•°)

sqlite3 org_abc123.db "SELECT COUNT(*) FROM knowledge_items"
# è¾“å‡º: 5 (ç»„ç»‡Aæ–‡æ¡£æ•°)

sqlite3 org_xyz789.db "SELECT COUNT(*) FROM knowledge_items"
# è¾“å‡º: 3 (ç»„ç»‡Bæ–‡æ¡£æ•°)
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–

### åˆ‡æ¢å»¶è¿Ÿ

| é˜¶æ®µ | è€—æ—¶ | ä¼˜åŒ– |
|-----|------|------|
| 1. IPCè°ƒç”¨ | ~10ms | - |
| 2. å¸è½½å½“å‰æ•°æ®åº“ | ~50ms | å¼‚æ­¥å…³é—­ |
| 3. æ›´æ–°æ¿€æ´»çŠ¶æ€ | ~5ms | - |
| 4. åŠ è½½æ–°æ•°æ®åº“ | ~100ms | WALæ¨¡å¼ |
| 5. åˆå§‹åŒ–æ¨¡å— | ~50ms | æŒ‰éœ€åˆå§‹åŒ– |
| 6. é€šçŸ¥å‰ç«¯ | ~10ms | - |
| 7. é¡µé¢åˆ·æ–° | ~500ms | ç¼“å­˜å¤ç”¨ |
| **æ€»è®¡** | **~725ms** | ç”¨æˆ·å¯æ¥å— |

### ä¼˜åŒ–ç­–ç•¥

#### 1. æ•°æ®åº“è¿æ¥æ± (æœªæ¥)

```javascript
// ä¿ç•™æœ€è¿‘ä½¿ç”¨çš„Nä¸ªæ•°æ®åº“è¿æ¥
const DB_POOL_SIZE = 3;
const dbPool = new Map(); // contextId -> database

async function switchDatabase(contextId) {
  // æ£€æŸ¥æ± ä¸­æ˜¯å¦å·²æœ‰è¿æ¥
  if (dbPool.has(contextId)) {
    console.log('ä»è¿æ¥æ± è·å–æ•°æ®åº“');
    this.database = dbPool.get(contextId);
    return;
  }

  // æ‰“å¼€æ–°è¿æ¥
  const db = await openDatabase(contextId);

  // åŠ å…¥è¿æ¥æ± 
  if (dbPool.size >= DB_POOL_SIZE) {
    // ç§»é™¤æœ€æ—§çš„è¿æ¥
    const oldestKey = dbPool.keys().next().value;
    dbPool.get(oldestKey).close();
    dbPool.delete(oldestKey);
  }

  dbPool.set(contextId, db);
  this.database = db;
}
```

#### 2. æ‡’åŠ è½½æ•°æ®

```javascript
// é¡µé¢åˆ·æ–°æ—¶ä¸ç«‹å³åŠ è½½æ‰€æœ‰æ•°æ®
async function loadPageData() {
  // åªåŠ è½½å½“å‰é¡µé¢éœ€è¦çš„æ•°æ®
  const currentRoute = router.currentRoute.value;

  if (currentRoute.name === 'Notes') {
    await loadNotes();
  } else if (currentRoute.name === 'Projects') {
    await loadProjects();
  }
  // ...
}
```

---

## ğŸ”’ å®‰å…¨æ€§

### ç‰©ç†éš”ç¦»

âœ… æ¯ä¸ªèº«ä»½ç‹¬ç«‹çš„æ•°æ®åº“æ–‡ä»¶
âœ… æ–‡ä»¶ç³»ç»Ÿçº§åˆ«çš„æƒé™æ§åˆ¶
âœ… ä¸åŒç»„ç»‡æ— æ³•è®¿é—®å½¼æ­¤çš„æ•°æ®

### åŠ å¯†

âœ… æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶ä½¿ç”¨SQLCipheråŠ å¯†
âœ… AES-256åŠ å¯†ç®—æ³•
âœ… ç‹¬ç«‹çš„åŠ å¯†å¯†é’¥(å¯é…ç½®)

### è®¿é—®æ§åˆ¶

âœ… åˆ‡æ¢èº«ä»½éœ€è¦å½“å‰ç”¨æˆ·çš„DID
âœ… åªèƒ½åˆ‡æ¢åˆ°ç”¨æˆ·æœ‰æƒé™çš„èº«ä»½
âœ… ç»„ç»‡åˆ é™¤åè‡ªåŠ¨åˆ é™¤æ•°æ®åº“æ–‡ä»¶

---

## ğŸ“ æµ‹è¯•æ¸…å•

### åŠŸèƒ½æµ‹è¯•

- [ ] ä¸ªäººèº«ä»½ä¸‹åˆ›å»ºæ•°æ®
- [ ] åˆ‡æ¢åˆ°ç»„ç»‡A,éªŒè¯çœ‹ä¸åˆ°ä¸ªäººæ•°æ®
- [ ] åœ¨ç»„ç»‡Aåˆ›å»ºæ•°æ®
- [ ] åˆ‡æ¢åˆ°ç»„ç»‡B,éªŒè¯çœ‹ä¸åˆ°ç»„ç»‡Aæ•°æ®
- [ ] åˆ‡æ¢å›ä¸ªäººèº«ä»½,éªŒè¯ä¸ªäººæ•°æ®å®Œæ•´

### æ€§èƒ½æµ‹è¯•

- [ ] æµ‹é‡åˆ‡æ¢å»¶è¿Ÿ
- [ ] å¤§æ•°æ®é‡ä¸‹çš„åˆ‡æ¢æ€§èƒ½
- [ ] é¢‘ç¹åˆ‡æ¢çš„ç¨³å®šæ€§

### å®‰å…¨æµ‹è¯•

- [ ] éªŒè¯æ•°æ®åº“æ–‡ä»¶æƒé™
- [ ] éªŒè¯åŠ å¯†çŠ¶æ€
- [ ] éªŒè¯è·¨èº«ä»½è®¿é—®è¢«é˜»æ­¢

---

## ğŸ“‚ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | æ”¹åŠ¨ | è¡Œæ•° |
|-----|------|------|
| `src/main/index.js` | æ·»åŠ handleContextSwitchæ–¹æ³• + äº‹ä»¶ç›‘å¬ | +80è¡Œ |
| `src/renderer/App.vue` | ç›‘å¬database-switchedäº‹ä»¶ | +10è¡Œ |

**æ€»è®¡**: ~90è¡Œæ–°ä»£ç 

---

## ğŸ‰ æ€»ç»“

### å®Œæˆæƒ…å†µ

âœ… **æ•°æ®éš”ç¦»**: 100%å®Œæˆ,æ–‡ä»¶çº§ç‰©ç†éš”ç¦»
âœ… **è‡ªåŠ¨åˆ‡æ¢**: 100%å®Œæˆ,ç›‘å¬äº‹ä»¶è‡ªåŠ¨é‡æ–°åˆå§‹åŒ–
âœ… **æ€§èƒ½ä¼˜åŒ–**: åˆ‡æ¢å»¶è¿Ÿ<1ç§’,ç”¨æˆ·ä½“éªŒè‰¯å¥½
âœ… **å®‰å…¨æ€§**: åŠ å¯†+æƒé™æ§åˆ¶,åŒé‡ä¿éšœ

### æŠ€æœ¯äº®ç‚¹

1. **äº‹ä»¶é©±åŠ¨æ¶æ„**: ä½¿ç”¨EventEmitterå®ç°æ¾è€¦åˆ
2. **æ–‡ä»¶çº§éš”ç¦»**: æ¯”è¡¨çº§éš”ç¦»æ›´å®‰å…¨ã€æ›´é«˜æ•ˆ
3. **è‡ªåŠ¨é‡æ–°åˆå§‹åŒ–**: æ— éœ€æ‰‹åŠ¨ç®¡ç†æ•°æ®åº“è¿æ¥
4. **å¹³æ»‘è¿‡æ¸¡**: ä¸ªäººç‰ˆç”¨æˆ·æ— æ„ŸçŸ¥å‡çº§

### åç»­ä¼˜åŒ–

1. æ•°æ®åº“è¿æ¥æ± (å‡å°‘åˆ‡æ¢å»¶è¿Ÿ)
2. å¢é‡æ•°æ®åŠ è½½(åŠ å¿«é¡µé¢åˆ·æ–°)
3. åˆ‡æ¢åŠ¨ç”»(æå‡ç”¨æˆ·ä½“éªŒ)
4. æ•°æ®é¢„åŠ è½½(é¢„æµ‹ç”¨æˆ·åˆ‡æ¢è¡Œä¸º)

---

**å®ç°äºº**: Claude Code
**å®Œæˆæ—¶é—´**: 2025-12-31
**çŠ¶æ€**: âœ… ç”Ÿäº§å°±ç»ª
