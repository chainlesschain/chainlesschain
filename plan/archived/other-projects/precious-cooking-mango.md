# çœ¼ç§‘æ™ºèƒ½åˆ†è¯Šç³»ç»ŸV3.0é‡æ„æ–¹æ¡ˆ

## ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°

### 1.1 é‡æ„ç›®æ ‡
å°†å½“å‰çš„**é¢„è®¾é€‰é¡¹å¼é—®ç­”**æ”¹é€ ä¸º**AIé©±åŠ¨çš„å¼€æ”¾å¼é—®ç­”**ï¼Œå®ç°ï¼š
- âœ… ç”¨æˆ·è‡ªç”±æè¿°ç—‡çŠ¶ï¼Œä¸å—é€‰é¡¹é™åˆ¶
- âœ… AIæ ¹æ®å¯¹è¯è®°å½•æ™ºèƒ½å†³å®šä¸‹ä¸€ä¸ªé—®é¢˜æˆ–æ¨èç§‘å®¤
- âœ… ä¿æŒç°æœ‰çš„ç§‘å®¤æ¨èå‡†ç¡®æ€§ï¼ˆåˆ©ç”¨250+æ¡æƒé‡é…ç½®ï¼‰
- âœ… ä¿ç•™ä¸“ä¸šçš„23ä¸ªé—®é¢˜ä½œä¸ºAIçŸ¥è¯†åº“

### 1.2 æ ¸å¿ƒè®¾è®¡åŸåˆ™
åŸºäºç”¨æˆ·é€‰æ‹©çš„**å¹³è¡¡æ–¹æ¡ˆ**ï¼š
1. **ä¿ç•™ç°æœ‰èµ„äº§**ï¼šåˆ©ç”¨23ä¸ªä¸“ä¸šé—®é¢˜+250+æ¡æƒé‡å…³ç³»
2. **AIå¢å¼ºç†è§£**ï¼šAIæå–è‡ªç”±æ–‡æœ¬ä¸­çš„å…³é”®ä¿¡æ¯
3. **æ™ºèƒ½æ˜ å°„æœºåˆ¶**ï¼šå°†ç”¨æˆ·è¾“å…¥æ˜ å°„åˆ°é¢„è®¾ç—‡çŠ¶å’Œé€‰é¡¹
4. **å‡†ç¡®æ€§ä¼˜å…ˆ**ï¼šç»§ç»­ä½¿ç”¨æƒé‡è®¡ç®—ç³»ç»Ÿä¿è¯å‡†ç¡®æ€§

---

## äºŒã€æŠ€æœ¯æ–¹æ¡ˆè®¾è®¡

### 2.1 æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    V3.0 AIé©±åŠ¨å¯¹è¯æµç¨‹                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è¾“å…¥è‡ªç”±æ–‡æœ¬
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIä¿¡æ¯æå–æ¨¡å—   â”‚  â† æ–°å¢æ ¸å¿ƒæ¨¡å—
â”‚ (DeepSeek)      â”‚
â”‚ â€¢ æå–ç—‡çŠ¶å…³é”®è¯  â”‚
â”‚ â€¢ æå–å¹´é¾„/ç—…å²   â”‚
â”‚ â€¢ ç†è§£è¯­ä¹‰        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ™ºèƒ½æ˜ å°„æ¨¡å—     â”‚  â† æ–°å¢æ ¸å¿ƒæ¨¡å—
â”‚ â€¢ æ˜ å°„åˆ°é¢„è®¾ç—‡çŠ¶  â”‚
â”‚ â€¢ æ˜ å°„åˆ°é—®é¢˜é€‰é¡¹  â”‚
â”‚ â€¢ ç”Ÿæˆæƒé‡è¾“å…¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æƒé‡è®¡ç®—å¼•æ“     â”‚  â† ä¿ç•™åŸæœ‰é€»è¾‘
â”‚ â€¢ QuestionDeptImpact â”‚
â”‚ â€¢ Softmaxç½®ä¿¡åº¦   â”‚
â”‚ â€¢ ä¿¡æ¯ç†µä¿®æ­£      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AIå†³ç­–æ¨¡å—       â”‚  â† æ–°å¢æ ¸å¿ƒæ¨¡å—
â”‚ â€¢ åˆ¤æ–­æ˜¯å¦ç»§ç»­æé—® â”‚
â”‚ â€¢ ç”Ÿæˆä¸‹ä¸€ä¸ªé—®é¢˜  â”‚
â”‚ â€¢ æˆ–æ¨èç§‘å®¤      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 æ ¸å¿ƒæ¨¡å—è¯¦è§£

#### æ¨¡å—Aï¼šAIä¿¡æ¯æå–æœåŠ¡ï¼ˆæ–°å¢ï¼‰
**æ–‡ä»¶è·¯å¾„**ï¼š`com.hospital.triage.service.impl.AiExtractionServiceImpl`

**åŠŸèƒ½**ï¼š
- ä»ç”¨æˆ·çš„è‡ªç”±æ–‡æœ¬ä¸­æå–ç»“æ„åŒ–ä¿¡æ¯
- è¯†åˆ«ç—‡çŠ¶å…³é”®è¯
- æå–å¹´é¾„ã€ç—…å²ã€æ—¶é•¿ç­‰å…³é”®ä¿¡æ¯

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
public class AiExtractionServiceImpl {

    @Autowired
    private DeepSeekUtil deepSeekUtil;

    /**
     * ä»è‡ªç”±æ–‡æœ¬ä¸­æå–ç—‡çŠ¶å’Œä¿¡æ¯
     */
    public ExtractionResult extractFromUserInput(String userInput,
                                                  List<TriageQuestion> availableQuestions) {
        // æ„å»ºAIæç¤ºè¯
        String prompt = buildExtractionPrompt(userInput, availableQuestions);

        // è°ƒç”¨AI
        Map<String, Object> aiResponse = deepSeekUtil.chat(prompt);

        // è§£æAIè¿”å›çš„ç»“æœ
        return parseExtractionResult(aiResponse);
    }

    /**
     * æ„å»ºæå–ä¿¡æ¯çš„æç¤ºè¯
     */
    private String buildExtractionPrompt(String userInput,
                                         List<TriageQuestion> questions) {
        StringBuilder prompt = new StringBuilder();
        prompt.append("ä½ æ˜¯ä¸€ä½çœ¼ç§‘åŒ»ç”ŸåŠ©æ‰‹ï¼Œè¯·ä»æ‚£è€…çš„æè¿°ä¸­æå–å…³é”®ä¿¡æ¯ã€‚\n\n");
        prompt.append("æ‚£è€…æè¿°ï¼š").append(userInput).append("\n\n");
        prompt.append("è¯·æå–ä»¥ä¸‹ä¿¡æ¯ï¼Œå¹¶ä»¥JSONæ ¼å¼è¿”å›ï¼š\n");
        prompt.append("1. symptoms: æå–çš„ç—‡çŠ¶åˆ—è¡¨ï¼ˆä»ä»¥ä¸‹é€‰é¡¹ä¸­é€‰æ‹©ï¼‰\n");
        prompt.append("   å¯é€‰ç—‡çŠ¶ï¼šè§†åŠ›ä¸‹é™ã€çœ¼ç—›ã€çœ¼èƒ€ã€çœ¼çº¢ã€å……è¡€ã€çœ¼å¹²ã€å¼‚ç‰©æ„Ÿã€");
        prompt.append("é£èšŠç—‡ã€é»‘å½±ã€å¤è§†ã€é‡å½±ã€è§†ç‰©å˜å½¢ã€çœ¼ç‘è‚¿èƒ€ã€æµæ³ªã€");
        prompt.append("ç•å…‰ã€åˆ†æ³Œç‰©ã€è§†é‡ç¼ºæŸã€çœ‹ä¸œè¥¿æœ‰å½©è™¹åœˆç­‰\n");
        prompt.append("2. duration: ç—‡çŠ¶æŒç»­æ—¶é—´ï¼ˆ1å‘¨å†…/1-2å‘¨/è¶…è¿‡2å‘¨ï¼‰\n");
        prompt.append("3. severity: ä¸¥é‡ç¨‹åº¦ï¼ˆè½»å¾®/ä¸­ç­‰/ä¸¥é‡/æä¸¥é‡ï¼‰\n");
        prompt.append("4. ageGroup: å¹´é¾„æ®µï¼ˆå„¿ç«¥/é’å°‘å¹´/é’å¹´/ä¸­å¹´/è€å¹´ï¼‰\n");
        prompt.append("5. hasHistory: æ˜¯å¦æåˆ°ç—…å²ï¼ˆtrue/falseï¼‰\n");
        prompt.append("6. historyDetails: ç—…å²è¯¦æƒ…ï¼ˆå¦‚æœ‰ï¼‰\n");
        prompt.append("7. keywords: å…¶ä»–å…³é”®ä¿¡æ¯\n\n");

        // æ·»åŠ é—®é¢˜åº“ä¸Šä¸‹æ–‡ï¼ˆå¸®åŠ©AIç†è§£ï¼‰
        prompt.append("å‚è€ƒé—®é¢˜åº“ï¼š\n");
        for (TriageQuestion q : questions) {
            prompt.append("- ").append(q.getQuestionContent()).append("\n");
            if (q.getOptions() != null) {
                prompt.append("  é€‰é¡¹ï¼š").append(q.getOptions()).append("\n");
            }
        }

        prompt.append("\nè¯·ä»¥æ ‡å‡†JSONæ ¼å¼è¿”å›ï¼Œä¸è¦åŒ…å«é¢å¤–è¯´æ˜ã€‚");
        return prompt.toString();
    }
}
```

**è¿”å›çš„æ•°æ®ç»“æ„**ï¼š
```java
@Data
public class ExtractionResult {
    private List<String> symptoms;           // æå–çš„ç—‡çŠ¶
    private String duration;                 // æŒç»­æ—¶é—´
    private String severity;                 // ä¸¥é‡ç¨‹åº¦
    private String ageGroup;                 // å¹´é¾„æ®µ
    private Boolean hasHistory;              // æ˜¯å¦æœ‰ç—…å²
    private String historyDetails;           // ç—…å²è¯¦æƒ…
    private Map<String, Object> keywords;    // å…¶ä»–å…³é”®è¯
    private Double confidence;               // AIæå–çš„ç½®ä¿¡åº¦
}
```

#### æ¨¡å—Bï¼šæ™ºèƒ½æ˜ å°„æœåŠ¡ï¼ˆæ–°å¢ï¼‰
**æ–‡ä»¶è·¯å¾„**ï¼š`com.hospital.triage.service.impl.MappingServiceImpl`

**åŠŸèƒ½**ï¼š
- å°†AIæå–çš„ç—‡çŠ¶æ˜ å°„åˆ°QuestionDeptImpactè¡¨ä¸­çš„é€‰é¡¹
- ç”Ÿæˆæƒé‡è¾“å…¥æ•°æ®

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
public class MappingServiceImpl {

    @Autowired
    private TriageQuestionMapper questionMapper;

    @Autowired
    private QuestionDeptImpactMapper impactMapper;

    /**
     * å°†æå–ç»“æœæ˜ å°„åˆ°æƒé‡ç³»ç»Ÿ
     */
    public Map<String, String> mapToQuestionAnswers(ExtractionResult extraction) {
        Map<String, String> mappedAnswers = new HashMap<>();

        // æ˜ å°„ç—‡çŠ¶ï¼ˆQ001ï¼‰
        if (extraction.getSymptoms() != null && !extraction.getSymptoms().isEmpty()) {
            String symptomsAnswer = String.join("ã€", extraction.getSymptoms());
            mappedAnswers.put("Q001", symptomsAnswer);
        }

        // æ˜ å°„æŒç»­æ—¶é—´ï¼ˆQ002ï¼‰
        if (extraction.getDuration() != null) {
            mappedAnswers.put("Q002", extraction.getDuration());
        }

        // æ˜ å°„ä¸¥é‡ç¨‹åº¦ï¼ˆQ003ï¼‰
        if (extraction.getSeverity() != null) {
            mappedAnswers.put("Q003", extraction.getSeverity());
        }

        // æ˜ å°„å¹´é¾„æ®µï¼ˆQ007ï¼‰
        if (extraction.getAgeGroup() != null) {
            mappedAnswers.put("Q007", extraction.getAgeGroup());
        }

        // æ˜ å°„ç—…å²ï¼ˆQ004ï¼‰
        if (extraction.getHasHistory() && extraction.getHistoryDetails() != null) {
            mappedAnswers.put("Q004", extraction.getHistoryDetails());
        }

        return mappedAnswers;
    }

    /**
     * æ ¹æ®æ˜ å°„ç»“æœè®¡ç®—ç§‘å®¤æƒé‡
     */
    public Map<Long, Double> calculateDeptWeights(Map<String, String> mappedAnswers) {
        Map<Long, Double> deptWeights = new HashMap<>();

        for (Map.Entry<String, String> entry : mappedAnswers.entrySet()) {
            String questionCode = entry.getKey();
            String answer = entry.getValue();

            // å¤„ç†å¤šé€‰æƒ…å†µï¼ˆç”¨é¡¿å·åˆ†éš”ï¼‰
            String[] options = answer.split("ã€");

            for (String option : options) {
                // æŸ¥è¯¢è¯¥é—®é¢˜-é€‰é¡¹å¯¹åº”çš„ç§‘å®¤å½±å“
                List<QuestionDeptImpact> impacts =
                    impactMapper.selectByQuestionAndOption(questionCode, option.trim());

                for (QuestionDeptImpact impact : impacts) {
                    Long deptId = impact.getAiDeptId();
                    Double weight = impact.getWeightAdjustment().doubleValue();

                    // åº”ç”¨å½±å“çº§åˆ«ç³»æ•°
                    Double factor = getImpactFactor(impact.getImpactLevel());
                    Double adjustedWeight = weight * factor;

                    // ç´¯åŠ æƒé‡
                    deptWeights.merge(deptId, adjustedWeight, Double::sum);
                }
            }
        }

        return deptWeights;
    }

    private Double getImpactFactor(String impactLevel) {
        if ("HIGH".equals(impactLevel)) return 1.2;
        if ("LOW".equals(impactLevel)) return 0.8;
        return 1.0; // MEDIUM
    }
}
```

#### æ¨¡å—Cï¼šAIå†³ç­–æœåŠ¡ï¼ˆæ–°å¢ï¼‰
**æ–‡ä»¶è·¯å¾„**ï¼š`com.hospital.triage.service.impl.AiDecisionServiceImpl`

**åŠŸèƒ½**ï¼š
- æ ¹æ®å½“å‰ç½®ä¿¡åº¦å’Œå¯¹è¯å†å²å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨
- ç”Ÿæˆæ–°çš„å¼€æ”¾å¼é—®é¢˜æˆ–æ¨èç§‘å®¤

**æŠ€æœ¯å®ç°**ï¼š
```java
@Service
public class AiDecisionServiceImpl {

    @Autowired
    private DeepSeekUtil deepSeekUtil;

    @Autowired
    private TriageQuestionMapper questionMapper;

    /**
     * å†³å®šä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼šç»§ç»­æé—® or æ¨èç§‘å®¤
     */
    public DecisionResult makeDecision(TriageSessionV3 session,
                                       ConfidenceResult confidence) {
        // å¦‚æœç½®ä¿¡åº¦è¾¾æ ‡ï¼Œæ¨èç§‘å®¤
        if (confidence.getReachedThreshold()) {
            return DecisionResult.recommend();
        }

        // å¦‚æœè¾¾åˆ°æœ€å¤§è½®æ•°ï¼Œæ¨èç§‘å®¤
        if (session.getRoundNumber() >= getMaxRounds()) {
            return DecisionResult.recommend();
        }

        // å¦åˆ™ï¼Œç”Ÿæˆä¸‹ä¸€ä¸ªé—®é¢˜
        String nextQuestion = generateNextQuestion(session, confidence);
        return DecisionResult.continueWithQuestion(nextQuestion);
    }

    /**
     * AIç”Ÿæˆä¸‹ä¸€ä¸ªé—®é¢˜
     */
    private String generateNextQuestion(TriageSessionV3 session,
                                        ConfidenceResult confidence) {
        // è·å–æœªé—®è¿‡çš„é—®é¢˜
        List<TriageQuestion> availableQuestions =
            getAvailableQuestions(session.getAskedQuestionSet());

        // æ ¹æ®ä¿¡æ¯å¢ç›Šé€‰æ‹©æœ€æœ‰ä»·å€¼çš„é—®é¢˜
        TriageQuestion bestQuestion = selectBestQuestion(
            availableQuestions,
            confidence.getAiDeptProbabilities()
        );

        // è®©AIå°†é—®é¢˜æ”¹å†™æˆå¼€æ”¾å¼é—®é¢˜
        String openEndedQuestion = convertToOpenEnded(
            bestQuestion,
            session.getQaHistoryList()
        );

        return openEndedQuestion;
    }

    /**
     * å°†é¢„è®¾é—®é¢˜è½¬æ¢ä¸ºå¼€æ”¾å¼é—®é¢˜
     */
    private String convertToOpenEnded(TriageQuestion question,
                                      List<Map<String, Object>> qaHistory) {
        StringBuilder prompt = new StringBuilder();
        prompt.append("ä½ æ˜¯çœ¼ç§‘åŒ»ç”ŸåŠ©æ‰‹ï¼Œæ­£åœ¨è¿›è¡Œé—®è¯Šã€‚\n\n");
        prompt.append("å¯¹è¯å†å²ï¼š\n");
        for (Map<String, Object> qa : qaHistory) {
            prompt.append("åŒ»ç”Ÿï¼š").append(qa.get("question")).append("\n");
            prompt.append("æ‚£è€…ï¼š").append(qa.get("answer")).append("\n");
        }
        prompt.append("\nä½ éœ€è¦è¯¢é—®ï¼š").append(question.getQuestionContent()).append("\n");

        if (question.getOptions() != null) {
            prompt.append("å‚è€ƒé€‰é¡¹ï¼š").append(question.getOptions()).append("\n");
        }

        prompt.append("\nè¯·å°†ä¸Šè¿°é—®é¢˜æ”¹å†™ä¸ºè‡ªç„¶ã€å‹å¥½çš„å¼€æ”¾å¼é—®é¢˜ï¼Œ");
        prompt.append("ä¸è¦åˆ—å‡ºé€‰é¡¹ï¼Œè®©æ‚£è€…è‡ªç”±æè¿°ã€‚");
        prompt.append("ç›´æ¥è¿”å›é—®é¢˜æ–‡æœ¬ï¼Œä¸è¦åŠ ä»»ä½•å‰ç¼€æˆ–è¯´æ˜ã€‚");

        Map<String, Object> aiResponse = deepSeekUtil.chat(prompt.toString());
        return (String) aiResponse.getOrDefault("content", question.getQuestionContent());
    }
}
```

---

## ä¸‰ã€é‡æ„å®æ–½æ­¥éª¤

### 3.1 ç¬¬ä¸€é˜¶æ®µï¼šæ–°å¢æœåŠ¡ç±»ï¼ˆä¸å½±å“ç°æœ‰åŠŸèƒ½ï¼‰

**æ–‡ä»¶æ¸…å•**ï¼š
1. `AiExtractionService.java` (æ¥å£)
2. `AiExtractionServiceImpl.java` (å®ç°)
3. `MappingService.java` (æ¥å£)
4. `MappingServiceImpl.java` (å®ç°)
5. `AiDecisionService.java` (æ¥å£)
6. `AiDecisionServiceImpl.java` (å®ç°)

**æ–°å¢DTO**ï¼š
1. `ExtractionResult.java` - AIæå–ç»“æœ
2. `DecisionResult.java` - AIå†³ç­–ç»“æœ

**è·¯å¾„**ï¼š
- æœåŠ¡ç±»ï¼š`src/main/java/com/hospital/triage/service/impl/`
- DTOç±»ï¼š`src/main/java/com/hospital/triage/dto/`

### 3.2 ç¬¬äºŒé˜¶æ®µï¼šä¿®æ”¹V3æœåŠ¡å®ç°

**ä¿®æ”¹æ–‡ä»¶**ï¼š`OphthalConversationTriageV3ServiceImpl.java`

**å…³é”®ä¿®æ”¹ç‚¹**ï¼š

#### ä¿®æ”¹1ï¼šcontinueConversationæ–¹æ³•

**åŸé€»è¾‘**ï¼š
```java
// ç”¨æˆ·é€‰æ‹©äº†é¢„è®¾é€‰é¡¹
String answer = requestDTO.getAnswer();
// è®°å½•åˆ°ä¼šè¯
session.addAnswer(questionCode, question, answer);
// ç›´æ¥è®¡ç®—æƒé‡
```

**æ–°é€»è¾‘**ï¼š
```java
// 1. ç”¨æˆ·è¾“å…¥è‡ªç”±æ–‡æœ¬
String userInput = requestDTO.getAnswer();

// 2. AIæå–ç»“æ„åŒ–ä¿¡æ¯
ExtractionResult extraction = aiExtractionService.extractFromUserInput(
    userInput,
    questionMapper.selectAllActive()
);

// 3. æ˜ å°„åˆ°é—®é¢˜ç­”æ¡ˆ
Map<String, String> mappedAnswers = mappingService.mapToQuestionAnswers(extraction);

// 4. è®°å½•åŸå§‹å›ç­”å’Œæå–ç»“æœ
session.addAnswer("OPEN_" + session.getRoundNumber(), userInput, userInput);
session.addExtractedInfo(extraction); // æ–°å¢æ–¹æ³•

// 5. è®¡ç®—ç§‘å®¤æƒé‡ï¼ˆä½¿ç”¨æ˜ å°„åçš„æ•°æ®ï¼‰
Map<Long, Double> deptWeights = mappingService.calculateDeptWeights(mappedAnswers);

// 6. åˆå¹¶ä¹‹å‰çš„æƒé‡ï¼ˆç´¯åŠ ï¼‰
Map<Long, Double> cumulativeWeights = session.getCumulativeWeights();
for (Map.Entry<Long, Double> entry : deptWeights.entrySet()) {
    cumulativeWeights.merge(entry.getKey(), entry.getValue(), Double::sum);
}
session.setCumulativeWeights(cumulativeWeights);

// 7. è®¡ç®—ç½®ä¿¡åº¦ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
ConfidenceResult confidence = calculateAiDeptConfidence(
    cumulativeWeights,
    threshold
);

// 8. AIå†³ç­–ï¼šç»§ç»­æé—® or æ¨èç§‘å®¤
DecisionResult decision = aiDecisionService.makeDecision(session, confidence);

if (decision.isRecommend()) {
    return generateRecommendations(session, cumulativeWeights, confidence);
} else {
    // 9. è¿”å›AIç”Ÿæˆçš„å¼€æ”¾å¼é—®é¢˜
    ConversationMessageDTO nextQuestion = ConversationMessageDTO.builder()
        .type("open_ended")
        .content(decision.getNextQuestion())
        .options(null)  // ä¸å†æä¾›é€‰é¡¹
        .multiSelect(false)
        .timestamp(System.currentTimeMillis())
        .build();

    return buildOngoingResponse(session, nextQuestion, confidence);
}
```

#### ä¿®æ”¹2ï¼šTriageSessionV3å®ä½“ç±»

**æ–°å¢å­—æ®µ**ï¼š
```java
// ç´¯è®¡çš„ç§‘å®¤æƒé‡ï¼ˆæ¯è½®ç´¯åŠ ï¼‰
@TableField(typeHandler = JacksonTypeHandler.class)
private Map<Long, Double> cumulativeWeights;

// AIæå–çš„ä¿¡æ¯å†å²
@TableField(typeHandler = JacksonTypeHandler.class)
private List<ExtractionResult> extractedInfoList;
```

**æ–°å¢æ–¹æ³•**ï¼š
```java
public void addExtractedInfo(ExtractionResult extraction) {
    if (this.extractedInfoList == null) {
        this.extractedInfoList = new ArrayList<>();
    }
    this.extractedInfoList.add(extraction);
}

public Map<Long, Double> getCumulativeWeights() {
    if (this.cumulativeWeights == null) {
        this.cumulativeWeights = new HashMap<>();
    }
    return this.cumulativeWeights;
}

public void setCumulativeWeights(Map<Long, Double> weights) {
    this.cumulativeWeights = weights;
}
```

### 3.3 ç¬¬ä¸‰é˜¶æ®µï¼šæ•°æ®åº“è¿ç§»

**SQLè„šæœ¬**ï¼š`v3.1_open_ended_upgrade.sql`

```sql
-- ä¸ºä¼šè¯è¡¨æ·»åŠ æ–°å­—æ®µ
ALTER TABLE t_triage_session_v3
ADD cumulative_weights TEXT NULL COMMENT 'ç´¯è®¡ç§‘å®¤æƒé‡(JSON)';

ALTER TABLE t_triage_session_v3
ADD extracted_info_list TEXT NULL COMMENT 'AIæå–ä¿¡æ¯å†å²(JSON)';

-- æ·»åŠ é…ç½®é¡¹ï¼šAIæå–ç½®ä¿¡åº¦é˜ˆå€¼
INSERT INTO t_triage_config (config_key, config_value, config_desc, value_type, is_active)
VALUES ('ai_extraction_confidence_threshold', '0.7', 'AIæå–ä¿¡æ¯çš„æœ€ä½ç½®ä¿¡åº¦é˜ˆå€¼', 'DECIMAL', 1);

-- æ·»åŠ é…ç½®é¡¹ï¼šæ˜¯å¦å¯ç”¨AIç”Ÿæˆé—®é¢˜
INSERT INTO t_triage_config (config_key, config_value, config_desc, value_type, is_active)
VALUES ('enable_ai_generate_question', '1', 'æ˜¯å¦å¯ç”¨AIç”Ÿæˆå¼€æ”¾å¼é—®é¢˜', 'BOOLEAN', 1);
```

### 3.4 ç¬¬å››é˜¶æ®µï¼šå‰ç«¯é€‚é…

**ä¿®æ”¹æ–‡ä»¶**ï¼š`uni/pages/conversation-triage-v3/conversation-triage-v3.vue`

**å…³é”®ä¿®æ”¹**ï¼š

```vue
<!-- æ‰€æœ‰é—®é¢˜ç±»å‹éƒ½æ”¹ä¸ºè‡ªç”±è¾“å…¥ -->
<view v-if="message.type === 'open_ended' || message.type === 'question'"
      class="message-question-card">
  <view class="question-header">
    <view class="question-icon">ğŸ’¬</view>
    <text class="question-title">{{ message.content }}</text>
  </view>

  <!-- ç»Ÿä¸€ä½¿ç”¨æ–‡æœ¬è¾“å…¥æ¡† -->
  <view class="text-input-area">
    <textarea
      class="symptom-textarea"
      :value="message.textInput || ''"
      @input="onTextInput($event, index)"
      placeholder="è¯·è¯¦ç»†æè¿°..."
      :maxlength="500"
      :disabled="message.answered"
      auto-height
    />
    <view class="text-counter">{{ (message.textInput || '').length }}/500</view>
  </view>

  <!-- æäº¤æŒ‰é’® -->
  <view class="submit-area" v-if="!message.answered && index === messages.length - 1">
    <button
      class="submit-btn"
      :class="{ 'submit-btn-disabled': !message.textInput }"
      :disabled="!message.textInput || submitting"
      @tap="submitTextAnswer(index)"
    >
      <text v-if="!submitting">æäº¤</text>
      <text v-else>æäº¤ä¸­...</text>
    </button>
  </view>
</view>

<!-- ç§»é™¤åŸæ¥çš„é€‰é¡¹æŒ‰é’®ç»„ä»¶ -->
```

---

## å››ã€æ ¸å¿ƒä¼˜åŠ¿åˆ†æ

### 4.1 ç”¨æˆ·ä½“éªŒæå‡
- âœ… **è‡ªç„¶äº¤äº’**ï¼šç”¨æˆ·å¯ä»¥ç”¨è‡ªå·±çš„è¯æè¿°ç—‡çŠ¶
- âœ… **çµæ´»è¡¨è¾¾**ï¼šä¸å—é€‰é¡¹é™åˆ¶ï¼Œå¯ä»¥è¡¥å……ç»†èŠ‚
- âœ… **å‡å°‘è¯¯è§£**ï¼šä¸ç”¨çº ç»“é€‰é¡¹ï¼Œç›´æ¥è¯´æ˜æƒ…å†µ

### 4.2 å‡†ç¡®æ€§ä¿è¯
- âœ… **ä¿ç•™æƒé‡ç³»ç»Ÿ**ï¼šç»§ç»­ä½¿ç”¨250+æ¡ä¸“ä¸šé…ç½®çš„æƒé‡å…³ç³»
- âœ… **AIè¾…åŠ©ç†è§£**ï¼šæå–å…³é”®ä¿¡æ¯åæ˜ å°„åˆ°æ ‡å‡†ç—‡çŠ¶
- âœ… **åŒé‡éªŒè¯**ï¼šAIç†è§£+æƒé‡è®¡ç®—ï¼Œé™ä½è¯¯åˆ¤é£é™©

### 4.3 ç³»ç»Ÿå¯ç»´æŠ¤æ€§
- âœ… **æ¸è¿›å¼æ”¹é€ **ï¼šä¸ç ´åç°æœ‰æ¶æ„ï¼Œé€æ­¥å¢å¼º
- âœ… **é™çº§æœºåˆ¶**ï¼šAIæœåŠ¡æ•…éšœæ—¶å¯å›é€€åˆ°é€‰é¡¹æ¨¡å¼
- âœ… **æ•°æ®ç§¯ç´¯**ï¼šä¿å­˜AIæå–ç»“æœï¼ŒæŒç»­ä¼˜åŒ–æ¨¡å‹

### 4.4 æ‰©å±•æ€§
- âœ… **é—®é¢˜åº“å¤ç”¨**ï¼š23ä¸ªä¸“ä¸šé—®é¢˜ç»§ç»­å‘æŒ¥ä»·å€¼
- âœ… **æƒé‡å¯è°ƒ**ï¼šåç»­å¯æ ¹æ®æ•°æ®ä¼˜åŒ–æƒé‡é…ç½®
- âœ… **AIå¯å‡çº§**ï¼šå¯æ›´æ¢æ›´å¼ºå¤§çš„AIæ¨¡å‹

---

## äº”ã€é£é™©æ§åˆ¶

### 5.1 AIç†è§£åå·®
**é£é™©**ï¼šAIå¯èƒ½æå–é”™è¯¯çš„ç—‡çŠ¶

**ç¼“è§£æªæ–½**ï¼š
1. åœ¨å“åº”ä¸­å±•ç¤º"AIç†è§£ä¸º"çš„å†…å®¹ï¼Œç”¨æˆ·å¯ä»¥çº æ­£
2. è®¾ç½®AIæå–ç½®ä¿¡åº¦é˜ˆå€¼ï¼ˆ0.7ï¼‰ï¼Œä½äºé˜ˆå€¼æ—¶è¦æ±‚ç”¨æˆ·ç¡®è®¤
3. è®°å½•AIæå–ç»“æœï¼Œåç»­å¯äººå·¥reviewå’Œä¼˜åŒ–

### 5.2 æ€§èƒ½é—®é¢˜
**é£é™©**ï¼šæ¯è½®éƒ½è°ƒç”¨AIï¼Œå“åº”å¯èƒ½å˜æ…¢

**ç¼“è§£æªæ–½**ï¼š
1. è®¾ç½®åˆç†çš„AIè¶…æ—¶æ—¶é—´ï¼ˆ5ç§’ï¼‰
2. ä½¿ç”¨ç¼“å­˜æœºåˆ¶ï¼šç›¸ä¼¼è¾“å…¥å¤ç”¨æå–ç»“æœ
3. å¼‚æ­¥å¤„ç†AIç”Ÿæˆé—®é¢˜çš„é€»è¾‘

### 5.3 æˆæœ¬é—®é¢˜
**é£é™©**ï¼šAIè°ƒç”¨æ¬¡æ•°å¢åŠ ï¼Œæˆæœ¬ä¸Šå‡

**ç¼“è§£æªæ–½**ï¼š
1. ä¼˜åŒ–æç¤ºè¯é•¿åº¦ï¼Œå‡å°‘tokenæ¶ˆè€—
2. å¯¹äºç®€å•è¾“å…¥ï¼ˆå¦‚"æ˜¯"/"å¦"ï¼‰ï¼Œç›´æ¥æ˜ å°„ï¼Œä¸è°ƒç”¨AI
3. æ‰¹é‡å¤„ç†ï¼šä¸€æ¬¡AIè°ƒç”¨åŒæ—¶å®Œæˆæå–å’Œå†³ç­–

---

## å…­ã€å®æ–½æ—¶é—´ä¼°ç®—

| é˜¶æ®µ | ä»»åŠ¡ | é¢„è®¡æ—¶é—´ |
|------|------|---------|
| ç¬¬ä¸€é˜¶æ®µ | æ–°å¢3ä¸ªæœåŠ¡ç±»+2ä¸ªDTO | 4å°æ—¶ |
| ç¬¬äºŒé˜¶æ®µ | ä¿®æ”¹V3æœåŠ¡å®ç° | 3å°æ—¶ |
| ç¬¬ä¸‰é˜¶æ®µ | æ•°æ®åº“è¿ç§»+é…ç½® | 1å°æ—¶ |
| ç¬¬å››é˜¶æ®µ | å‰ç«¯é€‚é… | 2å°æ—¶ |
| æµ‹è¯•è°ƒè¯• | ç«¯åˆ°ç«¯æµ‹è¯•+ä¼˜åŒ– | 3å°æ—¶ |
| **æ€»è®¡** | | **13å°æ—¶** |

---

## ä¸ƒã€æµ‹è¯•è®¡åˆ’

### 7.1 å•å…ƒæµ‹è¯•
- AiExtractionServiceï¼šæµ‹è¯•å„ç§ç—‡çŠ¶æè¿°çš„æå–å‡†ç¡®æ€§
- MappingServiceï¼šæµ‹è¯•ç—‡çŠ¶åˆ°é€‰é¡¹çš„æ˜ å°„æ­£ç¡®æ€§
- AiDecisionServiceï¼šæµ‹è¯•å†³ç­–é€»è¾‘

### 7.2 é›†æˆæµ‹è¯•
- å®Œæ•´å¯¹è¯æµç¨‹ï¼šä»å¼€å§‹åˆ°æ¨èç§‘å®¤
- è¾¹ç•Œæƒ…å†µï¼šç©ºè¾“å…¥ã€æ— æ•ˆè¾“å…¥ã€AIè¶…æ—¶ç­‰
- é™çº§æµ‹è¯•ï¼šAIæœåŠ¡æ•…éšœæ—¶çš„å›é€€æœºåˆ¶

### 7.3 ç”¨æˆ·éªŒæ”¶æµ‹è¯•
å‡†å¤‡10ä¸ªå…¸å‹ç—…ä¾‹ï¼ŒéªŒè¯ï¼š
1. ç™½å†…éšœæ‚£è€… â†’ åº”æ¨èç™½å†…éšœç§‘
2. é’å…‰çœ¼æ€¥æ€§å‘ä½œ â†’ åº”æ¨èé’å…‰çœ¼ç§‘
3. å¹²çœ¼ç—‡æ‚£è€… â†’ åº”æ¨èè§’è†œç—…ç§‘
4. å„¿ç«¥æ–œè§† â†’ åº”æ¨èå°å„¿çœ¼ç§‘
5. è§†ç½‘è†œè„±ç¦»é«˜å± â†’ åº”æ¨èçœ¼åº•ç—…ç§‘
6. ...

---

## å…«ã€å…³é”®æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶
1. `src/main/java/com/hospital/triage/service/AiExtractionService.java`
2. `src/main/java/com/hospital/triage/service/impl/AiExtractionServiceImpl.java`
3. `src/main/java/com/hospital/triage/service/MappingService.java`
4. `src/main/java/com/hospital/triage/service/impl/MappingServiceImpl.java`
5. `src/main/java/com/hospital/triage/service/AiDecisionService.java`
6. `src/main/java/com/hospital/triage/service/impl/AiDecisionServiceImpl.java`
7. `src/main/java/com/hospital/triage/dto/ExtractionResult.java`
8. `src/main/java/com/hospital/triage/dto/DecisionResult.java`
9. `src/main/resources/sql/v3.1_open_ended_upgrade.sql`

### ä¿®æ”¹æ–‡ä»¶
1. `src/main/java/com/hospital/triage/service/impl/OphthalConversationTriageV3ServiceImpl.java`
2. `src/main/java/com/hospital/triage/entity/TriageSessionV3.java`
3. `uni/pages/conversation-triage-v3/conversation-triage-v3.vue`

---

## ä¹ã€åç»­ä¼˜åŒ–å»ºè®®

### 9.1 çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰
1. æ”¶é›†ç”¨æˆ·åé¦ˆï¼Œä¼˜åŒ–AIæç¤ºè¯
2. åˆ†æAIæå–å‡†ç¡®ç‡ï¼Œè°ƒæ•´é˜ˆå€¼
3. ä¼˜åŒ–ç”Ÿæˆé—®é¢˜çš„è‡ªç„¶åº¦

### 9.2 ä¸­æœŸä¼˜åŒ–ï¼ˆ1-2æœˆï¼‰
1. åŸºäºçœŸå®æ•°æ®å¾®è°ƒAIæ¨¡å‹
2. å¼•å…¥å¤šè½®å¯¹è¯ä¸Šä¸‹æ–‡ç†è§£
3. æ·»åŠ å¤šæ¨¡æ€æ”¯æŒï¼ˆå›¾ç‰‡ä¸Šä¼ ï¼‰

### 9.3 é•¿æœŸä¼˜åŒ–ï¼ˆ3-6æœˆï¼‰
1. æ„å»ºä¸“é—¨çš„çœ¼ç§‘ç—‡çŠ¶è¯†åˆ«æ¨¡å‹
2. å¼•å…¥çŸ¥è¯†å›¾è°±å¢å¼ºæ¨ç†èƒ½åŠ›
3. å®ç°ä¸ªæ€§åŒ–é—®è¯Šç­–ç•¥

---

## åã€æ€»ç»“

æœ¬æ–¹æ¡ˆé‡‡ç”¨**AIå¢å¼º+æƒé‡ä¿ç•™**çš„æ··åˆæ¶æ„ï¼Œæ—¢å®ç°äº†å¼€æ”¾å¼é—®ç­”çš„çµæ´»æ€§ï¼Œåˆä¿è¯äº†ç§‘å®¤æ¨èçš„å‡†ç¡®æ€§ã€‚é€šè¿‡æ¸è¿›å¼æ”¹é€ ï¼Œæœ€å¤§åŒ–åˆ©ç”¨ç°æœ‰èµ„äº§ï¼Œé™ä½å®æ–½é£é™©ï¼Œæ˜¯å½“å‰æœ€ä½³çš„é‡æ„æ–¹æ¡ˆã€‚
