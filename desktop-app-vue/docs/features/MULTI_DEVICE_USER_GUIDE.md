# 多设备支持使用指南

**版本**: v0.16.0
**更新日期**: 2025-12-19

## 简介

ChainlessChain 现在支持多设备功能,允许您在多个设备上使用同一账户,并在设备间进行安全的端到端加密通信。每个设备都有独立的加密会话,确保消息安全性。

## 核心功能

### 1. 多设备管理

- **自动设备发现**: 同一网络内的设备会自动发现并注册
- **设备信息显示**: 查看每个用户的所有在线设备
- **设备级加密**: 每个设备独立的加密会话
- **设备统计**: 查看用户总数、设备总数和当前设备信息

### 2. 离线消息同步

- **消息队列**: 离线时消息自动加入队列
- **自动同步**: 设备上线后自动同步离线消息
- **状态跟踪**: 实时跟踪消息状态 (待发送/已发送/已送达/已读)
- **队列管理**: 查看和管理各设备的消息队列

### 3. 设备级聊天

- **设备选择**: 选择特定设备进行通信
- **消息历史**: 每个设备独立的消息历史
- **加密状态**: 实时显示加密会话状态

## 使用步骤

### 步骤 1: 查看当前设备信息

启动应用后,在 P2P 消息界面顶部可以看到当前设备信息:

```
当前设备: DESKTOP-ABC (win32) [12ab34cd...]
```

- **设备名称**: 系统主机名 + 平台类型
- **设备 ID**: 唯一的32位十六进制标识符

### 步骤 2: 连接对等节点

1. 获取对方的 Multiaddr 地址
2. 在"连接新节点"输入框中输入地址
3. 点击"连接"按钮

示例地址:
```
/ip4/192.168.1.100/tcp/9000/p2p/QmXXXXXXXXXXXXXXXXXXX
```

### 步骤 3: 查看对方设备列表

连接成功后:

1. 在对等节点列表中找到目标节点
2. 点击"设备 (X)" 按钮查看该用户的所有设备
3. 设备列表显示:
   - 设备名称和平台
   - 设备 ID (简短显示)
   - 最后活跃时间
   - 加密状态 (绿点=已加密, 灰点=未加密)

### 步骤 4: 建立加密会话

与特定设备建立加密会话:

1. 在设备列表中找到目标设备
2. 点击"建立加密"按钮
3. 等待密钥交换完成 (通常需要1-2秒)
4. 成功后加密状态变为绿色,按钮变为"聊天"

### 步骤 5: 发送加密消息

1. 点击设备的"聊天"按钮打开聊天窗口
2. 在输入框输入消息
3. 按 Enter 或点击"发送"按钮
4. 消息会以端到端加密方式发送

**特性**:
- 消息自动加密 (显示🔒图标)
- 支持多行文本
- 显示发送时间
- 显示发送设备名称

### 步骤 6: 多设备聊天

当对方有多个设备时:

1. 打开聊天窗口
2. 使用设备选择器切换目标设备
3. 每个设备有独立的消息历史
4. 可以与不同设备分别建立加密会话

### 步骤 7: 查看同步队列

查看离线消息队列:

1. 点击"同步队列"按钮 (显示待同步消息数徽章)
2. 查看同步统计:
   - 队列消息总数
   - 设备队列数量
   - 活动同步数量
3. 查看各设备队列详情
4. 点击"立即同步"手动触发同步

### 步骤 8: 查看设备统计

点击"设备统计"按钮查看:

- 用户总数
- 设备总数
- 当前设备详细信息 (名称、ID、平台、版本)

## 使用场景

### 场景 1: 办公室和家庭两台电脑

**设置**:
1. 在办公室电脑 A 启动应用
2. 在家里电脑 B 启动应用
3. 通过 mDNS 自动发现 (同一网络)
4. 或手动连接 multiaddr

**使用**:
- 在 A 上与同事聊天
- 在 B 上继续相同对话
- 消息历史自动同步
- 离线消息会在设备上线后送达

### 场景 2: 与多设备用户通信

**设置**:
1. 对方有设备 B1 (桌面) 和 B2 (笔记本)
2. 查看对方的设备列表
3. 分别与 B1 和 B2 建立加密会话

**使用**:
- 向 B1 发送工作相关消息
- 向 B2 发送私人消息
- 每个设备独立的消息历史
- 对方可以在任意设备上回复

### 场景 3: 离线消息同步

**设置**:
1. 与对方设备建立加密会话
2. 对方设备离线

**使用**:
- 继续发送消息 (自动进入队列)
- 消息显示"待发送"状态
- 对方上线后自动同步
- 消息状态更新为"已送达"

## 消息状态说明

| 状态 | 图标 | 说明 |
|------|------|------|
| PENDING | ⏳ | 等待发送 (对方离线或网络问题) |
| SENT | ✓ | 已发送到 P2P 网络 |
| DELIVERED | ✓✓ | 已送达目标设备 |
| READ | ✓✓ (蓝色) | 对方已读 |
| FAILED | ✗ | 发送失败 |

## 高级功能

### 手动同步

当自动同步未触发时:

1. 打开"同步队列"模态框
2. 在设备队列列表中找到目标设备
3. 点击"立即同步"按钮
4. 系统会尝试发送该设备的所有队列消息

### 加密会话管理

- **查看状态**: 设备列表中的绿点/灰点指示器
- **重新建立**: 如果会话失效,重新点击"建立加密"
- **多会话**: 可以与同一用户的多个设备同时保持加密会话

### 设备识别

设备图标:
- 📱 移动设备 (android/ios)
- 💻 桌面设备 (win32/darwin/linux)

设备颜色 (按平台):
- 🔵 Windows (蓝色)
- 🟣 macOS (紫色)
- 🟠 Linux (橙色)
- 🟢 Android (绿色)
- 🔷 iOS (青色)

## 安全注意事项

### 密钥管理

- 每个设备有独立的 Signal 协议密钥
- 密钥存储在本地加密文件中
- 不同设备间密钥完全隔离

### 消息加密

- 使用 Signal 协议端到端加密
- 消息在 P2P 传输层也有加密保护
- 队列中的消息以加密形式存储

### 设备信任

- 首次连接的设备应手动验证
- 检查设备 ID 是否匹配
- 建议使用带外渠道 (电话/邮件) 验证设备身份

### 数据隐私

- 设备信息仅在连接的节点间共享
- 消息历史存储在本地
- 无中心服务器,完全去中心化

## 常见问题

### Q: 为什么看不到对方的设备列表?

**A**: 可能原因:
1. 对方未启动应用
2. 对方版本过旧,不支持多设备
3. 网络连接问题
4. 设备广播未完成 (等待几秒)

**解决方法**:
- 检查连接状态
- 点击"刷新"按钮
- 等待设备自动发现完成

### Q: 加密会话建立失败?

**A**: 可能原因:
1. 网络不稳定
2. 对方设备离线
3. Signal 协议初始化失败

**解决方法**:
- 检查网络连接
- 稍后重试
- 重启应用

### Q: 消息一直显示"待发送"?

**A**: 可能原因:
1. 对方设备离线
2. 网络连接中断
3. 同步服务未启动

**解决方法**:
- 等待对方上线
- 检查网络连接
- 手动触发同步

### Q: 如何删除旧设备?

**A**:
- 设备超过7天未活跃会自动清理
- 或等待后续版本提供手动删除功能

### Q: 消息队列满了怎么办?

**A**:
- 默认队列大小为1000条
- 队列满时会自动删除最旧的消息
- 可通过配置调整队列大小

### Q: 如何备份设备密钥?

**A**:
- 设备密钥存储在 `{dataPath}/signal-identity.json`
- 建议定期备份此文件
- 恢复时将文件复制回原位置

## 性能优化建议

### 网络优化

- **本地网络**: 使用 mDNS 自动发现,速度最快
- **互联网**: 使用中继节点或 DHT 发现
- **NAT 穿透**: 启用 UPnP 或配置端口转发

### 同步优化

- **同步间隔**: 默认30秒,可调整为10-60秒
- **队列大小**: 根据需求调整 (100-5000条)
- **消息保留**: 默认7天,可调整为1-30天

### 资源使用

- **内存**: 每个设备约1KB
- **磁盘**: 队列和状态文件约10-100KB
- **网络**: 设备广播每次约100-200字节

## 故障排查

### 日志查看

打开开发者工具 (F12) 查看控制台日志:

```javascript
// 设备管理器日志
[DeviceManager] 设备管理器已初始化

// 同步管理器日志
[DeviceSyncManager] 设备同步管理器已初始化

// P2P 管理器日志
[P2PManager] 设备信息已广播到: QmXXX...
```

### 数据文件位置

- Windows: `%APPDATA%/chainlesschain/p2p/`
- macOS: `~/Library/Application Support/chainlesschain/p2p/`
- Linux: `~/.config/chainlesschain/p2p/`

文件列表:
```
peer-id.json              - P2P 节点身份
device.json               - 当前设备信息
devices.json              - 已知设备列表
signal-identity.json      - Signal 加密身份
message-queue.json        - 消息队列
message-status.json       - 消息状态
```

### 重置设备

如需重置设备身份:

1. 关闭应用
2. 删除 `device.json`
3. 重启应用 (会生成新的设备 ID)

**注意**: 删除后需要重新建立加密会话

## 未来功能

即将推出的功能:

- 设备别名管理
- 设备信任级别设置
- 设备远程注销
- 消息已读回执
- 消息撤回
- 文件传输
- 语音通话

## 技术支持

如需帮助:

1. 查看项目文档: `docs/MULTI_DEVICE_SUPPORT.md`
2. 提交 Issue: GitHub Issues
3. 社区论坛: ChainlessChain Community

---

**版本历史**:
- v0.16.0 (2025-12-19): 多设备支持和同步功能完成
- v0.15.0 (2025-12-18): 多设备核心功能实现
