# P2P网络设置UI - 使用指南

## 访问P2P设置

1. 启动应用：`npm run dev`
2. 进入设置页面
3. 点击"P2P 网络"标签（带有地球图标🌐）

---

## 功能模块

### 1. 传输层配置

**可配置选项**：
- ✅ **WebRTC 传输** - 适合大多数NAT环境（推荐）
- ✅ **WebSocket 传输** - HTTP兼容，防火墙友好
- ✅ **TCP 传输** - 直连传输，局域网性能最佳（向后兼容必需）
- ✅ **智能自动选择** - 根据NAT类型自动选择最优传输层
- ⚙️ **WebSocket 端口** - 默认9001，可修改为1024-65535之间

**使用建议**：
- 一般用户：保持所有传输层启用，开启"智能自动选择"
- 局域网用户：可只启用TCP传输以获得最佳性能
- 企业网络用户：优先启用WebSocket传输

---

### 2. NAT穿透状态

**显示信息**：
- 📊 **NAT类型** - 实时显示当前网络的NAT类型
  - 绿色：无NAT或Full Cone NAT（最佳）
  - 蓝色：Restricted NAT（良好）
  - 橙色：Port Restricted NAT（一般）
  - 红色：Symmetric NAT（需要中继）
  - 灰色：未知

- 🌍 **公网IP** - 当前设备的公网IP地址
- 🏠 **本地IP** - 设备在局域网中的IP

**操作按钮**：
- **重新检测** - 手动触发NAT类型检测（需要5秒左右）

**配置选项**：
- **自动检测NAT** - 启动时自动检测（推荐开启）
- **检测间隔** - 默认60分钟，网络环境稳定可延长至24小时

---

### 3. Circuit Relay中继设置

**功能说明**：
Circuit Relay是NAT穿透的后备方案，当直连和STUN都失败时，通过中继节点建立连接。

**配置选项**：
- **启用中继** - 开关（推荐开启）
- **最大预留数量** - 1-5个，默认2个
  - 预留越多，连接成功率越高，但占用资源也越多
- **自动升级直连** - 通过DCUTr尝试将中继连接升级为直连（推荐开启）

**中继节点列表**：
- 显示当前已连接的中继节点
- 显示PeerId（前20字符）
- 显示连接地址
- 显示连接状态（绿色=open，橙色=其他）
- 点击"刷新列表"可更新

**注意事项**：
- 中继连接延迟较高（50-200ms）
- 中继节点由libp2p.io公共服务提供
- 中继连接会在建立直连后自动关闭

---

### 4. 网络诊断

**功能说明**：
完整的P2P网络健康检查工具，诊断所有传输层的可用性。

**运行诊断**：
1. 点击"运行完整诊断"按钮
2. 等待3-5秒（会测试所有传输层）
3. 查看诊断结果

**诊断报告内容**：

**汇总信息**：
- 总传输层数量
- 可用传输层数量（绿色标签）
- 当前活跃连接数

**详细表格**：
| 传输层 | 状态 | 监听地址 | 错误信息 |
|--------|------|---------|---------|
| TCP | 可用/不可用 | /ip4/x.x.x.x/tcp/9000/... | - |
| WEBSOCKET | 可用/不可用 | /ip4/x.x.x.x/tcp/9001/ws/... | - |
| WEBRTC | 可用/不可用 | - | 错误详情 |

**状态说明**：
- ✅ 绿色"可用" - 传输层正常工作
- ❌ 红色"不可用" - 传输层启动失败或无法监听

---

## 常见配置场景

### 场景1: 家庭网络（路由器NAT）

**推荐配置**：
```
✅ WebRTC 传输: 启用
✅ WebSocket 传输: 启用
✅ TCP 传输: 启用
✅ 智能自动选择: 启用
✅ 自动检测 NAT: 启用
✅ 启用中继: 启用
```

**预期NAT类型**: Full Cone NAT 或 Restricted NAT
**主要传输**: WebRTC（通过STUN穿透）

---

### 场景2: 企业网络（严格防火墙）

**推荐配置**：
```
⚠️ WebRTC 传输: 可能被阻止，可尝试启用
✅ WebSocket 传输: 启用（主要传输）
✅ TCP 传输: 启用
❌ 智能自动选择: 可禁用，强制使用WebSocket
✅ 启用中继: 启用
```

**预期NAT类型**: Symmetric NAT
**主要传输**: WebSocket或Circuit Relay

---

### 场景3: 公网服务器（无NAT）

**推荐配置**：
```
❌ WebRTC 传输: 可禁用
❌ WebSocket 传输: 可禁用
✅ TCP 传输: 启用（性能最佳）
❌ 智能自动选择: 可禁用
❌ 启用中继: 可禁用
```

**预期NAT类型**: 无NAT（公网IP）
**主要传输**: TCP直连

---

### 场景4: 移动网络（4G/5G）

**推荐配置**：
```
✅ WebRTC 传输: 启用
✅ WebSocket 传输: 启用
✅ TCP 传输: 启用
✅ 智能自动选择: 启用
✅ 启用中继: 启用（重要！）
⚙️ 最大预留数量: 3-4个
```

**预期NAT类型**: 通常为Symmetric NAT
**主要传输**: WebSocket + Circuit Relay

---

## 故障排查

### 问题1: NAT检测失败

**症状**: 点击"重新检测"后显示"NAT检测失败"

**可能原因**：
1. 防火墙阻止UDP流量
2. STUN服务器不可达
3. 网络连接问题

**解决方案**：
1. 检查防火墙设置，允许Node.js/Electron使用UDP
2. 尝试更换STUN服务器（需修改数据库配置）
3. 检查网络连接

---

### 问题2: 所有传输层不可用

**症状**: 诊断显示所有传输层都是"不可用"

**可能原因**：
1. P2P节点未启动
2. 端口被占用
3. 依赖包缺失

**解决方案**：
1. 重启应用
2. 更改WebSocket端口（9001 → 9002）
3. 重新安装依赖：`npm install`

---

### 问题3: 中继节点列表为空

**症状**: "当前中继节点"显示"暂无中继连接"

**可能原因**：
1. Bootstrap节点不可达
2. 中继功能未启用
3. 网络隔离

**解决方案**：
1. 确保"启用中继"开关打开
2. 等待30秒-1分钟（中继发现需要时间）
3. 点击"刷新列表"按钮
4. 检查控制台日志

---

### 问题4: 诊断报告显示"错误信息"

**症状**: 某个传输层显示红色"有错误"标签

**解决方案**：
1. 将鼠标悬停在"有错误"标签上查看详细错误信息
2. 根据错误信息诊断：
   - "Address already in use" → 端口被占用，更改端口
   - "Permission denied" → 权限不足，以管理员身份运行
   - "Module not found" → 重新安装依赖

---

## 配置保存

**保存方式**：
1. 修改任何配置后，点击页面底部的"保存配置"按钮
2. 等待提示"配置保存成功"
3. **重启应用**以使配置生效

**重要提示**：
- P2P传输层配置需要重启应用才能生效
- NAT检测配置立即生效
- 中继设置需要重启应用

---

## 性能优化建议

### 1. 减少延迟
- 禁用不需要的传输层
- 在局域网环境使用TCP
- 启用"自动升级直连"

### 2. 提高成功率
- 启用所有传输层
- 启用智能自动选择
- 增加中继预留数量（3-4个）

### 3. 降低资源占用
- 仅启用必需的传输层
- 减少中继预留数量（1个）
- 延长NAT检测间隔

---

## 高级配置

### 自定义STUN服务器

目前需要通过数据库修改，未来版本会提供UI配置：

```sql
UPDATE system_settings
SET value = '["stun:your.stun.server:3478"]'
WHERE key = 'p2p.stun.servers';
```

### 完全禁用P2P

如果不需要P2P功能：

```sql
UPDATE system_settings SET value = 'false' WHERE key = 'p2p.transports.webrtc.enabled';
UPDATE system_settings SET value = 'false' WHERE key = 'p2p.transports.websocket.enabled';
UPDATE system_settings SET value = 'false' WHERE key = 'p2p.transports.tcp.enabled';
UPDATE system_settings SET value = 'false' WHERE key = 'p2p.relay.enabled';
```

---

## 监控与日志

### 查看P2P日志

打开开发者工具（F12），在Console中可以看到：
- `[P2P]` - P2P Manager日志
- `[NAT Detector]` - NAT检测日志
- `[Transport Diagnostics]` - 传输诊断日志

### 关键日志示例

```
[P2P] NAT类型: symmetric, 公网IP: 38.98.190.18
[P2P] 智能传输选择: NAT类型=symmetric
[P2P] 添加WebSocket传输（适合对称NAT）
[P2P] 添加Circuit Relay传输（通用后备）
[P2P] 启用传输层: 2 个
```

---

## 总结

P2P网络设置UI提供了完整的配置和诊断功能，适合从新手到专家的各类用户。通过合理配置，可以在各种网络环境下建立稳定的P2P连接。

**快速开始**：
1. 保持默认配置不变
2. 点击"运行完整诊断"检查网络状态
3. 根据NAT类型调整配置
4. 保存并重启应用

**获取帮助**：
- 查看开发者工具Console日志
- 运行测试脚本：`node test-p2p-nat-traversal.js`
- 查看实施总结：`P2P_NAT_IMPLEMENTATION_SUMMARY.md`
