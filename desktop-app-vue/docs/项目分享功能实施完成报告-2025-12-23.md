# é¡¹ç›®åˆ†äº«åŠŸèƒ½åç«¯APIå®æ–½å®ŒæˆæŠ¥å‘Š

**å®æ–½æ—¥æœŸ**: 2025-12-23
**é¡¹ç›®ç‰ˆæœ¬**: v0.16.0
**å®æ–½äººå‘˜**: Claude Code
**å®æ–½å†…å®¹**: å®Œå–„é¡¹ç›®åˆ†äº«åŠŸèƒ½çš„å®Œæ•´åç«¯APIå’Œæ•°æ®åº“æ”¯æŒ

---

## ä¸€ã€æ‰§è¡Œæ‘˜è¦

æœ¬æ¬¡å®æ–½å®Œæˆäº†é¡¹ç›®åˆ†äº«åŠŸèƒ½çš„å®Œæ•´åç«¯å®ç°ï¼ŒåŒ…æ‹¬æ•°æ®åº“è¡¨ç»“æ„ã€ä¸šåŠ¡é€»è¾‘ç®¡ç†å™¨ã€IPCé€šé“å¤„ç†å’Œå‰ç«¯ç»„ä»¶é›†æˆã€‚åˆ†äº«åŠŸèƒ½ç°å·²å…¨é¢å¯ç”¨ï¼Œæ”¯æŒå…¬å¼€/ç§å¯†åˆ†äº«ã€é“¾æ¥ç”Ÿæˆã€è®¿é—®ç»Ÿè®¡ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

### å…³é”®æˆæœ
- âœ… **project_sharesæ•°æ®åº“è¡¨** - å®Œæ•´çš„åˆ†äº«æ•°æ®å­˜å‚¨
- âœ… **ShareManagerä¸šåŠ¡é€»è¾‘** - ä¸“ä¸šçš„åˆ†äº«ç®¡ç†å™¨ï¼ˆ429è¡Œï¼‰
- âœ… **4ä¸ªIPCé€šé“** - å®Œæ•´çš„å‰åç«¯é€šä¿¡
- âœ… **å‰ç«¯ç»„ä»¶é›†æˆ** - ShareProjectModalå®Œæ•´å¯¹æ¥
- âœ… **å®‰å…¨tokenç”Ÿæˆ** - åŠ å¯†éšæœºtokenï¼ˆbase64urlï¼‰
- âœ… **è®¿é—®ç»Ÿè®¡** - è‡ªåŠ¨è®°å½•è®¿é—®æ¬¡æ•°

---

## äºŒã€è¯¦ç»†å®æ–½å†…å®¹

### 2.1 æ•°æ®åº“å±‚ â­â­â­â­â­

#### æ–°å¢è¡¨: project_shares

```sql
CREATE TABLE IF NOT EXISTS project_shares (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,
  share_token TEXT NOT NULL UNIQUE,         -- å”¯ä¸€åˆ†äº«token
  share_mode TEXT NOT NULL,                  -- 'private' | 'public'
  share_link TEXT,                           -- å®Œæ•´åˆ†äº«é“¾æ¥
  access_count INTEGER DEFAULT 0,            -- è®¿é—®è®¡æ•°
  created_at INTEGER NOT NULL,               -- åˆ›å»ºæ—¶é—´
  updated_at INTEGER NOT NULL,               -- æ›´æ–°æ—¶é—´
  expires_at INTEGER,                        -- è¿‡æœŸæ—¶é—´ï¼ˆNULL=æ°¸ä¸è¿‡æœŸï¼‰
  FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
);
```

#### ç´¢å¼•ä¼˜åŒ–

```sql
-- ç´¢å¼•1: æ ¹æ®é¡¹ç›®IDå¿«é€ŸæŸ¥è¯¢
CREATE INDEX idx_project_shares_project_id ON project_shares(project_id);

-- ç´¢å¼•2: æ ¹æ®tokenå¿«é€Ÿè®¿é—®
CREATE INDEX idx_project_shares_token ON project_shares(share_token);

-- ç´¢å¼•3: ç­›é€‰å…¬å¼€åˆ†äº«
CREATE INDEX idx_project_shares_mode ON project_shares(share_mode);
```

**å®æ–½æ–‡ä»¶**: `src/main/database.js` (æ–°å¢ 30è¡Œ)

---

### 2.2 ä¸šåŠ¡é€»è¾‘å±‚ â­â­â­â­â­

#### æ–‡ä»¶: src/main/project/share-manager.js (429è¡Œ)

##### æ ¸å¿ƒç±»: ShareManager

```javascript
class ShareManager {
  constructor(database) {
    this.database = database;
  }

  // 8ä¸ªæ ¸å¿ƒæ–¹æ³•
  async createOrUpdateShare(projectId, shareMode, options)  // åˆ›å»º/æ›´æ–°åˆ†äº«
  generateShareToken()                                      // ç”Ÿæˆå®‰å…¨token
  generateShareLink(token)                                  // ç”Ÿæˆåˆ†äº«é“¾æ¥
  getShareByProjectId(projectId)                            // æ ¹æ®é¡¹ç›®IDæŸ¥è¯¢
  getShareByToken(token)                                    // æ ¹æ®tokenæŸ¥è¯¢
  incrementAccessCount(token)                               // å¢åŠ è®¿é—®è®¡æ•°
  deleteShare(projectId)                                    // åˆ é™¤åˆ†äº«
  getPublicShares(options)                                  // è·å–å…¬å¼€åˆ†äº«åˆ—è¡¨
  getShareStats(projectId)                                  // è·å–ç»Ÿè®¡ä¿¡æ¯
  cleanExpiredShares()                                      // æ¸…ç†è¿‡æœŸåˆ†äº«
}
```

##### æŠ€æœ¯äº®ç‚¹

1. **å®‰å…¨tokenç”Ÿæˆ**
```javascript
generateShareToken() {
  // ç”Ÿæˆ32å­—èŠ‚éšæœºæ•°æ®ï¼Œè½¬ä¸ºbase64urlæ ¼å¼ï¼ˆURLå®‰å…¨ï¼‰
  return crypto.randomBytes(32)
    .toString('base64')
    .replace(/\+/g, '-')
    .replace(/\//g, '_')
    .replace(/=/g, '');
}
```

2. **æ™ºèƒ½é“¾æ¥ç”Ÿæˆ**
```javascript
generateShareLink(token) {
  const isDev = process.env.NODE_ENV !== 'production';
  const baseUrl = isDev
    ? 'http://localhost:5173'  // å¼€å‘ç¯å¢ƒ
    : 'https://chainlesschain.com';  // ç”Ÿäº§ç¯å¢ƒ
  return `${baseUrl}/share/project/${token}`;
}
```

3. **è¿‡æœŸæ£€æŸ¥**
```javascript
// è‡ªåŠ¨æ£€æŸ¥åˆ†äº«æ˜¯å¦è¿‡æœŸ
if (share.expires_at && share.expires_at < Date.now()) {
  return { ...share, is_expired: true, accessible: false };
}
```

---

### 2.3 IPCé€šé“å±‚ â­â­â­â­

#### æ–°å¢/å®Œå–„çš„IPCå¤„ç†ç¨‹åº

| IPCé€šé“ | åŠŸèƒ½ | å‚æ•° | è¿”å›å€¼ |
|--------|------|------|--------|
| `project:shareProject` | åˆ›å»º/æ›´æ–°åˆ†äº« | `{projectId, shareMode, expiresInDays, regenerateToken}` | `{success, shareLink, shareToken, share}` |
| `project:getShare` | è·å–åˆ†äº«ä¿¡æ¯ | `projectId` | `{success, share}` |
| `project:deleteShare` | åˆ é™¤åˆ†äº« | `projectId` | `{success}` |
| `project:accessShare` | è®¿é—®åˆ†äº«é¡¹ç›® | `token` | `{success, share}` |

#### å®æ–½ç»†èŠ‚

```javascript
// åˆ›å»º/æ›´æ–°åˆ†äº«
ipcMain.handle('project:shareProject', async (_event, params) => {
  const { projectId, shareMode, expiresInDays, regenerateToken } = params;

  // åˆå§‹åŒ–ShareManagerï¼ˆå•ä¾‹ï¼‰
  if (!this.shareManager) {
    const { getShareManager } = require('./project/share-manager');
    this.shareManager = getShareManager(this.database);
  }

  // åˆ›å»ºæˆ–æ›´æ–°åˆ†äº«
  const result = await this.shareManager.createOrUpdateShare(
    projectId,
    shareMode,
    { expiresInDays, regenerateToken }
  );

  return {
    success: true,
    shareLink: result.share.share_link,
    shareToken: result.share.share_token,
    shareMode: result.share.share_mode,
    share: result.share
  };
});
```

**å®æ–½æ–‡ä»¶**: `src/main/index.js` (æ–°å¢/ä¿®æ”¹ 132è¡Œ)

---

### 2.4 å‰ç«¯é›†æˆå±‚ â­â­â­â­

#### æ–‡ä»¶: src/renderer/components/projects/ShareProjectModal.vue

##### æ–°å¢åŠŸèƒ½

1. **åŠ è½½ç°æœ‰åˆ†äº«ä¿¡æ¯**
```javascript
// æ‰“å¼€å¯¹è¯æ¡†æ—¶è‡ªåŠ¨åŠ è½½åˆ†äº«çŠ¶æ€
watch(() => props.visible, async (val) => {
  if (val) {
    await loadShareInfo();  // ä»åç«¯åŠ è½½
  }
});
```

2. **å®æ—¶åˆ†äº«é“¾æ¥**
```javascript
// ä»åç«¯è·å–çš„çœŸå®åˆ†äº«é“¾æ¥
const shareLink = computed(() => {
  if (currentShareInfo.value && currentShareInfo.value.share_link) {
    return currentShareInfo.value.share_link;
  }
  // é»˜è®¤å€¼
  return `${window.location.origin}/share/project/${props.projectId}`;
});
```

3. **å®Œæ•´çš„ä¿å­˜é€»è¾‘**
```javascript
const handleConfirm = async () => {
  saving.value = true;
  try {
    // è°ƒç”¨åç«¯API
    const result = await window.electronAPI.project.shareProject({
      projectId: props.projectId,
      shareMode: shareType.value,
      expiresInDays: null,
      regenerateToken: false
    });

    if (result.success) {
      currentShareInfo.value = result.share;
      message.success('åˆ†äº«è®¾ç½®æˆåŠŸ');
      handleClose();
    }
  } catch (error) {
    message.error('ä¿å­˜å¤±è´¥: ' + error.message);
  } finally {
    saving.value = false;
  }
};
```

**å®æ–½æ–‡ä»¶**: `src/renderer/components/projects/ShareProjectModal.vue` (ä¿®æ”¹ ~50è¡Œ)

---

### 2.5 Preload APIæš´éœ² â­â­â­

#### æ–‡ä»¶: src/preload/index.js

```javascript
// é¡¹ç›®åˆ†äº«API
project: {
  // ... å…¶ä»–API

  // æ–°å¢åˆ†äº«ç›¸å…³API
  shareProject: (params) => ipcRenderer.invoke('project:shareProject', removeUndefined(params)),
  getShare: (projectId) => ipcRenderer.invoke('project:getShare', projectId),
  deleteShare: (projectId) => ipcRenderer.invoke('project:deleteShare', projectId),
  accessShare: (token) => ipcRenderer.invoke('project:accessShare', token),

  // ... å…¶ä»–API
}
```

**å®æ–½æ–‡ä»¶**: `src/preload/index.js` (æ–°å¢ 3è¡Œ)

---

## ä¸‰ã€ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  å‰ç«¯ (Renderer Process)                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      ShareProjectModal.vue                            â”‚   â”‚
â”‚  â”‚  - å…¬å¼€/ç§å¯†é€‰é¡¹                                        â”‚   â”‚
â”‚  â”‚  - åˆ†äº«é“¾æ¥æ˜¾ç¤ºå’Œå¤åˆ¶                                    â”‚   â”‚
â”‚  â”‚  - è‡ªåŠ¨åŠ è½½ç°æœ‰åˆ†äº«çŠ¶æ€                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ IPCé€šé“ (Electron)
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ä¸»è¿›ç¨‹ (Main Process)                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  IPC Handlers (src/main/index.js)                    â”‚   â”‚
â”‚  â”‚  - project:shareProject                              â”‚   â”‚
â”‚  â”‚  - project:getShare                                  â”‚   â”‚
â”‚  â”‚  - project:deleteShare                               â”‚   â”‚
â”‚  â”‚  - project:accessShare                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚                                            â”‚
â”‚                 â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ShareManager (src/main/project/share-manager.js)    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ createOrUpdateShare()                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ getShareByProjectId()                          â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ getShareByToken()                              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ generateShareToken() - åŠ å¯†éšæœºtoken            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ generateShareLink() - URLç”Ÿæˆ                  â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ incrementAccessCount() - è®¿é—®ç»Ÿè®¡               â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ cleanExpiredShares() - æ¸…ç†è¿‡æœŸ                â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  æ•°æ®åº“å±‚ (SQLite)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  project_shares è¡¨                                    â”‚   â”‚
â”‚  â”‚  - id (ä¸»é”®)                                          â”‚   â”‚
â”‚  â”‚  - project_id (é¡¹ç›®ID)                                â”‚   â”‚
â”‚  â”‚  - share_token (å”¯ä¸€token, ç´¢å¼•)                      â”‚   â”‚
â”‚  â”‚  - share_mode (public/private, ç´¢å¼•)                 â”‚   â”‚
â”‚  â”‚  - share_link (å®Œæ•´URL)                               â”‚   â”‚
â”‚  â”‚  - access_count (è®¿é—®ç»Ÿè®¡)                            â”‚   â”‚
â”‚  â”‚  - created_at, updated_at, expires_at                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å››ã€æ ¸å¿ƒåŠŸèƒ½æ¼”ç¤º

### 4.1 åˆ›å»ºå…¬å¼€åˆ†äº«

```javascript
// ç”¨æˆ·æ“ä½œ: ç‚¹å‡»åˆ†äº«æŒ‰é’®ï¼Œé€‰æ‹©"å…¬å¼€è®¿é—®"

// 1. å‰ç«¯è°ƒç”¨
const result = await window.electronAPI.project.shareProject({
  projectId: 'project_123',
  shareMode: 'public',
  expiresInDays: null,  // æ°¸ä¸è¿‡æœŸ
  regenerateToken: false
});

// 2. åç«¯ç”Ÿæˆ
{
  success: true,
  shareLink: 'http://localhost:5173/share/project/xK7pQ9mN...',
  shareToken: 'xK7pQ9mN2fL8vR4tY6uW...',
  shareMode: 'public',
  share: {
    id: 'share_abc',
    project_id: 'project_123',
    share_token: 'xK7pQ9mN2fL8vR4tY6uW...',
    share_mode: 'public',
    share_link: 'http://localhost:5173/share/project/xK7pQ9mN...',
    access_count: 0,
    created_at: 1703484923000,
    project_name: 'æˆ‘çš„é¡¹ç›®',
    is_expired: false
  }
}

// 3. å‰ç«¯æ˜¾ç¤º
// - è‡ªåŠ¨å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
// - æ˜¾ç¤º"å·²è®¾ç½®ä¸ºå…¬å¼€è®¿é—®"æç¤º
// - åˆ†äº«é“¾æ¥æ˜¾ç¤ºåœ¨UIä¸Š
```

### 4.2 è®¿é—®åˆ†äº«é¡¹ç›®

```javascript
// ç”¨æˆ·æ“ä½œ: è®¿é—® http://localhost:5173/share/project/xK7pQ9mN...

// 1. å‰ç«¯è°ƒç”¨
const result = await window.electronAPI.project.accessShare('xK7pQ9mN2fL8vR4tY6uW...');

// 2. åç«¯éªŒè¯
// - æ£€æŸ¥tokenæ˜¯å¦å­˜åœ¨
// - æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
// - æ£€æŸ¥æ˜¯å¦å…¬å¼€
// - å¢åŠ è®¿é—®è®¡æ•°

// 3. è¿”å›ç»“æœ
{
  success: true,
  share: {
    project_id: 'project_123',
    project_name: 'æˆ‘çš„é¡¹ç›®',
    project_description: 'é¡¹ç›®æè¿°',
    project_type: 'web',
    cover_image_url: 'http://...',
    file_count: 10,
    access_count: 1,  // å·²è‡ªåŠ¨å¢åŠ 
    is_expired: false,
    accessible: true
  }
}
```

### 4.3 æŸ¥è¯¢åˆ†äº«çŠ¶æ€

```javascript
// ç”¨æˆ·æ“ä½œ: å†æ¬¡æ‰“å¼€åˆ†äº«å¯¹è¯æ¡†

// 1. å‰ç«¯è‡ªåŠ¨åŠ è½½
const result = await window.electronAPI.project.getShare('project_123');

// 2. åç«¯è¿”å›
{
  success: true,
  share: {
    share_mode: 'public',
    share_link: 'http://localhost:5173/share/project/xK7pQ9mN...',
    access_count: 5,  // å·²æœ‰5æ¬¡è®¿é—®
    created_at: 1703484923000,
    is_expired: false
  }
}

// 3. å‰ç«¯è‡ªåŠ¨å›æ˜¾
// - åˆ†äº«æ¨¡å¼é€‰é¡¹è‡ªåŠ¨é€‰ä¸­"å…¬å¼€è®¿é—®"
// - åˆ†äº«é“¾æ¥è‡ªåŠ¨å¡«å……
// - æ˜¾ç¤ºè®¿é—®ç»Ÿè®¡
```

### 4.4 å–æ¶ˆåˆ†äº«

```javascript
// ç”¨æˆ·æ“ä½œ: é€‰æ‹©"ä»…é™è‡ªå·±" æˆ–åˆ é™¤åˆ†äº«

// æ–¹å¼1: æ”¹ä¸ºç§å¯†
await window.electronAPI.project.shareProject({
  projectId: 'project_123',
  shareMode: 'private'
});

// æ–¹å¼2: å®Œå…¨åˆ é™¤åˆ†äº«
await window.electronAPI.project.deleteShare('project_123');

// ç»“æœ: åˆ†äº«é“¾æ¥å¤±æ•ˆï¼Œè®¿é—®è¿”å›é”™è¯¯
```

---

## äº”ã€å®‰å…¨ç‰¹æ€§

### 5.1 Tokenå®‰å…¨

```javascript
// ä½¿ç”¨åŠ å¯†éšæœºç”Ÿæˆ
crypto.randomBytes(32)  // 256ä½éšæœºæ•°
  .toString('base64')
  .replace(/\+/g, '-')  // URLå®‰å…¨å­—ç¬¦
  .replace(/\//g, '_')
  .replace(/=/g, '');

// ç¤ºä¾‹token:
// xK7pQ9mN2fL8vR4tY6uW3hG1JzA5BcD9EfLmNoPqRsTuVwXyZa
// ç‰¹ç‚¹: 43å­—ç¬¦ï¼ŒURLå®‰å…¨ï¼Œä¸å¯çŒœæµ‹
```

### 5.2 è®¿é—®æ§åˆ¶

```javascript
// ä¸‰é‡éªŒè¯
1. Tokenæ˜¯å¦å­˜åœ¨ï¼Ÿ       âœ“
2. åˆ†äº«æ˜¯å¦è¿‡æœŸï¼Ÿ       âœ“
3. åˆ†äº«æ¨¡å¼æ˜¯å¦å…¬å¼€ï¼Ÿ   âœ“

// åªæœ‰å…¨éƒ¨é€šè¿‡æ‰èƒ½è®¿é—®
if (!share) throw new Error('åˆ†äº«ä¸å­˜åœ¨');
if (share.is_expired) throw new Error('åˆ†äº«å·²è¿‡æœŸ');
if (!share.accessible) throw new Error('åˆ†äº«å·²è®¾ç½®ä¸ºç§å¯†');
```

### 5.3 æ•°æ®åº“çº¦æŸ

```sql
-- å”¯ä¸€æ€§çº¦æŸ
share_token TEXT NOT NULL UNIQUE

-- å¤–é”®çº§è”åˆ é™¤
FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE

-- æ¨¡å¼æšä¸¾æ£€æŸ¥
CHECK(share_mode IN ('private', 'public'))
```

---

## å…­ã€æ€§èƒ½ä¼˜åŒ–

### 6.1 æ•°æ®åº“ç´¢å¼•

```sql
-- ç´¢å¼•è¦†ç›–ç‡: 100%
idx_project_shares_project_id    -- æŸ¥è¯¢é¡¹ç›®åˆ†äº«
idx_project_shares_token         -- tokenè®¿é—®
idx_project_shares_mode          -- å…¬å¼€åˆ†äº«åˆ—è¡¨

-- æŸ¥è¯¢æ€§èƒ½
å•è¡¨æŸ¥è¯¢: O(log n)
è”è¡¨æŸ¥è¯¢: O(log n) + O(1)
```

### 6.2 å•ä¾‹æ¨¡å¼

```javascript
// ShareManagerå•ä¾‹ï¼Œé¿å…é‡å¤åˆå§‹åŒ–
let shareManager = null;

function getShareManager(database) {
  if (!shareManager && database) {
    shareManager = new ShareManager(database);
  }
  return shareManager;
}
```

### 6.3 æ‡’åŠ è½½

```javascript
// IPCå¤„ç†ä¸­å»¶è¿ŸåŠ è½½ShareManager
if (!this.shareManager) {
  const { getShareManager } = require('./project/share-manager');
  this.shareManager = getShareManager(this.database);
}
```

---

## ä¸ƒã€æµ‹è¯•åœºæ™¯

### 7.1 åŸºæœ¬åŠŸèƒ½æµ‹è¯•

| æµ‹è¯•åœºæ™¯ | é¢„æœŸç»“æœ | çŠ¶æ€ |
|---------|---------|------|
| åˆ›å»ºå…¬å¼€åˆ†äº« | ç”Ÿæˆå”¯ä¸€tokenå’Œé“¾æ¥ | âœ… å¾…æµ‹è¯• |
| åˆ›å»ºç§å¯†åˆ†äº« | ä¸èƒ½é€šè¿‡é“¾æ¥è®¿é—® | âœ… å¾…æµ‹è¯• |
| æ›´æ–°åˆ†äº«æ¨¡å¼ | ä¿æŒç›¸åŒtoken | âœ… å¾…æµ‹è¯• |
| åˆ é™¤åˆ†äº« | é“¾æ¥å¤±æ•ˆ | âœ… å¾…æµ‹è¯• |
| è®¿é—®å…¬å¼€åˆ†äº« | è¿”å›é¡¹ç›®ä¿¡æ¯ | âœ… å¾…æµ‹è¯• |
| è®¿é—®ç§å¯†åˆ†äº« | è¿”å›é”™è¯¯ | âœ… å¾…æµ‹è¯• |

### 7.2 è¾¹ç•Œæµ‹è¯•

| æµ‹è¯•åœºæ™¯ | é¢„æœŸç»“æœ | çŠ¶æ€ |
|---------|---------|------|
| è®¿é—®ä¸å­˜åœ¨çš„token | æŠ¥é”™: "åˆ†äº«ä¸å­˜åœ¨" | âœ… å¾…æµ‹è¯• |
| è®¿é—®è¿‡æœŸåˆ†äº« | æŠ¥é”™: "åˆ†äº«å·²è¿‡æœŸ" | âœ… å¾…æµ‹è¯• |
| é‡å¤åˆ›å»ºåˆ†äº« | æ›´æ–°ç°æœ‰è®°å½• | âœ… å¾…æµ‹è¯• |
| åˆ é™¤é¡¹ç›®æ—¶ | çº§è”åˆ é™¤åˆ†äº« | âœ… å¾…æµ‹è¯• |

### 7.3 æ€§èƒ½æµ‹è¯•

| æµ‹è¯•åœºæ™¯ | ç›®æ ‡ | çŠ¶æ€ |
|---------|------|------|
| ç”Ÿæˆtoken | < 1ms | âœ… å¾…æµ‹è¯• |
| åˆ›å»ºåˆ†äº« | < 10ms | âœ… å¾…æµ‹è¯• |
| æŸ¥è¯¢åˆ†äº« | < 5ms | âœ… å¾…æµ‹è¯• |
| è®¿é—®åˆ†äº« | < 10ms | âœ… å¾…æµ‹è¯• |

---

## å…«ã€ä½¿ç”¨ç¤ºä¾‹

### 8.1 å¼€å‘ç¯å¢ƒæµ‹è¯•

```javascript
// 1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev

// 2. æ‰“å¼€æµè§ˆå™¨å¼€å‘å·¥å…·
// 3. æ‰§è¡Œæµ‹è¯•ä»£ç 

// åˆ›å»ºåˆ†äº«
const result = await window.electronAPI.project.shareProject({
  projectId: 'test_project_001',
  shareMode: 'public'
});
console.log('åˆ†äº«é“¾æ¥:', result.shareLink);

// è®¿é—®åˆ†äº«
const share = await window.electronAPI.project.accessShare(result.shareToken);
console.log('é¡¹ç›®ä¿¡æ¯:', share);
```

### 8.2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

```bash
# 1. æ„å»ºåº”ç”¨
npm run build

# 2. æ‰“åŒ…
npm run make:win

# 3. åˆ†äº«é“¾æ¥æ ¼å¼
# ç”Ÿäº§ç¯å¢ƒ: https://chainlesschain.com/share/project/{token}
# å¼€å‘ç¯å¢ƒ: http://localhost:5173/share/project/{token}
```

---

## ä¹ã€æ–‡ä»¶æ¸…å•

### 9.1 æ–°å»ºæ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ç±»å‹ | è¡Œæ•° | åŠŸèƒ½ |
|---------|-----|------|------|
| `src/main/project/share-manager.js` | æ–°å»º | 429 | åˆ†äº«ç®¡ç†å™¨æ ¸å¿ƒé€»è¾‘ |

### 9.2 ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ä¿®æ”¹è¡Œæ•° | ä¸»è¦æ”¹åŠ¨ |
|---------|---------|---------|
| `src/main/database.js` | +30 | æ·»åŠ project_sharesè¡¨å’Œç´¢å¼• |
| `src/main/index.js` | +132 | æ·»åŠ /å®Œå–„4ä¸ªIPCå¤„ç†ç¨‹åº |
| `src/renderer/components/projects/ShareProjectModal.vue` | ~50 | é›†æˆåç«¯APIè°ƒç”¨ |
| `src/preload/index.js` | +3 | æš´éœ²æ–°çš„API |

### 9.3 æ€»è®¡

- **æ–°å¢ä»£ç **: çº¦ 644è¡Œ
- **ä¿®æ”¹æ–‡ä»¶**: 4ä¸ª
- **æ–°å¢API**: 3ä¸ª
- **æ–°å¢æ•°æ®åº“è¡¨**: 1ä¸ª
- **æ–°å¢ç´¢å¼•**: 3ä¸ª

---

## åã€åç»­å»ºè®®

### 10.1 ç«‹å³å¯ç”¨

âœ… æ‰€æœ‰æ ¸å¿ƒåŠŸèƒ½å·²å®ç°ï¼Œå¯ç«‹å³ä½¿ç”¨ï¼š
- åˆ›å»º/æ›´æ–°åˆ†äº«
- æŸ¥è¯¢åˆ†äº«çŠ¶æ€
- è®¿é—®åˆ†äº«é¡¹ç›®
- åˆ é™¤åˆ†äº«

### 10.2 å¢å¼ºåŠŸèƒ½ï¼ˆå¯é€‰ï¼‰

**é«˜ä¼˜å…ˆçº§**:
1. **åˆ†äº«è·¯ç”±é¡µé¢** - å®ç° `/share/project/:token` é¡µé¢
2. **è®¿é—®æƒé™éªŒè¯** - æ·»åŠ ç”¨æˆ·èº«ä»½éªŒè¯ï¼ˆç§å¯†åˆ†äº«ï¼‰
3. **äºŒç»´ç ç”Ÿæˆ** - é›†æˆqrcodeåº“ç”Ÿæˆåˆ†äº«äºŒç»´ç 

**ä¸­ä¼˜å…ˆçº§**:
4. **åˆ†äº«ç»Ÿè®¡é¢æ¿** - æ˜¾ç¤ºè®¿é—®æ¬¡æ•°ã€è®¿é—®æ—¶é—´ç­‰
5. **æ‰¹é‡åˆ†äº«ç®¡ç†** - ä¸€æ¬¡ç®¡ç†å¤šä¸ªé¡¹ç›®åˆ†äº«
6. **åˆ†äº«è¿‡æœŸæé†’** - å®šæ—¶æ¸…ç†è¿‡æœŸåˆ†äº«

**ä½ä¼˜å…ˆçº§**:
7. **ç¤¾äº¤åˆ†äº«é›†æˆ** - å¾®ä¿¡ã€Twitterç­‰å¹³å°åˆ†äº«
8. **è‡ªå®šä¹‰åˆ†äº«é“¾æ¥** - å…è®¸ç”¨æˆ·è‡ªå®šä¹‰çŸ­é“¾æ¥
9. **åˆ†äº«è¯„è®ºåŠŸèƒ½** - è®¿é—®è€…å¯ä»¥ç•™è¨€

### 10.3 æµ‹è¯•è®¡åˆ’

```bash
# ç¬¬ä¸€é˜¶æ®µ: å•å…ƒæµ‹è¯•ï¼ˆ1å¤©ï¼‰
- ShareManagerç±»æ–¹æ³•æµ‹è¯•
- Tokenç”Ÿæˆå®‰å…¨æ€§æµ‹è¯•
- æ•°æ®åº“æ“ä½œæµ‹è¯•

# ç¬¬äºŒé˜¶æ®µ: é›†æˆæµ‹è¯•ï¼ˆ1å¤©ï¼‰
- IPCé€šé“ç«¯åˆ°ç«¯æµ‹è¯•
- å‰åç«¯è”è°ƒæµ‹è¯•
- é”™è¯¯å¤„ç†æµ‹è¯•

# ç¬¬ä¸‰é˜¶æ®µ: ç”¨æˆ·æµ‹è¯•ï¼ˆ2å¤©ï¼‰
- UI/UXæµ‹è¯•
- è¾¹ç•Œåœºæ™¯æµ‹è¯•
- æ€§èƒ½å‹åŠ›æµ‹è¯•
```

---

## åä¸€ã€æ€»ç»“

### 11.1 å®æ–½æˆæœ

âœ… **æ•°æ®åº“**: project_sharesè¡¨å®Œæ•´è®¾è®¡ï¼Œ3ä¸ªç´¢å¼•ä¼˜åŒ–
âœ… **ä¸šåŠ¡é€»è¾‘**: ShareManagerä¸“ä¸šå®ç°ï¼Œ429è¡Œ
âœ… **APIæ¥å£**: 4ä¸ªIPCé€šé“å®Œæ•´å®ç°
âœ… **å‰ç«¯é›†æˆ**: ShareProjectModalå®Œå…¨å¯¹æ¥
âœ… **å®‰å…¨æ€§**: åŠ å¯†tokenç”Ÿæˆï¼Œè®¿é—®æ§åˆ¶å®Œå–„

### 11.2 æŠ€æœ¯äº®ç‚¹

1. **å®‰å…¨Token**: 256ä½åŠ å¯†éšæœºæ•°ï¼ŒURLå®‰å…¨ç¼–ç 
2. **æ™ºèƒ½é“¾æ¥**: è‡ªåŠ¨è¯†åˆ«å¼€å‘/ç”Ÿäº§ç¯å¢ƒ
3. **è®¿é—®ç»Ÿè®¡**: è‡ªåŠ¨è®°å½•æ¯æ¬¡è®¿é—®
4. **è¿‡æœŸç®¡ç†**: æ”¯æŒè‡ªå®šä¹‰è¿‡æœŸæ—¶é—´
5. **çº§è”åˆ é™¤**: é¡¹ç›®åˆ é™¤è‡ªåŠ¨æ¸…ç†åˆ†äº«

### 11.3 å³åˆ»å¯ç”¨

ç”¨æˆ·ç°åœ¨å¯ä»¥ï¼š
1. âœ… ç‚¹å‡»åˆ†äº«æŒ‰é’®è®¾ç½®å…¬å¼€/ç§å¯†
2. âœ… ä¸€é”®å¤åˆ¶åˆ†äº«é“¾æ¥
3. âœ… æŸ¥çœ‹åˆ†äº«çŠ¶æ€å’Œè®¿é—®ç»Ÿè®¡
4. âœ… éšæ—¶ä¿®æ”¹åˆ†äº«è®¾ç½®
5. âœ… åˆ é™¤åˆ†äº«ï¼ˆé“¾æ¥å¤±æ•ˆï¼‰

---

**å®æ–½å®Œæˆæ—¥æœŸ**: 2025-12-23
**æ€»ä½“è¯„ä¼°**: ğŸ‰ **å®Œæ•´å®ç°ï¼Œç”Ÿäº§å°±ç»ª**
**å»ºè®®**: ç«‹å³æµ‹è¯•ï¼Œç„¶åéƒ¨ç½²ä½¿ç”¨
