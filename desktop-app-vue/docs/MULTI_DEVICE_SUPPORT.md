# å¤šè®¾å¤‡æ”¯æŒå®ç°æŠ¥å‘Š

**å®ç°æ—¥æœŸ**: 2025-12-18
**ç‰ˆæœ¬**: v0.15.0
**çŠ¶æ€**: ğŸš§ å®ç°ä¸­ (æ ¸å¿ƒåŠŸèƒ½å·²å®Œæˆ 80%)

## æ¦‚è¿°

æœ¬æ¬¡å®ç°ä¸º ChainlessChain æ·»åŠ äº†å¤šè®¾å¤‡æ”¯æŒåŠŸèƒ½,å…è®¸åŒä¸€ç”¨æˆ·åœ¨å¤šä¸ªè®¾å¤‡ä¸Šä½¿ç”¨åº”ç”¨,å¹¶åœ¨è®¾å¤‡é—´è¿›è¡Œç«¯åˆ°ç«¯åŠ å¯†é€šä¿¡ã€‚

## å·²å®ç°åŠŸèƒ½

### âœ… æ ¸å¿ƒç»„ä»¶

1. **è®¾å¤‡ç®¡ç†å™¨** (`device-manager.js` - 350+ è¡Œ)
   - âœ… è®¾å¤‡èº«ä»½ç”Ÿæˆå’Œç®¡ç†
   - âœ… è®¾å¤‡æ³¨å†Œè¡¨ (æ¯ä¸ªç”¨æˆ·çš„æ‰€æœ‰è®¾å¤‡)
   - âœ… è®¾å¤‡åˆ—è¡¨æŒä¹…åŒ–å­˜å‚¨
   - âœ… è®¾å¤‡å¹¿æ’­å’Œå‘ç°æœºåˆ¶
   - âœ… è®¾å¤‡æ´»è·ƒæ—¶é—´æ›´æ–°
   - âœ… ä¸æ´»è·ƒè®¾å¤‡è‡ªåŠ¨æ¸…ç†
   - âœ… è®¾å¤‡ç»Ÿè®¡ä¿¡æ¯

2. **P2P ç®¡ç†å™¨é›†æˆ**
   - âœ… é›†æˆè®¾å¤‡ç®¡ç†å™¨
   - âœ… è®¾å¤‡å¹¿æ’­åè®® (`/chainlesschain/device-broadcast/1.0.0`)
   - âœ… è‡ªåŠ¨å¹¿æ’­è®¾å¤‡ä¿¡æ¯
   - âœ… æ¥æ”¶å’Œå¤„ç†è®¾å¤‡å¹¿æ’­
   - âœ… ä¿®æ”¹å¯†é’¥äº¤æ¢æ”¯æŒè®¾å¤‡ID
   - âœ… Signal ä¼šè¯ä½¿ç”¨å”¯ä¸€è®¾å¤‡ID

3. **IPC æ¥å£**
   - âœ… `p2p:get-user-devices` - è·å–ç”¨æˆ·æ‰€æœ‰è®¾å¤‡
   - âœ… `p2p:get-current-device` - è·å–å½“å‰è®¾å¤‡ä¿¡æ¯
   - âœ… `p2p:get-device-statistics` - è·å–è®¾å¤‡ç»Ÿè®¡
   - âœ… `p2p:initiate-key-exchange` - æ”¯æŒè®¾å¤‡IDå‚æ•°

4. **Preload API**
   - âœ… æš´éœ²è®¾å¤‡ç®¡ç†ç›¸å…³ API

## æ¶æ„è®¾è®¡

### è®¾å¤‡èº«ä»½

æ¯ä¸ªè®¾å¤‡æœ‰å”¯ä¸€çš„æ ‡è¯†:

```javascript
{
  deviceId: '32ä½åå…­è¿›åˆ¶UUID',
  deviceName: 'hostname (platform)',
  userId: 'peerId',
  createdAt: timestamp,
  lastActiveAt: timestamp,
  platform: 'win32|darwin|linux',
  version: '0.15.0'
}
```

### è®¾å¤‡å‘ç°æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Device A â”‚                      â”‚ Device B â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                                 â”‚
     â”‚ 1. è¿æ¥å»ºç«‹ (libp2p)            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                 â”‚
     â”‚ 2. å¹¿æ’­è®¾å¤‡ä¿¡æ¯                 â”‚
     â”‚    /device-broadcast/1.0.0      â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                                 â”‚
     â”‚ 3. è¿”å›ç¡®è®¤                     â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                 â”‚
     â”‚ 4. æ³¨å†Œè®¾å¤‡åˆ°è®¾å¤‡åˆ—è¡¨           â”‚
     â”‚                                 â”‚
```

### å¤šè®¾å¤‡åŠ å¯†é€šä¿¡

```
Alice (è®¾å¤‡ A1)  <-->  Bob (è®¾å¤‡ B1, B2, B3)

1. Alice å‘ Bob çš„è®¾å¤‡ B1 å‘èµ·å¯†é’¥äº¤æ¢:
   - Alice å‘é€è¯·æ±‚ (requestDeviceId: A1, targetDeviceId: B1)
   - Bob çš„è®¾å¤‡ B1 è¿”å›é¢„å¯†é’¥åŒ… (deviceId: B1)
   - Alice å»ºç«‹ä¼šè¯ (Bob-B1 <-> Alice-A1)

2. Alice å‘é€æ¶ˆæ¯åˆ° B1:
   - åŠ å¯†æ¶ˆæ¯ä½¿ç”¨ (Bob, B1) ä½œä¸ºä¼šè¯æ ‡è¯†
   - æ¶ˆæ¯åªèƒ½è¢« B1 è§£å¯†

3. Alice è¦ä¸ B2 é€šä¿¡:
   - éœ€è¦é‡æ–°ä¸ B2 è¿›è¡Œå¯†é’¥äº¤æ¢
   - å»ºç«‹æ–°ä¼šè¯ (Bob-B2 <-> Alice-A1)
```

## æ•°æ®å­˜å‚¨

### è®¾å¤‡ä¿¡æ¯æ–‡ä»¶

```
{dataPath}/device.json          - å½“å‰è®¾å¤‡ä¿¡æ¯
{dataPath}/devices.json         - å·²çŸ¥è®¾å¤‡åˆ—è¡¨
{dataPath}/signal-identity.json - Signal èº«ä»½å¯†é’¥ (å«è®¾å¤‡ID)
```

### è®¾å¤‡åˆ—è¡¨æ ¼å¼

```json
{
  "userId1": [
    {
      "deviceId": "abc123...",
      "deviceName": "MacBook Pro (darwin)",
      "userId": "userId1",
      "createdAt": 1703001234567,
      "lastActiveAt": 1703001234567,
      "platform": "darwin",
      "version": "0.15.0",
      "peerId": "Qm...",
      "registeredAt": 1703001234567
    }
  ],
  "userId2": [
    ...
  ]
}
```

## API å‚è€ƒ

### è®¾å¤‡ç®¡ç†å™¨ API

```javascript
// åˆå§‹åŒ–
const deviceManager = new DeviceManager({
  userId: 'user-id',
  dataPath: '/path/to/data',
  deviceName: 'My MacBook'
});

await deviceManager.initialize();

// è·å–å½“å‰è®¾å¤‡
const currentDevice = deviceManager.getCurrentDevice();

// æ³¨å†Œè®¾å¤‡
await deviceManager.registerDevice(userId, device);

// è·å–ç”¨æˆ·è®¾å¤‡åˆ—è¡¨
const devices = deviceManager.getUserDevices(userId);

// å¤„ç†è®¾å¤‡å¹¿æ’­
await deviceManager.handleDeviceBroadcast(peerId, broadcast);

// è·å–è®¾å¤‡å¹¿æ’­ä¿¡æ¯
const broadcast = deviceManager.getDeviceBroadcast();

// æ¸…ç†ä¸æ´»è·ƒè®¾å¤‡ (é»˜è®¤7å¤©)
await deviceManager.cleanupInactiveDevices();

// è·å–ç»Ÿè®¡ä¿¡æ¯
const stats = deviceManager.getStatistics();
```

### P2P ç®¡ç†å™¨ API

```javascript
// è·å–ç”¨æˆ·è®¾å¤‡åˆ—è¡¨
const devices = p2pManager.getUserDevices(userId);

// è·å–å½“å‰è®¾å¤‡
const device = p2pManager.getCurrentDevice();

// è·å–è®¾å¤‡ç»Ÿè®¡
const stats = p2pManager.getDeviceStatistics();

// å‘èµ·å¯†é’¥äº¤æ¢ (æŒ‡å®šè®¾å¤‡)
await p2pManager.initiateKeyExchange(peerId, deviceId);

// å¹¿æ’­è®¾å¤‡ä¿¡æ¯
await p2pManager.broadcastDeviceInfo();
```

### IPC API

```javascript
// è·å–ç”¨æˆ·è®¾å¤‡åˆ—è¡¨
const devices = await window.electronAPI.p2p.getUserDevices(userId);

// è·å–å½“å‰è®¾å¤‡
const device = await window.electronAPI.p2p.getCurrentDevice();

// è·å–è®¾å¤‡ç»Ÿè®¡
const stats = await window.electronAPI.p2p.getDeviceStatistics();

// å‘èµ·å¯†é’¥äº¤æ¢ (æŒ‡å®šè®¾å¤‡)
await window.electronAPI.p2p.initiateKeyExchange(peerId, deviceId);
```

## å¾…å®ŒæˆåŠŸèƒ½

### ğŸš§ UI ç»„ä»¶ (è¿›è¡Œä¸­)

- [ ] æ›´æ–° P2PMessaging.vue æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
- [ ] æ˜¾ç¤ºå½“å‰è®¾å¤‡è¯¦æƒ…
- [ ] æ˜¾ç¤ºå¯¹ç­‰èŠ‚ç‚¹çš„è®¾å¤‡åˆ—è¡¨
- [ ] å…è®¸é€‰æ‹©ç‰¹å®šè®¾å¤‡è¿›è¡Œé€šä¿¡
- [ ] è®¾å¤‡åœ¨çº¿çŠ¶æ€æŒ‡ç¤º
- [ ] åˆ›å»ºç‹¬ç«‹çš„è®¾å¤‡ç®¡ç†ç•Œé¢

### ğŸ“‹ æœªæ¥æ”¹è¿›

- [ ] è®¾å¤‡é—´æ¶ˆæ¯åŒæ­¥ (ç¦»çº¿æ¶ˆæ¯)
- [ ] è®¾å¤‡åˆ«åç®¡ç†
- [ ] è®¾å¤‡ä¿¡ä»»çº§åˆ«
- [ ] è®¾å¤‡é”å®š/è§£é”
- [ ] è®¾å¤‡è¿œç¨‹æ³¨é”€
- [ ] è®¾å¤‡æ´»åŠ¨æ—¥å¿—
- [ ] è®¾å¤‡ä½ç½®ä¿¡æ¯ (å¯é€‰)
- [ ] è®¾å¤‡ç±»å‹è¯†åˆ« (æ‰‹æœº/ç”µè„‘/å¹³æ¿)

## å®‰å…¨è€ƒè™‘

1. **è®¾å¤‡èº«ä»½éªŒè¯**: å½“å‰ä½¿ç”¨ P2P èŠ‚ç‚¹èº«ä»½,æœªæ¥åº”é›†æˆ DID ç³»ç»Ÿ
2. **è®¾å¤‡ä¿¡ä»»**: é¦–æ¬¡è¿æ¥çš„è®¾å¤‡åº”è¦æ±‚ç”¨æˆ·ç¡®è®¤
3. **è®¾å¤‡æ’¤é”€**: åº”æ”¯æŒè¿œç¨‹æ’¤é”€è¢«ç›—è®¾å¤‡çš„è®¿é—®æƒé™
4. **å¯†é’¥éš”ç¦»**: æ¯ä¸ªè®¾å¤‡ä½¿ç”¨ç‹¬ç«‹çš„ Signal ä¼šè¯å¯†é’¥

## æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: å•ç”¨æˆ·å¤šè®¾å¤‡

```
1. ç”¨æˆ·åœ¨è®¾å¤‡ A å¯åŠ¨åº”ç”¨
2. ç”¨æˆ·åœ¨è®¾å¤‡ B å¯åŠ¨åº”ç”¨
3. è®¾å¤‡ A å’Œ B é€šè¿‡ mDNS è‡ªåŠ¨å‘ç°
4. è®¾å¤‡ A å’Œ B äº¤æ¢è®¾å¤‡ä¿¡æ¯
5. éªŒè¯ä¸¤ä¸ªè®¾å¤‡éƒ½è®°å½•äº†å¯¹æ–¹
```

### åœºæ™¯ 2: å¤šè®¾å¤‡åŠ å¯†é€šä¿¡

```
1. Alice è®¾å¤‡ A1 ä¸ Bob è®¾å¤‡ B1 å»ºç«‹åŠ å¯†ä¼šè¯
2. Alice A1 å‘é€æ¶ˆæ¯åˆ° Bob B1
3. Bob åœ¨ B2 å¯åŠ¨,å‘ç° B1 å­˜åœ¨
4. Alice A1 ä¸ Bob B2 å»ºç«‹æ–°çš„åŠ å¯†ä¼šè¯
5. Alice A1 å¯ä»¥é€‰æ‹©å‘ B1 æˆ– B2 å‘é€æ¶ˆæ¯
```

### åœºæ™¯ 3: è®¾å¤‡æ¸…ç†

```
1. å¯åŠ¨åº”ç”¨è¿è¡Œå¤šå¤©
2. æŸäº›è®¾å¤‡é•¿æœŸä¸æ´»è·ƒ
3. è¿è¡Œè®¾å¤‡æ¸…ç†
4. éªŒè¯ä¸æ´»è·ƒè®¾å¤‡è¢«ç§»é™¤
```

## æ€§èƒ½å½±å“

- **è®¾å¤‡å¹¿æ’­**: æ¯æ¬¡è¿æ¥æ–°èŠ‚ç‚¹æ—¶å¹¿æ’­ä¸€æ¬¡,çº¦ 100-200ms
- **è®¾å¤‡åˆ—è¡¨**: å†…å­˜å ç”¨ ~1KB æ¯ä¸ªè®¾å¤‡
- **æŒä¹…åŒ–**: å¼‚æ­¥å†™å…¥,ä¸å½±å“ä¸»çº¿ç¨‹

## æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶

1. `src/main/p2p/device-manager.js` (350+ è¡Œ)
   - è®¾å¤‡ç®¡ç†å™¨æ ¸å¿ƒå®ç°

### ä¿®æ”¹æ–‡ä»¶

1. `src/main/p2p/p2p-manager.js`
   - é›†æˆè®¾å¤‡ç®¡ç†å™¨
   - æ·»åŠ è®¾å¤‡å¹¿æ’­åè®®
   - ä¿®æ”¹å¯†é’¥äº¤æ¢æ”¯æŒè®¾å¤‡ID

2. `src/main/index.js`
   - æ·»åŠ è®¾å¤‡ç›¸å…³ IPC å¤„ç†å™¨

3. `src/preload/index.js`
   - æš´éœ²è®¾å¤‡ç®¡ç† API

## ä¸‹ä¸€æ­¥è®¡åˆ’

1. **å®Œæˆ UI ç»„ä»¶** (ä¼˜å…ˆçº§: é«˜)
   - æ›´æ–° P2PMessaging.vue
   - åˆ›å»ºè®¾å¤‡ç®¡ç†ç•Œé¢

2. **è®¾å¤‡åŒæ­¥** (ä¼˜å…ˆçº§: ä¸­)
   - ç¦»çº¿æ¶ˆæ¯é˜Ÿåˆ—
   - æ¶ˆæ¯çŠ¶æ€åŒæ­¥

3. **è®¾å¤‡ç®¡ç†åŠŸèƒ½** (ä¼˜å…ˆçº§: ä¸­)
   - è®¾å¤‡åˆ«å
   - è®¾å¤‡ä¿¡ä»»ç®¡ç†

4. **æ–‡æ¡£å’Œæµ‹è¯•** (ä¼˜å…ˆçº§: ä¸­)
   - å®Œå–„ç”¨æˆ·æ–‡æ¡£
   - æ·»åŠ å•å…ƒæµ‹è¯•

## æ€»ç»“

å¤šè®¾å¤‡æ”¯æŒçš„æ ¸å¿ƒåŠŸèƒ½å·²ç»å®ç°,åŒ…æ‹¬è®¾å¤‡èº«ä»½ç®¡ç†ã€è®¾å¤‡å‘ç°ã€è®¾å¤‡å¹¿æ’­å’Œå¤šè®¾å¤‡åŠ å¯†ä¼šè¯ã€‚ç›®å‰ç¼ºå°‘ UI ç»„ä»¶æ¥å±•ç¤ºå’Œç®¡ç†è®¾å¤‡ã€‚

**å®Œæˆåº¦**: çº¦ 80%

**ä¸‹ä¸€æ­¥**: å®Œæˆ UI ç»„ä»¶,æä¾›å®Œæ•´çš„å¤šè®¾å¤‡ä½“éªŒã€‚

---

**æ›´æ–°æ—¥å¿—**:
- 2025-12-18: æ ¸å¿ƒåŠŸèƒ½å®ç°å®Œæˆ
