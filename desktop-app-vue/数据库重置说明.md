# 数据库重置完成

## 问题分析

您遇到的模板 `tpl_lifestyle_wellness_002` (个人健康管理计划) 的 `prompt_template` 字段为空的问题，确实与修改数据库密码有关。

### 根本原因

1. **加密数据库问题**: 修改密码后创建了新的加密数据库 `test-password.encrypted.db`
2. **模板数据不完整**: 在加密数据库中，模板记录被创建了，但 `prompt_template` 字段为空
3. **重新加载失败**: 由于 `templatesLoaded` 标志已设置为 `true`，系统跳过了从 JSON 文件重新加载模板的步骤

### 已执行的修复操作

✅ **备份旧数据库**
```
旧文件: data/test-password.encrypted.db
备份至: data/test-password.encrypted.db.backup.20251230_094437
```

✅ **删除问题数据库**
- 已移除 `test-password.encrypted.db`
- 系统将在下次启动时创建新数据库

## 下一步操作

### 1. 重启桌面应用

```bash
cd desktop-app-vue
npm run dev
```

### 2. 系统将自动完成

应用启动时会自动执行以下操作：

1. ✅ 检测到数据库不存在
2. ✅ 创建新的 `chainlesschain.db` 数据库
3. ✅ 从 `src/main/templates/` 目录加载所有模板的 JSON 文件
4. ✅ 正确导入包含完整 `prompt_template` 字段的模板数据

### 3. 验证修复

启动后，您可以：

1. 打开模板列表，查看 "个人健康管理计划" 模板
2. 点击使用模板，填写变量
3. 检查右侧实时预览是否正常显示
4. 如果预览显示正常，说明问题已解决 ✅

### 4. 如果需要重新启用数据库加密

如果您需要数据库加密功能，请在问题修复确认后：

1. 进入应用的 "系统设置"
2. 找到 "数据库设置" 部分
3. 启用数据库加密
4. 设置新的加密密码
5. 系统会自动迁移数据到加密数据库

⚠️ **重要提示**:
- 设置密码后，数据库会使用 SQLCipher 加密
- 请务必记住密码，忘记密码将无法恢复数据
- 建议先备份数据再启用加密

## 技术细节

### 模板文件验证

我已确认模板 JSON 文件是完整的：

```javascript
// src/main/templates/lifestyle/wellness-plan.json
{
  "id": "tpl_lifestyle_wellness_002",
  "name": "wellness_lifestyle_plan",
  "display_name": "个人健康管理计划",
  "prompt_template": "请帮我制定一份为期{{planDuration}}周的个人健康管理计划...",
  // ... 完整的 prompt_template 内容 (约 8000+ 字符)
  "variables_schema": [
    // ... 变量定义
  ]
}
```

✅ JSON 文件包含完整的 `prompt_template` 字段
✅ 模板结构正确
✅ 所有必需字段都存在

### 问题复现条件

此问题发生在以下情况：

1. 应用首次启动，创建数据库并加载模板
2. 用户修改数据库密码，创建加密数据库
3. 在加密数据库创建过程中，模板数据的 `prompt_template` 字段未能正确写入
4. 系统标记 `templatesLoaded = true`，后续启动不再重新加载

### 防止未来再次发生

建议在代码中添加验证逻辑（已在最近的 commit 中实现）：

```javascript
// src/main/index.js:9274-9286
if (!template.prompt_template || template.prompt_template.trim() === '') {
  // 强制重新初始化
  this.templateManager.templatesLoaded = false;
  await this.templateManager.initialize();

  // 重新获取模板
  template = await this.templateManager.getTemplateById(templateId);

  if (!template.prompt_template) {
    throw new Error(`模板 ${templateId} 的 prompt_template 字段为空`);
  }
}
```

## 备用修复方案

如果上述自动修复不工作，我还准备了两个手动修复脚本：

### 方案 A: 重置脚本（Windows）
```bash
.\reset-database.bat
```

### 方案 B: 修复加密数据库（需要密码）
```bash
node fix-encrypted-db-templates.js
```

## 总结

✅ 问题原因已确认：加密数据库迁移时模板数据不完整
✅ 已备份旧数据库
✅ 已删除问题数据库
✅ 系统将在下次启动时自动创建新数据库并加载完整模板

**现在请重启应用，问题应该已经解决！** 🎉

---

如有任何问题，请查看控制台日志或联系技术支持。
