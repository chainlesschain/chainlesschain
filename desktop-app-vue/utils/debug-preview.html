<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Officeæ–‡ä»¶é¢„è§ˆè°ƒè¯•å·¥å…·</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f5f5;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 4px;
      border-left: 4px solid #1890ff;
    }

    .section h2 {
      color: #333;
      margin-bottom: 15px;
      font-size: 18px;
    }

    .input-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      color: #555;
      font-weight: 500;
    }

    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }

    button {
      background: #1890ff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
      transition: background 0.3s;
    }

    button:hover {
      background: #0056b3;
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .log-container {
      margin-top: 20px;
      padding: 15px;
      background: #1e1e1e;
      color: #d4d4d4;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .log-success {
      color: #4ade80;
    }

    .log-error {
      color: #f87171;
    }

    .log-info {
      color: #60a5fa;
    }

    .log-warning {
      color: #fbbf24;
    }

    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-success {
      background: #d1fae5;
      color: #065f46;
    }

    .status-error {
      background: #fee2e2;
      color: #991b1b;
    }

    .status-pending {
      background: #e0e7ff;
      color: #3730a3;
    }

    .result-box {
      margin-top: 15px;
      padding: 15px;
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 4px;
    }

    .result-title {
      font-weight: 600;
      color: #374151;
      margin-bottom: 10px;
    }

    .result-content {
      color: #6b7280;
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” Officeæ–‡ä»¶é¢„è§ˆè°ƒè¯•å·¥å…·</h1>
    <p class="subtitle">å¿«é€Ÿè¯Šæ–­å’Œæµ‹è¯•Officeæ–‡ä»¶é¢„è§ˆåŠŸèƒ½</p>

    <!-- æ­¥éª¤1: é¡¹ç›®ä¿¡æ¯ -->
    <div class="section">
      <h2>æ­¥éª¤1: è¾“å…¥é¡¹ç›®ä¿¡æ¯</h2>
      <div class="input-group">
        <label for="projectId">é¡¹ç›®ID:</label>
        <input type="text" id="projectId" placeholder="ä¾‹å¦‚: abc123-def456-ghi789">
      </div>
      <div class="input-group">
        <label for="fileName">æ–‡ä»¶å:</label>
        <input type="text" id="fileName" placeholder="ä¾‹å¦‚: å·¥ä½œæŠ¥å‘Š.docx">
      </div>
    </div>

    <!-- æ­¥éª¤2: è·¯å¾„æµ‹è¯• -->
    <div class="section">
      <h2>æ­¥éª¤2: æµ‹è¯•è·¯å¾„è§£æ</h2>
      <button onclick="testPathResolution()">æµ‹è¯•è·¯å¾„è§£æ</button>
      <div id="pathResult"></div>
    </div>

    <!-- æ­¥éª¤3: æ–‡ä»¶æ£€æŸ¥ -->
    <div class="section">
      <h2>æ­¥éª¤3: æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨</h2>
      <button onclick="testFileExists()">æ£€æŸ¥æ–‡ä»¶</button>
      <div id="fileExistsResult"></div>
    </div>

    <!-- æ­¥éª¤4: æ–‡ä»¶ä¿¡æ¯ -->
    <div class="section">
      <h2>æ­¥éª¤4: è·å–æ–‡ä»¶ä¿¡æ¯</h2>
      <button onclick="testFileInfo()">è·å–æ–‡ä»¶ä¿¡æ¯</button>
      <div id="fileInfoResult"></div>
    </div>

    <!-- æ­¥éª¤5: é¢„è§ˆæµ‹è¯• -->
    <div class="section">
      <h2>æ­¥éª¤5: æµ‹è¯•æ–‡ä»¶é¢„è§ˆ</h2>
      <button onclick="testPreview('word')">æµ‹è¯•Wordé¢„è§ˆ</button>
      <button onclick="testPreview('excel')">æµ‹è¯•Excelé¢„è§ˆ</button>
      <button onclick="testPreview('powerpoint')">æµ‹è¯•PPTé¢„è§ˆ</button>
      <div id="previewResult"></div>
    </div>

    <!-- æ—¥å¿—è¾“å‡º -->
    <div class="section">
      <h2>è°ƒè¯•æ—¥å¿—</h2>
      <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
      <button onclick="copyLog()">å¤åˆ¶æ—¥å¿—</button>
      <div class="log-container" id="logContainer"></div>
    </div>
  </div>

  <script>
    let resolvedPath = '';

    function log(message, type = 'info') {
      const logContainer = document.getElementById('logContainer');
      const timestamp = new Date().toLocaleTimeString();
      const className = `log-${type}`;
      logContainer.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      logContainer.scrollTop = logContainer.scrollHeight;
      console.log(`[${type.toUpperCase()}]`, message);
    }

    function clearLog() {
      document.getElementById('logContainer').innerHTML = '';
      log('æ—¥å¿—å·²æ¸…ç©º', 'info');
    }

    function copyLog() {
      const logContainer = document.getElementById('logContainer');
      const text = logContainer.innerText;
      navigator.clipboard.writeText(text).then(() => {
        alert('æ—¥å¿—å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
      });
    }

    function getFilePath() {
      const projectId = document.getElementById('projectId').value.trim();
      const fileName = document.getElementById('fileName').value.trim();

      if (!projectId || !fileName) {
        log('è¯·å…ˆè¾“å…¥é¡¹ç›®IDå’Œæ–‡ä»¶å', 'error');
        alert('è¯·å…ˆè¾“å…¥é¡¹ç›®IDå’Œæ–‡ä»¶å');
        return null;
      }

      return `/data/projects/${projectId}/${fileName}`;
    }

    async function testPathResolution() {
      log('=== å¼€å§‹æµ‹è¯•è·¯å¾„è§£æ ===', 'info');

      const filePath = getFilePath();
      if (!filePath) return;

      log(`è¾“å…¥è·¯å¾„: ${filePath}`, 'info');

      try {
        const resolved = await window.electronAPI.project.resolvePath(filePath);
        resolvedPath = resolved;

        log(`âœ“ è·¯å¾„è§£ææˆåŠŸ`, 'success');
        log(`è§£æåè·¯å¾„: ${resolved}`, 'success');

        document.getElementById('pathResult').innerHTML = `
          <div class="result-box">
            <div class="result-title">
              <span class="status status-success">æˆåŠŸ</span>
              è·¯å¾„è§£æç»“æœ
            </div>
            <div class="result-content">
              <strong>åŸå§‹è·¯å¾„:</strong> ${filePath}<br>
              <strong>ç»å¯¹è·¯å¾„:</strong> ${resolved}
            </div>
          </div>
        `;
      } catch (error) {
        log(`âœ— è·¯å¾„è§£æå¤±è´¥: ${error.message}`, 'error');
        document.getElementById('pathResult').innerHTML = `
          <div class="result-box">
            <div class="result-title">
              <span class="status status-error">å¤±è´¥</span>
              è·¯å¾„è§£æå¤±è´¥
            </div>
            <div class="result-content">
              ${error.message}
            </div>
          </div>
        `;
      }
    }

    async function testFileExists() {
      log('=== å¼€å§‹æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ ===', 'info');

      if (!resolvedPath) {
        log('è¯·å…ˆæ‰§è¡Œæ­¥éª¤2ï¼šæµ‹è¯•è·¯å¾„è§£æ', 'warning');
        alert('è¯·å…ˆæ‰§è¡Œæ­¥éª¤2ï¼šæµ‹è¯•è·¯å¾„è§£æ');
        return;
      }

      log(`æ£€æŸ¥æ–‡ä»¶: ${resolvedPath}`, 'info');

      try {
        const stats = await window.electronAPI.file.stat(resolvedPath);

        if (stats.success) {
          log(`âœ“ æ–‡ä»¶å­˜åœ¨`, 'success');
          document.getElementById('fileExistsResult').innerHTML = `
            <div class="result-box">
              <div class="result-title">
                <span class="status status-success">æ–‡ä»¶å­˜åœ¨</span>
              </div>
              <div class="result-content">
                æ–‡ä»¶è·¯å¾„: ${resolvedPath}
              </div>
            </div>
          `;
        } else {
          log(`âœ— æ–‡ä»¶ä¸å­˜åœ¨`, 'error');
          document.getElementById('fileExistsResult').innerHTML = `
            <div class="result-box">
              <div class="result-title">
                <span class="status status-error">æ–‡ä»¶ä¸å­˜åœ¨</span>
              </div>
              <div class="result-content">
                ${stats.error || 'æ–‡ä»¶æœªæ‰¾åˆ°'}
              </div>
            </div>
          `;
        }
      } catch (error) {
        log(`âœ— æ–‡ä»¶æ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('fileExistsResult').innerHTML = `
          <div class="result-box">
            <div class="result-title">
              <span class="status status-error">æ£€æŸ¥å¤±è´¥</span>
            </div>
            <div class="result-content">
              ${error.message}
            </div>
          </div>
        `;
      }
    }

    async function testFileInfo() {
      log('=== å¼€å§‹è·å–æ–‡ä»¶ä¿¡æ¯ ===', 'info');

      if (!resolvedPath) {
        log('è¯·å…ˆæ‰§è¡Œæ­¥éª¤2ï¼šæµ‹è¯•è·¯å¾„è§£æ', 'warning');
        alert('è¯·å…ˆæ‰§è¡Œæ­¥éª¤2ï¼šæµ‹è¯•è·¯å¾„è§£æ');
        return;
      }

      log(`è·å–æ–‡ä»¶ä¿¡æ¯: ${resolvedPath}`, 'info');

      try {
        const stats = await window.electronAPI.file.stat(resolvedPath);

        if (stats.success && stats.stats) {
          const size = stats.stats.size;
          const sizeKB = (size / 1024).toFixed(2);
          const sizeMB = (size / 1024 / 1024).toFixed(2);

          log(`âœ“ æ–‡ä»¶å¤§å°: ${size} bytes (${sizeKB} KB, ${sizeMB} MB)`, 'success');
          log(`ä¿®æ”¹æ—¶é—´: ${new Date(stats.stats.mtimeMs).toLocaleString()}`, 'info');

          document.getElementById('fileInfoResult').innerHTML = `
            <div class="result-box">
              <div class="result-title">
                <span class="status status-success">æ–‡ä»¶ä¿¡æ¯</span>
              </div>
              <div class="result-content">
                <strong>æ–‡ä»¶å¤§å°:</strong> ${size} bytes (${sizeKB} KB)<br>
                <strong>ä¿®æ”¹æ—¶é—´:</strong> ${new Date(stats.stats.mtimeMs).toLocaleString()}<br>
                <strong>æ˜¯å¦ä¸ºæ–‡ä»¶:</strong> ${stats.stats.isFile ? 'æ˜¯' : 'å¦'}<br>
                <strong>æ˜¯å¦ä¸ºç›®å½•:</strong> ${stats.stats.isDirectory ? 'æ˜¯' : 'å¦'}
              </div>
            </div>
          `;

          if (size === 0) {
            log('âš  è­¦å‘Š: æ–‡ä»¶å¤§å°ä¸º0ï¼Œå¯èƒ½æ˜¯ç©ºæ–‡ä»¶ï¼', 'warning');
          }
        } else {
          log(`âœ— æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯`, 'error');
          document.getElementById('fileInfoResult').innerHTML = `
            <div class="result-box">
              <div class="result-title">
                <span class="status status-error">è·å–å¤±è´¥</span>
              </div>
              <div class="result-content">
                ${stats.error || 'æ— æ³•è·å–æ–‡ä»¶ä¿¡æ¯'}
              </div>
            </div>
          `;
        }
      } catch (error) {
        log(`âœ— è·å–æ–‡ä»¶ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
        document.getElementById('fileInfoResult').innerHTML = `
          <div class="result-box">
            <div class="result-title">
              <span class="status status-error">è·å–å¤±è´¥</span>
            </div>
            <div class="result-content">
              ${error.message}
            </div>
          </div>
        `;
      }
    }

    async function testPreview(format) {
      log(`=== å¼€å§‹æµ‹è¯•${format}é¢„è§ˆ ===`, 'info');

      if (!resolvedPath) {
        log('è¯·å…ˆæ‰§è¡Œæ­¥éª¤2ï¼šæµ‹è¯•è·¯å¾„è§£æ', 'warning');
        alert('è¯·å…ˆæ‰§è¡Œæ­¥éª¤2ï¼šæµ‹è¯•è·¯å¾„è§£æ');
        return;
      }

      log(`é¢„è§ˆæ–‡ä»¶: ${resolvedPath}`, 'info');
      log(`é¢„è§ˆæ ¼å¼: ${format}`, 'info');

      const startTime = Date.now();

      try {
        const result = await window.electronAPI.file.previewOffice(resolvedPath, format);

        const duration = Date.now() - startTime;
        log(`é¢„è§ˆè€—æ—¶: ${duration}ms`, 'info');

        if (result.success) {
          log(`âœ“ ${format}é¢„è§ˆæˆåŠŸ`, 'success');

          let contentInfo = '';
          if (format === 'word' && result.data.html) {
            contentInfo = `HTMLé•¿åº¦: ${result.data.html.length} å­—ç¬¦`;
            log(`Word HTMLé•¿åº¦: ${result.data.html.length}`, 'success');
          } else if (format === 'excel' && result.data.sheets) {
            contentInfo = `å·¥ä½œè¡¨æ•°é‡: ${result.data.sheets.length}`;
            log(`Excelå·¥ä½œè¡¨æ•°é‡: ${result.data.sheets.length}`, 'success');
            result.data.sheets.forEach((sheet, i) => {
              log(`  å·¥ä½œè¡¨ ${i + 1}: ${sheet.name}, è¡Œæ•°: ${sheet.data.length}`, 'info');
            });
          } else if (format === 'powerpoint' && result.data.slides) {
            contentInfo = `å¹»ç¯ç‰‡æ•°é‡: ${result.data.slides.length}`;
            log(`PowerPointå¹»ç¯ç‰‡æ•°é‡: ${result.data.slides.length}`, 'success');
            result.data.slides.forEach((slide, i) => {
              log(`  å¹»ç¯ç‰‡ ${i + 1}: ${slide.title || '(æ— æ ‡é¢˜)'}`, 'info');
            });
          }

          document.getElementById('previewResult').innerHTML = `
            <div class="result-box">
              <div class="result-title">
                <span class="status status-success">é¢„è§ˆæˆåŠŸ</span>
              </div>
              <div class="result-content">
                <strong>æ ¼å¼:</strong> ${format}<br>
                <strong>è€—æ—¶:</strong> ${duration}ms<br>
                <strong>å†…å®¹:</strong> ${contentInfo}
              </div>
            </div>
          `;
        } else {
          log(`âœ— ${format}é¢„è§ˆå¤±è´¥: ${result.error}`, 'error');
          document.getElementById('previewResult').innerHTML = `
            <div class="result-box">
              <div class="result-title">
                <span class="status status-error">é¢„è§ˆå¤±è´¥</span>
              </div>
              <div class="result-content">
                ${result.error || 'æœªçŸ¥é”™è¯¯'}
              </div>
            </div>
          `;
        }
      } catch (error) {
        const duration = Date.now() - startTime;
        log(`âœ— ${format}é¢„è§ˆå¼‚å¸¸: ${error.message} (è€—æ—¶: ${duration}ms)`, 'error');
        document.getElementById('previewResult').innerHTML = `
          <div class="result-box">
            <div class="result-title">
              <span class="status status-error">é¢„è§ˆå¼‚å¸¸</span>
            </div>
            <div class="result-content">
              ${error.message}
            </div>
          </div>
        `;
      }
    }

    // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
    window.addEventListener('DOMContentLoaded', () => {
      log('Officeæ–‡ä»¶é¢„è§ˆè°ƒè¯•å·¥å…·å·²å¯åŠ¨', 'success');
      log('è¯·æŒ‰ç…§æ­¥éª¤1-5ä¾æ¬¡æµ‹è¯•', 'info');
      log('', 'info');
    });
  </script>
</body>
</html>
