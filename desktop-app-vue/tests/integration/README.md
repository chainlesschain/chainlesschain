# 技能工具系统集成测试

## 概述

集成测试验证技能工具系统各组件之间的协同工作,确保完整工作流程的正确性。

## 测试覆盖

### 1. 技能-工具关联流程测试

- ✅ 创建技能并关联工具
- ✅ 移除技能-工具关联
- ✅ 一个技能关联多个工具
- ✅ 验证关联关系的正确性

### 2. 技能执行流程测试

- ✅ 执行包含单个工具的技能
- ✅ 按优先级顺序执行多个工具
- ✅ 记录技能执行统计
- ✅ 正确处理执行失败

### 3. 统计数据清理测试

- ✅ 清理过期的使用日志
- ✅ 汇总每日统计数据
- ✅ 验证数据保留策略

### 4. 定时任务调度测试

- ✅ 调度定时工作流
- ✅ 停止定时任务
- ✅ 查询定时任务列表

### 5. 插件扩展集成测试

- ✅ 通过插件注册技能和工具
- ✅ 验证插件技能-工具关联
- ✅ 确保插件隔离性

## 运行测试

### 运行所有集成测试

```bash
npm run test:integration
```

### 运行特定测试文件

```bash
npx vitest run tests/integration/skill-tool-integration.test.js
```

### 监视模式

```bash
npx vitest tests/integration/skill-tool-integration.test.js
```

## 测试架构

```
集成测试
├── 独立的测试数据库 (test-integration.db)
├── Mock FunctionCaller
├── 真实的 SkillManager
├── 真实的 ToolManager
├── 真实的 SkillExecutor
└── 真实的 StatsCleaner
```

## 测试数据清理

每个测试用例执行前会自动清理测试数据:
- 删除非内置技能和工具
- 清空使用日志
- 清空统计数据

测试完成后自动删除测试数据库文件。

## 注意事项

1. **隔离性**: 测试使用独立的数据库,不影响开发数据库
2. **并发安全**: 测试可以并发运行
3. **可重复性**: 每次测试结果应该一致
4. **覆盖率**: 目标覆盖率 > 80%

## 预期测试结果

所有测试应该通过:

```
✓ 技能-工具关联流程 (4个测试)
✓ 技能执行流程 (5个测试)
✓ 统计数据清理 (2个测试)
✓ 定时任务调度 (2个测试)
✓ 插件扩展集成 (1个测试)

总计: 14个测试全部通过 ✅
```

## 问题排查

### 测试失败

1. 检查数据库Schema是否正确
2. 验证测试数据是否正确清理
3. 查看错误日志

### 性能问题

1. 检查数据库索引
2. 优化测试数据量
3. 使用并发执行

## 扩展测试

可以添加以下测试场景:

- [ ] 并发执行测试
- [ ] 错误恢复测试
- [ ] 性能压力测试
- [ ] 内存泄漏测试
