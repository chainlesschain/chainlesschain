# RSS 和邮件集成功能测试指导

## 测试目标

验证 RSS 和邮件集成功能的性能优化效果，包括：
- 请求缓存机制
- 连接池管理
- 自动重试机制
- LRU 缓存
- 数据清理
- 并发控制

## 测试环境准备

### 1. 构建应用

```bash
# 构建主进程
npm run build:main

# 启动开发环境
npm run dev
```

### 2. 准备测试数据

#### RSS 订阅源（推荐）
- **技术博客**: https://www.ruanyifeng.com/blog/atom.xml
- **GitHub Blog**: https://github.blog/feed/
- **Hacker News**: https://news.ycombinator.com/rss
- **阮一峰周刊**: https://www.ruanyifeng.com/blog/weekly/

#### 邮件账户（测试用）
- **Gmail**: 需要应用专用密码
- **QQ邮箱**: 需要开启 IMAP/SMTP 服务并获取授权码
- **163邮箱**: 需要开启 IMAP/SMTP 服务并获取授权码

## 功能测试

### 测试 1: RSS 订阅和缓存

#### 目标
验证 RSS Feed 获取、缓存机制和 LRU 缓存功能

#### 步骤
1. 打开应用，导航到 RSS 订阅页面
2. 添加第一个 RSS 订阅源（例如：阮一峰的博客）
3. **首次获取** - 记录加载时间（预期：< 500ms）
4. 刷新页面或重新获取同一订阅源
5. **缓存命中** - 记录加载时间（预期：< 10ms）
6. 等待 5 分钟后再次获取
7. **缓存过期** - 记录加载时间（预期：< 500ms）

#### 验证点
- ✅ 首次获取成功，显示文章列表
- ✅ 缓存命中时响应时间 < 10ms（提升 98%）
- ✅ 缓存过期后自动重新获取
- ✅ LRU 缓存最多保留 100 个 Feed

#### 预期结果
```
首次获取: ~500ms
缓存命中: < 10ms (98% 提升)
缓存过期: ~500ms (自动重新获取)
```

### 测试 2: RSS 批量获取和并发控制

#### 目标
验证批量获取多个 RSS 订阅源的并发控制优化

#### 步骤
1. 添加 10 个不同的 RSS 订阅源
2. 点击"全部刷新"按钮
3. 记录总加载时间
4. 观察控制台日志，确认并发数为 5

#### 验证点
- ✅ 批量获取 10 个 Feed 总时间 < 2s（优化前：5s）
- ✅ 并发数控制在 5 个以内
- ✅ 所有订阅源都成功获取或显示错误

#### 预期结果
```
优化前: ~5000ms (串行)
优化后: ~1000ms (并发5个) - 80% 提升
```

### 测试 3: RSS 自动重试机制

#### 目标
验证网络不稳定时的自动重试功能

#### 步骤
1. 添加一个可能不稳定的 RSS 订阅源
2. 或者临时断开网络连接
3. 尝试获取 Feed
4. 观察控制台日志，确认重试行为

#### 验证点
- ✅ 首次失败后自动重试（延迟 1s）
- ✅ 第二次失败后再次重试（延迟 2s）
- ✅ 第三次失败后最后重试（延迟 4s）
- ✅ 所有重试失败后显示错误信息

#### 预期结果
```
重试策略: 指数退避
- 第1次重试: 1s 后
- 第2次重试: 2s 后
- 第3次重试: 4s 后
- 最多重试: 3 次
```

### 测试 4: 邮件连接池管理

#### 目标
验证邮件 IMAP 连接池的复用和管理

#### 步骤
1. 添加一个邮件账户（Gmail 或 QQ 邮箱）
2. **首次连接** - 记录连接时间（预期：~2s）
3. 获取邮件列表
4. 切换到其他邮箱文件夹
5. **连接复用** - 记录连接时间（预期：< 100ms）
6. 等待 10 分钟后再次操作
7. **连接超时** - 记录连接时间（预期：~2s，重新连接）

#### 验证点
- ✅ 首次连接时间 ~2s
- ✅ 连接复用时间 < 100ms（提升 95%）
- ✅ 连接池最多保持 5 个连接
- ✅ 10 分钟后连接自动清理

#### 预期结果
```
首次连接: ~2000ms
连接复用: < 100ms (95% 提升)
连接超时: 10 分钟自动清理
最大连接数: 5
```

### 测试 5: 邮件发送和接收

#### 目标
验证邮件发送和接收功能的基本操作

#### 步骤
1. 配置邮件账户（IMAP + SMTP）
2. 发送一封测试邮件给自己
3. 刷新收件箱，查看是否收到
4. 标记邮件为已读
5. 归档邮件

#### 验证点
- ✅ 邮件发送成功
- ✅ 邮件接收成功
- ✅ 标记已读功能正常
- ✅ 归档功能正常

### 测试 6: 数据清理功能

#### 目标
验证自动数据清理功能

#### 步骤
1. 确保数据库中有一些旧数据（30天前）
2. 打开开发者工具控制台
3. 手动触发数据清理（如果有 UI）或等待自动清理
4. 检查控制台日志

#### 验证点
- ✅ 清理 30 天前未标星、未归档的 RSS 文章
- ✅ 清理 30 天前已归档的邮件
- ✅ 清理孤立的邮件附件
- ✅ 显示清理统计信息

#### 预期结果
```
清理策略:
- RSS 文章: 30天前，未标星，未归档
- 邮件: 30天前，已归档
- 附件: 孤立附件（邮件已删除）
清理间隔: 24小时自动执行
```

## 性能基准测试

### 测试场景 1: RSS Feed 获取性能

```bash
# 运行性能测试脚本
node scripts/test-rss-email.js
```

**预期结果:**
- URL 验证: < 1ms
- Feed 标准化: < 10ms
- 缓存命中: < 10ms
- 缓存未命中: < 500ms

### 测试场景 2: 批量操作性能

**测试数据:**
- 10 个 RSS 订阅源
- 50 封邮件

**预期结果:**
- 批量获取 10 个 Feed: < 2s（优化前：5s）
- 同步 50 封邮件: < 5s
- 并发连接数: 5

### 测试场景 3: 内存和存储优化

**测试数据:**
- 添加 200 个 RSS 订阅源
- 获取所有订阅源

**预期结果:**
- LRU 缓存最多保留 100 个 Feed
- 内存使用稳定，不会无限增长
- 数据库大小在自动清理后保持稳定

## 压力测试

### 测试 1: 高并发 RSS 获取

```javascript
// 测试代码示例
const feedUrls = [/* 100 个 RSS URL */];
const results = await rssFetcher.fetchMultipleFeeds(feedUrls, {
  concurrency: 5
});
```

**预期结果:**
- 100 个 Feed 获取时间: < 20s
- 并发数控制在 5 个
- 无内存泄漏
- 无连接泄漏

### 测试 2: 长时间运行稳定性

**测试步骤:**
1. 启动应用
2. 每 5 分钟刷新一次所有 RSS 订阅源
3. 持续运行 24 小时

**预期结果:**
- 内存使用稳定
- 缓存自动过期和清理
- 连接池自动管理
- 无崩溃或错误

## 故障恢复测试

### 测试 1: 网络中断恢复

**步骤:**
1. 正常获取 RSS Feed
2. 断开网络连接
3. 尝试获取 Feed（应该失败并重试）
4. 恢复网络连接
5. 再次尝试获取 Feed

**预期结果:**
- 网络中断时显示错误信息
- 自动重试 3 次
- 网络恢复后正常获取

### 测试 2: 服务器错误处理

**步骤:**
1. 添加一个返回 500 错误的 RSS URL
2. 尝试获取 Feed
3. 观察错误处理

**预期结果:**
- 显示友好的错误信息
- 不影响其他订阅源的获取
- 错误信息包含详细的调试信息

## 测试报告模板

### 测试环境
- 操作系统: macOS / Windows / Linux
- Node.js 版本:
- Electron 版本:
- 应用版本: v0.20.2

### 测试结果

| 测试项 | 预期结果 | 实际结果 | 状态 |
|--------|----------|----------|------|
| RSS 缓存命中 | < 10ms | ___ ms | ✅/❌ |
| 批量获取 10 个 Feed | < 2s | ___ s | ✅/❌ |
| Email 连接复用 | < 100ms | ___ ms | ✅/❌ |
| 自动重试 | 3 次 | ___ 次 | ✅/❌ |
| LRU 缓存限制 | 100 条 | ___ 条 | ✅/❌ |
| 数据自动清理 | 正常 | ___ | ✅/❌ |

### 性能对比

| 操作 | 优化前 | 优化后 | 提升 |
|------|--------|--------|------|
| RSS Feed 获取（缓存命中） | 500ms | ___ ms | ___% |
| 批量获取 10 个 Feed | 5000ms | ___ ms | ___% |
| Email IMAP 连接 | 2000ms | ___ ms | ___% |

### 问题和建议

记录测试过程中发现的问题和改进建议。

## 常见问题

### Q1: RSS 订阅源无法获取
**A:** 检查网络连接，确认 RSS URL 是否有效，查看控制台错误日志。

### Q2: 邮件连接失败
**A:** 确认邮箱账户配置正确，IMAP/SMTP 服务已开启，授权码正确。

### Q3: 缓存没有生效
**A:** 检查是否使用了 `skipCache` 选项，确认缓存时间未过期（5分钟）。

### Q4: 数据清理没有执行
**A:** 检查是否启动了自动清理任务，确认数据是否满足清理条件（30天前）。

## 下一步

完成测试后，请：
1. 填写测试报告
2. 记录性能数据
3. 报告发现的问题
4. 提出改进建议

---

**测试版本**: v0.20.2
**测试日期**: 2026-01-12
**文档版本**: 1.0
