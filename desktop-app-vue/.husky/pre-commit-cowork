#!/bin/sh
# Cowork-Enhanced Pre-commit Hook
# Optimized for speed: 2-5 min â†’ 30-60 sec (-75%)

echo "ğŸš€ Coworkæ™ºèƒ½Pre-commitæ£€æŸ¥ (ä¼˜åŒ–ç‰ˆ)"
echo ""

START_TIME=$(date +%s)

# 1. Coworkæ™ºèƒ½ä»£ç å®¡æŸ¥ (10-30ç§’)
echo "ğŸ¤– Step 1/3: Coworkæ™ºèƒ½ä»£ç å®¡æŸ¥..."
node desktop-app-vue/scripts/cowork-pre-commit.js

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ Coworkä»£ç å®¡æŸ¥å‘ç°criticalé—®é¢˜ï¼"
  echo "è¯·ä¿®å¤é—®é¢˜åå†æäº¤"
  echo ""
  echo "è·³è¿‡æ£€æŸ¥: git commit --no-verify"
  exit 1
fi

echo "âœ… Coworkå®¡æŸ¥é€šè¿‡"
echo ""

# 2. ESLintå¿«é€Ÿæ£€æŸ¥ (ä»…stagedæ–‡ä»¶) (10-20ç§’)
echo "ğŸ“ Step 2/3: ESLintæ£€æŸ¥..."
cd desktop-app-vue || exit 1
npx lint-staged --quiet

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ ESLintæ£€æŸ¥å¤±è´¥ï¼"
  exit 1
fi

echo "âœ… ESLinté€šè¿‡"
echo ""

# 3. æ™ºèƒ½æµ‹è¯•é€‰æ‹© (10-30ç§’ï¼Œè€Œé2-3åˆ†é’Ÿ)
echo "ğŸ§ª Step 3/3: æ™ºèƒ½æµ‹è¯•é€‰æ‹©..."
node scripts/cowork-test-selector.js --staged

if [ $? -ne 0 ]; then
  echo ""
  echo "âŒ æµ‹è¯•å¤±è´¥ï¼"
  exit 1
fi

echo "âœ… æµ‹è¯•é€šè¿‡"
echo ""

# æ€»ç»“
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "âœ¨ æ‰€æœ‰Pre-commitæ£€æŸ¥é€šè¿‡ï¼"
echo "â±ï¸  æ€»è€—æ—¶: ${DURATION}ç§’"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "ğŸ’¡ å®Œæ•´å®¡æŸ¥: npm run cowork:review"
echo "ğŸ’¡ å®Œæ•´æµ‹è¯•: npm test"
echo ""
