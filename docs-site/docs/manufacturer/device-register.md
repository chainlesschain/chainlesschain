# 设备注册

设备注册是厂家管理系统的核心功能之一，用于将新生产的U盾或SIMKey设备注册到系统中。

## 注册流程

### 1. 单个设备注册

#### 进入注册页面

```
登录厂家管理系统
→ 设备管理
→ 设备注册
→ 单个注册
```

#### 填写设备信息

| 字段 | 说明 | 必填 | 示例 |
|------|------|------|------|
| 设备类型 | U盾 或 SIMKey | ✅ | U盾 |
| 设备型号 | 具体型号 | ✅ | ePass3003 |
| 序列号 | 唯一标识符 | ✅ | UP2024010100001 |
| 生产日期 | 设备生产日期 | ✅ | 2024-01-01 |
| 硬件版本 | 硬件版本号 | ✅ | v2.1 |
| 固件版本 | 固件版本号 | ✅ | v1.5.3 |
| MAC地址 | 设备MAC地址 | ❌ | 00:1A:2B:3C:4D:5E |
| 备注 | 其他信息 | ❌ | 批次A |

#### 提交注册

```
1. 填写完整信息
2. 点击"预览"检查
3. 确认无误后点击"提交"
4. 系统生成设备ID
5. 打印设备标签（可选）
```

### 2. 批量注册

#### 准备导入文件

使用Excel模板批量导入：

```excel
设备类型 | 设备型号   | 序列号           | 生产日期   | 硬件版本 | 固件版本
--------|-----------|-----------------|-----------|---------|----------
U盾     | ePass3003 | UP2024010100001 | 2024-01-01| v2.1    | v1.5.3
U盾     | ePass3003 | UP2024010100002 | 2024-01-01| v2.1    | v1.5.3
SIMKey  | USIM-001  | SK2024010100001 | 2024-01-02| v1.0    | v1.2.0
```

#### 导入流程

```
1. 下载模板
   设备注册 → 批量注册 → 下载模板

2. 填写设备信息
   - 严格按照模板格式
   - 序列号不能重复
   - 日期格式: YYYY-MM-DD

3. 上传文件
   选择文件 → 点击上传 → 系统验证

4. 验证结果
   - 成功: 显示成功数量
   - 失败: 显示错误行号和原因

5. 确认导入
   检查无误 → 确认导入 → 完成
```

#### 常见错误

| 错误信息 | 原因 | 解决方法 |
|---------|------|---------|
| 序列号重复 | 系统中已存在该序列号 | 检查序列号是否正确 |
| 日期格式错误 | 日期格式不正确 | 使用YYYY-MM-DD格式 |
| 必填字段为空 | 缺少必填信息 | 补充完整信息 |
| 设备型号不存在 | 型号未在系统中定义 | 先添加设备型号 |

## 设备序列号规则

### 序列号格式

```
U盾序列号: UP + 年份(4位) + 月份(2位) + 日期(2位) + 流水号(5位)
示例: UP2024010100001
      │ │   │  │  │
      │ │   │  │  └─ 流水号 (00001-99999)
      │ │   │  └──── 日期 (01-31)
      │ │   └─────── 月份 (01-12)
      │ └─────────── 年份 (2024)
      └───────────── 设备类型 (UP=U盾)

SIMKey序列号: SK + 年份(4位) + 月份(2位) + 日期(2位) + 流水号(5位)
示例: SK2024010100001
```

### 序列号校验规则

```typescript
function validateSerialNumber(serial: string, deviceType: string): boolean {
    const pattern = deviceType === 'U盾'
        ? /^UP\d{12}$/
        : /^SK\d{12}$/

    if (!pattern.test(serial)) {
        return false
    }

    // 提取日期部分验证
    const year = parseInt(serial.substr(2, 4))
    const month = parseInt(serial.substr(6, 2))
    const day = parseInt(serial.substr(8, 2))

    if (month < 1 || month > 12) return false
    if (day < 1 || day > 31) return false

    return true
}
```

## 设备状态

注册后的设备状态为 **"已注册"**，生命周期如下：

```
已注册 → 已激活 → 使用中 → 已停用 → 已报废
  ↓
  └─→ 待发货 → 已发货 → 已签收
```

| 状态 | 说明 | 可执行操作 |
|------|------|-----------|
| 已注册 | 刚注册，未激活 | 激活、发货、编辑、删除 |
| 待发货 | 准备发货 | 发货、取消 |
| 已发货 | 已发出 | 标记签收 |
| 已签收 | 用户已签收 | 激活 |
| 已激活 | 用户已激活使用 | 停用 |
| 使用中 | 正常使用 | 停用、报修 |
| 已停用 | 暂时停用 | 重新启用 |
| 已报废 | 设备报废 | 归档 |

## 生成设备证书

注册成功后，可以为设备生成数字证书：

### 证书类型

1. **出厂证书**: 证明设备来源
2. **安全证书**: 包含公钥信息
3. **质保证书**: 质保信息

### 生成流程

```
设备详情 → 证书管理 → 生成证书

选择证书类型:
□ 出厂证书
☑ 安全证书
□ 质保证书

填写证书信息:
- 有效期: 2年 / 5年 / 永久
- 用途: 身份认证 / 数字签名
- 算法: RSA-4096 / Ed25519

生成并下载证书
```

### 证书格式

```json
{
  "certificate": {
    "version": "1.0",
    "serialNumber": "UP2024010100001",
    "deviceType": "U盾",
    "model": "ePass3003",
    "manufacturer": "飞天诚信",
    "issueDate": "2024-01-01T00:00:00Z",
    "expiryDate": "2026-01-01T00:00:00Z",
    "publicKey": {
      "algorithm": "RSA",
      "keySize": 4096,
      "exponent": 65537,
      "modulus": "0x..."
    },
    "signature": "0x...",
    "issuer": "ChainlessChain Certificate Authority"
  }
}
```

## 打印设备标签

注册成功后可以打印设备标签：

### 标签内容

```
┌─────────────────────────────┐
│  ChainlessChain U盾          │
├─────────────────────────────┤
│ 型号: ePass3003              │
│ 序列号: UP2024010100001      │
│ 生产日期: 2024-01-01         │
│                              │
│ [二维码]                      │
│ (扫码查看设备信息)             │
├─────────────────────────────┤
│ 厂商: 深圳市ChainlessChain   │
│ 客服: 400-1068-687           │
└─────────────────────────────┘
```

### 打印设置

```
设备详情 → 打印标签

标签尺寸:
○ 40mm × 30mm (标准)
○ 50mm × 40mm (大号)
● 自定义

打印数量: 2 份

包含内容:
☑ 序列号
☑ 二维码
☑ 生产日期
□ 公钥指纹

打印预览 → 确认打印
```

## 设备信息查询

### 按序列号查询

```
设备管理 → 设备查询

序列号: UP2024010100001

查询结果:
- 设备类型: U盾
- 设备型号: ePass3003
- 状态: 已注册
- 注册时间: 2024-01-01 10:30:00
- 操作员: admin
```

### 按批次查询

```
设备管理 → 批次查询

生产日期: 2024-01-01
设备型号: ePass3003

查询结果: 找到 100 个设备
- 已注册: 100
- 已激活: 0
- 使用中: 0
```

### 导出设备列表

```
设备管理 → 导出

筛选条件:
- 注册时间: 2024-01-01 ~ 2024-01-31
- 设备类型: U盾
- 状态: 已注册

导出格式: Excel / CSV / PDF

导出内容:
☑ 序列号
☑ 设备型号
☑ 注册时间
☑ 状态
□ 公钥信息

生成报表
```

## 数据统计

### 注册统计

```
仪表盘 → 设备统计 → 注册统计

本月注册设备:
- U盾: 1,523 个
- SIMKey: 876 个
- 总计: 2,399 个

同比增长: +15.3%
环比增长: +8.7%

趋势图:
[显示每日注册数量折线图]
```

### 型号分布

```
设备型号分布:
- ePass3003: 45%
- WatchData: 30%
- USIM-001: 15%
- 其他: 10%

[饼图显示]
```

## API接口

### 注册单个设备

```http
POST /api/v1/devices/register
Content-Type: application/json
Authorization: Bearer {token}

{
  "deviceType": "U盾",
  "model": "ePass3003",
  "serialNumber": "UP2024010100001",
  "productionDate": "2024-01-01",
  "hardwareVersion": "v2.1",
  "firmwareVersion": "v1.5.3",
  "macAddress": "00:1A:2B:3C:4D:5E",
  "remarks": "批次A"
}
```

响应：
```json
{
  "code": 0,
  "message": "注册成功",
  "data": {
    "deviceId": "d7f3e8a1-4b2c-4d9e-8f1a-2b3c4d5e6f7a",
    "serialNumber": "UP2024010100001",
    "status": "已注册",
    "registeredAt": "2024-01-01T10:30:00Z"
  }
}
```

### 批量注册

```http
POST /api/v1/devices/batch-register
Content-Type: multipart/form-data
Authorization: Bearer {token}

file: devices.xlsx
```

响应：
```json
{
  "code": 0,
  "message": "批量注册完成",
  "data": {
    "total": 100,
    "success": 98,
    "failed": 2,
    "errors": [
      {
        "row": 15,
        "serialNumber": "UP2024010100015",
        "error": "序列号重复"
      },
      {
        "row": 23,
        "serialNumber": "UP2024010100023",
        "error": "日期格式错误"
      }
    ]
  }
}
```

## 常见问题

### 序列号重复怎么办？

检查：
1. 是否重复导入
2. 是否序列号规则错误
3. 联系管理员检查数据库

### 批量导入失败？

常见原因：
- Excel格式不正确
- 数据格式错误
- 文件太大（建议<1000行）
- 网络超时

建议：
- 使用官方模板
- 分批导入
- 检查数据格式

### 如何修改已注册设备信息？

```
设备管理 → 查找设备 → 编辑

注意:
- 序列号不可修改
- 状态为"已激活"后部分信息不可修改
- 需要管理员权限
```

## 最佳实践

1. ✅ **使用批量导入**: 大批量设备使用Excel导入
2. ✅ **规范序列号**: 严格遵循序列号规则
3. ✅ **及时生成证书**: 注册后立即生成证书
4. ✅ **打印标签**: 为每个设备打印标签
5. ✅ **定期备份**: 定期导出设备列表备份
