# 规则审查指南

> 定期审查和更新项目编码规则的流程指南
>
> **审查周期**: 每月或重大功能发布前
> **负责人**: 技术负责人 + 核心开发团队
> **文档版本**: v1.0
> **最后审查**: 2026-01-16

---

## 📋 审查流程

### 1. 准备阶段

#### 1.1 收集反馈
- 检查最近一个月的规则验证报告
- 收集团队成员对现有规则的反馈
- 分析常见的规则违反情况
- 查看 GitHub Issues 中关于规则的讨论

#### 1.2 技术调研
- 研究行业最佳实践的变化
- 检查依赖库的安全更新
- 评估新技术/工具的引入

---

### 2. 审查内容

#### 2.1 规则有效性审查

**检查清单**：

- [ ] **SQL 注入防护规则**
  - 是否覆盖所有数据库操作场景？
  - 是否有误报（false positive）？
  - 是否需要添加新的检测模式？

- [ ] **P2P 加密规则**
  - 加密算法是否符合最新安全标准？
  - 是否覆盖所有通信场景？
  - 离线消息处理是否安全？

- [ ] **敏感信息泄露规则**
  - 日志过滤规则是否完善？
  - 是否有新的敏感数据类型需要保护？
  - 开发/生产环境的区分是否合理？

- [ ] **依赖项漏洞规则**
  - npm audit 阈值是否合理？
  - 是否需要添加自动更新策略？
  - 已知不兼容问题是否记录？

#### 2.2 规则可执行性审查

**评估指标**：

| 指标 | 目标 | 当前状态 |
|------|------|----------|
| 规则验证耗时 | < 30 秒 | ⏱️ 待测量 |
| 误报率 | < 5% | 📊 待统计 |
| 修复成功率 | > 80% | 📊 待统计 |
| 团队遵守率 | > 95% | 📊 待统计 |

#### 2.3 规则覆盖度审查

**技术栈覆盖**：

- [x] JavaScript/Node.js
- [x] Electron 主进程
- [x] Vue3 渲染进程
- [ ] Java 后端服务
- [ ] Python AI 服务
- [ ] Docker 配置
- [ ] GitHub Actions

**安全领域覆盖**：

- [x] SQL 注入（SQLite/better-sqlite3）
- [x] 加密/解密（P2P 消息）
- [x] 敏感信息泄露
- [ ] XSS（跨站脚本）
- [ ] CSRF（跨站请求伪造）
- [ ] 认证/授权
- [ ] 文件上传安全

---

### 3. 规则更新流程

#### 3.1 提议新规则

**新规则提案模板**：

```markdown
## 规则提案

### 背景
为什么需要这个规则？遇到了什么问题？

### 规则描述
- **类型**: 强制 / 建议 / 警告
- **适用范围**: 模块/文件类型
- **检测方法**: 静态分析 / 运行时检查

### 示例

#### ✅ 正确
\`\`\`javascript
// 示例代码
\`\`\`

#### ❌ 错误
\`\`\`javascript
// 示例代码
\`\`\`

### 实施计划
- [ ] 更新 rules.md
- [ ] 更新 rules-validator.js
- [ ] 添加测试用例
- [ ] 团队培训

### 影响评估
- 预计影响文件数: X 个
- 预计修复工作量: X 人日
- 向后兼容性: 是 / 否
```

#### 3.2 审批流程

1. **技术评审**（2 天）
   - 核心开发团队投票
   - 需要 >= 2/3 同意

2. **试运行**（1 周）
   - 在 CI/CD 中启用（警告模式）
   - 收集误报数据

3. **正式发布**
   - 更新 `.chainlesschain/rules.md`
   - 更新验证器代码
   - 发布公告

#### 3.3 废弃旧规则

**废弃标准**：
- 连续 3 个月无违反记录
- 技术栈已废弃
- 被更严格的规则取代

**废弃流程**：
1. 标记为 `deprecated`（保留 1 个月）
2. 从验证器中移除
3. 从 rules.md 归档到历史记录

---

### 4. 规则执行监控

#### 4.1 统计指标

**每月统计报告应包含**：

```
规则违反统计（最近 30 天）
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
SQL 注入:          12 次 (↓ 45%)
P2P 加密:           3 次 (↓ 67%)
敏感信息泄露:       8 次 (→  0%)
依赖项漏洞:        50 个 (↑ 12%)

修复率:            78% (目标: >80%)
平均修复时间:      2.3 天 (目标: <3天)
```

#### 4.2 问题分类

| 分类 | 描述 | 处理优先级 |
|------|------|------------|
| 🔴 Critical | 严重安全漏洞 | P0 - 立即修复 |
| 🟠 High | 高风险问题 | P1 - 本周修复 |
| 🟡 Medium | 中风险问题 | P2 - 本月修复 |
| 🟢 Low | 低风险/优化建议 | P3 - 计划修复 |

---

### 5. 团队培训

#### 5.1 新规则培训

**培训内容**：
- 规则背景和目的
- 正确/错误示例对比
- 修复工具使用方法
- 常见问题 FAQ

**培训形式**：
- 每月技术分享会
- 文档 + 视频教程
- 一对一代码评审

#### 5.2 规则文档维护

**文档结构**：

```
.chainlesschain/
├── rules.md                    # 主规则文档
├── RULES_REVIEW_GUIDE.md       # 本文件
├── examples/                   # 示例代码
│   ├── sql-injection-bad.js
│   ├── sql-injection-good.js
│   ├── p2p-encryption-bad.js
│   └── p2p-encryption-good.js
└── history/                    # 历史记录
    └── deprecated-rules.md
```

---

## 🔄 审查时间表

### 常规审查

| 时间 | 内容 | 负责人 |
|------|------|--------|
| 每周一 | 查看上周规则违反情况 | 技术负责人 |
| 每月 1 日 | 月度规则审查会议 | 核心团队 |
| 每季度 | 全面规则体系评估 | 技术委员会 |

### 特殊触发审查

- 发现新的安全漏洞类型
- 引入新技术栈
- 团队成员反馈
- 连续 3 次规则误报

---

## 📊 审查记录模板

```markdown
# 规则审查记录 - YYYY-MM

## 参与人员
- 技术负责人: XXX
- 核心开发: XXX, XXX
- 安全顾问: XXX

## 审查结果

### 新增规则
1. [规则名称] - [提案链接]

### 更新规则
1. [规则名称] - 更新内容

### 废弃规则
1. [规则名称] - 废弃原因

### 统计数据
- 规则总数: X 条
- 本月违反: X 次
- 修复率: X%

## 行动项
- [ ] 更新文档
- [ ] 部署验证器
- [ ] 团队培训

## 下次审查
- 时间: YYYY-MM-DD
- 重点: XXX
```

---

## 🛠️ 工具清单

### 自动化工具

| 工具 | 用途 | 命令 |
|------|------|------|
| `rules-validator.js` | 代码规则检查 | `npm run validate:rules` |
| `fix-sql-injection.js` | SQL 注入修复 | `node scripts/fix-sql-injection.js` |
| Husky | Git Hooks | 自动触发 |
| GitHub Actions | CI/CD 检查 | 自动触发 |

### 手动工具

- **代码审查清单**: `.chainlesschain/review-checklist.md`
- **安全扫描工具**: OWASP ZAP, SonarQube（待集成）
- **依赖检查**: `npm audit`, Snyk（待集成）

---

## 📚 参考资料

### 行业标准

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [CWE/SANS Top 25](https://cwe.mitre.org/top25/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Node.js Security Best Practices](https://nodejs.org/en/docs/guides/security/)

### 内部文档

- [`.chainlesschain/rules.md`](./rules.md) - 主规则文档
- [`CLAUDE.md`](../CLAUDE.md) - 项目开发指南
- [`IMPLEMENTATION_COMPLETE.md`](../IMPLEMENTATION_COMPLETE.md) - 实施状态

---

## 💡 改进建议提交

**方式 1: GitHub Issue**
- 标签: `rules`, `security`, `improvement`
- 模板: 使用 `.github/ISSUE_TEMPLATE/rule-proposal.md`

**方式 2: 团队会议**
- 每月规则审查会议
- 技术分享会

**方式 3: Pull Request**
- 直接提交规则更新 PR
- 需要至少 2 人 review

---

**最后更新**: 2026-01-16
**维护者**: 技术团队
**审核周期**: 每月
