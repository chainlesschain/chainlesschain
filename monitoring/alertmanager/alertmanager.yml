# AlertManager é…ç½®æ–‡ä»¶
# ç”¨é€”: å®šä¹‰å‘Šè­¦è·¯ç”±å’Œé€šçŸ¥æ–¹å¼

global:
  # SMTPé‚®ä»¶é…ç½®
  smtp_smarthost: 'smtp.example.com:587'
  smtp_from: 'alertmanager@chainlesschain.com'
  smtp_auth_username: 'alertmanager@chainlesschain.com'
  smtp_auth_password: 'your-smtp-password'
  smtp_require_tls: true

  # é»˜è®¤é€šçŸ¥æ¨¡æ¿
  resolve_timeout: 5m

# å‘Šè­¦è·¯ç”±é…ç½®
route:
  # é»˜è®¤åˆ†ç»„
  group_by: ['alertname', 'cluster', 'service']
  group_wait: 10s  # ç­‰å¾…10ç§’æ”¶é›†åŒç»„å‘Šè­¦
  group_interval: 10s  # åŒç»„å‘Šè­¦é—´éš”10ç§’
  repeat_interval: 12h  # é‡å¤å‘Šè­¦é—´éš”12å°æ—¶

  # é»˜è®¤æ¥æ”¶è€…
  receiver: 'default-receiver'

  # å­è·¯ç”±
  routes:
    # ä¸¥é‡å‘Šè­¦ - ç«‹å³é€šçŸ¥å¤šä¸ªæ¸ é“
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      repeat_interval: 4h
      routes:
        # æœåŠ¡å®•æœº - ç´§æ€¥é€šçŸ¥
        - match_re:
            alertname: '.*ServiceDown|.*Down'
          receiver: 'emergency-alerts'
          group_wait: 0s
          repeat_interval: 1h

    # è­¦å‘Šçº§åˆ« - é‚®ä»¶é€šçŸ¥
    - match:
        severity: warning
      receiver: 'warning-alerts'
      repeat_interval: 12h

    # æ•°æ®åº“å‘Šè­¦
    - match:
        service: database
      receiver: 'database-team'

    # å®‰å…¨å‘Šè­¦
    - match_re:
        alertname: '.*Authentication.*|.*Suspicious.*'
      receiver: 'security-team'
      group_wait: 0s
      repeat_interval: 6h

# å‘Šè­¦æŠ‘åˆ¶è§„åˆ™ï¼ˆé˜²æ­¢å‘Šè­¦é£æš´ï¼‰
inhibit_rules:
  # å¦‚æœæœåŠ¡å®•æœºï¼ŒæŠ‘åˆ¶å…¶ä»–æ‰€æœ‰ç›¸å…³å‘Šè­¦
  - source_match:
      severity: 'critical'
      alertname: '.*ServiceDown'
    target_match:
      severity: 'warning'
    equal: ['service', 'instance']

  # å¦‚æœç£ç›˜å³å°†æ»¡ï¼ŒæŠ‘åˆ¶ç£ç›˜ä½¿ç”¨ç‡å‘Šè­¦
  - source_match:
      alertname: 'DiskAlmostFull'
    target_match:
      alertname: 'HighDiskUsage'
    equal: ['instance', 'mountpoint']

# æ¥æ”¶è€…é…ç½®
receivers:
  # ==================== é»˜è®¤æ¥æ”¶è€… ====================
  - name: 'default-receiver'
    email_configs:
      - to: 'ops-team@chainlesschain.com'
        headers:
          Subject: '[ChainlessChain] {{ .GroupLabels.alertname }}'
        html: |
          {{ range .Alerts }}
          <h3>{{ .Labels.alertname }}</h3>
          <p><strong>ä¸¥é‡ç¨‹åº¦:</strong> {{ .Labels.severity }}</p>
          <p><strong>æè¿°:</strong> {{ .Annotations.description }}</p>
          <p><strong>å®ä¾‹:</strong> {{ .Labels.instance }}</p>
          <p><strong>æ—¶é—´:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
          {{ end }}

  # ==================== ä¸¥é‡å‘Šè­¦ ====================
  - name: 'critical-alerts'
    # é‚®ä»¶é€šçŸ¥
    email_configs:
      - to: 'ops-team@chainlesschain.com,cto@chainlesschain.com'
        headers:
          Subject: 'ğŸš¨ [CRITICAL] {{ .GroupLabels.alertname }}'
        send_resolved: true

    # é’‰é’‰é€šçŸ¥
    webhook_configs:
      - url: 'http://dingtalk-webhook:8060/dingtalk/webhook1/send'
        send_resolved: true

    # ä¼ä¸šå¾®ä¿¡é€šçŸ¥
    # wechat_configs:
    #   - corp_id: 'your-corp-id'
    #     to_user: '@all'
    #     agent_id: 'your-agent-id'
    #     api_secret: 'your-api-secret'

  # ==================== ç´§æ€¥å‘Šè­¦ï¼ˆæœåŠ¡å®•æœºï¼‰====================
  - name: 'emergency-alerts'
    # é‚®ä»¶é€šçŸ¥
    email_configs:
      - to: 'ops-team@chainlesschain.com,cto@chainlesschain.com'
        headers:
          Subject: 'ğŸ”¥ [EMERGENCY] æœåŠ¡å®•æœº: {{ .GroupLabels.service }}'
        send_resolved: true

    # é’‰é’‰é€šçŸ¥ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
    webhook_configs:
      - url: 'http://dingtalk-webhook:8060/dingtalk/webhook1/send'
        send_resolved: true

    # Slacké€šçŸ¥ï¼ˆå¯é€‰ï¼‰
    # slack_configs:
    #   - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
    #     channel: '#alerts-critical'
    #     title: 'ğŸ”¥ æœåŠ¡å®•æœº'
    #     text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'

    # PagerDutyé€šçŸ¥ï¼ˆå¯é€‰ï¼Œé€‚åˆ24/7å€¼ç­ï¼‰
    # pagerduty_configs:
    #   - service_key: 'your-pagerduty-service-key'

  # ==================== è­¦å‘Šå‘Šè­¦ ====================
  - name: 'warning-alerts'
    email_configs:
      - to: 'ops-team@chainlesschain.com'
        headers:
          Subject: 'âš ï¸ [WARNING] {{ .GroupLabels.alertname }}'
        send_resolved: true

  # ==================== æ•°æ®åº“å›¢é˜Ÿ ====================
  - name: 'database-team'
    email_configs:
      - to: 'dba-team@chainlesschain.com'
        headers:
          Subject: '[æ•°æ®åº“å‘Šè­¦] {{ .GroupLabels.alertname }}'
        send_resolved: true

  # ==================== å®‰å…¨å›¢é˜Ÿ ====================
  - name: 'security-team'
    email_configs:
      - to: 'security-team@chainlesschain.com'
        headers:
          Subject: 'ğŸ›¡ï¸ [å®‰å…¨å‘Šè­¦] {{ .GroupLabels.alertname }}'
        send_resolved: true

    webhook_configs:
      - url: 'http://dingtalk-webhook:8060/dingtalk/webhook2/send'

# å‘Šè­¦æ¨¡æ¿
templates:
  - '/etc/alertmanager/templates/*.tmpl'
