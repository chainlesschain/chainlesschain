name: Android Tests

on:
  push:
    branches: [main, develop]
    paths:
      - "android-app/**"
      - ".github/workflows/android-tests.yml"
  pull_request:
    branches: [main, develop]
    paths:
      - "android-app/**"

jobs:
  unit-tests:
    name: Unit Tests (P0 + P1 DAO)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Grant execute permission for gradlew
        run: chmod +x android-app/gradlew

      - name: Run P0 Critical Security Tests
        run: |
          cd android-app
          ./gradlew :core-e2ee:testDebugUnitTest \
            --tests "*DoubleRatchetTest" \
            --tests "*X3DHKeyExchangeTest" \
            --no-daemon
          ./gradlew :core-network:testDebugUnitTest \
            --tests "*LinkPreviewFetcherTest" \
            --no-daemon

      - name: Run P1 DAO Tests
        run: |
          cd android-app
          ./gradlew :core-database:testDebugUnitTest \
            --tests "*DaoTest" \
            --no-daemon

      - name: Run All Unit Tests
        run: |
          cd android-app
          ./gradlew test --no-daemon

      - name: Upload Unit Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: unit-test-results
          path: android-app/**/build/test-results/testDebugUnitTest/
          retention-days: 7

      - name: Upload Unit Test Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: unit-test-reports
          path: android-app/**/build/reports/tests/testDebugUnitTest/
          retention-days: 7

  instrumented-tests:
    name: Instrumented Tests (P1 Integration + P2 UI)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      matrix:
        api-level: [28, 30]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x android-app/gradlew

      - name: Enable KVM group perms
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: AVD cache
        uses: actions/cache@v3
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: avd-${{ matrix.api-level }}

      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: google_apis
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: echo "Generated AVD snapshot for caching."

      - name: Run P1 Integration Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: google_apis
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            cd android-app
            ./gradlew :core-e2ee:connectedAndroidTest --tests "*E2EEIntegrationTest*"
            ./gradlew :feature-p2p:connectedAndroidTest --tests "*P2PIntegrationTest*"
            ./gradlew :feature-ai:connectedAndroidTest --tests "*AI_RAG_IntegrationTest*"

      - name: Run P2 UI Component Tests
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: ${{ matrix.api-level }}
          target: google_apis
          arch: x86_64
          force-avd-creation: false
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          disable-animations: true
          script: |
            cd android-app
            ./gradlew :feature-knowledge:connectedAndroidTest --tests "*KnowledgeUITest*"
            ./gradlew :feature-ai:connectedAndroidTest --tests "*AIConversationUITest*"
            ./gradlew :feature-p2p:connectedAndroidTest --tests "*SocialPostUITest*"
            ./gradlew :feature-project:connectedAndroidTest --tests "*ProjectEditorUITest*"

      - name: Upload Instrumented Test Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: instrumented-test-results-api${{ matrix.api-level }}
          path: android-app/**/build/outputs/androidTest-results/
          retention-days: 7

      - name: Upload Instrumented Test Reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: instrumented-test-reports-api${{ matrix.api-level }}
          path: android-app/**/build/reports/androidTests/
          retention-days: 7

  coverage:
    name: Code Coverage
    runs-on: ubuntu-latest
    needs: unit-tests
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x android-app/gradlew

      - name: Run tests with coverage
        run: |
          cd android-app
          ./gradlew test jacocoTestReport --no-daemon

      - name: Verify coverage thresholds
        run: |
          cd android-app
          ./gradlew jacocoTestCoverageVerification --no-daemon

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: android-app/app/build/reports/jacoco/jacocoTestReport/jacocoTestReport.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: coverage-reports
          path: android-app/**/build/reports/jacoco/
          retention-days: 30

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [unit-tests, instrumented-tests, coverage]
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v3

      - name: Publish Test Summary
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            **/test-results/**/*.xml
            **/androidTest-results/**/*.xml

  lint:
    name: Lint & Static Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "gradle"

      - name: Grant execute permission for gradlew
        run: chmod +x android-app/gradlew

      - name: Run Android Lint
        run: |
          cd android-app
          ./gradlew lint --no-daemon

      - name: Upload Lint Results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: lint-results
          path: android-app/**/build/reports/lint-results-*.html
          retention-days: 7

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Grant execute permission for gradlew
        run: chmod +x android-app/gradlew

      - name: Run OWASP Dependency Check
        run: |
          cd android-app
          ./gradlew dependencyCheckAnalyze --no-daemon || true
        continue-on-error: true

      - name: Upload Security Report
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: security-report
          path: android-app/build/reports/dependency-check-report.html
          retention-days: 7

  build-status:
    name: Build Status Check
    runs-on: ubuntu-latest
    needs: [unit-tests, instrumented-tests, coverage, lint, security-scan]
    if: always()

    steps:
      - name: Check build status
        run: |
          if [[ "${{ needs.unit-tests.result }}" == "success" ]] && \
             [[ "${{ needs.instrumented-tests.result }}" == "success" ]] && \
             [[ "${{ needs.coverage.result }}" == "success" ]]; then
            echo "‚úÖ All critical tests passed!"
            echo "üìä Test Summary:"
            echo "  - Unit Tests: ${{ needs.unit-tests.result }}"
            echo "  - Instrumented Tests: ${{ needs.instrumented-tests.result }}"
            echo "  - Coverage: ${{ needs.coverage.result }}"
            echo "  - Lint: ${{ needs.lint.result }}"
            echo "  - Security: ${{ needs.security-scan.result }}"
            exit 0
          else
            echo "‚ùå Some tests failed!"
            echo "üìä Test Summary:"
            echo "  - Unit Tests: ${{ needs.unit-tests.result }}"
            echo "  - Instrumented Tests: ${{ needs.instrumented-tests.result }}"
            echo "  - Coverage: ${{ needs.coverage.result }}"
            echo "  - Lint: ${{ needs.lint.result }}"
            echo "  - Security: ${{ needs.security-scan.result }}"
            exit 1
          fi

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const output = `#### Android Tests üß™
            - Unit Tests: \`${{ needs.unit-tests.result }}\`
            - Instrumented Tests: \`${{ needs.instrumented-tests.result }}\`
            - Coverage: \`${{ needs.coverage.result }}\`
            - Lint: \`${{ needs.lint.result }}\`
            - Security Scan: \`${{ needs.security-scan.result }}\`

            *Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });
