name: PR Tests

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # å¿«é€Ÿæµ‹è¯•ï¼ˆåªè¿è¡Œæ ¸å¿ƒæµ‹è¯•ï¼‰
  quick-tests:
    name: Quick Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run Jest tests (no coverage)
        run: npm run test:jest
        continue-on-error: true

      - name: Run Vitest tests (no coverage)
        run: npx vitest run tests/unit/ai-engine-workflow.test.js tests/unit/ai-skill-scheduler.test.js
        continue-on-error: true

      - name: Comment PR
        uses: actions/github-script@v7
        if: always()
        with:
          script: |
            const output = `
            ## ðŸ§ª Test Results

            Quick tests have been executed on this PR.

            - âœ… Jest tests completed
            - âœ… Vitest tests completed

            For detailed coverage reports, please check the full test workflow.
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            });

  # ä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Install dependencies
        run: npm install --legacy-peer-deps

      - name: Run ESLint
        run: npm run lint
        continue-on-error: true

      - name: Check for test files
        run: |
          changed_files=$(git diff --name-only origin/main...HEAD)
          test_files=$(echo "$changed_files" | grep -E '\.test\.(js|ts)$' || true)

          if [ -z "$test_files" ]; then
            echo "âš ï¸ Warning: No test files were modified in this PR"
            echo "warning=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Test files found: $test_files"
          fi
