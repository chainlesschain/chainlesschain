name: Documentation Generation

on:
  push:
    branches:
      - main
    paths:
      - "desktop-app-vue/src/**/*.js"
      - "desktop-app-vue/src/**/*.vue"
      - "desktop-app-vue/scripts/cowork-doc-generator.js"
      - ".github/workflows/documentation.yml"
  pull_request:
    branches:
      - main
    paths:
      - "desktop-app-vue/src/**/*.js"
      - "desktop-app-vue/src/**/*.vue"
  workflow_dispatch: # Allow manual trigger
    inputs:
      doc_type:
        description: "Documentation type to generate"
        required: false
        default: "all"
        type: choice
        options:
          - all
          - api
          - user-guide
          - changelog
          - architecture

permissions:
  contents: write

jobs:
  generate-docs:
    name: Generate Documentation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Full history for changelog
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            desktop-app-vue/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-docs-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-docs-
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ./desktop-app-vue
        run: npm install --legacy-peer-deps --ignore-optional

      - name: Preview documentation changes
        working-directory: ./desktop-app-vue
        run: |
          echo "ðŸ“š Previewing documentation generation..."
          node scripts/cowork-doc-generator.js --type ${{ github.event.inputs.doc_type || 'all' }} --dry-run

      - name: Generate documentation
        working-directory: ./desktop-app-vue
        run: |
          echo "ðŸ“– Generating documentation..."
          node scripts/cowork-doc-generator.js --type ${{ github.event.inputs.doc_type || 'all' }}

      - name: Check for documentation changes
        id: check-changes
        working-directory: ./desktop-app-vue
        run: |
          if git diff --quiet docs/ CHANGELOG.md 2>/dev/null; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  No documentation changes detected"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "âœ… Documentation changes detected"
            git diff --stat docs/ CHANGELOG.md
          fi

      - name: Commit documentation updates (main branch only)
        if: |
          steps.check-changes.outputs.has_changes == 'true' &&
          github.event_name == 'push' &&
          github.ref == 'refs/heads/main'
        working-directory: ./desktop-app-vue
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/ CHANGELOG.md
          git commit -m "docs: auto-generate documentation from latest changes

          Generated by Cowork Documentation Generator

          - API reference updated
          - User guide updated
          - Architecture docs updated
          - Changelog updated

          Co-Authored-By: Cowork Documentation Team <noreply@chainlesschain.com>"
          git pull --rebase origin main || true
          git push

      - name: Upload documentation artifacts
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: generated-docs
          path: |
            desktop-app-vue/docs/api/generated/
            desktop-app-vue/docs/user-guide/
            desktop-app-vue/docs/architecture/
            desktop-app-vue/CHANGELOG.md
          retention-days: 30

      - name: Generate documentation summary
        if: github.event_name == 'pull_request'
        working-directory: ./desktop-app-vue
        run: |
          echo "## ðŸ“š Documentation Changes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Documentation has been generated for this PR." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -d "docs/api/generated" ]; then
            api_count=$(find docs/api/generated -name "*.md" 2>/dev/null | wc -l)
            echo "- **API Documentation**: $api_count files" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "docs/user-guide/COMPONENT_REFERENCE.md" ]; then
            echo "- **User Guide**: Component reference updated" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "docs/architecture/ARCHITECTURE_OVERVIEW.md" ]; then
            echo "- **Architecture**: Overview updated" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "CHANGELOG.md" ]; then
            echo "- **Changelog**: Updated from git history" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Changes Summary" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          git diff --stat docs/ CHANGELOG.md 2>/dev/null || echo "No changes"
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

  validate-docs:
    name: Validate Documentation Quality
    runs-on: ubuntu-latest
    needs: generate-docs
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download generated documentation
        uses: actions/download-artifact@v4
        with:
          name: generated-docs
          path: desktop-app-vue/

      - name: Validate documentation structure
        working-directory: ./desktop-app-vue
        run: |
          echo "ðŸ“‹ Validating documentation structure..."

          # Check required directories exist
          required_dirs=("docs/api" "docs/user-guide" "docs/architecture")
          for dir in "${required_dirs[@]}"; do
            if [ ! -d "$dir" ]; then
              echo "âŒ Missing required directory: $dir"
              exit 1
            fi
            echo "âœ… Directory exists: $dir"
          done

          # Check required files exist
          if [ ! -f "CHANGELOG.md" ]; then
            echo "âŒ Missing CHANGELOG.md"
            exit 1
          fi
          echo "âœ… CHANGELOG.md exists"

      - name: Check for broken links (optional)
        working-directory: ./desktop-app-vue
        continue-on-error: true
        run: |
          echo "ðŸ”— Checking for broken internal links..."

          # Simple broken link detection
          find docs -name "*.md" -type f -exec grep -H "\[.*\](.*)" {} \; > /tmp/links.txt || true

          if [ -s /tmp/links.txt ]; then
            echo "Found $(wc -l < /tmp/links.txt) markdown links"
          else
            echo "No markdown links found or all links are valid"
          fi

      - name: Documentation quality summary
        run: |
          echo "## ðŸ“Š Documentation Quality Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All documentation structure checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- Target: 95%" >> $GITHUB_STEP_SUMMARY
          echo "- Current: Needs manual assessment" >> $GITHUB_STEP_SUMMARY
