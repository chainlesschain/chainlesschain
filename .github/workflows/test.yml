name: CI Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # å¿«é€Ÿå•å…ƒæµ‹è¯•ï¼ˆæ’é™¤ä¸ç¨³å®šæµ‹è¯•ï¼‰
  unit-tests:
    name: Unit Tests
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        node-version: [22.x]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            desktop-app-vue/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ./desktop-app-vue
        run: npm install --legacy-peer-deps

      - name: Run TypeScript type check
        working-directory: ./desktop-app-vue
        run: npm run type-check

      - name: Fetch base branch for diff
        run: |
          git fetch origin ${{ github.base_ref || 'main' }}:refs/remotes/origin/${{ github.base_ref || 'main' }}

      - name: Run intelligent test selection
        id: test-selector
        working-directory: ./desktop-app-vue
        shell: bash
        run: |
          echo "ğŸ§ª Running Cowork intelligent test selection..."
          node scripts/cowork-ci-test-selector.js
        continue-on-error: true

      - name: Run stable unit tests (fallback)
        if: steps.test-selector.outcome == 'failure'
        working-directory: ./desktop-app-vue
        shell: bash
        run: |
          echo "âš ï¸  Intelligent test selection failed, running stable test suite..."
          npx vitest run tests/unit \
            --exclude="**/media/ocr-service.test.js" \
            --exclude="**/mcp/**" \
            --exclude="**/p2p/**" \
            --exclude="**/ukey/**" \
            --exclude="**/blockchain/**" \
            --exclude="**/components/**" \
            --exclude="**/import/**" \
            --exclude="**/extended-tools*.test.js" \
            --exclude="**/*-ipc.test.js" \
            --exclude="**/llm/session-manager*.test.js" \
            --exclude="**/llm/llm-performance.test.js" \
            --exclude="**/tools/tool-manager.test.js" \
            --exclude="**/ai/skill-manager.test.js" \
            --exclude="**/document/word-engine.test.js" \
            --exclude="**/media/image-engine.test.js" \
            --exclude="**/did/did-invitation.test.js" \
            --exclude="**/core/ipc-guard.test.js" \
            --exclude="**/security/permission-system.test.js" \
            --exclude="**/api/**" \
            --exclude="**/pages/**" \
            --exclude="**/stores/**" \
            --exclude="**/sync/**" \
            --exclude="**/ai/builtin-tools.test.js" \
            --exclude="**/document/pdf-engine.test.js" \
            --exclude="**/document/ppt-engine.test.js" \
            --exclude="**/integration/p2p-sync-engine.test.js" \
            --exclude="**/components/planning-components.test.js" \
            --exclude="**/pages/PlanningView.test.js" \
            --exclude="**/core/function-caller.test.js" \
            --exclude="**/core/response-parser.test.js" \
            --exclude="**/media/speech-recognizer.test.js" \
            --exclude="**/planning/task-planner*.test.js" \
            --exclude="**/planning/taskPlanner.test.js" \
            --exclude="**/src/main/**/__tests__/**" \
            --exclude="**/src/renderer/**/__tests__/**" \
            --exclude="**/tests/integration/**"

  # ä»£ç è´¨é‡æ£€æŸ¥
  lint:
    name: Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            desktop-app-vue/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ./desktop-app-vue
        run: npm install --legacy-peer-deps

      - name: Run ESLint
        working-directory: ./desktop-app-vue
        run: npm run lint --if-present
        continue-on-error: true

      - name: Run rules validator
        working-directory: ./desktop-app-vue
        run: npm run validate:rules
        continue-on-error: true

  # æ„å»ºæ£€æŸ¥
  build:
    name: Build Check
    runs-on: ${{ matrix.os }}
    timeout-minutes: 15

    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            desktop-app-vue/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ./desktop-app-vue
        run: npm install --legacy-peer-deps

      - name: Build main process
        working-directory: ./desktop-app-vue
        run: npm run build:main

      - name: Build renderer
        working-directory: ./desktop-app-vue
        run: npm run build:renderer

      - name: Archive build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}
          path: |
            desktop-app-vue/dist/
          retention-days: 7

  # æ•°æ®åº“æµ‹è¯•ï¼ˆä»… Linuxï¼Œéœ€è¦ SQLiteï¼‰
  database-tests:
    name: Database Tests
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            desktop-app-vue/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ./desktop-app-vue
        run: npm install --legacy-peer-deps

      - name: Run database tests
        working-directory: ./desktop-app-vue
        run: npm run test:db
        continue-on-error: true

  # å®Œæ•´æµ‹è¯•ï¼ˆå¯é€‰ï¼Œæ‰‹åŠ¨è§¦å‘æˆ–å®šæ—¶è¿è¡Œï¼‰
  full-tests:
    name: Full Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.ref == 'refs/heads/main')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"

      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: |
            desktop-app-vue/node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Install dependencies
        working-directory: ./desktop-app-vue
        run: npm install --legacy-peer-deps

      - name: Run all unit tests
        working-directory: ./desktop-app-vue
        run: npm run test:unit
        continue-on-error: true

      - name: Run test coverage
        working-directory: ./desktop-app-vue
        run: npm run test:coverage
        continue-on-error: true

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: ./desktop-app-vue/coverage/lcov.info
          flags: unittests
          name: codecov-full
          fail_ci_if_error: false

      - name: Archive coverage reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: desktop-app-vue/coverage/
          retention-days: 30
