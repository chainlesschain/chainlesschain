name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v0.20.0)"
        required: true
        type: string
      draft:
        description: "Create as draft"
        required: false
        type: boolean
        default: true
      prerelease:
        description: "Mark as prerelease"
        required: false
        type: boolean
        default: false

jobs:
  # Build for Windows
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build main process
        working-directory: desktop-app-vue
        run: npm run build:main

      - name: Build renderer
        working-directory: desktop-app-vue
        run: npm run build:renderer
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Link hoisted modules for packaging
        shell: cmd
        run: |
          @REM Use directory junction (mklink /J) for instant linking instead of slow copy
          @REM This is MUCH faster than robocopy for large node_modules directories
          if exist "desktop-app-vue\node_modules" rmdir /s /q "desktop-app-vue\node_modules"
          mklink /J "desktop-app-vue\node_modules" "%CD%\node_modules"
          if %ERRORLEVEL% NEQ 0 (
            echo Junction failed, falling back to xcopy...
            xcopy node_modules desktop-app-vue\node_modules /E /I /H /Y /Q
          )
          echo Hoisted modules linked to desktop-app-vue

      - name: Package Windows
        working-directory: desktop-app-vue
        run: npm run make:win
        env:
          CHAINLESSCHAIN_DISABLE_NATIVE_DB: "1"
          SKIP_BACKEND_CHECK: "true"
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            desktop-app-vue/out/make/**/*.zip
            desktop-app-vue/out/make/**/*.exe
          retention-days: 7

  # Build for macOS
  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        arch: [x64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build main process
        working-directory: desktop-app-vue
        run: npm run build:main

      - name: Build renderer
        working-directory: desktop-app-vue
        run: npm run build:renderer
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Link hoisted modules for packaging
        run: |
          rm -rf desktop-app-vue/node_modules
          ln -s "$(pwd)/node_modules" desktop-app-vue/node_modules
          echo "Hoisted modules symlinked to desktop-app-vue"

      - name: Package macOS (${{ matrix.arch }})
        working-directory: desktop-app-vue
        run: npm run make:mac:${{ matrix.arch }}
        env:
          CHAINLESSCHAIN_DISABLE_NATIVE_DB: "1"
          SKIP_BACKEND_CHECK: "true"
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-${{ matrix.arch }}-artifacts
          path: |
            desktop-app-vue/out/make/**/*.dmg
            desktop-app-vue/out/make/**/*.zip
          retention-days: 7

  # Build for Linux
  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            rpm \
            fakeroot \
            dpkg \
            libarchive-tools

      - name: Install dependencies
        run: npm ci

      - name: Build main process
        working-directory: desktop-app-vue
        run: npm run build:main

      - name: Build renderer
        working-directory: desktop-app-vue
        run: npm run build:renderer
        env:
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Link hoisted modules for packaging
        run: |
          rm -rf desktop-app-vue/node_modules
          ln -s "$(pwd)/node_modules" desktop-app-vue/node_modules
          echo "Hoisted modules symlinked to desktop-app-vue"

      - name: Package Linux
        working-directory: desktop-app-vue
        # Use make:linux:deb to avoid RPM strip errors with cross-arch native modules
        run: npm run make:linux:deb
        env:
          CHAINLESSCHAIN_DISABLE_NATIVE_DB: "1"
          SKIP_BACKEND_CHECK: "true"
          NODE_OPTIONS: "--max-old-space-size=4096"

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            desktop-app-vue/out/make/**/*.deb
            desktop-app-vue/out/make/**/*.zip
          retention-days: 7

  # Build for iOS
  build-ios:
    runs-on: macos-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode.app/Contents/Developer

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Install Ruby dependencies
        run: |
          gem install xcodeproj
          echo "âœ… xcodeproj gem installed"

      - name: Generate Xcode project
        working-directory: ios-app
        run: |
          ruby create_xcode_project.rb
          echo "âœ… Xcode project generated"
          ls -la *.xcodeproj || true

      - name: Resolve Swift Package dependencies
        working-directory: ios-app
        run: |
          xcodebuild -resolvePackageDependencies \
            -project ChainlessChain.xcodeproj \
            -scheme ChainlessChain \
            -clonedSourcePackagesDirPath .spm-cache || true
          echo "âœ… Package dependencies resolved"

      - name: Decode signing certificate
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          IOS_CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          IOS_PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
        run: |
          if [ -n "$IOS_CERTIFICATE_BASE64" ]; then
            # Create keychain
            KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
            security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
            security default-keychain -s build.keychain
            security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
            security set-keychain-settings -lut 21600 build.keychain

            # Import certificate
            echo "$IOS_CERTIFICATE_BASE64" | base64 -d > certificate.p12
            security import certificate.p12 -k build.keychain -P "$IOS_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
            security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
            rm certificate.p12

            # Install provisioning profile
            if [ -n "$IOS_PROVISIONING_PROFILE_BASE64" ]; then
              mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
              echo "$IOS_PROVISIONING_PROFILE_BASE64" | base64 -d > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
            fi

            echo "âœ… Signing certificate configured"
            echo "SIGNING_AVAILABLE=true" >> $GITHUB_ENV
          else
            echo "âš ï¸ No signing certificate found, building unsigned"
            echo "SIGNING_AVAILABLE=false" >> $GITHUB_ENV
          fi

      - name: Build iOS app (Signed)
        if: env.SIGNING_AVAILABLE == 'true'
        working-directory: ios-app
        env:
          IOS_TEAM_ID: ${{ secrets.IOS_TEAM_ID }}
        run: |
          xcodebuild archive \
            -project ChainlessChain.xcodeproj \
            -scheme ChainlessChain \
            -configuration Release \
            -archivePath build/ChainlessChain.xcarchive \
            -destination 'generic/platform=iOS' \
            DEVELOPMENT_TEAM="$IOS_TEAM_ID" \
            CODE_SIGN_STYLE=Manual \
            -allowProvisioningUpdates

      - name: Build iOS app (Simulator - Unsigned)
        if: env.SIGNING_AVAILABLE != 'true'
        working-directory: ios-app
        run: |
          # Build for simulator (no signing required)
          xcodebuild build \
            -project ChainlessChain.xcodeproj \
            -scheme ChainlessChain \
            -configuration Release \
            -destination 'generic/platform=iOS Simulator' \
            -derivedDataPath build/DerivedData \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO || echo "âš ï¸ Build completed with warnings"

          # Create a simulator app archive
          mkdir -p build/output
          if [ -d "build/DerivedData/Build/Products/Release-iphonesimulator/ChainlessChain.app" ]; then
            cd build/DerivedData/Build/Products/Release-iphonesimulator
            zip -r ../../../../output/ChainlessChain-ios-simulator.zip ChainlessChain.app
            echo "âœ… Simulator build packaged"
          fi

      - name: Export IPA
        if: env.SIGNING_AVAILABLE == 'true'
        working-directory: ios-app
        run: |
          # Create export options plist
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>ad-hoc</string>
            <key>teamID</key>
            <string>${{ secrets.IOS_TEAM_ID }}</string>
            <key>compileBitcode</key>
            <false/>
            <key>stripSwiftSymbols</key>
            <true/>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath build/ChainlessChain.xcarchive \
            -exportPath build/output \
            -exportOptionsPlist ExportOptions.plist

          echo "âœ… IPA exported"
          ls -la build/output/

      - name: Clean up keychain
        if: always()
        run: |
          security delete-keychain build.keychain 2>/dev/null || true

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          path: |
            ios-app/build/output/*.ipa
            ios-app/build/output/*.zip
          if-no-files-found: warn
          retention-days: 7

  # Build for Android
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: "17"
          distribution: "temurin"
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x android-app/gradlew

      - name: Decode keystore
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > android-app/keystore.jks
            echo "âœ… Keystore decoded successfully"
          else
            echo "âš ï¸ No keystore found, using debug signing"
          fi

      - name: Build release APK
        working-directory: android-app
        env:
          KEYSTORE_FILE: keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -f keystore.jks ]; then
            ./gradlew assembleRelease
          else
            ./gradlew assembleDebug
            mkdir -p app/build/outputs/apk/release
            cp app/build/outputs/apk/debug/app-debug.apk app/build/outputs/apk/release/app-release.apk
          fi

      - name: Build App Bundle
        working-directory: android-app
        env:
          KEYSTORE_FILE: keystore.jks
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -f keystore.jks ]; then
            ./gradlew bundleRelease
          else
            echo "âš ï¸ Skipping bundle build (requires release signing)"
          fi

      - name: Clean up keystore
        if: always()
        run: rm -f android-app/keystore.jks

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            android-app/app/build/outputs/apk/release/*.apk
            android-app/app/build/outputs/bundle/release/*.aab
          retention-days: 7

  # Create GitHub Release
  create-release:
    needs: [build-windows, build-macos, build-linux, build-android, build-ios]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display artifact structure
        run: ls -R artifacts/

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "VERSION=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ steps.version.outputs.VERSION }}"
          PREV_TAG=$(git describe --tags --abbrev=0 ${VERSION}^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            RANGE="${VERSION}"
          else
            RANGE="${PREV_TAG}..${VERSION}"
          fi

          CHANGELOG=$(git log ${RANGE} --pretty=format:"- %s (%h)" --no-merges || echo "Initial release")

          cat > release-notes.md << EOF
          ## ChainlessChain ${VERSION}

          ### What's Changed

          ${CHANGELOG}

          ### Installation

          Download the appropriate file for your platform:

          #### Windows
          - \`ChainlessChain-win32-x64-${VERSION#v}.zip\` - Portable version (extract and run)

          #### macOS
          - \`ChainlessChain-darwin-x64-${VERSION#v}.dmg\` - Intel Mac installer
          - \`ChainlessChain-darwin-arm64-${VERSION#v}.dmg\` - Apple Silicon installer

          #### Linux
          - \`ChainlessChain-${VERSION#v}.AppImage\` - Universal Linux package
          - \`chainlesschain_${VERSION#v}_amd64.deb\` - Debian/Ubuntu package
          - \`chainlesschain-${VERSION#v}.x86_64.rpm\` - Fedora/RHEL package

          #### Android
          - \`app-release.apk\` - Android APK (direct install)
          - \`app-release.aab\` - Android App Bundle (Google Play Store)

          #### iOS
          - \`ChainlessChain.ipa\` - iOS App (Ad-hoc distribution, requires signing)
          - \`ChainlessChain-ios-simulator.zip\` - iOS Simulator build (for testing)

          ### System Requirements

          - **Windows**: Windows 10/11 (x64)
          - **macOS**: macOS 10.15+ (Intel & Apple Silicon)
          - **Linux**: Ubuntu 20.04+ / Fedora 34+ / Arch Linux (x64)
          - **Android**: Android 8.0 (API 26) or higher
          - **iOS**: iOS 15.0+ (iPhone/iPad)

          ### Notes

          - U-Key hardware integration is Windows-only
          - Backend services can run via Docker or bundled binaries
          - First launch may take longer as services initialize

          ### Verification

          All binaries are built via GitHub Actions and can be verified against the workflow runs.

          **Full Changelog**: https://github.com/\${{ github.repository }}/compare/${PREV_TAG}...${VERSION}
          EOF

          cat release-notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          name: ChainlessChain ${{ steps.version.outputs.VERSION }}
          body_path: release-notes.md
          draft: ${{ github.event_name == 'workflow_dispatch' && inputs.draft || false }}
          prerelease: ${{ github.event_name == 'workflow_dispatch' && inputs.prerelease || false }}
          files: |
            artifacts/**/*.zip
            artifacts/**/*.dmg
            artifacts/**/*.deb
            artifacts/**/*.rpm
            artifacts/**/*.AppImage
            artifacts/**/*.exe
            artifacts/**/*.apk
            artifacts/**/*.aab
            artifacts/**/*.ipa
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release created
        run: |
          echo "âœ… Release ${{ steps.version.outputs.VERSION }} created successfully!"
          echo "ðŸ”— View at: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.VERSION }}"
