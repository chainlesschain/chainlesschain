name: üöÄ Multi-Platform Docker Offline Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v0.16.0)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        required: false
        type: boolean
        default: false
      draft:
        description: 'Create as draft'
        required: false
        type: boolean
        default: true

env:
  NODE_VERSION: '20'
  SKIP_BACKEND_CHECK: 'true'
  # ÁºìÂ≠òÈîÆÁâàÊú¨ÔºàÊõ¥Êñ∞Ê≠§ÂÄº‰ª•Âº∫Âà∂ÈáçÊñ∞ÊûÑÂª∫ÁºìÂ≠òÔºâ
  CACHE_VERSION: 'v1'

jobs:
  # Job 1: ÂØºÂá∫ Docker ÈïúÂÉèÔºàÂè™ÈúÄË¶Å‰∏ÄÊ¨°ÔºåÊâÄÊúâÂπ≥Âè∞ÂÖ±Áî®Ôºâ
  export-docker-images:
    name: üì¶ Export Docker Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull Docker images
        run: |
          echo "Pulling PostgreSQL..."
          docker pull postgres:16-alpine

          echo "Pulling Redis..."
          docker pull redis:7-alpine

          echo "Pulling Qdrant..."
          docker pull qdrant/qdrant:v1.12.5

          echo "Pulling Ollama..."
          docker pull ollama/ollama:latest

      - name: Export Docker images
        run: |
          mkdir -p packaging/docker-images

          echo "Exporting PostgreSQL..."
          docker save -o packaging/docker-images/postgres-16-alpine.tar postgres:16-alpine

          echo "Exporting Redis..."
          docker save -o packaging/docker-images/redis-7-alpine.tar redis:7-alpine

          echo "Exporting Qdrant..."
          docker save -o packaging/docker-images/qdrant-qdrant-v1.12.5.tar qdrant/qdrant:v1.12.5

          echo "Exporting Ollama..."
          docker save -o packaging/docker-images/ollama-ollama-latest.tar ollama/ollama:latest

      - name: Create manifest file
        run: |
          cat > packaging/docker-images/images-manifest.txt << EOF
          # ChainlessChain Docker Images Manifest
          # Generated: $(date)
          postgres-16-alpine.tar|postgres:16-alpine
          redis-7-alpine.tar|redis:7-alpine
          qdrant-qdrant-v1.12.5.tar|qdrant/qdrant:v1.12.5
          ollama-ollama-latest.tar|ollama/ollama:latest
          EOF

      - name: Calculate sizes
        run: |
          echo "## Docker Images Sizes" >> $GITHUB_STEP_SUMMARY
          echo "| Image | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|------|" >> $GITHUB_STEP_SUMMARY
          for file in packaging/docker-images/*.tar; do
            size=$(du -h "$file" | cut -f1)
            name=$(basename "$file")
            echo "| $name | $size |" >> $GITHUB_STEP_SUMMARY
          done

          total_size=$(du -sh packaging/docker-images/ | cut -f1)
          echo "| **Total** | **$total_size** |" >> $GITHUB_STEP_SUMMARY

      - name: Upload Docker images artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-images
          path: packaging/docker-images/
          retention-days: 1
          compression-level: 0  # Â∑≤ÁªèÊòØÂéãÁº©ÁöÑ tar Êñá‰ª∂Ôºå‰∏çÈúÄË¶ÅÂÜçÂéãÁº©

  # Job 2: ÊûÑÂª∫ Windows ÂÆâË£ÖÂåÖ
  build-windows:
    name: ü™ü Build Windows
    needs: export-docker-images
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Cache Electron binaries
        uses: actions/cache@v4
        with:
          path: |
            ~\AppData\Local\electron\Cache
            ~\AppData\Local\electron-builder\Cache
          key: ${{ runner.os }}-electron-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-electron-

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            desktop-app-vue/node_modules
          key: ${{ runner.os }}-node-modules-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-node-modules-

      - name: Download Docker images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: packaging/docker-images/

      - name: Verify Docker images
        run: |
          dir packaging\docker-images
          Write-Host "Docker images downloaded successfully"

      - name: Install root dependencies
        run: npm ci

      - name: Install desktop-app-vue dependencies
        working-directory: desktop-app-vue
        run: npm ci

      - name: Setup Windows Code Signing
        if: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 != '' }}
        env:
          WINDOWS_CERTIFICATE_BASE64: ${{ secrets.WINDOWS_CERTIFICATE_BASE64 }}
        run: |
          # Ëß£Á†ÅËØÅ‰π¶
          $cert_bytes = [Convert]::FromBase64String($env:WINDOWS_CERTIFICATE_BASE64)
          $cert_path = Join-Path $env:RUNNER_TEMP "cert.pfx"
          [IO.File]::WriteAllBytes($cert_path, $cert_bytes)

          # ÂØºÂÖ•ËØÅ‰π¶Âà∞ÂΩìÂâçÁî®Êà∑Â≠òÂÇ®
          $password = ConvertTo-SecureString "${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}" -AsPlainText -Force
          Import-PfxCertificate -FilePath $cert_path -CertStoreLocation Cert:\CurrentUser\My -Password $password

          # ËÆæÁΩÆÁéØÂ¢ÉÂèòÈáè‰æõ Electron Forge ‰ΩøÁî®
          echo "WINDOWS_CERTIFICATE_FILE=$cert_path" >> $env:GITHUB_ENV
          echo "WINDOWS_CERTIFICATE_PASSWORD=${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}" >> $env:GITHUB_ENV

          Write-Host "‚úì Windows code signing certificate configured"

      - name: Build main process
        working-directory: desktop-app-vue
        run: npm run build:main

      - name: Build renderer process
        working-directory: desktop-app-vue
        run: npm run build
        env:
          NODE_ENV: production

      - name: Package Windows with Signing
        working-directory: desktop-app-vue
        run: npm run make:win
        env:
          SKIP_BACKEND_CHECK: true
          WINDOWS_CERTIFICATE_FILE: ${{ env.WINDOWS_CERTIFICATE_FILE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}

      - name: List output files
        run: |
          Get-ChildItem -Path "desktop-app-vue\out\make" -Recurse | Where-Object { $_.Extension -in @('.exe', '.zip', '.nupkg') } | Format-Table Name, Length, DirectoryName

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-artifacts
          path: |
            desktop-app-vue/out/make/**/*.exe
            desktop-app-vue/out/make/**/*.zip
            desktop-app-vue/out/make/**/*.nupkg
          retention-days: 5

  # Job 3: ÊûÑÂª∫ macOS ÂÆâË£ÖÂåÖ
  build-macos:
    name: üçé Build macOS
    needs: export-docker-images
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Cache Electron binaries
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/electron
            ~/Library/Caches/electron-builder
          key: ${{ runner.os }}-electron-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-electron-

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            desktop-app-vue/node_modules
          key: ${{ runner.os }}-node-modules-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-node-modules-

      - name: Download Docker images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: packaging/docker-images/

      - name: Verify Docker images
        run: |
          ls -lh packaging/docker-images/
          echo "Docker images downloaded successfully"

      - name: Install root dependencies
        run: npm ci

      - name: Install desktop-app-vue dependencies
        working-directory: desktop-app-vue
        run: npm ci

      - name: Setup macOS Code Signing
        if: ${{ secrets.MACOS_CERTIFICATE_BASE64 != '' }}
        env:
          MACOS_CERTIFICATE_BASE64: ${{ secrets.MACOS_CERTIFICATE_BASE64 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
        run: |
          # ÂàõÂª∫‰∏¥Êó∂Èí•Âåô‰∏≤
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          # ÂàõÂª∫Èí•Âåô‰∏≤
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # Ëß£Á†ÅÂπ∂ÂØºÂÖ•ËØÅ‰π¶
          CERT_PATH=$RUNNER_TEMP/certificate.p12
          echo "$MACOS_CERTIFICATE_BASE64" | base64 --decode > $CERT_PATH
          security import $CERT_PATH -P "$MACOS_CERTIFICATE_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH

          # ËÆæÁΩÆÈí•Âåô‰∏≤ÊêúÁ¥¢ÂàóË°®
          security list-keychain -d user -s $KEYCHAIN_PATH

          # ÂÖÅËÆ∏ codesign ‰ΩøÁî®ËØÅ‰π¶
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          echo "‚úì macOS code signing certificate configured"

      - name: Build main process
        working-directory: desktop-app-vue
        run: npm run build:main

      - name: Build renderer process
        working-directory: desktop-app-vue
        run: npm run build
        env:
          NODE_ENV: production

      - name: Package macOS with Signing and Notarization
        working-directory: desktop-app-vue
        run: npm run make
        env:
          SKIP_BACKEND_CHECK: true
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}

      - name: List output files
        run: |
          find desktop-app-vue/out/make -type f \( -name "*.dmg" -o -name "*.zip" \) -exec ls -lh {} \;

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-artifacts
          path: |
            desktop-app-vue/out/make/**/*.dmg
            desktop-app-vue/out/make/**/*.zip
          retention-days: 5

  # Job 4: ÊûÑÂª∫ Linux ÂÆâË£ÖÂåÖ
  build-linux:
    name: üêß Build Linux
    needs: export-docker-images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: package-lock.json

      - name: Cache Electron binaries
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/electron
            ~/.cache/electron-builder
          key: ${{ runner.os }}-electron-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-electron-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-electron-

      - name: Cache node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            desktop-app-vue/node_modules
          key: ${{ runner.os }}-node-modules-${{ env.CACHE_VERSION }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-${{ env.CACHE_VERSION }}-
            ${{ runner.os }}-node-modules-

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            rpm \
            fakeroot \
            dpkg \
            libarchive-tools

      - name: Download Docker images
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: packaging/docker-images/

      - name: Verify Docker images
        run: |
          ls -lh packaging/docker-images/
          du -sh packaging/docker-images/
          echo "Docker images downloaded successfully"

      - name: Install root dependencies
        run: npm ci

      - name: Install desktop-app-vue dependencies
        working-directory: desktop-app-vue
        run: npm ci

      - name: Build main process
        working-directory: desktop-app-vue
        run: npm run build:main

      - name: Build renderer process
        working-directory: desktop-app-vue
        run: npm run build
        env:
          NODE_ENV: production

      - name: Package Linux (DEB)
        working-directory: desktop-app-vue
        run: |
          npx electron-forge make --platform=linux --arch=x64 --targets=@electron-forge/maker-deb
        env:
          SKIP_BACKEND_CHECK: true

      - name: Package Linux (RPM)
        working-directory: desktop-app-vue
        run: |
          npx electron-forge make --platform=linux --arch=x64 --targets=@electron-forge/maker-rpm
        env:
          SKIP_BACKEND_CHECK: true

      - name: Package Linux (ZIP)
        working-directory: desktop-app-vue
        run: |
          npx electron-forge make --platform=linux --arch=x64 --targets=@electron-forge/maker-zip
        env:
          SKIP_BACKEND_CHECK: true

      - name: List output files
        run: |
          find desktop-app-vue/out/make -type f \( -name "*.deb" -o -name "*.rpm" -o -name "*.zip" \) -exec ls -lh {} \;

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-artifacts
          path: |
            desktop-app-vue/out/make/**/*.deb
            desktop-app-vue/out/make/**/*.rpm
            desktop-app-vue/out/make/**/*.zip
          retention-days: 5

  # Job 5: ÂàõÂª∫ GitHub Release
  create-release:
    name: üìù Create GitHub Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Ëé∑ÂèñÂÆåÊï¥ÂéÜÂè≤‰ª•ÁîüÊàê changelog

      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          fi
          echo "Version: $(cat $GITHUB_OUTPUT)"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Display structure of downloaded files
        run: |
          echo "## Artifacts Structure" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          ls -R artifacts/
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Prepare release files
        run: |
          mkdir -p release-files

          # Windows
          echo "Copying Windows files..."
          find artifacts/windows-artifacts -name "*.exe" -exec cp {} release-files/ \; || true
          find artifacts/windows-artifacts -name "*.zip" | head -1 | xargs -I {} cp {} release-files/ChainlessChain-Windows-x64.zip || true

          # macOS
          echo "Copying macOS files..."
          find artifacts/macos-artifacts -name "*.dmg" -exec cp {} release-files/ \; || true
          find artifacts/macos-artifacts -name "*.zip" | head -1 | xargs -I {} cp {} release-files/ChainlessChain-macOS-Universal.zip || true

          # Linux
          echo "Copying Linux files..."
          find artifacts/linux-artifacts -name "*.deb" -exec cp {} release-files/ \; || true
          find artifacts/linux-artifacts -name "*.rpm" -exec cp {} release-files/ \; || true
          find artifacts/linux-artifacts -name "*.zip" | head -1 | xargs -I {} cp {} release-files/ChainlessChain-Linux-x64.zip || true

          # List all files with sizes
          echo "## Release Files" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          for file in release-files/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              echo "| $filename | $size |" >> $GITHUB_STEP_SUMMARY
            fi
          done

          ls -lh release-files/

      - name: Generate SHA256 checksums
        run: |
          cd release-files

          echo "## üìã SHA256 Checksums" > checksums.txt
          echo "" >> checksums.txt
          echo "ÁîüÊàêÊó∂Èó¥: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> checksums.txt
          echo "" >> checksums.txt

          # ‰∏∫ÊØè‰∏™Êñá‰ª∂ÁîüÊàê checksum
          for file in *; do
            if [ -f "$file" ] && [ "$file" != "checksums.txt" ]; then
              sha256sum "$file" >> checksums.txt
            fi
          done

          echo "" >> checksums.txt
          echo "## È™åËØÅÊñπÊ≥ï" >> checksums.txt
          echo "" >> checksums.txt
          echo "Windows (PowerShell):" >> checksums.txt
          echo "  Get-FileHash -Algorithm SHA256 ChainlessChain-Windows-x64.zip" >> checksums.txt
          echo "" >> checksums.txt
          echo "Linux/macOS:" >> checksums.txt
          echo "  sha256sum ChainlessChain-Linux-x64.zip" >> checksums.txt
          echo "  shasum -a 256 ChainlessChain-macOS-Universal.zip" >> checksums.txt

          cat checksums.txt

          # Ê∑ªÂä†Âà∞ Step Summary
          echo "## üìã SHA256 Checksums" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          grep -v "^#" checksums.txt | grep -v "^$" | head -20 >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PREV_TAG=$(git describe --tags --abbrev=0 ${VERSION}^ 2>/dev/null || echo "")

          if [ -z "$PREV_TAG" ]; then
            RANGE="${VERSION}"
          else
            RANGE="${PREV_TAG}..${VERSION}"
          fi

          CHANGELOG=$(git log ${RANGE} --pretty=format:"- %s (%h)" --no-merges 2>/dev/null || echo "Initial release")

          cat > release-notes.md << 'EOFNOTES'
          ## üéâ ChainlessChain ${{ steps.version.outputs.version }}

          ### üì¶ Á¶ªÁ∫ø Docker ÁâàÊú¨ÔºàÂÆåÂÖ®Á¶ªÁ∫øÂÆâË£ÖÔºâ

          **ÊâÄÊúâÂÆâË£ÖÂåÖÂùáÂåÖÂê´ÂÆåÊï¥ÁöÑ Docker ÈïúÂÉè**ÔºåÂèØÂú®Êó†ÁΩëÁªúÁéØÂ¢É‰∏ãÂÆåÊàêÂÆâË£ÖÂíå‰ΩøÁî®„ÄÇ

          - ‚úÖ PostgreSQL 16 Alpine (~90 MB)
          - ‚úÖ Redis 7 Alpine (~30 MB)
          - ‚úÖ Qdrant v1.12.5 (~120 MB)
          - ‚úÖ Ollama Latest (~500 MB)

          ---

          ### üíæ ‰∏ãËΩΩÂÆâË£Ö

          #### ü™ü Windows

          **Êé®Ëçê‰ΩøÁî® ZIP ÁâàÊú¨ÔºàÁªøËâ≤‰æøÊê∫ÁâàÔºâ**

          | Êñá‰ª∂ | ËØ¥Êòé | Â§ßÂ∞è |
          |------|------|------|
          | `ChainlessChain-Windows-x64.zip` | ‰æøÊê∫ÁâàÔºåËß£ÂéãÂç≥Áî® | ~1.3 GB |
          | `ChainlessChain-Setup.exe` | ÂÆâË£ÖÁ®ãÂ∫èÔºàÂ¶ÇÊûúÊúâÔºâ | ~1.3 GB |

          #### üçé macOS

          **ÊîØÊåÅ Intel Âíå Apple Silicon (M1/M2/M3) ËäØÁâá**

          | Êñá‰ª∂ | ËØ¥Êòé | Â§ßÂ∞è |
          |------|------|------|
          | `ChainlessChain.dmg` | DMG ÂÆâË£ÖÂåÖÔºàÊé®ËçêÔºâ | ~1.3 GB |
          | `ChainlessChain-macOS-Universal.zip` | ZIP ÁâàÊú¨ | ~1.3 GB |

          #### üêß Linux

          **Â§öÁßçÊ†ºÂºèÊîØÊåÅ‰∏ªÊµÅÂèëË°åÁâà**

          | Êñá‰ª∂ | ËØ¥Êòé | ÈÄÇÁî®Á≥ªÁªü | Â§ßÂ∞è |
          |------|------|----------|------|
          | `chainlesschain_*.deb` | DEB ÂåÖ | Debian, Ubuntu, Mint | ~1.3 GB |
          | `chainlesschain-*.rpm` | RPM ÂåÖ | Fedora, RHEL, CentOS | ~1.3 GB |
          | `ChainlessChain-Linux-x64.zip` | ÈÄöÁî® ZIP | ÊâÄÊúâÂèëË°åÁâà | ~1.3 GB |

          ---

          ### üìã ÂÆâË£ÖÊ≠•È™§

          #### 1Ô∏è‚É£ ÂÆâË£Ö Docker DesktopÔºà‰∏ÄÊ¨°ÊÄßÔºâ

          **Windows Âíå macOSÔºö**
          - ‰∏ãËΩΩÔºöhttps://www.docker.com/products/docker-desktop/
          - ÂÆâË£ÖÂêéÂêØÂä® Docker Desktop
          - Á≠âÂæÖ Docker ÂõæÊ†áÂèò‰∏∫ÁªøËâ≤ÔºàËøêË°å‰∏≠Ôºâ

          **LinuxÔºö**
          ```bash
          # Ubuntu/Debian
          sudo apt-get update
          sudo apt-get install -y docker.io docker-compose

          # Fedora/RHEL
          sudo dnf install -y docker docker-compose

          # ÂêØÂä® Docker
          sudo systemctl start docker
          sudo systemctl enable docker
          ```

          #### 2Ô∏è‚É£ ÂÆâË£Ö ChainlessChain

          **WindowsÔºö**
          - ‰∏ãËΩΩ `ChainlessChain-Windows-x64.zip`
          - Ëß£ÂéãÂà∞‰ªªÊÑèÁõÆÂΩïÔºàÂ¶Ç `C:\ChainlessChain\`Ôºâ

          **macOSÔºö**
          - ‰∏ãËΩΩ `ChainlessChain.dmg`
          - ÊâìÂºÄ DMG Êñá‰ª∂
          - ÊãñÊãΩ ChainlessChain Âà∞ Applications Êñá‰ª∂Â§π

          **LinuxÔºö**
          ```bash
          # DEB ÂåÖÂÆâË£Ö
          sudo dpkg -i chainlesschain_*.deb

          # RPM ÂåÖÂÆâË£Ö
          sudo rpm -i chainlesschain-*.rpm

          # Êàñ‰ΩøÁî® ZIP
          unzip ChainlessChain-Linux-x64.zip -d ~/ChainlessChain
          ```

          #### 3Ô∏è‚É£ Âä†ËΩΩ Docker ÈïúÂÉèÔºàÈ¶ñÊ¨°ÂÆâË£ÖÔºâ

          **WindowsÔºö**
          ```cmd
          cd C:\ChainlessChain\resources
          load-docker-images.bat
          ```

          **macOSÔºö**
          ```bash
          cd /Applications/ChainlessChain.app/Contents/Resources
          ./load-docker-images.sh
          ```

          **LinuxÔºö**
          ```bash
          cd ~/ChainlessChain/resources  # ÊàñÂÆâË£ÖÁõÆÂΩï
          sudo ./load-docker-images.sh
          ```

          **È¢ÑËÆ°Êó∂Èó¥Ôºö** 2-5 ÂàÜÈíüÔºàÂèñÂÜ≥‰∫éÁ°¨ÁõòÈÄüÂ∫¶Ôºâ

          #### 4Ô∏è‚É£ ÂêØÂä®ÂêéÁ´ØÊúçÂä°

          **WindowsÔºö**
          ```cmd
          start-services.bat
          ```

          **Linux/macOSÔºö**
          ```bash
          sudo ./start-services.sh
          ```

          **È™åËØÅÊúçÂä°Áä∂ÊÄÅÔºö**
          ```bash
          docker-compose -f docker-compose.production.yml ps
          ```

          Â∫îËØ•ÁúãÂà∞ 4 ‰∏™ÊúçÂä°ÂÖ®ÈÉ® `Up`Ôºö
          - `postgres` (Á´ØÂè£ 5432)
          - `redis` (Á´ØÂè£ 6379)
          - `qdrant` (Á´ØÂè£ 6333)
          - `ollama` (Á´ØÂè£ 11434)

          #### 5Ô∏è‚É£ ÂêØÂä®Â∫îÁî®

          - **Windows**: ËøêË°å `ChainlessChain.exe`
          - **macOS**: ÊâìÂºÄ Applications ‰∏≠ÁöÑ ChainlessChain
          - **Linux**: ËøêË°å `chainlesschain` ÂëΩ‰ª§Êàñ‰ªéÂ∫îÁî®ËèúÂçïÂêØÂä®

          ---

          ### ‚ú® ‰∏ªË¶ÅÁâπÊÄß

          - ‚úÖ **ÂÆåÂÖ®Á¶ªÁ∫øÂÆâË£Ö** - Êó†ÈúÄËÅîÁΩë‰∏ãËΩΩ‰ªª‰Ωï‰æùËµñ
          - ‚úÖ **Ë∑®Âπ≥Âè∞ÊîØÊåÅ** - Windows„ÄÅmacOS„ÄÅLinux Áªü‰∏ÄÊñπÊ°à
          - ‚úÖ **‰∏ÄÈîÆÂêØÂä®** - Ëá™Âä®ÂåñËÑöÊú¨ÁÆ°ÁêÜÂêéÁ´ØÊúçÂä°
          - ‚úÖ **Á°¨‰ª∂Á∫ßÂÆâÂÖ®** - U-Key/SIMKey ÊîØÊåÅÔºàWindowsÔºâ
          - ‚úÖ **Êú¨Âú∞ AI** - ÈõÜÊàê Ollama Êú¨Âú∞Â§ßËØ≠Ë®ÄÊ®°Âûã
          - ‚úÖ **ÂêëÈáèÊêúÁ¥¢** - Qdrant ÂêëÈáèÊï∞ÊçÆÂ∫ìÔºåRAG Â¢ûÂº∫Ê£ÄÁ¥¢
          - ‚úÖ **Êï∞ÊçÆÂä†ÂØÜ** - SQLCipher AES-256 Âä†ÂØÜÊï∞ÊçÆÂ∫ì
          - ‚úÖ **P2P ÈÄö‰ø°** - libp2p + Signal ÂçèËÆÆÁ´ØÂà∞Á´ØÂä†ÂØÜ

          ---

          ### üîß Á≥ªÁªüË¶ÅÊ±Ç

          | ÁªÑ‰ª∂ | ÊúÄ‰ΩéË¶ÅÊ±Ç | Êé®ËçêÈÖçÁΩÆ |
          |------|---------|---------|
          | **Êìç‰ΩúÁ≥ªÁªü** | Windows 10, macOS 11, Ubuntu 20.04 | Windows 11, macOS 13+, Ubuntu 22.04+ |
          | **ÂÜÖÂ≠ò** | 8 GB RAM | 16 GB RAM |
          | **Á£ÅÁõòÁ©∫Èó¥** | 10 GB ÂèØÁî® | 20 GB ÂèØÁî®ÔºàÂåÖÊã¨Ê®°ÂûãÔºâ |
          | **Docker** | Docker Desktop 4.0+ | Docker Desktop ÊúÄÊñ∞Áâà |
          | **Â§ÑÁêÜÂô®** | x64 ÂèåÊ†∏ | x64 ÂõõÊ†∏Êàñ Apple Silicon |

          ---

          ### üìö ÊñáÊ°£

          - üìñ [Âø´ÈÄüÂºÄÂßãÊåáÂçó](https://github.com/${{ github.repository }}/blob/main/packaging/QUICK_START_OFFLINE.md)
          - üìñ [ÂÆåÊï¥ÂÆâË£ÖÊñáÊ°£](https://github.com/${{ github.repository }}/blob/main/packaging/DOCKER_OFFLINE_PACKAGING.md)
          - üîß [ÊïÖÈöúÊéíÈô§](https://github.com/${{ github.repository }}/blob/main/packaging/DOCKER_OFFLINE_PACKAGING.md#ÊïÖÈöúÊéíÈô§)
          - üìù [Áî®Êà∑ÊâãÂÜå](https://github.com/${{ github.repository }}/blob/main/QUICK_START.md)
          - üèóÔ∏è [ÂºÄÂèëÊñáÊ°£](https://github.com/${{ github.repository }}/blob/main/HOW_TO_RUN.md)

          ---

          ### üõ†Ô∏è ÊïÖÈöúÊéíÈô§

          #### Docker Êú™ËøêË°å
          ```
          ÈîôËØØ: Cannot connect to the Docker daemon
          ```
          **Ëß£ÂÜ≥**ÔºöÂêØÂä® Docker DesktopÔºåÁ≠âÂæÖÂõæÊ†áÂèòÁªøËâ≤

          #### Á£ÅÁõòÁ©∫Èó¥‰∏çË∂≥
          ```
          ÈîôËØØ: no space left on device
          ```
          **Ëß£ÂÜ≥**ÔºöDocker Desktop > Settings > Resources > Â¢ûÂä†Á£ÅÁõòÈïúÂÉèÂ§ßÂ∞èËá≥ 30GB

          #### Á´ØÂè£ÂÜ≤Á™Å
          ```
          ÈîôËØØ: port is already allocated
          ```
          **Ëß£ÂÜ≥**Ôºö‰øÆÊîπ `docker-compose.production.yml` ‰∏≠ÁöÑÁ´ØÂè£Êò†Â∞Ñ

          ---

          ### üêõ ÈóÆÈ¢òÂèçÈ¶à

          Â¶ÇÈÅáÂà∞ÈóÆÈ¢òÔºåËØ∑ÂâçÂæÄ [Issues](https://github.com/${{ github.repository }}/issues) Êèê‰∫§ÂèçÈ¶à„ÄÇ

          Êèê‰∫§Êó∂ËØ∑ÂåÖÂê´Ôºö
          - Êìç‰ΩúÁ≥ªÁªüÁâàÊú¨
          - Docker ÁâàÊú¨ (`docker --version`)
          - ÈîôËØØÊó•ÂøóÔºà`docker-compose logs`Ôºâ
          - Â§çÁé∞Ê≠•È™§

          ---

          ### üìù Êõ¥Êñ∞Êó•Âøó

          ${CHANGELOG}

          ---

          ### üîó Áõ∏ÂÖ≥ÈìæÊé•

          - **ÂÆåÊï¥Êõ¥Êñ∞Êó•Âøó**: https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md
          EOFNOTES

          # Â¶ÇÊûúÊúâ‰∏ä‰∏Ä‰∏™ÁâàÊú¨ÔºåÊ∑ªÂä†ÂØπÊØîÈìæÊé•
          if [ -n "$PREV_TAG" ]; then
            echo "" >> release-notes.md
            echo "**‰ª£Á†ÅÂØπÊØî**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${VERSION}" >> release-notes.md
          fi

          cat release-notes.md

      - name: Create GitHub Release with gh CLI
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          ARGS="--title \"ChainlessChain ${VERSION}\" --notes-file release-notes.md"

          # Add draft flag if workflow_dispatch with draft=true
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.draft }}" == "true" ]; then
            ARGS="$ARGS --draft"
          fi

          # Add prerelease flag if specified
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ "${{ inputs.prerelease }}" == "true" ]; then
            ARGS="$ARGS --prerelease"
          fi

          # Create release and upload files
          eval gh release create ${VERSION} ${ARGS} release-files/*

      - name: Generate summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          echo "## üéâ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ inputs.draft == true && 'üìù Draft' || '‚úÖ Published' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Links:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- [Release Page](https://github.com/${{ github.repository }}/releases/tag/${VERSION})" >> $GITHUB_STEP_SUMMARY
          echo "- [Download Page](https://github.com/${{ github.repository }}/releases/latest)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Published Assets:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          for file in release-files/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              size=$(du -h "$file" | cut -f1)
              echo "- **$filename** ($size)" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Send Discord notification
        if: ${{ success() && secrets.DISCORD_WEBHOOK != '' }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO_URL="https://github.com/${{ github.repository }}"
          RELEASE_URL="${REPO_URL}/releases/tag/${VERSION}"

          # ËÆ°ÁÆóÊñá‰ª∂ÊÄªÊï∞ÂíåÊÄªÂ§ßÂ∞è
          FILE_COUNT=$(ls -1 release-files/* 2>/dev/null | wc -l)
          TOTAL_SIZE=$(du -sh release-files/ | cut -f1)

          # ÊûÑÂª∫ Discord embed JSON
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "üéâ New Release: '"${VERSION}"'",
                "description": "ChainlessChain '"${VERSION}"' has been released!",
                "url": "'"${RELEASE_URL}"'",
                "color": 5814783,
                "fields": [
                  {
                    "name": "üì¶ Packages",
                    "value": "'"${FILE_COUNT}"' files ('"${TOTAL_SIZE}"')",
                    "inline": true
                  },
                  {
                    "name": "üöÄ Status",
                    "value": "${{ inputs.draft == true && 'üìù Draft' || '‚úÖ Published' }}",
                    "inline": true
                  },
                  {
                    "name": "üîó Links",
                    "value": "[Release Page]('"${RELEASE_URL}"') ‚Ä¢ [Download Latest]('"${REPO_URL}/releases/latest"')"
                  }
                ],
                "footer": {
                  "text": "ChainlessChain CI/CD"
                },
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
              }]
            }' \
            ${{ secrets.DISCORD_WEBHOOK }}

      - name: Send Slack notification
        if: ${{ success() && secrets.SLACK_WEBHOOK != '' }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO_URL="https://github.com/${{ github.repository }}"
          RELEASE_URL="${REPO_URL}/releases/tag/${VERSION}"

          # ËÆ°ÁÆóÊñá‰ª∂ÊÄªÊï∞ÂíåÊÄªÂ§ßÂ∞è
          FILE_COUNT=$(ls -1 release-files/* 2>/dev/null | wc -l)
          TOTAL_SIZE=$(du -sh release-files/ | cut -f1)

          # ÊûÑÂª∫ Slack message JSON
          curl -X POST -H "Content-Type: application/json" \
            -d '{
              "text": "üéâ New Release: '"${VERSION}"'",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üéâ ChainlessChain '"${VERSION}"' Released!"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*üì¶ Packages:*\n'"${FILE_COUNT}"' files ('"${TOTAL_SIZE}"')"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*üöÄ Status:*\n${{ inputs.draft == true && 'üìù Draft' || '‚úÖ Published' }}"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üì• Download Release"
                      },
                      "url": "'"${RELEASE_URL}"'"
                    },
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "üìù View Changelog"
                      },
                      "url": "'"${REPO_URL}/blob/main/CHANGELOG.md"'"
                    }
                  ]
                }
              ]
            }' \
            ${{ secrets.SLACK_WEBHOOK }}

      - name: Send failure notification
        if: ${{ failure() && (secrets.DISCORD_WEBHOOK != '' || secrets.SLACK_WEBHOOK != '') }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          REPO_URL="https://github.com/${{ github.repository }}"
          RUN_URL="${REPO_URL}/actions/runs/${{ github.run_id }}"

          # Discord failure notification
          if [ -n "${{ secrets.DISCORD_WEBHOOK }}" ]; then
            curl -H "Content-Type: application/json" \
              -d '{
                "embeds": [{
                  "title": "‚ùå Release Failed: '"${VERSION}"'",
                  "description": "The release build has failed. Please check the logs.",
                  "url": "'"${RUN_URL}"'",
                  "color": 15158332,
                  "fields": [
                    {
                      "name": "üîó Actions Run",
                      "value": "[View Logs]('"${RUN_URL}"')"
                    }
                  ],
                  "footer": {
                    "text": "ChainlessChain CI/CD"
                  },
                  "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%SZ)"'"
                }]
              }' \
              ${{ secrets.DISCORD_WEBHOOK }}
          fi

          # Slack failure notification
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            curl -X POST -H "Content-Type: application/json" \
              -d '{
                "text": "‚ùå ChainlessChain '"${VERSION}"' Release Failed",
                "blocks": [
                  {
                    "type": "header",
                    "text": {
                      "type": "plain_text",
                      "text": "‚ùå Release Build Failed"
                    }
                  },
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "The release build for *'"${VERSION}"'* has failed. Please check the logs for details."
                    }
                  },
                  {
                    "type": "actions",
                    "elements": [
                      {
                        "type": "button",
                        "text": {
                          "type": "plain_text",
                          "text": "üîç View Logs"
                        },
                        "url": "'"${RUN_URL}"'"
                      }
                    ]
                  }
                ]
              }' \
              ${{ secrets.SLACK_WEBHOOK }}
          fi
