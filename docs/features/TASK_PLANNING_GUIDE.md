# 对话式任务规划系统使用指南

## 📋 功能概述

本系统实现了类似 Claude Code 的 Plan 模式，通过智能对话帮助用户规划和执行复杂任务。系统会主动分析需求完整性，在必要时通过提问收集补充信息，然后生成详细的任务计划供用户确认后执行。

### 核心特性

- 🤖 **智能需求分析** - AI自动判断用户需求是否完整
- 💬 **对话式信息采集** - 如需补充信息，AI主动提问
- 📋 **详细任务规划** - 生成包含步骤、预期输出的执行计划
- ✅ **用户确认机制** - 计划可查看、修改、确认或取消
- 📊 **可视化流程** - 清晰展示规划和执行的各个阶段

## 🎯 适用场景

### 推荐使用

- ✅ **创建型任务**: 生成PPT、文档、报告等
- ✅ **复杂需求**: 需要多个步骤完成的任务
- ✅ **需要明确**: 要求步骤清晰、输出明确的工作

### 不推荐使用

- ❌ **简单问答**: 直接询问知识性问题
- ❌ **单步操作**: 只需一个动作完成的任务
- ❌ **纯聊天**: 日常对话交流

## 🚀 快速开始

### 1. 触发任务规划

在项目详情页的AI助手对话框中输入创建型需求，系统会自动检测并启动规划模式。

**触发关键词**：
```
创建、生成、制作、写、做、开发、设计、ppt、PPT、文档、报告
```

**示例**：
```
✅ "做个新年致辞ppt"
✅ "生成一份项目进度报告"
✅ "创建用户手册文档"
✅ "写一个产品介绍PPT"
```

### 2. 系统工作流程

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  用户输入需求                                                 │
│  "做个新年致辞ppt"                                            │
│                                                             │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  阶段1: 需求分析 (ANALYZING)                                  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━        │
│  AI分析：                                                    │
│  • 目标明确性                                                 │
│  • 内容要求                                                   │
│  • 格式规格                                                   │
│  • 受众对象                                                   │
│  • 风格偏好                                                   │
│  • 其他约束                                                   │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ├─── 需求完整 ───────────┐
                       │                        │
                       ├─── 需求不完整 ─────┐   │
                       │                    │   │
                       ▼                    ▼   ▼
┌─────────────────────────────────────────────────────────────┐
│  阶段2A: 信息采访 (INTERVIEWING)                              │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━        │
│  问题示例：                                                   │
│  Q1: 这份PPT的目标受众是谁？                                  │
│  Q2: 您期望的风格是正式还是轻松？                             │
│  Q3: 大约需要多少页？                                         │
│                                                             │
│  [用户逐个回答或跳过]                                         │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │  (采访完成或需求已完整)
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  阶段3: 生成计划 (PLANNING)                                   │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━        │
│  AI正在：                                                    │
│  • 分析收集的信息                                             │
│  • 拆解任务步骤                                               │
│  • 设计内容结构                                               │
│  • 生成执行计划                                               │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  阶段4: 确认计划 (CONFIRMING)                                 │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━        │
│  # 2026新年致辞PPT                                            │
│                                                             │
│  ## 📋 任务步骤                                               │
│  1. 设计PPT结构                                               │
│     • 创建标题页                                              │
│     • 设计章节页                                              │
│     • 规划内容布局                                            │
│                                                             │
│  2. 编写内容                                                  │
│     • 撰写致辞正文                                            │
│     • 添加关键数据                                            │
│     • 设计结尾语                                              │
│                                                             │
│  3. 美化和优化                                                │
│     • 选择配色方案                                            │
│     • 添加图片和图表                                          │
│     • 调整排版                                                │
│                                                             │
│  ## 🎯 预期输出                                               │
│  • 2026新年致辞.pptx (8-10页)                                │
│  • 包含标题页、目录、正文、结束页                             │
│                                                             │
│  [取消] [修改计划] [✅ 确认执行]                              │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       │  (用户点击"确认执行")
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  阶段5: 执行任务 (EXECUTING)                                  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━        │
│  正在执行任务...                                              │
│  ████████████████████ 85%                                   │
│  当前: 生成PPT文件内容                                        │
└──────────────────────┬──────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────────────────┐
│  阶段6: 完成 (COMPLETED)                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━        │
│  ✅ 任务执行完成！                                            │
│  🎉 PPT文件已生成！                                           │
│  文件名: 2026新年致辞.pptx                                    │
│  幻灯片数: 8                                                  │
└─────────────────────────────────────────────────────────────┘
```

## 💡 使用示例

### 示例1: 需求完整的场景

**用户输入**：
```
写一个8页的2026新年致辞PPT，正式风格，
面向全体员工，包含2025年成绩回顾和2026年展望
```

**系统流程**：
1. ✅ 需求分析：信息完整（目标、受众、风格、内容都很明确）
2. 🔄 直接生成计划
3. 📋 展示详细的8步执行计划
4. ✅ 用户确认后立即执行

**耗时**: 约30-60秒

---

### 示例2: 需求不完整的场景

**用户输入**：
```
做个ppt
```

**系统流程**：

1. ❓ 需求分析：信息不完整
2. 💬 **启动采访模式**

   **AI提问1**：
   ```
   问题 1/4 *
   这份PPT的主题是什么？

   [输入答案]
   [下一个]
   ```

   **用户回答**：`新年致辞`

   **AI提问2**：
   ```
   问题 2/4 *
   目标受众是谁？

   [输入答案]
   [跳过] [下一个]
   ```

   **用户回答**：`公司全体员工`

   **AI提问3**：
   ```
   问题 3/4
   您期望的风格是正式还是轻松？

   [输入答案]
   [跳过] [下一个]
   ```

   **用户回答**：`正式`

   **AI提问4**：
   ```
   问题 4/4
   大约需要多少页？

   [输入答案]
   [跳过] [完成]
   ```

   **用户回答**：`8-10页`

3. 🔄 采访完成，生成计划
4. 📋 展示详细计划
5. ✅ 用户确认后执行

**耗时**: 约2-3分钟（取决于用户回答速度）

---

### 示例3: 修改计划的场景

**用户操作流程**：

1. 📋 查看生成的计划
2. 🤔 发现计划中某些内容不符合预期
3. 🔄 点击"修改计划"按钮
4. 💬 重新进入采访模式
5. 🔁 重新回答问题，补充或修改需求
6. 📋 查看更新后的计划
7. ✅ 确认并执行

---

## 🛠️ 技术架构

### 核心模块

#### 1. TaskPlanner (taskPlanner.js)

**PlanningState** - 规划状态枚举
```javascript
{
  IDLE: 'idle',                    // 空闲状态
  ANALYZING: 'analyzing',          // 分析需求
  INTERVIEWING: 'interviewing',    // 采访用户
  PLANNING: 'planning',            // 生成计划
  CONFIRMING: 'confirming',        // 等待确认
  EXECUTING: 'executing',          // 执行任务
  COMPLETED: 'completed',          // 已完成
  CANCELLED: 'cancelled'           // 已取消
}
```

**PlanningSession** - 规划会话类
```javascript
class PlanningSession {
  id                   // 会话ID
  state                // 当前状态
  userInput            // 用户原始输入
  projectType          // 项目类型

  analysis: {          // 需求分析结果
    isComplete         // 是否完整
    confidence         // 置信度 (0-1)
    missing            // 缺失的信息
    collected          // 已收集的信息
    suggestions        // 建议
  }

  interview: {         // 采访数据
    questions          // 问题列表
    currentIndex       // 当前问题索引
    answers            // 用户答案
    completed          // 是否完成
  }

  plan: {              // 任务计划
    title              // 计划标题
    summary            // 摘要
    tasks              // 任务列表
    outputs            // 预期输出
    notes              // 注意事项
  }

  confirmed            // 是否确认
}
```

**TaskPlanner** - 任务规划器类
```javascript
class TaskPlanner {
  // 分析需求完整性
  static async analyzeRequirements(userInput, projectType, llmService)

  // 生成任务计划
  static async generatePlan(session, llmService)

  // 格式化计划为Markdown
  static formatPlanAsMarkdown(plan)
}
```

#### 2. PlanningView (PlanningView.vue)

UI组件，根据不同的状态展示不同的界面：

- **ANALYZING**: 显示"正在分析需求..."加载状态
- **INTERVIEWING**: 展示当前问题和已回答的问题列表
- **PLANNING**: 显示"正在生成计划..."加载状态
- **CONFIRMING**: 展示详细计划和操作按钮
- **EXECUTING**: 显示执行进度

#### 3. ChatPanel集成 (ChatPanel.vue)

主要函数：

```javascript
// 判断是否需要使用任务规划
shouldUsePlanning(input)

// 启动任务规划流程
startTaskPlanning(userInput)

// 生成任务计划
generateTaskPlan()

// 处理采访问答
handleAnswerSubmitted({ questionIndex, answer })
handleQuestionSkipped(questionIndex)

// 处理计划确认
handlePlanConfirmed()
handlePlanCancelled()
handlePlanModify()
```

### 数据流

```
用户输入
    ↓
shouldUsePlanning() 判断
    ↓
启动 PlanningSession
    ↓
analyzeRequirements() 分析需求
    ↓
需求完整？
    ├─ 是 → generatePlan()
    └─ 否 → 进入采访模式
              ↓
         收集用户答案
              ↓
         generatePlan()
    ↓
展示计划 (PlanningView)
    ↓
用户确认？
    ├─ 确认 → 执行任务 → 完成
    ├─ 修改 → 重新采访
    └─ 取消 → 结束
```

## 🎨 用户界面说明

### 采访阶段界面

```
┌──────────────────────────────────────────────────────┐
│  需要了解更多信息                                       │
│  为了更好地完成任务，请回答以下问题 (2/4)               │
├──────────────────────────────────────────────────────┤
│                                                      │
│  ┌────────────────────────────────────────────────┐ │
│  │ 问题 2 * 目标受众是谁？                          │ │
│  │                                                │ │
│  │ ┌────────────────────────────────────────────┐ │ │
│  │ │ 请输入答案（必填）                           │ │ │
│  │ │                                            │ │ │
│  │ └────────────────────────────────────────────┘ │ │
│  │                                                │ │
│  │                          [跳过] [下一个] ────► │ │
│  └────────────────────────────────────────────────┘ │
│                                                      │
│  已回答的问题 ▼                                       │
│  ✓ 这份PPT的主题是什么？                              │
│    └─ 新年致辞                                       │
│                                                      │
└──────────────────────────────────────────────────────┘
```

### 计划确认界面

```
┌──────────────────────────────────────────────────────┐
│  任务计划已生成                                        │
├──────────────────────────────────────────────────────┤
│                                                      │
│  # 2026新年致辞PPT                                    │
│  为全体员工准备的新年致辞演示文稿，正式风格            │
│                                                      │
│  ## 📋 任务步骤                                       │
│  ┌────────────────────────────────────────────────┐ │
│  │ 1  设计PPT结构                                  │ │
│  │    描述: 规划PPT的整体框架和页面布局             │ │
│  │    操作: 创建标题页、目录、章节页、结束页        │ │
│  │    输出: PPT基础结构（4页）                     │ │
│  └────────────────────────────────────────────────┘ │
│                                                      │
│  ┌────────────────────────────────────────────────┐ │
│  │ 2  撰写致辞内容                                 │ │
│  │    描述: 编写2025年回顾和2026年展望             │ │
│  │    操作: 撰写正文内容，添加关键数据              │ │
│  │    输出: 内容页面（4-6页）                      │ │
│  └────────────────────────────────────────────────┘ │
│                                                      │
│  ## 🎯 预期输出                                       │
│  • 2026新年致辞.pptx (8-10页)                        │
│  • 正式风格，适合全体员工                            │
│                                                      │
│  ## ⚠️ 注意事项                                       │
│  • 确保数据准确性                                     │
│  • 保持风格一致性                                     │
│                                                      │
│  [取消] [修改计划] [✅ 确认执行]                      │
└──────────────────────────────────────────────────────┘
```

## 🔧 配置选项

### 启用/禁用任务规划

在 ChatPanel.vue 中：

```javascript
const enablePlanning = ref(true);  // 设为false可全局禁用
```

### 自定义触发关键词

修改 `shouldUsePlanning` 函数：

```javascript
const shouldUsePlanning = (input) => {
  // 添加或修改关键词
  const keywords = [
    '创建', '生成', '制作', '写', '做',
    '开发', '设计', 'ppt', 'PPT', '文档', '报告',
    // 添加更多关键词...
    '编写', '撰写', '构建'
  ];

  const hasKeyword = keywords.some(keyword => input.includes(keyword));
  return hasKeyword;
};
```

### 调整分析Prompt

修改 `TaskPlanner.analyzeRequirements` 中的 prompt：

```javascript
const prompt = `请分析以下用户需求的完整性：

用户输入: "${userInput}"
项目类型: ${projectType}

请从以下维度分析需求是否完整：
1. 目标明确性 - 用户想要什么？
2. 内容要求 - 需要包含什么内容？
3. 格式规格 - 输出格式是什么？
4. 受众对象 - 面向谁？
5. 风格偏好 - 什么风格？
6. 其他约束 - 还有什么要求？

// ... 添加更多分析维度
`;
```

## 📊 性能优化建议

### 1. 缓存分析结果

对于相似的需求，可以缓存分析结果：

```javascript
const analysisCache = new Map();

const getCachedAnalysis = (userInput) => {
  const key = userInput.toLowerCase().trim();
  return analysisCache.get(key);
};
```

### 2. 并行处理

在生成计划时，可以并行处理多个子任务：

```javascript
const [plan, resources, timeline] = await Promise.all([
  generateMainPlan(),
  fetchRequiredResources(),
  estimateTimeline()
]);
```

### 3. 渐进式加载

对于大型计划，可以分批加载和展示：

```javascript
// 先展示概要
showPlanSummary(plan.summary);

// 然后逐步加载详细步骤
plan.tasks.forEach((task, index) => {
  setTimeout(() => showTask(task), index * 100);
});
```

## 🐛 故障排查

### 问题1: 规划模式未触发

**可能原因**：
- `enablePlanning` 设置为 false
- 输入未包含触发关键词
- LLM服务不可用

**解决方案**：
1. 检查 `enablePlanning` 配置
2. 查看控制台日志，确认是否调用 `shouldUsePlanning`
3. 确保 `window.electronAPI.project.aiChat` 可用

### 问题2: 采访问题未显示

**可能原因**：
- LLM返回的JSON格式不正确
- `suggestedQuestions` 为空

**解决方案**：
1. 查看控制台中的需求分析结果日志
2. 检查LLM返回的JSON是否符合预期格式
3. 添加默认问题作为后备方案

### 问题3: 计划生成失败

**可能原因**：
- LLM服务超时
- 返回的JSON无法解析
- 网络问题

**解决方案**：
1. 增加超时时间
2. 添加重试机制
3. 提供更具体的Prompt指导
4. 使用结构化输出格式

## 📚 扩展开发

### 添加新的规划阶段

1. 在 `PlanningState` 中添加新状态：
   ```javascript
   export const PlanningState = {
     // ... 现有状态
     REVIEWING: 'reviewing',  // 新增：审核阶段
   };
   ```

2. 在 `PlanningView.vue` 中添加对应UI：
   ```vue
   <div v-else-if="state === PlanningState.REVIEWING">
     <!-- 审核界面 -->
   </div>
   ```

3. 在 `ChatPanel.vue` 中添加处理逻辑：
   ```javascript
   const handlePlanReview = async () => {
     planningSession.value.setState(PlanningState.REVIEWING);
     // ... 审核逻辑
   };
   ```

### 集成外部服务

例如，集成项目管理工具：

```javascript
const exportToPMTool = async (plan) => {
  const tasks = plan.tasks.map(task => ({
    title: task.name,
    description: task.description,
    assignee: '待分配',
    dueDate: calculateDueDate(task)
  }));

  await window.electronAPI.pm.createTasks(tasks);
};
```

### 添加模板系统

创建预定义的任务模板：

```javascript
const templates = {
  ppt: {
    requiredFields: ['主题', '受众', '页数', '风格'],
    defaultPlan: {
      tasks: [
        { name: '设计结构', ... },
        { name: '编写内容', ... },
        { name: '美化优化', ... }
      ]
    }
  },
  report: {
    requiredFields: ['报告类型', '目标读者', '字数'],
    defaultPlan: { ... }
  }
};
```

## ✅ 最佳实践

### 1. 用户输入建议

**推荐格式**：
```
[动作] + [对象] + [要求细节]

示例：
• "创建一个产品介绍PPT，面向潜在客户，15页左右，商务风格"
• "生成季度工作报告，包含KPI数据和下季度计划，正式格式"
```

### 2. 采访问题设计

**好的问题**：
- ✅ 具体明确："目标受众的年龄段是？"
- ✅ 提供选项："风格：A.正式 B.活泼 C.简约"
- ✅ 有默认值："页数（默认10页）："

**不好的问题**：
- ❌ 太宽泛："您还有什么要求？"
- ❌ 太专业："需要使用什么色彩模式？"
- ❌ 无引导："请描述您的需求"

### 3. 计划设计

**好的计划**：
- ✅ 步骤清晰，每步有明确产出
- ✅ 包含预期输出和注意事项
- ✅ 使用用户易懂的语言

**不好的计划**：
- ❌ 步骤太笼统："完成PPT制作"
- ❌ 缺少细节："添加内容"
- ❌ 使用过多技术术语

## 🎓 学习资源

### 相关文档

- [系统设计文档](./系统设计_个人移动AI管理系统.md)
- [PPT自动生成完整实现](./PPT_AUTO_GENERATION_COMPLETE.md)
- [意图识别集成](./INTENT_RECOGNITION_INTEGRATION_COMPLETE.md)

### 源代码

- TaskPlanner核心: `/desktop-app-vue/src/renderer/utils/taskPlanner.js`
- PlanningView组件: `/desktop-app-vue/src/renderer/components/projects/PlanningView.vue`
- ChatPanel集成: `/desktop-app-vue/src/renderer/components/projects/ChatPanel.vue`

### 测试示例

```bash
# 启动开发服务器
cd desktop-app-vue
npm run dev

# 测试场景
1. 输入："做个ppt" → 触发采访模式
2. 输入："生成一个8页的新年致辞PPT，正式风格" → 直接生成计划
3. 在计划确认页点击"修改" → 重新进入采访
```

## 📝 版本历史

### v1.0.0 (2026-01-05)

**初始发布**
- ✅ 实现基础任务规划流程
- ✅ 支持需求分析和信息采访
- ✅ 支持任务计划生成和展示
- ✅ 支持用户确认、修改和取消
- ✅ 集成到ChatPanel

**已知限制**
- 仅支持中文
- 仅针对文档类项目优化
- LLM返回格式依赖较强

## 🤝 贡献指南

欢迎贡献代码和建议！

### 改进方向

1. **多语言支持** - 添加英文界面
2. **模板系统** - 预定义常见任务模板
3. **历史记录** - 保存和复用历史计划
4. **智能推荐** - 根据项目类型推荐最佳实践
5. **协作功能** - 支持团队共同规划

### 提交流程

1. Fork 项目
2. 创建功能分支
3. 提交更改
4. 创建 Pull Request

---

**文档维护者**: Claude Code Team
**最后更新**: 2026-01-05
**版本**: 1.0.0
