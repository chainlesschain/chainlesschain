# 基于U盾和SIMKey的个人移动AI管理系统

## 系统设计文档 v2.15 (更新至 v0.20.0 实际实现状态)

**文档版本**: 2.15
**系统版本**: v0.20.0 (生产就绪,核心功能100%完成)
**最后更新**: 2026-01-18

> **注意**: 本文档为主文档索引，详细的模块设计已拆分到独立文件中。

---

## 文档索引

### 核心模块设计

| 模块 | 文档 | 说明 |
|------|------|------|
| 知识库管理 | [01_知识库管理模块.md](modules/01_知识库管理模块.md) | 个人第二大脑,RAG检索,向量存储 |
| 去中心化社交 | [02_去中心化社交模块.md](modules/02_去中心化社交模块.md) | DID身份,P2P通信,Signal加密 |
| 交易辅助 | [03_交易辅助模块.md](modules/03_交易辅助模块.md) | 智能合约,信用评分,AI协商 |
| 项目管理 ⭐ | [04_项目管理模块.md](modules/04_项目管理模块.md) | **核心功能**,对话式任务,AI生成 |
| 企业版组织 | [05_企业版组织模块.md](modules/05_企业版组织模块.md) | RBAC权限,组织协作,实时编辑 |
| AI优化系统 | [06_AI优化系统.md](modules/06_AI优化系统.md) | P2优化,高级特性,在线学习 |
| 性能优化 | [07_性能优化系统.md](modules/07_性能优化系统.md) | 三层优化体系,Core Web Vitals |
| MCP与配置 | [08_MCP与配置系统.md](modules/08_MCP与配置系统.md) | Model Context Protocol,统一配置,预算跟踪 |

### 基础设施设计

| 文档 | 说明 |
|------|------|
| [安全机制设计.md](安全机制设计.md) | U盾/SIMKey硬件安全,密钥管理,备份恢复 |
| [数据同步方案.md](数据同步方案.md) | Git同步,HTTP同步,P2P移动端同步 |
| [AI模型部署方案.md](AI模型部署方案.md) | Ollama本地部署,云端API,模型选型 |

### 参考资料

| 文档 | 说明 |
|------|------|
| [实施总结与附录.md](实施总结与附录.md) | 实施完成状态,快速开始指南,API文档,版本历史 |
| [系统设计_个人移动AI管理系统.md](系统设计_个人移动AI管理系统.md) | 原始完整文档(归档) |

---

## 一、系统概述

### 1.1 系统定位

本系统是一个**去中心化的个人AI助手平台**,整合了知识库管理、**项目管理(⭐核心)**、**企业版组织协作(⭐新增)**、社交网络和交易辅助五大核心功能,通过U盾(USB Key)和SIMKey提供硬件级安全保障。

**主要应用**: `desktop-app-vue/` (Electron 39.2.6 + Vue 3.4 + TypeScript)

**当前状态** (v0.20.0 - 生产就绪):

| 模块 | 完成度 | 说明 |
|------|--------|------|
| 知识库管理 | 100% ✅ | RAG检索,向量存储,知识图谱可视化 |
| 项目管理 | 100% ✅ | 对话式任务,AI代码/文档生成 |
| 企业版协作 | 45% 🚧 | RBAC权限,组织管理,DID邀请 |
| AI引擎系统 | 100% ✅ | 多意图识别,任务规划,少样本学习 |
| MCP集成 | POC ✅ | Model Context Protocol v0.1.0 |
| P2P社交 | 100% ✅ | WebRTC音视频,Signal加密,文件传输 |
| 交易系统 | 100% ✅ | 实时交易引擎,6个智能合约 |
| 移动端应用 | 10% 🚧 | 同步/社交/UI完成,其他开发中 |
| **SessionManager** | 100% ✅ | 自动压缩,30-40%令牌节省 ⭐v0.22.0 |
| **ErrorMonitor** | 100% ✅ | LLM诊断,自动修复策略 ⭐v2.0 |
| **LLM性能仪表板** | 100% ✅ | 令牌追踪,成本分析 ⭐新增 |
| **Manus优化** | 100% ✅ | Context Engineering + Tool Masking + Multi-Agent ⭐v0.24.0 |

**总体完成度**: **100%** (核心功能,知识库/P2P/交易三大支柱)

### 1.2 核心特性

- **完全去中心化**: 数据存储在用户自己的设备上,不依赖第三方云服务
- **硬件安全**: 基于U盾/SIMKey的硬件级密钥保护
- **跨设备同步**: Git同步 + HTTP同步 + P2P移动端同步
- **AI增强**: 集成本地大模型(Ollama)和14+云端LLM API,支持RAG检索增强
- **隐私优先**: 用户完全掌控自己的数据和AI模型
- **对话式项目管理**: AI驱动的项目创建、文件生成和智能任务拆解
- **多身份切换**: 个人身份+多组织身份,数据完全隔离

### 1.2.1 最近更新 (v0.20.0)

**架构重构** (2026-01-18):
- ✅ 主进程代码重组: 508个文件重新组织到75个分类目录
- ✅ 改进代码可维护性和可发现性
- ✅ 更新所有导入路径和测试引用

**P2P增强**:
- ✅ 新增WebRTC兼容层 (`wrtc-compat.js`, 152行)
- ✅ 增强P2P通信稳定性
- ✅ 改进P2P功能测试覆盖

**测试框架改进**:
- ✅ 跳过不稳定的环境依赖测试
- ✅ 改进CI/CD稳定性
- ✅ 更好的测试组织结构

**关键提交**:
- `b1a87b8` - 重构: 将src/main重组为分类子目录
- `733c7ab` - 功能: 添加WebRTC兼容层并更新测试
- `1e4317f` - 修复: 为状态模态框传递正确的项目ID

### 1.3 架构规模 (v0.20.0)

- **508个** 主进程JS文件 (组织在75个分类目录中)
- **379个** Vue组件
- **17个** 数据库迁移文件 (3,300行SQL)
- **300+** 工具函数,**115+** 技能模块
- **~200,000行** 核心代码
- **70,000字** 技术文档

**主进程目录结构** (75个分类目录):
```
核心系统:
├── ai-engine/        (61文件) - 多意图识别,少样本学习,任务规划
├── llm/              (26文件) - LLM集成,会话管理,Manus优化
├── rag/              (9文件)  - RAG检索增强生成
├── mcp/              (16文件) - Model Context Protocol集成
├── memory/           (18文件) - 记忆库系统(偏好,学习模式,备份)
├── p2p/              (29文件) - P2P网络,WebRTC,Signal协议
├── trade/            (12文件) - 交易引擎,合约,市场
├── monitoring/       (9文件)  - 错误监控,健康检查,分析
├── skill-tool-system/(57文件) - 300+工具,115+技能,10个类别

数据与存储:
├── database/         (15文件) - SQLCipher加密,迁移,密钥管理
├── file/             (9文件)  - 文件管理,版本控制,大文件处理
├── file-sync/        (4文件)  - 同步管理,冲突解决
├── knowledge/        (7文件)  - 知识版本控制,协作

集成与API:
├── api/              (12文件) - 后端客户端(项目,Git,RAG,代码API)
├── ipc/              (8文件)  - IPC注册和处理器

专业引擎:
├── engines/          (20文件) - 代码,文档,数据,图像,视频,Web引擎
├── blockchain/       (25文件) - 智能合约,钱包,交易监控
├── did/              (6文件)  - DID身份系统
├── social/           (6文件)  - 社交功能,论坛
├── organization/     (12文件) - 企业组织管理

工具与支持:
├── utils/            (16文件) - 辅助工具,性能监控,日志转发
├── config/           (10文件) - 配置管理,数据库配置
├── git/              (10文件) - Git操作,自动提交,Markdown导出
├── plugins/          (15文件) - 插件系统,市场,沙箱
├── ukey/             (18文件) - U盾硬件集成(仅Windows)
```

### 1.4 技术架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户层                                     │
├──────────────────────┬──────────────────────┬───────────────────┤
│   移动端 (Android/iOS)│ PC端 (Win/Mac/Linux) │   Web端 (可选)    │
│   - SIMKey认证        │      - U盾认证        │   - 浏览器访问     │
│   - P2P同步           │      - P2P桥接        │   - 轻量级界面     │
└──────────────────────┴──────────────────────┴───────────────────┘
              ↕                       ↕                    ↕
┌─────────────────────────────────────────────────────────────────┐
│                     业务逻辑层                                    │
├──────────────────────────────────────────────────────────────────┤
│  项目管理(核心) │ 知识库管理 │ 社交模块 │ 交易模块 │ 企业协作   │
└──────────────────────────────────────────────────────────────────┘
              ↕                       ↕                    ↕
┌─────────────────────────────────────────────────────────────────┐
│                     数据层                                        │
├──────────────────┬─────────────────────┬────────────────────────┤
│  本地存储         │   分布式存储         │   AI模型层             │
│  - SQLite/sql.js │   - Git仓库          │   - Ollama本地         │
│  - ChromaDB      │   - P2P同步          │   - 14+云端API         │
└──────────────────┴─────────────────────┴────────────────────────┘
              ↕                       ↕                    ↕
┌─────────────────────────────────────────────────────────────────┐
│                     安全层                                        │
├──────────────────────────────┬──────────────────────────────────┤
│       U盾 (PC端)              │        SIMKey (移动端)           │
│  - 私钥存储/数字签名          │   - 私钥存储/SIM卡安全芯片       │
└──────────────────────────────┴──────────────────────────────────┘
```

---

## 二、核心模块设计 (详见子文档)

| 序号 | 模块 | 子文档 |
|------|------|--------|
| 2.1 | 知识库管理模块 | [modules/01_知识库管理模块.md](modules/01_知识库管理模块.md) |
| 2.2 | 去中心化社交模块 | [modules/02_去中心化社交模块.md](modules/02_去中心化社交模块.md) |
| 2.3 | 去中心化交易辅助模块 | [modules/03_交易辅助模块.md](modules/03_交易辅助模块.md) |
| 2.4 | 项目管理模块 ⭐核心 | [modules/04_项目管理模块.md](modules/04_项目管理模块.md) |
| 2.5 | 企业版组织模块 | [modules/05_企业版组织模块.md](modules/05_企业版组织模块.md) |
| 2.6-2.7 | AI优化系统 | [modules/06_AI优化系统.md](modules/06_AI优化系统.md) |
| 2.8 | 性能优化系统 | [modules/07_性能优化系统.md](modules/07_性能优化系统.md) |
| 2.9-2.11 | MCP与配置系统 | [modules/08_MCP与配置系统.md](modules/08_MCP与配置系统.md) |

---

## 三、安全机制设计 (详见子文档)

详细设计请参考: [安全机制设计.md](安全机制设计.md)

主要内容:
- 3.1 U盾安全机制 (密钥管理、备份恢复)
- 3.2 SIMKey安全机制
- 3.3 数据加密方案

---

## 四、数据同步方案 (详见子文档)

详细设计请参考: [数据同步方案.md](数据同步方案.md)

主要内容:
- 4.1 Git同步 (PC间版本控制同步)
- 4.2 HTTP同步 (轻量级PC间同步)
- 4.3 P2P移动端同步 (WebRTC实时同步)

---

## 五、AI模型部署方案 (详见子文档)

详细设计请参考: [AI模型部署方案.md](AI模型部署方案.md)

主要内容:
- 5.1 模型选型 (LLM、Embedding、向量数据库)
- 5.2 部署架构 (PC端Docker、移动端轻量级)
- 5.3 混合推理策略

---

## 六、系统实现技术栈

### 6.1 PC端 (跨平台桌面应用)

**核心框架**: Electron 39.2.6 + Vue 3.4.0 + Vite 7.2.7

```
实际技术栈 (v0.20.0):
├── 前端框架: Vue 3.4.0 + TypeScript 5.9.3
├── UI库: Ant Design Vue 4.1.0
├── 可视化: ECharts 6.0.0 + ECharts GL 2.0.9
├── 编辑器: Monaco Editor 0.55.1 + Milkdown 7.17.3
├── 状态管理: Pinia 2.1.7
├── Git操作: isomorphic-git
├── 数据库: better-sqlite3-multiple-ciphers 12.5.0 (SQLCipher)
├── 向量库: ChromaDB 3.1.8 + @chroma-core/default-embed 0.1.9
├── 加密: node-forge 1.3.1 + tweetnacl 1.0.3
├── P2P网络: libp2p 3.1.2
│   ├── @libp2p/webrtc 6.0.10
│   ├── @libp2p/noise 1.0.1
│   ├── @libp2p/kad-dht 16.1.2
│   ├── @libp2p/circuit-relay-v2 4.1.2
│   └── werift 0.22.2 (WebRTC)
├── Signal协议: @privacyresearch/libsignal-protocol-typescript 0.0.16
├── 区块链: ethers 6.16.0 + @openzeppelin/contracts 5.4.0
├── 文件处理:
│   ├── Sharp 0.33.5 (图像处理)
│   ├── Tesseract.js 5.1.1 (OCR)
│   ├── pdf-parse 1.1.1
│   ├── docx 9.5.1
│   ├── exceljs 4.4.0
│   └── pptxgenjs 4.0.1
├── MCP集成: @modelcontextprotocol/sdk 1.25.2
├── LLM客户端: Ollama SDK + 14+云端API客户端
├── 测试框架: Vitest 3.0.0 + Playwright 1.57.0
├── 打包: Electron Forge 7.2.0
└── 代码规范: ESLint 8.57.1 + Prettier 3.2.4
```

### 6.2 移动端

**Android**: Kotlin + Jetpack Compose + Room + SIMKey (OMAPI)

**iOS**: Swift + SwiftUI + Core Data + Core Telephony

### 6.3 后端服务 (可选)

- **中继服务器**: Rust/Go + PostgreSQL + Redis
- **引导节点**: Go + libp2p (DHT网络)

---

## 七、开发路线图

### Phase 1: MVP (最小可行产品) - 已完成 ✅
- 知识库基础功能
- AI集成 (Ollama + RAG)
- Git同步

### Phase 2: 社交功能 - 已完成 ✅
- DID系统
- P2P通信
- Signal协议加密

### Phase 3: 交易功能 - 已完成 ✅
- 交易发布与匹配
- 智能合约
- 信誉系统

### Phase 4: 生态完善 - 进行中 🚧
- [ ] 浏览器扩展完善
- [ ] 更多LLM支持
- [ ] 企业版增强
- [ ] Web端 (PWA)

---

## 八、关键挑战与解决方案

### 8.1 U盾/SIMKey兼容性

**解决方案**: 抽象层设计 + 适配器模式 + 自动检测 + 降级方案

### 8.2 移动端性能优化

**解决方案**: 模型量化 + 混合推理 + 预计算缓存 + 异步处理

### 8.3 数据隐私与合规

**解决方案**: 隐私设计原则 + GDPR/CCPA合规 + 审计日志

### 8.4 P2P网络稳定性

**解决方案**: 多层连接策略 + 离线支持 + 全球中继节点

---

## 九、商业模式 (可选)

### 9.1 免费增值模式

**免费功能**: 完整知识库、基础社交、本地LLM、Git同步

**高级功能**: 云端LLM额度、托管Git仓库、全球加速中继、企业版协作

### 9.2 企业服务

私有化部署、定制开发、技术支持、员工培训

### 9.3 生态收益

硬件销售分成、插件市场抽成、交易手续费

---

## 十、总结

这套**基于U盾和SIMKey的个人移动AI管理系统**整合了:

1. **知识库管理**: 个人第二大脑,本地AI增强检索和问答
2. **去中心化社交**: 基于DID的隐私优先社交网络
3. **去中心化交易**: AI辅助的可信交易平台

**核心优势**:

- **极致安全**: 硬件级密钥保护,端到端加密
- **完全去中心化**: 无需信任第三方平台
- **AI原生**: 本地大模型,保护隐私的同时享受AI能力
- **跨设备**: PC、手机无缝协作
- **开源自主**: 代码开源,数据自己掌控

---

## 附录

详细附录内容请参考: [实施总结与附录.md](实施总结与附录.md)

- 附录A: 快速开始指南
- 附录B: API文档
- 附录C: 版本更新历史
