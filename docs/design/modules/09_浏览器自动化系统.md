# 浏览器自动化系统

> 本文档是 [系统设计主文档](../系统设计_主文档.md) 的子文档，详细描述浏览器自动化系统的设计。

**最后更新**: 2026-02-06 (v0.29.0)

---

## 2.12 浏览器自动化系统 ✅已完成 (v0.29.0)

> **✅ 完成状态**: 已在v0.29.0版本中全部实现(Phase 1-3)
>
> **完成时间**: 2026-02-06
> **代码量**: ~3000+ 行新代码
> **核心模块**: 18个文件，4个子目录

### 2.12.1 系统概述

浏览器自动化系统提供完整的网页自动化能力，支持工作流编辑、智能元素定位、操作录制回放和 AI 诊断功能。该系统通过三个阶段逐步完成，实现了企业级的自动化测试和任务自动化需求。

**核心特性**:

- **工作流编辑器**: 可视化构建自动化工作流
- **智能元素定位**: 多策略定位 (XPath、CSS、文本、视觉识别)
- **操作录制回放**: 录制用户操作并自动生成脚本
- **AI 智能诊断**: 自动检测问题并提供修复建议
- **SPA 支持**: 单页应用状态监测和变更检测

### 2.12.2 三阶段实现

#### Phase 1: 基础引擎 (✅完成)

**BrowserEngine** - 核心自动化引擎

```javascript
// 核心功能
class BrowserEngine {
  // 浏览器实例管理
  async launch(options);
  async close();

  // 页面导航
  async goto(url, options);
  async reload();
  async goBack();
  async goForward();

  // 元素交互
  async click(selector, options);
  async type(selector, text, options);
  async select(selector, value);
  async hover(selector);

  // 页面操作
  async screenshot(options);
  async evaluate(fn, ...args);
  async waitForSelector(selector, options);
}
```

**关键文件**: `src/main/browser/browser-engine.js` (~300行)

**IPC 接口** (12个):

| 通道                     | 功能           | 参数             |
| ------------------------ | -------------- | ---------------- |
| `browser:launch`         | 启动浏览器     | options          |
| `browser:close`          | 关闭浏览器     | -                |
| `browser:goto`           | 导航到 URL     | url, options     |
| `browser:click`          | 点击元素       | selector, opts   |
| `browser:type`           | 输入文本       | selector, text   |
| `browser:screenshot`     | 截图           | options          |
| `browser:evaluate`       | 执行 JS        | script, args     |
| `browser:wait-selector`  | 等待元素       | selector, opts   |
| `browser:get-content`    | 获取页面内容   | -                |
| `browser:get-url`        | 获取当前 URL   | -                |
| `browser:get-title`      | 获取页面标题   | -                |
| `browser:execute-action` | 执行自动化动作 | action           |

#### Phase 2: 智能定位与快照 (✅完成)

**ElementLocator** - 智能元素定位器

```javascript
class ElementLocator {
  // 多策略定位
  async locate(target, options) {
    // 策略1: 精确 ID/CSS 选择器
    // 策略2: XPath 路径定位
    // 策略3: 文本内容匹配
    // 策略4: 属性匹配
    // 策略5: 视觉识别 (OCR)
  }

  // 智能元素识别
  async findSimilar(element, page);
  async generateSelector(element);

  // 元素验证
  async isVisible(selector);
  async isEnabled(selector);
  async isClickable(selector);
}
```

**关键文件**: `src/main/browser/element-locator.js` (~450行)

**定位策略优先级**:

| 优先级 | 策略         | 准确率 | 速度   | 适用场景         |
| ------ | ------------ | ------ | ------ | ---------------- |
| 1      | ID 选择器    | 99%    | <5ms   | 具有唯一 ID 元素 |
| 2      | 数据属性     | 98%    | <10ms  | 自动化测试属性   |
| 3      | CSS 选择器   | 95%    | <15ms  | 结构化页面       |
| 4      | XPath        | 93%    | <20ms  | 复杂嵌套结构     |
| 5      | 文本匹配     | 90%    | <25ms  | 动态内容         |
| 6      | 视觉识别     | 85%    | <200ms | 无明确标识元素   |

**SnapshotEngine** - 快照与诊断引擎

```javascript
class SnapshotEngine {
  // 快照管理
  async capture(page, options);
  async compare(snapshot1, snapshot2);
  async diff(baseline, current);

  // 变更检测
  async detectChanges(page, previousSnapshot);
  async highlightDifferences(diff);

  // 问题诊断
  async diagnose(page, expectedState);
  async suggestFixes(issues);
}
```

**关键文件**: `src/main/browser/diagnostics/snapshot-engine.js` (~280行)

**IPC 接口** (6个):

| 通道                     | 功能         | 参数              |
| ------------------------ | ------------ | ----------------- |
| `browser:locate-element` | 定位元素     | target, options   |
| `browser:capture-snap`   | 捕获快照     | options           |
| `browser:compare-snaps`  | 对比快照     | snap1, snap2      |
| `browser:diagnose-page`  | 诊断页面     | expectedState     |
| `browser:get-elements`   | 获取元素列表 | selector, options |
| `browser:analyze-page`   | 分析页面结构 | options           |

#### Phase 3: AI 智能代理 (✅完成)

**BrowserAutomationAgent** - AI 自动化代理

```javascript
class BrowserAutomationAgent {
  // AI 驱动的任务执行
  async executeTask(task, context);

  // 智能决策
  async analyzeIntent(userInput);
  async planSteps(goal);
  async selectAction(context);

  // 自适应执行
  async handleError(error, context);
  async retryWithAlternative(action, error);
  async learnFromExecution(result);
}
```

**关键文件**: `src/main/browser/browser-automation-agent.js` (~400行)

**智能能力**:

- **意图理解**: 从自然语言描述中提取自动化意图
- **步骤规划**: 自动生成执行步骤序列
- **错误恢复**: 智能处理执行错误，尝试替代方案
- **学习优化**: 从执行历史中学习，优化未来执行

### 2.12.3 录制与回放系统

**RecordingEngine** - 操作录制引擎

```javascript
class RecordingEngine {
  // 录制控制
  async startRecording(page, options);
  async stopRecording();
  async pauseRecording();
  async resumeRecording();

  // 事件捕获
  onUserAction(callback);
  captureClick(event);
  captureInput(event);
  captureNavigation(event);
  captureScroll(event);

  // 脚本生成
  async generateScript(format); // 'js', 'python', 'json'
  async exportRecording(path);
}
```

**关键文件**:
- `src/main/browser/recording/recorder.js` (~250行)
- `src/main/browser/recording/player.js` (~200行)

**录制事件类型**:

| 事件类型   | 描述         | 捕获数据                      |
| ---------- | ------------ | ----------------------------- |
| click      | 点击操作     | selector, coordinates, button |
| input      | 输入操作     | selector, value, inputType    |
| navigation | 页面跳转     | url, type (goto/back/forward) |
| scroll     | 滚动操作     | scrollX, scrollY, element     |
| select     | 下拉选择     | selector, value, options      |
| keypress   | 键盘操作     | key, modifiers                |
| wait       | 等待操作     | selector, timeout, condition  |

**回放控制**:

```javascript
class RecordingPlayer {
  // 回放控制
  async play(recording, options);
  async playStep(step);
  async pause();
  async resume();
  async stop();

  // 回放配置
  setSpeed(speed); // 0.5x, 1x, 2x, 4x
  setBreakpoints(stepIndexes);
  enableStepMode(enabled);
}
```

### 2.12.4 诊断系统

**SmartDiagnostics** - AI 诊断系统

```javascript
class SmartDiagnostics {
  // 问题检测
  async detectIssues(page, expectedState);
  async analyzePerformance(page);
  async checkAccessibility(page);

  // 根因分析
  async findRootCause(issue);
  async correlateIssues(issues);

  // 修复建议
  async suggestFixes(issues);
  async autoFix(issue, options);
}
```

**关键文件**: `src/main/browser/diagnostics/smart-diagnostics.js` (~350行)

**诊断类型**:

| 类型         | 检测内容                         | 自动修复 |
| ------------ | -------------------------------- | -------- |
| 元素缺失     | 预期元素不存在                   | 尝试替代选择器 |
| 元素不可见   | 元素存在但不可见                 | 滚动到视图 |
| 元素禁用     | 元素不可交互                     | 等待启用 |
| 加载超时     | 页面或元素加载超时               | 重试/刷新 |
| 断言失败     | 预期值与实际值不匹配             | 报告差异 |
| 网络错误     | API 请求失败                     | 重试请求 |
| JavaScript错误| 页面脚本错误                    | 记录并报告 |

**截图对比** - 视觉回归测试

```javascript
class ScreenshotDiff {
  // 截图对比
  async compare(baseline, current, options);

  // 差异分析
  calculateDiffPercentage(diff);
  highlightDifferences(diff);
  generateDiffImage(baseline, current);

  // 阈值配置
  setThreshold(percentage);
  setIgnoreRegions(regions);
}
```

**关键文件**: `src/main/browser/diagnostics/screenshot-diff.js` (~200行)

### 2.12.5 前端 UI 组件

**BrowserControl.vue** - 工作流编辑器

```vue
<template>
  <div class="browser-control">
    <!-- 工具栏 -->
    <div class="toolbar">
      <button @click="launchBrowser">启动浏览器</button>
      <button @click="startRecording">开始录制</button>
      <button @click="runWorkflow">运行工作流</button>
    </div>

    <!-- 浏览器预览 -->
    <div class="browser-preview">
      <iframe ref="browserFrame" />
    </div>

    <!-- 工作流编辑器 -->
    <div class="workflow-editor">
      <WorkflowStepList :steps="steps" />
      <StepEditor :step="selectedStep" />
    </div>
  </div>
</template>
```

**DiagnosticsPanel.vue** - 诊断面板

```vue
<template>
  <div class="diagnostics-panel">
    <!-- 问题列表 -->
    <IssueList :issues="issues" />

    <!-- 快照对比 -->
    <SnapshotCompare
      :baseline="baseline"
      :current="current"
    />

    <!-- 修复建议 -->
    <FixSuggestions
      :suggestions="suggestions"
      @apply="applyFix"
    />
  </div>
</template>
```

**RecordingPanel.vue** - 录制面板

```vue
<template>
  <div class="recording-panel">
    <!-- 录制控制 -->
    <RecordingControls
      :isRecording="isRecording"
      @start="startRecording"
      @stop="stopRecording"
      @pause="pauseRecording"
    />

    <!-- 步骤列表 -->
    <RecordedStepList :steps="recordedSteps" />

    <!-- 回放控制 -->
    <PlaybackControls
      :speed="playbackSpeed"
      @play="playRecording"
      @stop="stopPlayback"
    />
  </div>
</template>
```

### 2.12.6 目录结构

```
desktop-app-vue/src/main/browser/
├── browser-engine.js           # 核心自动化引擎 (~300行)
├── browser-ipc.js              # IPC 处理器 (~200行)
├── browser-automation-agent.js # AI 自动化代理 (~400行)
├── element-locator.js          # 智能元素定位 (~450行)
├── spa-observer.js             # SPA 状态监测 (~180行)
├── ocr-engine.js               # OCR 识别引擎 (~150行)
├── actions/                    # 自动化操作
│   ├── click-action.js         # 点击操作
│   ├── input-action.js         # 输入操作
│   ├── navigation-action.js    # 导航操作
│   ├── scroll-action.js        # 滚动操作
│   └── wait-action.js          # 等待操作
├── advanced/                   # 高级功能
│   ├── advanced-scanner.js     # 高级扫描器
│   ├── pattern-matcher.js      # 模式匹配
│   └── element-analyzer.js     # 元素分析
├── diagnostics/                # 诊断系统
│   ├── smart-diagnostics.js    # AI 诊断 (~350行)
│   ├── snapshot-engine.js      # 快照引擎 (~280行)
│   ├── screenshot-diff.js      # 截图对比 (~200行)
│   └── issue-reporter.js       # 问题报告
└── recording/                  # 录制系统
    ├── recorder.js             # 录制器 (~250行)
    ├── player.js               # 回放器 (~200行)
    └── script-generator.js     # 脚本生成
```

### 2.12.7 性能指标

**实测数据**:

| 指标             | 数值      | 说明                   |
| ---------------- | --------- | ---------------------- |
| 元素定位准确率   | 95%+      | 包含视觉识别备选方案   |
| 快照对比延迟     | <200ms    | 实时诊断反馈           |
| 工作流编辑响应   | <50ms     | 流畅的用户交互         |
| 录制覆盖率       | 98%+      | 完整捕获用户操作       |
| 回放成功率       | 92%+      | 含自动错误恢复         |
| AI 意图理解准确率| 88%+      | 自然语言到动作转换     |

**资源消耗**:

| 资源     | 空闲状态 | 活动状态 | 峰值     |
| -------- | -------- | -------- | -------- |
| CPU      | <1%      | 5-15%    | 30%      |
| 内存     | 50MB     | 150MB    | 300MB    |
| 磁盘 I/O | 最小     | 中等     | 高(录制) |

### 2.12.8 与其他系统集成

**AI 引擎集成**:

```javascript
// 通过 AI 引擎执行自动化任务
aiEngine.executeTask({
  type: 'browser-automation',
  goal: '登录网站并提取数据',
  parameters: {
    url: 'https://example.com',
    credentials: { username, password },
    dataSelector: '.data-table'
  }
});
```

**知识库集成**:

- 录制的工作流可保存到知识库
- 支持工作流模板共享
- 执行历史记录和分析

**P2P 协作集成**:

- 远程浏览器控制
- 协作录制和编辑
- 实时共享执行状态

### 2.12.9 安全考虑

**沙箱隔离**:

- 浏览器进程隔离执行
- 敏感数据自动过滤
- 网络请求白名单

**权限控制**:

- 操作级别权限检查
- 录制内容审计
- 脚本执行审批

**数据保护**:

- 敏感信息脱敏
- 录制数据加密存储
- 截图自动模糊处理

---

## 附录

### A. 相关文档

- [系统设计主文档](../系统设计_主文档.md)
- [AI优化系统](./06_AI优化系统.md)
- [MCP与配置系统](./08_MCP与配置系统.md)

### B. 关键提交

- `browser-automation-phase1`: 基础引擎实现
- `browser-automation-phase2`: 智能定位和快照
- `browser-automation-phase3`: AI 代理和诊断

### C. 版本历史

| 版本    | 日期       | 说明                           |
| ------- | ---------- | ------------------------------ |
| v0.29.0 | 2026-02-06 | Phase 1-3 全部完成，生产就绪   |
