# P0 任务测试指南：Token 监控 UI + 性能监控仪表板

**完成日期**：2026-01-16
**版本**：v1.0
**目标**：验证 Token 使用监控和性能监控仪表板功能完整性

---

## 📋 **任务概述**

本次 P0 任务实施了以下两个核心功能：

1. **Token 使用监控 UI** - 可视化 LLM Token 使用情况和成本
2. **性能监控仪表板** - 全方位监控系统性能指标

---

## ✅ **完成清单**

### **1. Token 使用监控 UI**

已实现的组件：

- ✅ `TokenUsageTab.vue` - 详细的 Token 使用分析页面
  - 支持时间范围筛选（今天、最近7天、最近30天、本月）
  - 提供商筛选（OpenAI、Anthropic、DeepSeek、火山引擎、Ollama）
  - 成本趋势图表（ECharts 时间序列）
  - 提供商占比饼图
  - 热门模型成本排行
  - 预算管理（每日/每周/每月限制）
  - 导出 CSV 报告
  - 缓存管理

- ✅ `TokenDashboardWidget.vue` - 紧凑的仪表板小组件
  - 本周支出进度条
  - 缓存命中率
  - 节省成本统计
  - 今日调用次数和成本
  - 预算告警

### **2. 性能监控仪表板**

已实现的组件：

- ✅ `PerformanceDashboard.vue` - 全方位性能监控仪表板
  - **顶部指标卡片**：
    - CPU 使用率（系统 + 进程）
    - 内存使用（MB + 百分比）
    - 数据库查询 P95 延迟
    - IPC 延迟 P95

  - **4个Tab页签**：
    1. **系统资源**：
       - CPU 使用趋势图
       - 内存使用趋势图

    2. **数据库性能**：
       - 慢查询列表（耗时、SQL语句、时间戳）
       - 索引优化建议
       - 一键应用索引

    3. **IPC 调用**：
       - 慢 IPC 调用列表
       - 活跃 IPC 请求监控

    4. **AI 引擎**：
       - 意图识别延迟 (P95)
       - 知识检索延迟 (P95)
       - 响应生成延迟 (P95)
       - 总响应时间 (P95)
       - 阈值对比（目标 vs 可接受）
       - 性能趋势图表

  - **操作按钮**：
    - 手动刷新
    - 清除历史
    - 导出性能报告
    - 自动刷新开关（默认每5秒）

### **3. IPC 处理程序**

已注册的 IPC 通道（位于 `llm-ipc.js`）：

- ✅ `llm:get-usage-stats` - 获取使用统计
- ✅ `llm:get-cost-breakdown` - 获取成本分解
- ✅ `llm:get-budget` - 获取预算配置
- ✅ `llm:set-budget` - 设置预算限制
- ✅ `llm:export-cost-report` - 导出成本报告
- ✅ `llm:clear-cache` - 清除缓存
- ✅ `llm:get-cache-stats` - 获取缓存统计
- ✅ `llm:get-time-series` - 获取时间序列数据

性能监控 IPC（位于 `performance-ipc.js`）：

- ✅ `performance:getMetrics` - 获取详细指标
- ✅ `performance:getCPUMetrics` - 获取 CPU 指标
- ✅ `performance:getMemoryMetrics` - 获取内存指标
- ✅ `performance:getSlowQueries` - 获取慢查询
- ✅ `performance:getSlowIPCCalls` - 获取慢 IPC 调用
- ✅ `performance:getActiveIPCRequests` - 获取活跃请求
- ✅ `performance:clearHistory` - 清除历史
- ✅ `performance:exportReport` - 导出报告

数据库性能 IPC（位于 `database-performance-ipc.js`）：

- ✅ `db-performance:get-stats` - 获取统计
- ✅ `db-performance:get-slow-queries` - 获取慢查询
- ✅ `db-performance:get-index-suggestions` - 获取索引建议
- ✅ `db-performance:apply-index-suggestion` - 应用单个索引
- ✅ `db-performance:apply-all-index-suggestions` - 应用所有索引

### **4. 路由集成**

已添加的路由：

- ✅ `/performance/dashboard` - 性能监控仪表板（新增）
- ✅ `/settings?tab=token-usage` - Token 使用（已有）
- ✅ `/settings?tab=performance` - 性能监控（已有）

---

## 🧪 **测试步骤**

### **测试环境准备**

```bash
# 1. 进入项目目录
cd desktop-app-vue

# 2. 确保依赖已安装
npm install

# 3. 构建主进程
npm run build:main

# 4. 启动开发服务器
npm run dev
```

---

### **测试 1：Token 使用监控 UI**

#### **1.1 访问 Token 使用页面**

1. 启动应用后，点击右上角 **设置（⚙️）** 图标
2. 在设置页面中，切换到 **Token 使用** 标签页

#### **1.2 验证顶部统计卡片**

检查以下4个卡片是否正常显示：

- ✅ **总 Token 使用**：显示总数 + 本周数量
- ✅ **总成本**：显示美元金额 + 本周成本
- ✅ **缓存命中率**：显示百分比 + 节省 Token 数
- ✅ **平均成本/次**：显示单次调用平均成本 + 总调用次数

#### **1.3 验证筛选功能**

1. **日期范围筛选**：
   - 点击日期选择器，选择 "今天"
   - 验证图表和表格数据更新
   - 再选择 "最近30天"，验证数据变化

2. **提供商筛选**：
   - 从下拉菜单选择 "OpenAI"
   - 验证只显示 OpenAI 的数据
   - 选择 "全部提供商" 恢复

#### **1.4 验证图表**

1. **成本趋势图**：
   - 检查图表是否显示
   - 验证双 Y 轴（Token 数 vs 成本）
   - 鼠标悬停查看 tooltip

2. **提供商占比饼图**：
   - 检查饼图是否渲染
   - 验证图例显示
   - 点击图例隐藏/显示对应扇区

#### **1.5 验证热门模型排行**

检查表格是否显示：

- ✅ 排名、提供商、模型名称
- ✅ Token 数（格式化显示）
- ✅ 调用次数
- ✅ 成本（绿色粗体）

#### **1.6 验证预算管理**

1. 检查三个预算进度条：
   - 每日预算
   - 每周预算
   - 每月预算

2. 点击 **设置预算限制** 按钮：
   - 修改每日限制为 `$0.50`
   - 修改每周限制为 `$3.00`
   - 修改每月限制为 `$15.00`
   - 点击 **确定**，验证保存成功

3. 验证预算告警：
   - 如果使用超过 80%，应显示黄色警告
   - 如果使用超过 95%，应显示红色告警

#### **1.7 验证导出和缓存**

1. **导出 CSV 报告**：
   - 点击 **导出 CSV** 按钮
   - 验证成功提示："报告已导出: ..."
   - 检查文件是否生成

2. **清除缓存**：
   - 点击 **清除缓存** 按钮
   - 验证成功提示："已清除 X 条缓存"
   - 刷新页面，缓存命中率应降低

---

### **测试 2：性能监控仪表板**

#### **2.1 访问性能监控页面**

**方式1**：通过设置页面

1. 点击设置
2. 切换到 **性能监控** 标签页

**方式2**：通过路由直接访问

- 在地址栏输入：`#/performance/dashboard`

#### **2.2 验证顶部指标卡片**

检查4个卡片是否实时更新：

- ✅ **CPU 使用率**：
  - 显示系统 CPU 使用率（0-100%）
  - 下方显示进程使用率
  - 超过70%显示黄色，超过90%显示红色

- ✅ **内存使用**：
  - 显示已用内存（MB）
  - 下方显示总内存
  - 超过70%显示黄色，超过85%显示红色

- ✅ **数据库查询 (P95)**：
  - 显示 P95 延迟（毫秒）
  - 下方显示慢查询数量
  - 超过100ms显示黄色，超过200ms显示红色

- ✅ **IPC 延迟 (P95)**：
  - 显示 IPC P95 延迟
  - 下方显示活跃请求数
  - 超过50ms显示黄色，超过100ms显示红色

#### **2.3 验证操作按钮**

1. **手动刷新**：
   - 点击 **刷新** 按钮
   - 验证加载动画
   - 检查数据是否更新

2. **自动刷新开关**：
   - 默认应为 "自动刷新" 状态
   - 关闭后，数据停止自动更新
   - 重新打开，每5秒刷新一次

3. **清除历史**：
   - 点击 **清除历史**
   - 验证成功提示
   - 趋势图应重置

4. **导出报告**：
   - 点击 **导出报告**
   - 验证导出成功

#### **2.4 测试"系统资源"标签页**

1. 切换到 **系统资源** Tab
2. 验证两个图表：
   - **CPU 使用趋势**：
     - 显示实时曲线
     - X轴为时间（HH:mm:ss）
     - Y轴为百分比（0-100%）
     - 曲线平滑过渡

   - **内存使用趋势**：
     - 显示实时曲线
     - 与 CPU 图表样式一致

3. 执行密集操作（如打开多个标签页），观察曲线上升

#### **2.5 测试"数据库性能"标签页**

1. 切换到 **数据库性能** Tab

2. **慢查询列表**：
   - 检查表格是否显示慢查询
   - 验证列：
     - 查询语句（超长自动省略，hover 显示完整）
     - 耗时（带颜色标签：绿色 < 100ms，橙色 < 200ms，红色 ≥ 200ms）
     - 时间戳（HH:mm:ss 格式）
   - 测试分页功能

3. **索引优化建议**：
   - 如果有建议，检查显示：
     - 表名
     - 字段列表
     - 优化原因
     - 预计改善
   - 点击单个建议的 **应用** 按钮
   - 验证成功提示："索引已应用"
   - 点击 **应用所有建议** 按钮
   - 验证成功提示："已应用 X 个索引建议"
   - 如果无建议，应显示空状态提示

#### **2.6 测试"IPC 调用"标签页**

1. 切换到 **IPC 调用** Tab

2. **慢 IPC 调用**：
   - 验证表格显示慢调用记录
   - 列：IPC 通道、耗时（带颜色）、时间戳
   - 测试分页

3. **活跃 IPC 请求**：
   - 如果当前有活跃请求，显示：
     - IPC 通道
     - 已运行时长
     - 开始时间
   - 如果无活跃请求，显示空状态

#### **2.7 测试"AI 引擎"标签页**

1. 切换到 **AI 引擎** Tab

2. 验证4个性能指标卡片：
   - **意图识别延迟 (P95)**：
     - 显示延迟值
     - 下方显示阈值："阈值: 1500 ms"
     - 颜色：绿色（< 1000ms）、黄色（< 1500ms）、红色（≥ 1500ms）

   - **知识检索延迟 (P95)**：
     - 阈值：2000 ms

   - **响应生成延迟 (P95)**：
     - 阈值：4000 ms

   - **总响应时间 (P95)**：
     - 阈值：8000 ms

3. **AI 引擎性能趋势图**：
   - 验证柱状图显示4个指标的实际延迟
   - 验证两条虚线：
     - 绿色虚线：目标阈值
     - 黄色虚线：可接受阈值
   - 鼠标悬停查看详细数值

---

### **测试 3：集成测试**

#### **3.1 测试数据联动**

1. 在 AI 聊天页面进行一次对话
2. 切换到 Token 使用页面
3. 验证：
   - 总 Token 数增加
   - 总成本增加
   - 今日调用次数 +1
   - 成本趋势图更新

#### **3.2 测试性能监控实时性**

1. 打开性能监控仪表板
2. 执行以下操作：
   - 导入大文件（触发文件处理）
   - 运行复杂查询（触发数据库慢查询）
   - 发起 AI 对话（触发 IPC 调用）
3. 验证：
   - CPU/内存使用率上升
   - 慢查询列表更新
   - AI 引擎延迟变化

#### **3.3 测试预算告警**

1. 设置极低的每日预算（如 $0.01）
2. 发起 AI 对话
3. 验证：
   - Token 使用页面显示红色告警
   - Dashboard Widget 显示告警
   - 可选：桌面通知（如已启用）

---

## 🐛 **已知问题和注意事项**

### **潜在问题**

1. **ECharts 图表未渲染**
   - **原因**：窗口大小变化后图表未自动调整
   - **解决**：手动刷新页面或切换标签页

2. **IPC 调用超时**
   - **原因**：后端性能监控数据收集耗时
   - **解决**：等待 Loading 状态结束

3. **Token 数据为 0**
   - **原因**：数据库中无历史使用记录
   - **解决**：先进行一次 AI 对话生成数据

### **兼容性**

- ✅ **支持**：Windows 10/11, Electron 39+
- ⚠️ **限制**：某些图表功能需要 GPU 加速
- ⚠️ **注意**：首次加载可能需要 2-3 秒初始化 ECharts

---

## 📊 **性能基准**

### **UI 加载性能**

- Token 使用页面首次加载：< 2s
- 性能监控页面首次加载：< 2s
- 图表渲染时间：< 500ms
- 数据刷新间隔：5s（自动）

### **内存占用**

- Token 使用页面：+15 MB
- 性能监控页面：+20 MB
- ECharts 图表实例：~8 MB/图表

---

## ✅ **验收标准**

### **Token 监控 UI**

- [ ] 所有统计卡片正常显示
- [ ] 日期范围筛选正常工作
- [ ] 提供商筛选正常工作
- [ ] 成本趋势图正常渲染
- [ ] 提供商占比饼图正常渲染
- [ ] 热门模型排行正常显示
- [ ] 预算管理可设置和保存
- [ ] 预算告警正常触发
- [ ] 导出 CSV 功能正常
- [ ] 清除缓存功能正常

### **性能监控仪表板**

- [ ] 顶部4个指标卡片实时更新
- [ ] CPU/内存趋势图实时绘制
- [ ] 慢查询列表正常显示
- [ ] 索引优化建议正常显示并可应用
- [ ] 慢 IPC 调用列表正常显示
- [ ] 活跃 IPC 请求实时监控
- [ ] AI 引擎4个性能指标正常显示
- [ ] AI 性能趋势图正常渲染
- [ ] 自动刷新功能正常
- [ ] 导出性能报告功能正常

### **集成测试**

- [ ] AI 对话后 Token 数据实时更新
- [ ] 性能操作后监控数据实时更新
- [ ] 预算告警正常触发并显示
- [ ] 所有 IPC 调用无错误

---

## 🎉 **测试完成后**

1. **更新 CLAUDE.md**：
   - 在 "已完成的优化措施" 部分标记 P0 任务为 ✅

2. **提交 Git Commit**：

   ```bash
   git add .
   git commit -m "feat(ui): 完成 P0 任务 - Token 监控 UI + 性能监控仪表板

   - 完善 PerformanceDashboard.vue（4个Tab页签，全方位性能监控）
   - 增强 TokenUsageTab.vue（图表、筛选、预算管理）
   - 添加 TokenDashboardWidget.vue（紧凑仪表板组件）
   - 集成所有 IPC 处理程序（Token追踪、性能监控、数据库性能）
   - 添加路由和导航菜单集成
   - 编写测试指南和文档

   🎯 用户可见性大幅提升：
   - Token 使用可视化，成本透明
   - 性能问题快速定位
   - 实时监控告警

   📊 技术细节：
   - ECharts 实时图表
   - 自动刷新（每5秒）
   - 预算管理和告警
   - 索引优化建议
   - AI 引擎性能分析"
   ```

3. **更新优化计划文档**：
   - 在 `OPTIMIZATION_PLAN_FROM_OPENCLAUDE.md` 中标记 P0 任务完成

---

## 📚 **相关文档**

- [OPTIMIZATION_PLAN_FROM_OPENCLAUDE.md](./OPTIMIZATION_PLAN_FROM_OPENCLAUDE.md) - 总体优化计划
- [TokenTracker 实现文档](../../desktop-app-vue/src/main/llm/token-tracker.js) - 后端 Token 追踪
- [PerformanceMonitor 实现文档](../../desktop-app-vue/src/main/performance/performance-monitor.js) - 后端性能监控
- [CLAUDE.md](../../CLAUDE.md) - 项目总览

---

**测试负责人**：Claude Code
**测试日期**：2026-01-16
**预计测试时长**：30-45 分钟
