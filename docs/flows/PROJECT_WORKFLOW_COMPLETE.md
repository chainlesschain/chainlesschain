# ChainlessChain 项目完整工作流程文档

> 版本: v0.26.2 | 更新日期: 2026-01-26
> 涵盖: 用户调查 → 需求分析 → 开发实现 → 文档生成 → 交付部署

---

## 目录

1. [项目概览](#1-项目概览)
2. [用户调查与需求分析](#2-用户调查与需求分析)
3. [系统架构流程](#3-系统架构流程)
4. [核心功能流程](#4-核心功能流程)
5. [文档生成系统](#5-文档生成系统)
6. [开发到交付流程](#6-开发到交付流程)
7. [数据流转图](#7-数据流转图)

---

## 1. 项目概览

### 1.1 项目定位

ChainlessChain 是一个去中心化个人 AI 管理系统，集成三大核心功能：

```
┌─────────────────────────────────────────────────────────────┐
│                    ChainlessChain                           │
├─────────────────┬─────────────────┬─────────────────────────┤
│   知识库管理     │   去中心化社交    │      去中心化交易        │
│  (Second Brain) │  (P2P + DID)    │   (Marketplace)         │
├─────────────────┼─────────────────┼─────────────────────────┤
│ • RAG 增强搜索   │ • DID 身份认证   │ • 数字资产管理           │
│ • 知识图谱可视化  │ • P2P 加密通讯   │ • 智能合约托管           │
│ • 多格式导入导出  │ • Signal 协议    │ • 多链跨链桥接           │
│ • AI 对话增强    │ • 社交论坛       │ • 知识付费变现           │
└─────────────────┴─────────────────┴─────────────────────────┘
```

### 1.2 技术栈概览

| 层级 | 技术选型 |
|------|----------|
| 前端框架 | Electron 39.2.7 + Vue 3.4 + Vite 7.2 |
| UI 组件 | Ant Design Vue 4.1 |
| 状态管理 | Pinia 2.1 (23个 Store) |
| 本地数据库 | SQLCipher (AES-256 加密) |
| 向量存储 | ChromaDB / Qdrant |
| P2P 网络 | libp2p 3.1.2 |
| 加密协议 | Signal Protocol + Noise |
| 区块链 | ethers.js 6.16 (15+ 链支持) |
| LLM 支持 | 14+ 云服务商 + Ollama 本地 |

---

## 2. 用户调查与需求分析

### 2.1 用户调查流程

```
┌──────────────────────────────────────────────────────────────────┐
│                      用户调查完整流程                              │
└──────────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│  用户画像分析   │    │  需求收集     │    │  竞品分析     │
├───────────────┤    ├───────────────┤    ├───────────────┤
│ • 目标用户群体  │    │ • 功能需求    │    │ • 功能对比    │
│ • 使用场景     │    │ • 性能需求    │    │ • 技术对比    │
│ • 痛点分析     │    │ • 安全需求    │    │ • 差异化定位  │
│ • 期望价值     │    │ • 体验需求    │    │ • 优势识别    │
└───────────────┘    └───────────────┘    └───────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              ▼
                    ┌───────────────────┐
                    │    需求优先级排序   │
                    ├───────────────────┤
                    │ P0: 核心功能       │
                    │ P1: 重要功能       │
                    │ P2: 增强功能       │
                    │ P3: 未来规划       │
                    └───────────────────┘
                              │
                              ▼
                    ┌───────────────────┐
                    │    产品规格文档    │
                    └───────────────────┘
```

### 2.2 用户画像定义

#### 目标用户群体

| 用户类型 | 特征描述 | 核心需求 |
|----------|----------|----------|
| **知识工作者** | 研究员、作家、分析师 | 高效知识管理、AI 辅助写作 |
| **开发者** | 软件工程师、架构师 | 代码管理、技术文档、AI 编程 |
| **创业者** | 小团队负责人 | 团队协作、知识共享、低成本 |
| **内容创作者** | 博主、教育者 | 内容变现、知识付费、版权保护 |
| **隐私关注者** | 对数据安全敏感的用户 | 本地存储、端对端加密、去中心化 |

#### 用户场景分析

```
场景1: 知识管理
┌─────────────────────────────────────────────────────────┐
│ 用户: 研究员                                             │
│ 需求: 整理大量论文和笔记，快速检索相关内容                   │
│ 流程: 导入文档 → 自动分类 → RAG 索引 → AI 问答 → 生成报告   │
│ 痛点: 传统工具检索效率低，无法跨文档关联                     │
│ 价值: 节省 60% 检索时间，发现隐藏知识关联                   │
└─────────────────────────────────────────────────────────┘

场景2: 团队协作
┌─────────────────────────────────────────────────────────┐
│ 用户: 创业团队                                           │
│ 需求: 安全共享敏感文档，不依赖第三方云服务                   │
│ 流程: 创建组织 → 邀请成员 → DID 认证 → P2P 同步 → 权限控制  │
│ 痛点: 云服务费用高，数据泄露风险                           │
│ 价值: 零云服务费，完全数据自主                             │
└─────────────────────────────────────────────────────────┘

场景3: 知识变现
┌─────────────────────────────────────────────────────────┐
│ 用户: 内容创作者                                         │
│ 需求: 将专业知识打包销售，保护版权                         │
│ 流程: 创建内容 → NFT 铸造 → 上架市场 → 托管交易 → 收款     │
│ 痛点: 平台抽成高(30%+)，版权难以追溯                       │
│ 价值: 低抽成(2-5%)，区块链版权永久存证                     │
└─────────────────────────────────────────────────────────┘
```

### 2.3 需求分析矩阵

| 需求类别 | P0 (必须) | P1 (重要) | P2 (增强) |
|----------|-----------|-----------|-----------|
| **知识管理** | 笔记CRUD、搜索 | RAG增强、知识图谱 | AI写作、多模态 |
| **AI 对话** | 基础对话、多模型 | 上下文管理、工具调用 | 多Agent、自主规划 |
| **社交通讯** | 联系人、消息 | 群组、文件传输 | 音视频、设备同步 |
| **交易市场** | 钱包、转账 | 市场、托管 | 跨链、智能合约 |
| **安全隐私** | 加密存储 | E2E加密、DID | 硬件密钥、零知识证明 |

### 2.4 用户反馈收集机制

```javascript
// 系统内置的用户反馈收集点
const feedbackPoints = {
  // 1. 应用内反馈
  inApp: {
    bugReport: 'Help → Report Bug',
    featureRequest: 'Help → Request Feature',
    rating: 'Settings → Rate App',
    nps: '每月弹窗 NPS 调查'
  },

  // 2. 使用数据分析 (匿名)
  analytics: {
    featureUsage: '功能使用频率统计',
    errorPatterns: '错误模式识别',
    performanceMetrics: '性能指标收集',
    userJourney: '用户路径分析'
  },

  // 3. 社区渠道
  community: {
    github: 'Issues / Discussions',
    discord: '社区频道反馈',
    forum: '官方论坛讨论'
  }
};
```

---

## 3. 系统架构流程

### 3.1 应用启动流程 (10阶段)

```
应用启动 (index.js)
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 1: 核心基础设施 (10%)                                  │
│ ├── Database (SQLCipher AES-256)                            │
│ ├── GraphExtractor (知识图谱)                                │
│ ├── VersionManager (版本管理)                                │
│ └── PerformanceMonitor (性能监控)                            │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 2: 文件与模板 (20%)                                    │
│ ├── FileImporter (多格式导入)                                │
│ ├── TemplateManager (提示词模板)                             │
│ └── UKeyManager (硬件密钥)                                   │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 3: LLM 服务 (35%)                                      │
│ ├── LLMSelector (智能路由)                                   │
│ ├── TokenTracker (成本追踪)                                  │
│ ├── PromptCompressor (上下文压缩)                            │
│ ├── ResponseCache (响应缓存)                                 │
│ └── LLMManager (14+ 服务商)                                  │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 4: 会话与监控 (45%)                                    │
│ ├── SessionManager (对话上下文)                              │
│ ├── ErrorMonitor (AI 诊断)                                   │
│ ├── MultiAgentSystem (多Agent)                               │
│ └── MemoryBank (学习记忆)                                    │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 5: RAG 与 Git (55%)                                    │
│ ├── RAGManager (检索增强生成)                                │
│ ├── PromptTemplates (提示词管理)                             │
│ └── GitManager (版本控制)                                    │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 6: P2P 社交网络 (65%)                                  │
│ ├── DIDManager (去中心化身份)                                │
│ ├── P2PManager (libp2p 网络)                                 │
│ ├── ContactManager (联系人)                                  │
│ ├── FriendManager (好友关系)                                 │
│ └── PostManager (社交动态)                                   │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 7: 企业功能 (75%)                                      │
│ ├── OrganizationManager (组织管理)                           │
│ ├── CollaborationManager (协作)                              │
│ ├── SyncEngine (同步引擎)                                    │
│ ├── VCManager (可验证凭证)                                   │
│ └── VCTemplateManager (凭证模板)                             │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 8: AI 引擎 (85%)                                       │
│ ├── WebEngine (网页分析)                                     │
│ ├── DocumentEngine (文档处理)                                │
│ ├── DataEngine (数据分析)                                    │
│ ├── VisionManager (视觉理解) ← 新增                          │
│ ├── MemGPTCore (长期记忆) ← 新增                             │
│ ├── ImageGenManager (图像生成) ← 新增                        │
│ ├── TTSManager (语音合成) ← 新增                             │
│ └── AIEngineManager (任务规划)                               │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 9: 技能与工具 (90%)                                    │
│ ├── ToolManager (285个工具)                                  │
│ ├── SkillManager (可组合技能)                                │
│ ├── SkillExecutor (技能执行)                                 │
│ ├── AIScheduler (任务调度)                                   │
│ └── ChatSkillBridge (对话技能桥接)                           │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ Phase 10: 交易系统 (95%)                                     │
│ ├── AssetManager (数字资产)                                  │
│ ├── EscrowManager (托管)                                     │
│ ├── MarketplaceManager (市场)                                │
│ ├── ContractEngine (智能合约)                                │
│ ├── KnowledgePaymentManager (知识付费)                       │
│ └── CreditScoreManager (信用评分)                            │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 启动完成 (100%)                                              │
│ ├── 注册 IPC 处理器 (150+ 通道)                              │
│ ├── 初始化 MCP 系统                                          │
│ └── 创建主窗口                                               │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 IPC 通信架构

```
┌─────────────────────────────────────────────────────────────┐
│                     Renderer (Vue)                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                  Pinia Stores (23个)                 │   │
│  │  app, conversation, llm, session, skill, task...    │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│                    window.api                               │
│                          │                                  │
└──────────────────────────┼──────────────────────────────────┘
                           │ IPC (contextBridge)
┌──────────────────────────┼──────────────────────────────────┐
│                     Preload Script                          │
│              (安全桥接, 白名单通道)                           │
└──────────────────────────┼──────────────────────────────────┘
                           │
┌──────────────────────────┼──────────────────────────────────┐
│                      Main Process                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              IPC Registry (150+ handlers)            │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │ LLM IPC │ │ RAG IPC │ │ P2P IPC │ │ DB IPC  │   │   │
│  │  │ (14个)  │ │ (10个)  │ │ (20个)  │ │ (8个)   │   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐   │   │
│  │  │Block IPC│ │Vision   │ │MemGPT  │ │ImageGen │   │   │
│  │  │ (15个)  │ │ (8个)   │ │ (24个)  │ │ (15个)  │   │   │
│  │  └─────────┘ └─────────┘ └─────────┘ └─────────┘   │   │
│  └─────────────────────────────────────────────────────┘   │
│                          │                                  │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                    Managers                          │   │
│  │  LLMManager, RAGManager, P2PManager, Database...    │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 核心功能流程

### 4.1 知识管理完整流程

```
用户操作                    系统处理                     存储层
─────────                   ─────────                    ─────
    │                           │                          │
    │  1. 创建/导入笔记          │                          │
    ├──────────────────────────►│                          │
    │                           │                          │
    │                     ┌─────┴─────┐                    │
    │                     │FileImporter│                   │
    │                     │ 支持格式:  │                   │
    │                     │ • Markdown │                   │
    │                     │ • PDF      │                   │
    │                     │ • Word     │                   │
    │                     │ • HTML     │                   │
    │                     │ • 图片OCR  │                   │
    │                     └─────┬─────┘                    │
    │                           │                          │
    │                           ▼                          │
    │                     ┌───────────┐                    │
    │                     │  解析内容  │                    │
    │                     │ • 提取文本 │                    │
    │                     │ • 提取图片 │                    │
    │                     │ • 提取元数据│                   │
    │                     └─────┬─────┘                    │
    │                           │                          │
    │                           ▼                          │
    │                     ┌───────────┐    ┌─────────────┐
    │                     │ 保存到DB  │───►│ SQLCipher   │
    │                     │ (notes表) │    │ (AES-256)   │
    │                     └─────┬─────┘    └─────────────┘
    │                           │                          │
    │                           ▼                          │
    │                     ┌───────────┐                    │
    │                     │ RAG 索引  │                    │
    │                     │ • 文本分块 │                    │
    │                     │ • 生成嵌入 │                    │
    │                     │ • 存入向量库│                   │
    │                     └─────┬─────┘    ┌─────────────┐
    │                           │─────────►│ ChromaDB/   │
    │                           │          │ Qdrant      │
    │                           ▼          └─────────────┘
    │                     ┌───────────┐                    │
    │                     │知识图谱提取│                    │
    │                     │ • 实体识别 │                    │
    │                     │ • 关系抽取 │                    │
    │                     │ • 图谱构建 │                    │
    │                     └─────┬─────┘                    │
    │                           │                          │
    │◄──────────────────────────┤                          │
    │  2. 返回成功              │                          │
    │                           │                          │
    │  3. 搜索知识              │                          │
    ├──────────────────────────►│                          │
    │                           │                          │
    │                     ┌─────┴─────┐                    │
    │                     │RAGManager │                    │
    │                     │ 混合搜索:  │                   │
    │                     │ • 向量搜索 │◄────ChromaDB      │
    │                     │ • 关键词   │◄────SQLite FTS    │
    │                     │ • 重排序   │◄────BGE-Reranker  │
    │                     └─────┬─────┘                    │
    │                           │                          │
    │◄──────────────────────────┤                          │
    │  4. 返回搜索结果           │                          │
    │                           │                          │
    │  5. AI 问答               │                          │
    ├──────────────────────────►│                          │
    │                     ┌─────┴─────┐                    │
    │                     │ RAG 增强   │                   │
    │                     │ • 检索上下文│                   │
    │                     │ • 构建提示词│                   │
    │                     │ • 调用 LLM │                   │
    │                     └─────┬─────┘                    │
    │◄──────────────────────────┤                          │
    │  6. 返回 AI 回答          │                          │
```

### 4.2 AI 对话完整流程

```
┌─────────────────────────────────────────────────────────────┐
│                    AI 对话处理流程                           │
└─────────────────────────────────────────────────────────────┘

用户输入: "帮我分析这份报告的关键观点"
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 1: 意图识别 (IntentClassifier)                        │
├───────────────────────────────────────────────────────────┤
│ 输入: 用户消息 + 上下文                                     │
│ 输出: {                                                    │
│   primaryIntent: 'document_analysis',                      │
│   secondaryIntents: ['summarization', 'extraction'],       │
│   entities: { documentType: 'report' },                    │
│   confidence: 0.92                                         │
│ }                                                          │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 2: RAG 检索 (RAGManager)                              │
├───────────────────────────────────────────────────────────┤
│ 1. 查询改写 (QueryRewriter)                                │
│    原始: "分析报告关键观点"                                  │
│    改写: ["报告核心论点", "主要发现", "关键结论"]             │
│                                                            │
│ 2. 混合检索                                                 │
│    • 向量搜索: top-20 相似文档块                            │
│    • 关键词搜索: BM25 匹配                                  │
│    • 合并去重: 30 个候选                                    │
│                                                            │
│ 3. 重排序 (BGE-Reranker)                                   │
│    • 60% BGE 分数 + 40% 向量相似度                         │
│    • 输出: top-5 最相关文档块                               │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 3: 上下文压缩 (PromptCompressor)                      │
├───────────────────────────────────────────────────────────┤
│ 输入: 系统提示 + 历史消息 + RAG 上下文 + 用户问题           │
│ 处理:                                                      │
│ • 检测总 Token 数: 12,500                                  │
│ • 目标 Token 数: 8,000                                     │
│ • 压缩策略: 可恢复压缩                                      │
│ • 压缩后: 7,800 tokens (节省 37.6%)                        │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 4: 缓存检查 (ResponseCache)                           │
├───────────────────────────────────────────────────────────┤
│ • 计算语义哈希                                              │
│ • 查找相似请求 (相似度 > 0.95)                              │
│ • 未命中缓存 → 继续调用 LLM                                 │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 5: 模型选择 (LLMSelector)                             │
├───────────────────────────────────────────────────────────┤
│ 评估因素:                                                   │
│ • 任务类型: 文档分析 → 推荐 Claude/GPT-4                    │
│ • Token 预算: 剩余 $45.00                                  │
│ • 历史性能: Claude 准确率 94%                               │
│ • 响应延迟: GPT-4 平均 2.3s                                │
│                                                            │
│ 决策: 使用 Claude-3-Opus                                   │
│ 原因: 文档分析任务最优 + 预算充足                           │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 6: LLM 调用 (LLMManager)                              │
├───────────────────────────────────────────────────────────┤
│ 请求:                                                       │
│ {                                                          │
│   model: 'claude-3-opus',                                  │
│   messages: [...压缩后的消息],                              │
│   tools: [已注册的工具定义],                                │
│   stream: true                                             │
│ }                                                          │
│                                                            │
│ 流式响应:                                                   │
│ "根据报告分析，以下是关键观点：\n\n"                         │
│ "1. **市场趋势**：报告指出..."                              │
│ "2. **技术创新**：主要体现在..."                            │
│ ...                                                        │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 7: 后处理                                              │
├───────────────────────────────────────────────────────────┤
│ 1. Token 统计 (TokenTracker)                               │
│    • 输入: 7,800 tokens × $0.015 = $0.117                  │
│    • 输出: 1,200 tokens × $0.075 = $0.090                  │
│    • 总计: $0.207                                          │
│                                                            │
│ 2. 响应缓存                                                 │
│    • 存入 ResponseCache (TTL: 24h)                         │
│                                                            │
│ 3. 会话保存 (SessionManager)                               │
│    • 更新对话历史                                           │
│    • 检查是否需要压缩 (> 30k tokens)                        │
│                                                            │
│ 4. 生成后续建议                                             │
│    • "深入分析第一个观点"                                   │
│    • "对比其他报告"                                         │
│    • "生成摘要报告"                                         │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 8: UI 展示                                            │
├───────────────────────────────────────────────────────────┤
│ • 流式渲染 Markdown                                        │
│ • 高亮引用来源                                              │
│ • 显示 Token 消耗                                          │
│ • 展示后续建议按钮                                          │
└───────────────────────────────────────────────────────────┘
```

### 4.3 P2P 社交通讯流程

```
┌─────────────────────────────────────────────────────────────┐
│                  P2P 通讯完整流程                            │
└─────────────────────────────────────────────────────────────┘

                    用户A                    用户B
                      │                        │
Step 1: 创建 DID      │                        │
                      │                        │
    ┌─────────────────┴─────────────────┐     │
    │ DIDManager.createDID()            │     │
    │ • 生成 Ed25519 密钥对              │     │
    │ • 创建 DID 文档                    │     │
    │ • 存储到本地数据库                  │     │
    │ • 发布到 DHT (可选)                │     │
    └─────────────────┬─────────────────┘     │
                      │                        │
                      │  did:chainless:abc123  │
                      │                        │
Step 2: 添加联系人     │                        │
                      │                        │
    ┌─────────────────┴────────────────────────┴─────────────────┐
    │ 方式1: 扫描 QR 码 (包含 DID + 公钥)                         │
    │ 方式2: 手动输入 DID                                         │
    │ 方式3: DHT 搜索                                             │
    └─────────────────┬────────────────────────┬─────────────────┘
                      │                        │
Step 3: 配对握手      │                        │
                      │                        │
    ┌─────────────────┴────────────────────────┴─────────────────┐
    │                    Signal 协议配对                          │
    │                                                             │
    │  用户A                                         用户B        │
    │    │                                             │          │
    │    │──── 1. PreKeyBundle ────────────────────►  │          │
    │    │     (身份密钥 + 签名预密钥 + 一次性预密钥)    │          │
    │    │                                             │          │
    │    │  ◄─── 2. PreKeyBundle ──────────────────── │          │
    │    │                                             │          │
    │    │──── 3. 验证安全号码 (指纹对比) ────────────► │          │
    │    │                                             │          │
    │    │  ◄─── 4. 确认配对 ─────────────────────────│          │
    │    │                                             │          │
    │    │     5. 建立 Double Ratchet 会话             │          │
    │    │        (完美前向保密)                        │          │
    │                                                             │
    └─────────────────┬────────────────────────┬─────────────────┘
                      │                        │
Step 4: 发送消息      │                        │
                      │                        │
    ┌─────────────────┴─────────────────┐     │
    │ 1. 编写消息                        │     │
    │ 2. Signal 加密                     │     │
    │    • 获取会话状态                   │     │
    │    • Ratchet 前进                  │     │
    │    • AES-256-GCM 加密              │     │
    │ 3. P2P 传输                        │     │
    │    • DHT 查找对方节点               │     │
    │    • 建立直连 (TCP/WebRTC)         │     │
    │    • 发送加密数据                   │     │
    └─────────────────┬─────────────────┘     │
                      │                        │
                      │ ══加密消息══════════► │
                      │                        │
                      │     ┌─────────────────┴─────────────────┐
                      │     │ 4. 接收 & 解密                     │
                      │     │    • Signal 解密                   │
                      │     │    • 验证签名                      │
                      │     │    • 更新 Ratchet 状态             │
                      │     │ 5. 存储到本地数据库                 │
                      │     │ 6. 显示消息                        │
                      │     └─────────────────┬─────────────────┘
                      │                        │
Step 5: 多设备同步     │                        │
                      │                        │
    ┌─────────────────┴─────────────────┐     │
    │ DeviceSyncManager                  │     │
    │ • 检测已配对设备                    │     │
    │ • 同步消息到手机/平板               │     │
    │ • 同步已读状态                      │     │
    │ • 冲突解决 (时间戳优先)             │     │
    └───────────────────────────────────┘     │
```

### 4.4 交易市场流程

```
┌─────────────────────────────────────────────────────────────┐
│                   知识付费交易流程                            │
└─────────────────────────────────────────────────────────────┘

卖家                        系统                        买家
  │                          │                           │
  │  1. 创建知识产品          │                           │
  ├─────────────────────────►│                           │
  │                          │                           │
  │   ┌──────────────────────┴──────────────────────┐   │
  │   │ MarketplaceManager.createListing()          │   │
  │   │ • 验证内容完整性                              │   │
  │   │ • 设置价格和许可条款                          │   │
  │   │ • 生成内容哈希 (防篡改)                       │   │
  │   │ • 可选: 铸造 NFT (版权存证)                   │   │
  │   └──────────────────────┬──────────────────────┘   │
  │                          │                           │
  │                          │  2. 发布到 DHT            │
  │                          ├─────────────────────────►│
  │                          │                           │
  │                          │                           │  3. 浏览市场
  │                          │◄──────────────────────────┤
  │                          │                           │
  │                          │  4. 查看产品详情          │
  │                          ├─────────────────────────►│
  │                          │                           │
  │                          │  5. 发起购买              │
  │                          │◄──────────────────────────┤
  │                          │                           │
  │   ┌──────────────────────┴──────────────────────┐   │
  │   │ EscrowManager.createEscrow()                │   │
  │   │ • 创建托管智能合约                           │   │
  │   │ • 锁定买家资金                               │   │
  │   │ • 设置超时保护 (7天)                         │   │
  │   └──────────────────────┬──────────────────────┘   │
  │                          │                           │
  │  6. 收到购买通知          │                           │
  │◄─────────────────────────┤                           │
  │                          │                           │
  │  7. 确认发货/授权访问      │                           │
  ├─────────────────────────►│                           │
  │                          │                           │
  │   ┌──────────────────────┴──────────────────────┐   │
  │   │ • 生成访问密钥                               │   │
  │   │ • 记录交易日志                               │   │
  │   │ • 通知买家                                   │   │
  │   └──────────────────────┬──────────────────────┘   │
  │                          │                           │
  │                          │  8. 接收内容              │
  │                          ├─────────────────────────►│
  │                          │                           │
  │                          │  9. 确认收货              │
  │                          │◄──────────────────────────┤
  │                          │                           │
  │   ┌──────────────────────┴──────────────────────┐   │
  │   │ EscrowManager.release()                     │   │
  │   │ • 释放托管资金给卖家                         │   │
  │   │ • 扣除平台佣金 (2-5%)                        │   │
  │   │ • 更新双方信用分                             │   │
  │   │ • 记录区块链交易                             │   │
  │   └──────────────────────┬──────────────────────┘   │
  │                          │                           │
  │  10. 收到款项             │                           │
  │◄─────────────────────────┤                           │
  │                          │                           │
  │                          │  11. 评价交易             │
  │                          │◄──────────────────────────┤
  │                          │                           │
  │  12. 收到评价通知         │                           │
  │◄─────────────────────────┤                           │
```

---

## 5. 文档生成系统

### 5.1 文档生成能力概览

```
┌─────────────────────────────────────────────────────────────┐
│                    文档生成系统架构                          │
└─────────────────────────────────────────────────────────────┘

                         DocumentEngine
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌───────────────┐    ┌───────────────┐    ┌───────────────┐
│  输入处理      │    │  AI 生成      │    │  格式输出      │
├───────────────┤    ├───────────────┤    ├───────────────┤
│ • 文本输入    │    │ • 内容生成    │    │ • Markdown    │
│ • 文件上传    │    │ • 结构优化    │    │ • PDF         │
│ • 模板选择    │    │ • 风格调整    │    │ • Word        │
│ • RAG 检索    │    │ • 图表生成    │    │ • HTML        │
│ • 知识图谱    │    │ • 代码生成    │    │ • JSON        │
└───────────────┘    └───────────────┘    │ • CSV         │
                                          └───────────────┘
```

### 5.2 支持的文档类型

| 文档类型 | 生成方式 | 主要用途 |
|----------|----------|----------|
| **技术文档** | AI + 模板 | API 文档、架构设计、开发指南 |
| **分析报告** | RAG + AI | 数据分析、市场调研、竞品分析 |
| **项目计划** | 模板 + AI | 项目规划、里程碑、任务分解 |
| **会议纪要** | 语音转文字 + AI | 会议记录、行动项提取 |
| **知识摘要** | RAG + 压缩 | 文档摘要、关键信息提取 |
| **代码文档** | 代码分析 + AI | 函数说明、使用示例、变更日志 |

### 5.3 文档生成流程

```
┌─────────────────────────────────────────────────────────────┐
│                    文档生成完整流程                          │
└─────────────────────────────────────────────────────────────┘

用户请求: "基于这些笔记生成一份技术方案文档"
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 1: 需求分析                                           │
├───────────────────────────────────────────────────────────┤
│ • 识别文档类型: 技术方案                                    │
│ • 确定目标受众: 技术团队                                    │
│ • 确定输出格式: Markdown + PDF                             │
│ • 确定详细程度: 详细 (包含代码示例)                         │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 2: 资料收集                                           │
├───────────────────────────────────────────────────────────┤
│ 1. RAG 检索相关笔记                                        │
│    • 搜索关键词: "架构", "设计", "实现"                     │
│    • 获取 top-10 相关文档                                  │
│                                                            │
│ 2. 知识图谱分析                                            │
│    • 提取实体关系                                          │
│    • 识别核心概念                                          │
│    • 发现关联知识                                          │
│                                                            │
│ 3. 加载模板                                                │
│    • 技术方案模板                                          │
│    • 包含: 背景、目标、方案、实现、风险                     │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 3: 大纲生成                                           │
├───────────────────────────────────────────────────────────┤
│ AI 生成文档大纲:                                           │
│                                                            │
│ 1. 项目背景                                                │
│    1.1 业务需求                                            │
│    1.2 技术挑战                                            │
│ 2. 设计目标                                                │
│    2.1 功能目标                                            │
│    2.2 性能目标                                            │
│ 3. 技术方案                                                │
│    3.1 架构设计                                            │
│    3.2 模块划分                                            │
│    3.3 数据流设计                                          │
│ 4. 实现计划                                                │
│    4.1 阶段划分                                            │
│    4.2 资源需求                                            │
│ 5. 风险评估                                                │
│    5.1 技术风险                                            │
│    5.2 缓解措施                                            │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 4: 内容生成 (逐章节)                                   │
├───────────────────────────────────────────────────────────┤
│ For each section in outline:                               │
│   1. 检索相关 RAG 上下文                                    │
│   2. 构建章节提示词                                         │
│   3. 调用 LLM 生成内容                                      │
│   4. 插入代码示例 (如需要)                                  │
│   5. 生成图表 (Mermaid/ECharts)                            │
│   6. 添加引用来源                                          │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 5: 文档组装                                           │
├───────────────────────────────────────────────────────────┤
│ 1. 合并所有章节                                            │
│ 2. 生成目录                                                │
│ 3. 添加页眉页脚                                            │
│ 4. 格式化代码块                                            │
│ 5. 渲染图表                                                │
│ 6. 添加元数据 (作者、日期、版本)                            │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 6: 格式导出                                           │
├───────────────────────────────────────────────────────────┤
│ 根据需求导出:                                              │
│ • Markdown: 直接输出 .md 文件                              │
│ • PDF: 使用 PDFKit 渲染                                    │
│ • Word: 使用 docx 库生成 .docx                             │
│ • HTML: 渲染为网页格式                                      │
└───────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────┐
│ Step 7: 交付                                               │
├───────────────────────────────────────────────────────────┤
│ • 保存到知识库                                              │
│ • 可选: 分享给团队成员                                      │
│ • 可选: 上架知识市场                                        │
│ • 版本记录 (Git 管理)                                       │
└───────────────────────────────────────────────────────────┘
```

### 5.4 文档工具集 (285个工具中的文档相关)

```javascript
// 文档生成相关工具
const documentTools = {
  // 基础文档操作
  'doc_create': '创建新文档',
  'doc_edit': '编辑文档内容',
  'doc_export': '导出文档 (6种格式)',
  'doc_import': '导入外部文档',

  // AI 文档生成
  'doc_generate_outline': '生成文档大纲',
  'doc_generate_section': '生成章节内容',
  'doc_generate_summary': '生成文档摘要',
  'doc_generate_report': '生成分析报告',

  // 格式转换
  'doc_to_pdf': 'Markdown → PDF',
  'doc_to_word': 'Markdown → Word',
  'doc_to_html': 'Markdown → HTML',
  'pdf_to_text': 'PDF → 文本提取',

  // 图表生成
  'chart_generate': '生成数据图表',
  'diagram_generate': '生成流程图/架构图',
  'table_generate': '生成数据表格',

  // 代码文档
  'code_doc_generate': '生成代码文档',
  'api_doc_generate': '生成 API 文档',
  'changelog_generate': '生成变更日志',
};
```

### 5.5 文档模板系统

```
templates/
├── technical/
│   ├── architecture-design.md      # 架构设计模板
│   ├── api-documentation.md        # API 文档模板
│   ├── technical-spec.md           # 技术规格模板
│   └── code-review.md              # 代码审查模板
├── business/
│   ├── project-proposal.md         # 项目提案模板
│   ├── market-analysis.md          # 市场分析模板
│   ├── competitive-analysis.md     # 竞品分析模板
│   └── business-plan.md            # 商业计划模板
├── meeting/
│   ├── meeting-notes.md            # 会议纪要模板
│   ├── action-items.md             # 行动项模板
│   └── decision-log.md             # 决策日志模板
└── report/
    ├── weekly-report.md            # 周报模板
    ├── monthly-report.md           # 月报模板
    ├── incident-report.md          # 事故报告模板
    └── research-report.md          # 研究报告模板
```

---

## 6. 开发到交付流程

### 6.1 开发流程全景

```
┌─────────────────────────────────────────────────────────────┐
│                    开发到交付完整流程                        │
└─────────────────────────────────────────────────────────────┘

需求阶段                开发阶段                交付阶段
────────               ────────                ────────
    │                      │                      │
    ▼                      ▼                      ▼
┌─────────┐          ┌─────────┐          ┌─────────┐
│用户调查  │          │代码开发  │          │构建打包  │
│  │      │          │  │      │          │  │      │
│  ▼      │          │  ▼      │          │  ▼      │
│需求分析  │──────────│单元测试  │──────────│自动化测试│
│  │      │          │  │      │          │  │      │
│  ▼      │          │  ▼      │          │  ▼      │
│产品规格  │          │代码审查  │          │发布部署  │
│  │      │          │  │      │          │  │      │
│  ▼      │          │  ▼      │          │  ▼      │
│技术方案  │          │集成测试  │          │用户反馈  │
└─────────┘          └─────────┘          └─────────┘
```

### 6.2 开发环境配置

```bash
# 1. 克隆仓库
git clone https://github.com/example/chainlesschain.git
cd chainlesschain/desktop-app-vue

# 2. 安装依赖
npm install

# 3. 配置环境变量 (复制模板)
cp .env.example .env
# 编辑 .env 设置 API 密钥等

# 4. 启动开发服务
npm run dev
# - Vite 开发服务器: localhost:5173
# - Electron 主进程: 自动启动

# 5. 开发工具
# - Vue DevTools: 自动注入
# - Electron DevTools: Ctrl+Shift+I
```

### 6.3 构建流程

```
┌─────────────────────────────────────────────────────────────┐
│                      构建流程详解                            │
└─────────────────────────────────────────────────────────────┘

npm run build
    │
    ├─► Step 1: 构建渲染进程 (Vite)
    │   │
    │   ├── 代码分割 (按路由/功能)
    │   │   ├── core.js (核心框架)
    │   │   ├── editor.js (编辑器)
    │   │   ├── ai.js (AI 功能)
    │   │   ├── social.js (社交功能)
    │   │   └── blockchain.js (区块链)
    │   │
    │   ├── 资源优化
    │   │   ├── CSS 压缩
    │   │   ├── 图片压缩
    │   │   └── 字体子集化
    │   │
    │   └── 输出: dist/renderer/
    │
    ├─► Step 2: 构建主进程 (scripts/build-main.js)
    │   │
    │   ├── 复制 src/main → dist/main
    │   ├── 复制 src/preload → dist/preload
    │   ├── 复制 src/shared → dist/shared
    │   │
    │   ├── 生产模式: 代码压缩 (terser)
    │   │   └── 保留变量名 (调试友好)
    │   │
    │   └── 输出: dist/main/
    │
    └─► Step 3: Electron 打包 (electron-forge)
        │
        ├── 配置: forge.config.js
        │
        ├── Windows:
        │   ├── 制作 .msi 安装包
        │   ├── 代码签名 (可选)
        │   └── 输出: out/make/squirrel.windows/
        │
        ├── macOS:
        │   ├── 制作 .dmg 镜像
        │   ├── 公证 (notarization)
        │   └── 输出: out/make/
        │
        └── Linux:
            ├── 制作 .deb, .rpm, .AppImage
            └── 输出: out/make/
```

### 6.4 测试策略

```
┌─────────────────────────────────────────────────────────────┐
│                       测试金字塔                             │
└─────────────────────────────────────────────────────────────┘

                         ▲
                        /|\
                       / | \
                      /  |  \
                     / E2E \      <- 端到端测试 (10%)
                    /   |   \        Playwright
                   /    |    \
                  / Integration \   <- 集成测试 (20%)
                 /      |       \      IPC 通道测试
                /       |        \
               /    Unit Tests    \  <- 单元测试 (70%)
              /         |          \    Vitest + Jest
             ────────────────────────

测试命令:
├── npm run test          # 单元测试
├── npm run test:e2e      # E2E 测试
├── npm run test:db       # 数据库测试
├── npm run test:ukey     # 硬件密钥测试
├── npm run test:signal   # 加密协议测试
└── npm run test:all      # 完整测试套件
```

### 6.5 发布流程

```
┌─────────────────────────────────────────────────────────────┐
│                       发布流程                               │
└─────────────────────────────────────────────────────────────┘

npm run release
    │
    ├─► Pre-release 检查
    │   ├── npm run security:audit  # 安全扫描
    │   ├── npm run lint:strict     # 代码规范
    │   └── npm run test:all        # 完整测试
    │
    ├─► 版本管理
    │   ├── 更新 package.json 版本号
    │   ├── 更新 CHANGELOG.md
    │   └── 创建 Git tag
    │
    ├─► 构建所有平台
    │   ├── npm run make:win
    │   ├── npm run make:mac
    │   └── npm run make:linux
    │
    ├─► 代码签名
    │   ├── Windows: Authenticode 签名
    │   └── macOS: Apple Developer 签名 + 公证
    │
    ├─► 发布到 GitHub
    │   ├── 创建 Release
    │   ├── 上传构建产物
    │   └── 发布 Release Notes
    │
    └─► 自动更新
        ├── 更新 latest.yml (Windows)
        ├── 更新 latest-mac.yml (macOS)
        └── 用户客户端自动检测更新
```

### 6.6 版本命名规范

```
v{major}.{minor}.{patch}[-{prerelease}]

示例:
├── v0.26.2        # 当前稳定版
├── v0.27.0-alpha  # Alpha 预览版
├── v0.27.0-beta   # Beta 测试版
├── v0.27.0-rc.1   # Release Candidate
└── v1.0.0         # 正式发布版

版本变更规则:
├── major: 不兼容的 API 变更
├── minor: 新增功能 (向后兼容)
└── patch: Bug 修复 (向后兼容)
```

---

## 7. 数据流转图

### 7.1 整体数据流

```
┌─────────────────────────────────────────────────────────────────────────┐
│                           ChainlessChain 数据流                          │
└─────────────────────────────────────────────────────────────────────────┘

    用户输入                    处理层                      存储层
    ────────                   ──────                      ──────
        │                         │                           │
        │  文本/语音/文件          │                           │
        ├────────────────────────►│                           │
        │                         │                           │
        │                   ┌─────┴─────┐                     │
        │                   │  解析器    │                     │
        │                   │ • 文本解析 │                     │
        │                   │ • OCR     │                     │
        │                   │ • ASR     │                     │
        │                   └─────┬─────┘                     │
        │                         │                           │
        │                         ▼                           │
        │                   ┌───────────┐                     │
        │                   │ 业务逻辑层 │                     │
        │                   │           │                     │
        │                   │ ┌───────┐ │    ┌─────────────┐ │
        │                   │ │ LLM   │─┼───►│ TokenTracker│ │
        │                   │ └───────┘ │    └─────────────┘ │
        │                   │           │                     │
        │                   │ ┌───────┐ │    ┌─────────────┐ │
        │                   │ │ RAG   │─┼───►│ VectorStore │ │
        │                   │ └───────┘ │    └─────────────┘ │
        │                   │           │                     │
        │                   │ ┌───────┐ │    ┌─────────────┐ │
        │                   │ │ P2P   │─┼───►│ DHT Network │ │
        │                   │ └───────┘ │    └─────────────┘ │
        │                   │           │                     │
        │                   │ ┌───────┐ │    ┌─────────────┐ │
        │                   │ │ Block │─┼───►│ Blockchain  │ │
        │                   │ └───────┘ │    └─────────────┘ │
        │                   └─────┬─────┘                     │
        │                         │                           │
        │                         ▼                           │
        │                   ┌───────────┐    ┌─────────────┐ │
        │                   │  数据库    │───►│  SQLCipher  │ │
        │                   │  (ORM)    │    │  (本地加密)  │ │
        │                   └───────────┘    └─────────────┘ │
        │                         │                           │
        │◄────────────────────────┤                           │
        │       响应结果           │                           │
```

### 7.2 知识库数据流

```
┌─────────────────────────────────────────────────────────────┐
│                    知识库数据流详解                          │
└─────────────────────────────────────────────────────────────┘

                    ┌─────────────┐
                    │  用户输入    │
                    │ (笔记/文件)  │
                    └──────┬──────┘
                           │
              ┌────────────┼────────────┐
              ▼            ▼            ▼
        ┌─────────┐  ┌─────────┐  ┌─────────┐
        │Markdown │  │  PDF    │  │  图片   │
        └────┬────┘  └────┬────┘  └────┬────┘
             │            │            │
             └────────────┼────────────┘
                          ▼
                    ┌───────────┐
                    │FileImporter│
                    │  • 解析    │
                    │  • 提取    │
                    │  • 清洗    │
                    └─────┬─────┘
                          │
         ┌────────────────┼────────────────┐
         ▼                ▼                ▼
   ┌───────────┐   ┌───────────┐   ┌───────────┐
   │  SQLite   │   │ VectorDB  │   │ GraphDB   │
   │  (结构化)  │   │ (向量化)   │   │ (关系)    │
   │           │   │           │   │           │
   │ • notes   │   │ • embeddings│  │ • nodes  │
   │ • files   │   │ • chunks  │   │ • edges   │
   │ • tags    │   │           │   │           │
   └─────┬─────┘   └─────┬─────┘   └─────┬─────┘
         │               │               │
         └───────────────┼───────────────┘
                         ▼
                   ┌───────────┐
                   │  RAG 检索  │
                   │  • 混合搜索│
                   │  • 重排序  │
                   └─────┬─────┘
                         │
                         ▼
                   ┌───────────┐
                   │  LLM 增强  │
                   │  • 问答    │
                   │  • 摘要    │
                   │  • 生成    │
                   └─────┬─────┘
                         │
                         ▼
                   ┌───────────┐
                   │  用户响应  │
                   └───────────┘
```

### 7.3 关键数据表结构

```sql
-- 核心表结构概览 (50+ 表)

-- 知识库
CREATE TABLE notes (
    id TEXT PRIMARY KEY,
    title TEXT NOT NULL,
    content TEXT,
    content_type TEXT DEFAULT 'markdown',
    category_id TEXT,
    created_at DATETIME,
    updated_at DATETIME,
    deleted_at DATETIME,  -- 软删除
    is_encrypted BOOLEAN DEFAULT 0,
    embedding BLOB,       -- 向量嵌入
    metadata JSON
);

-- 对话历史
CREATE TABLE chat_conversations (
    id TEXT PRIMARY KEY,
    title TEXT,
    model TEXT,
    provider TEXT,
    total_tokens INTEGER DEFAULT 0,
    total_cost REAL DEFAULT 0,
    created_at DATETIME,
    updated_at DATETIME
);

CREATE TABLE chat_messages (
    id TEXT PRIMARY KEY,
    conversation_id TEXT,
    role TEXT,           -- 'user', 'assistant', 'system'
    content TEXT,
    tokens INTEGER,
    created_at DATETIME,
    FOREIGN KEY (conversation_id) REFERENCES chat_conversations(id)
);

-- DID 身份
CREATE TABLE did_identities (
    id TEXT PRIMARY KEY,
    did TEXT UNIQUE,
    public_key TEXT,
    private_key_encrypted TEXT,
    did_document JSON,
    is_primary BOOLEAN DEFAULT 0,
    created_at DATETIME
);

-- P2P 消息
CREATE TABLE p2p_messages (
    id TEXT PRIMARY KEY,
    conversation_id TEXT,
    sender_did TEXT,
    receiver_did TEXT,
    content_encrypted TEXT,
    message_type TEXT,
    status TEXT,         -- 'sent', 'delivered', 'read'
    created_at DATETIME
);

-- 长期记忆 (MemGPT)
CREATE TABLE long_term_memories (
    id TEXT PRIMARY KEY,
    user_id TEXT,
    content TEXT,
    memory_type TEXT,    -- 'fact', 'preference', 'context'
    importance REAL,
    embedding BLOB,
    created_at DATETIME,
    accessed_at DATETIME,
    access_count INTEGER DEFAULT 0
);
```

---

## 附录

### A. 快速参考命令

```bash
# 开发
npm run dev                 # 启动开发环境
npm run build:main          # 构建主进程
npm run lint                # 代码检查

# 测试
npm run test                # 单元测试
npm run test:e2e            # E2E 测试
npm run test:all            # 全部测试

# 构建
npm run build               # 完整构建
npm run make:win            # Windows 打包
npm run make:mac            # macOS 打包
npm run make:linux          # Linux 打包

# 发布
npm run release             # 发布新版本
npm run release:draft       # 草稿发布
```

### B. 端口映射

| 服务 | 端口 | 说明 |
|------|------|------|
| Vite Dev | 5173 | 前端开发服务器 |
| Signaling | 9001 | WebRTC 信令服务 |
| Ollama | 11434 | 本地 LLM |
| ChromaDB | 8000 | 向量数据库 |
| Qdrant | 6333 | 向量数据库 |
| PostgreSQL | 5432 | 关系数据库 |
| Redis | 6379 | 缓存服务 |
| AI Service | 8001 | Python AI 服务 |

### C. 文档更新记录

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| 1.0.0 | 2026-01-26 | 初始版本，完整流程文档 |

---

*文档由 ChainlessChain AI Engine 自动生成*
*最后更新: 2026-01-26*
