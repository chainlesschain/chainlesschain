# ChainlessChain 企业协作功能设计方案 v1.0

**文档版本**: 1.0
**系统版本**: v0.16.0 → v0.17.0
**设计日期**: 2025-12-31
**设计目标**: 在已有85%完成度基础上，补充完整的企业协作功能，达到100%生产可用

---

## 一、现状分析

### 1.1 已实现功能（85%完成度）

#### ✅ 核心基础设施
- **身份上下文管理** (`identity-context-manager.js`)
  - 个人身份 + 多组织身份切换
  - 独立数据库隔离 (`personal.db`, `org_*.db`)
  - 上下文切换历史追踪

- **组织管理** (`organization-manager.js`)
  - 组织CRUD（创建/加入/离开/删除）
  - 5种组织类型: startup, company, community, opensource, education
  - 组织DID（去中心化身份标识）

#### ✅ 成员与权限系统
- **成员管理**
  - 双重邀请机制：邀请码 + DID点对点邀请
  - 成员状态管理：active, inactive, removed
  - 成员信息：displayName, avatar, role, permissions

- **基于角色的权限控制（RBAC）**
  - 4个内置角色：owner, admin, member, viewer
  - 自定义角色支持
  - 细粒度权限（6大类别，20+权限项）
    - 组织管理: org.manage, org.delete
    - 成员管理: member.invite, member.manage, member.remove
    - 角色管理: role.create, role.manage, role.assign, role.delete
    - 知识库: knowledge.*
    - 项目: project.*
    - 消息: message.*

#### ✅ 去中心化同步
- **P2P网络同步**
  - libp2p + PubSub机制
  - 组织topic订阅 (`org_<orgId>_sync`)
  - 增量同步（基于timestamp）
  - Last-Write-Wins冲突解决策略
  - Vector Clock支持

- **离线队列**
  - sync_queue表：pending/processing/failed/completed
  - sync_conflicts表：冲突记录与解决

- **活动日志**
  - organization_activities表
  - 完整操作审计追踪

#### ✅ 数据库设计
48张表，包含：
- 9张组织相关表
- 3张同步相关表
- 支持企业级数据隔离

### 1.2 待补充功能（15%）

#### ⚠️ 缺失的核心功能
1. **团队工作区（Workspace）**
   - 多工作区支持（开发/测试/生产）
   - 工作区级别权限

2. **团队协作工具**
   - 实时协作编辑
   - 团队任务管理（Kanban/列表视图）
   - 文件共享与版本控制
   - 团队聊天室

3. **企业级流程**
   - 审批工作流（申请→审批→执行）
   - 流程模板系统

4. **数据分析与可视化**
   - 团队仪表盘
   - 成员活跃度统计
   - 项目进度报表

5. **UI组件**
   - Vue组件库（组织管理、成员管理、权限配置）
   - 移动端适配

---

## 二、功能设计

### 2.1 团队工作区（Workspace）

#### 2.1.1 功能概述
工作区是组织内的逻辑分区，用于隔离不同环境或团队的数据。

#### 2.1.2 数据模型

```sql
-- 工作区表
CREATE TABLE IF NOT EXISTS organization_workspaces (
  id TEXT PRIMARY KEY,
  org_id TEXT NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  type TEXT CHECK(type IN ('default', 'development', 'testing', 'production')),
  color TEXT,  -- UI颜色标识
  icon TEXT,   -- 工作区图标
  is_default INTEGER DEFAULT 0,
  visibility TEXT DEFAULT 'members' CHECK(visibility IN ('members', 'admins', 'specific_roles')),
  allowed_roles TEXT,  -- JSON数组: 允许访问的角色列表
  created_by TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  archived INTEGER DEFAULT 0,
  UNIQUE(org_id, name)
);

-- 工作区成员表（可选，用于更细粒度控制）
CREATE TABLE IF NOT EXISTS workspace_members (
  id TEXT PRIMARY KEY,
  workspace_id TEXT NOT NULL,
  member_did TEXT NOT NULL,
  role TEXT NOT NULL CHECK(role IN ('admin', 'member', 'viewer')),
  joined_at INTEGER NOT NULL,
  UNIQUE(workspace_id, member_did),
  FOREIGN KEY(workspace_id) REFERENCES organization_workspaces(id) ON DELETE CASCADE
);

-- 工作区资源表（关联知识库、项目等）
CREATE TABLE IF NOT EXISTS workspace_resources (
  id TEXT PRIMARY KEY,
  workspace_id TEXT NOT NULL,
  resource_type TEXT NOT NULL CHECK(resource_type IN ('knowledge', 'project', 'conversation')),
  resource_id TEXT NOT NULL,
  added_by TEXT NOT NULL,
  added_at INTEGER NOT NULL,
  UNIQUE(workspace_id, resource_type, resource_id),
  FOREIGN KEY(workspace_id) REFERENCES organization_workspaces(id) ON DELETE CASCADE
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_workspaces_org ON organization_workspaces(org_id);
CREATE INDEX IF NOT EXISTS idx_workspace_members ON workspace_members(workspace_id, member_did);
CREATE INDEX IF NOT EXISTS idx_workspace_resources ON workspace_resources(workspace_id, resource_type);
```

#### 2.1.3 核心接口

```javascript
// IPC接口
ipcMain.handle('organization:workspace:create', async (event, { orgId, workspaceData }))
ipcMain.handle('organization:workspace:list', async (event, { orgId }))
ipcMain.handle('organization:workspace:update', async (event, { workspaceId, updates }))
ipcMain.handle('organization:workspace:delete', async (event, { workspaceId }))
ipcMain.handle('organization:workspace:addMember', async (event, { workspaceId, memberDID, role }))
ipcMain.handle('organization:workspace:removeMember', async (event, { workspaceId, memberDID }))
ipcMain.handle('organization:workspace:addResource', async (event, { workspaceId, resourceType, resourceId }))
```

### 2.2 团队任务管理

#### 2.2.1 功能概述
基于现有project_tasks表扩展，增加团队协作功能。

#### 2.2.2 数据模型增强

```sql
-- 扩展现有 project_tasks 表（已存在，需migration添加字段）
ALTER TABLE project_tasks ADD COLUMN org_id TEXT;
ALTER TABLE project_tasks ADD COLUMN workspace_id TEXT;
ALTER TABLE project_tasks ADD COLUMN assigned_to TEXT;
ALTER TABLE project_tasks ADD COLUMN collaborators TEXT;
ALTER TABLE project_tasks ADD COLUMN labels TEXT;
ALTER TABLE project_tasks ADD COLUMN due_date INTEGER;
ALTER TABLE project_tasks ADD COLUMN reminder_at INTEGER;
ALTER TABLE project_tasks ADD COLUMN blocked_by TEXT;
ALTER TABLE project_tasks ADD COLUMN estimate_hours REAL;
ALTER TABLE project_tasks ADD COLUMN actual_hours REAL;

-- 任务评论表（团队讨论）
CREATE TABLE IF NOT EXISTS task_comments (
  id TEXT PRIMARY KEY,
  task_id TEXT NOT NULL,
  author_did TEXT NOT NULL,
  content TEXT NOT NULL,
  mentions TEXT,
  attachments TEXT,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  is_deleted INTEGER DEFAULT 0,
  FOREIGN KEY(task_id) REFERENCES project_tasks(id) ON DELETE CASCADE
);

-- 任务变更历史
CREATE TABLE IF NOT EXISTS task_changes (
  id TEXT PRIMARY KEY,
  task_id TEXT NOT NULL,
  changed_by TEXT NOT NULL,
  change_type TEXT NOT NULL,
  old_value TEXT,
  new_value TEXT,
  changed_at INTEGER NOT NULL,
  FOREIGN KEY(task_id) REFERENCES project_tasks(id) ON DELETE CASCADE
);

-- 任务看板配置
CREATE TABLE IF NOT EXISTS task_boards (
  id TEXT PRIMARY KEY,
  org_id TEXT NOT NULL,
  workspace_id TEXT,
  name TEXT NOT NULL,
  description TEXT,
  columns TEXT NOT NULL,
  filters TEXT,
  created_by TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  UNIQUE(org_id, name)
);
```

### 2.3 团队文件共享

#### 2.3.1 数据模型

```sql
-- 扩展现有 project_files 表
ALTER TABLE project_files ADD COLUMN org_id TEXT;
ALTER TABLE project_files ADD COLUMN workspace_id TEXT;
ALTER TABLE project_files ADD COLUMN shared_with TEXT;
ALTER TABLE project_files ADD COLUMN lock_status TEXT DEFAULT 'unlocked';
ALTER TABLE project_files ADD COLUMN locked_by TEXT;
ALTER TABLE project_files ADD COLUMN locked_at INTEGER;

-- 文件版本历史
CREATE TABLE IF NOT EXISTS file_versions (
  id TEXT PRIMARY KEY,
  file_id TEXT NOT NULL,
  version_number INTEGER NOT NULL,
  file_path TEXT NOT NULL,
  file_size INTEGER,
  checksum TEXT,
  created_by TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  change_description TEXT,
  UNIQUE(file_id, version_number),
  FOREIGN KEY(file_id) REFERENCES project_files(id) ON DELETE CASCADE
);

-- 文件权限表
CREATE TABLE IF NOT EXISTS file_permissions (
  id TEXT PRIMARY KEY,
  file_id TEXT NOT NULL,
  member_did TEXT,
  role TEXT,
  permission TEXT NOT NULL CHECK(permission IN ('view', 'edit', 'manage')),
  granted_by TEXT NOT NULL,
  granted_at INTEGER NOT NULL,
  FOREIGN KEY(file_id) REFERENCES project_files(id) ON DELETE CASCADE
);
```

### 2.4 团队聊天与即时通讯

#### 2.4.1 数据模型

```sql
-- 聊天室表
CREATE TABLE IF NOT EXISTS chat_rooms (
  id TEXT PRIMARY KEY,
  org_id TEXT NOT NULL,
  workspace_id TEXT,
  name TEXT NOT NULL,
  description TEXT,
  type TEXT NOT NULL CHECK(type IN ('channel', 'group', 'direct')),
  is_private INTEGER DEFAULT 0,
  created_by TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  last_message_at INTEGER,
  archived INTEGER DEFAULT 0
);

-- 聊天室成员表
CREATE TABLE IF NOT EXISTS chat_room_members (
  id TEXT PRIMARY KEY,
  room_id TEXT NOT NULL,
  member_did TEXT NOT NULL,
  role TEXT DEFAULT 'member' CHECK(role IN ('owner', 'admin', 'member')),
  joined_at INTEGER NOT NULL,
  last_read_at INTEGER,
  notification_level TEXT DEFAULT 'all' CHECK(notification_level IN ('all', 'mentions', 'none')),
  UNIQUE(room_id, member_did),
  FOREIGN KEY(room_id) REFERENCES chat_rooms(id) ON DELETE CASCADE
);

-- 扩展现有 p2p_chat_messages 表
ALTER TABLE p2p_chat_messages ADD COLUMN room_id TEXT;
ALTER TABLE p2p_chat_messages ADD COLUMN org_id TEXT;
ALTER TABLE p2p_chat_messages ADD COLUMN thread_id TEXT;
ALTER TABLE p2p_chat_messages ADD COLUMN mentions TEXT;
ALTER TABLE p2p_chat_messages ADD COLUMN reactions TEXT;
ALTER TABLE p2p_chat_messages ADD COLUMN attachments TEXT;
ALTER TABLE p2p_chat_messages ADD COLUMN is_pinned INTEGER DEFAULT 0;

-- 消息已读状态
CREATE TABLE IF NOT EXISTS message_read_status (
  id TEXT PRIMARY KEY,
  message_id TEXT NOT NULL,
  room_id TEXT NOT NULL,
  member_did TEXT NOT NULL,
  read_at INTEGER NOT NULL,
  UNIQUE(message_id, member_did)
);
```

### 2.5 审批工作流

#### 2.5.1 数据模型

```sql
-- 审批流程模板
CREATE TABLE IF NOT EXISTS approval_templates (
  id TEXT PRIMARY KEY,
  org_id TEXT NOT NULL,
  name TEXT NOT NULL,
  description TEXT,
  category TEXT,
  steps TEXT NOT NULL,
  form_schema TEXT,
  is_active INTEGER DEFAULT 1,
  created_by TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  UNIQUE(org_id, name)
);

-- 审批申请
CREATE TABLE IF NOT EXISTS approval_requests (
  id TEXT PRIMARY KEY,
  org_id TEXT NOT NULL,
  template_id TEXT,
  requester_did TEXT NOT NULL,
  title TEXT NOT NULL,
  description TEXT,
  form_data TEXT,
  current_step INTEGER DEFAULT 1,
  status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'approved', 'rejected', 'cancelled')),
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL,
  completed_at INTEGER
);

-- 审批步骤记录
CREATE TABLE IF NOT EXISTS approval_steps (
  id TEXT PRIMARY KEY,
  request_id TEXT NOT NULL,
  step_order INTEGER NOT NULL,
  approver_did TEXT NOT NULL,
  status TEXT DEFAULT 'pending' CHECK(status IN ('pending', 'approved', 'rejected', 'skipped')),
  comment TEXT,
  approved_at INTEGER,
  UNIQUE(request_id, step_order)
);
```

### 2.6 团队仪表盘与报表

#### 2.6.1 数据模型

```sql
-- 仪表盘配置
CREATE TABLE IF NOT EXISTS dashboards (
  id TEXT PRIMARY KEY,
  org_id TEXT NOT NULL,
  workspace_id TEXT,
  name TEXT NOT NULL,
  description TEXT,
  layout TEXT NOT NULL,
  is_default INTEGER DEFAULT 0,
  visibility TEXT DEFAULT 'private',
  created_by TEXT NOT NULL,
  created_at INTEGER NOT NULL,
  updated_at INTEGER NOT NULL
);

-- 仪表盘小部件
CREATE TABLE IF NOT EXISTS dashboard_widgets (
  id TEXT PRIMARY KEY,
  dashboard_id TEXT NOT NULL,
  widget_type TEXT NOT NULL,
  title TEXT NOT NULL,
  config TEXT NOT NULL,
  position TEXT NOT NULL,
  created_at INTEGER NOT NULL
);

-- 统计缓存表
CREATE TABLE IF NOT EXISTS org_statistics (
  id TEXT PRIMARY KEY,
  org_id TEXT NOT NULL,
  stat_date INTEGER NOT NULL,
  stat_type TEXT NOT NULL,
  stat_data TEXT NOT NULL,
  generated_at INTEGER NOT NULL,
  UNIQUE(org_id, stat_date, stat_type)
);
```

---

## 三、API接口设计

### 3.1 IPC接口汇总（新增109个）

#### 工作区管理（7个）
- `organization:workspace:create`
- `organization:workspace:list`
- `organization:workspace:update`
- `organization:workspace:delete`
- `organization:workspace:addMember`
- `organization:workspace:removeMember`
- `organization:workspace:addResource`

#### 任务管理（15个）
- `tasks:create/update/delete/list/detail`
- `tasks:assign/changeStatus`
- `tasks:comment:add/list/delete`
- `tasks:board:create/list/update/delete`
- `tasks:getHistory`

#### 文件共享（12个）
- `files:upload/download/list/delete`
- `files:lock/unlock`
- `files:version:create/list/restore`
- `files:permission:grant/revoke/list`

#### 团队聊天（16个）
- `chat:room:create/list/update/delete/archive`
- `chat:room:addMember/removeMember/getUnreadCount`
- `chat:message:send/list/edit/delete/react/pin/markRead/search`

#### 审批流程（13个）
- `approval:template:create/list/update/delete`
- `approval:request:create/list/detail/cancel`
- `approval:approve/reject/getPending/getHistory/addComment`

#### 仪表盘与报表（13个）
- `dashboard:create/list/update/delete`
- `dashboard:widget:add/update/delete`
- `stats:member:activity/task:completion/file:storage/message:volume/approval:trend/generate`

#### 通知系统（10个）
- `notification:create/list/markRead/markAllRead/delete/getUnreadCount`
- `notification:subscribe/unsubscribe/getSettings/updateSettings`

#### 搜索与过滤（8个）
- `search:global/tasks/files/messages/members/history`
- `search:saveFilter/getSavedFilters`

---

## 四、权限设计

### 4.1 权限矩阵扩展

```javascript
// 新增权限
{
  workspace: ['create', 'manage', 'delete', 'view'],
  task: ['create', 'assign', 'edit', 'delete', 'view'],
  file: ['upload', 'download', 'edit', 'delete', 'share', 'version'],
  chat: ['create_room', 'send', 'manage_room', 'delete_message'],
  approval: ['create_template', 'manage_template', 'submit', 'approve'],
  dashboard: ['create', 'edit', 'view', 'share']
}
```

### 4.2 角色权限配置

```javascript
const rolePermissions = {
  owner: ['*'],

  admin: [
    'org.manage', 'member.*', 'role.*',
    'workspace.*', 'task.*', 'file.*', 'chat.*',
    'approval.create_template', 'approval.manage_template', 'approval.approve',
    'dashboard.*', 'knowledge.*', 'project.*'
  ],

  member: [
    'knowledge.create', 'knowledge.read', 'knowledge.write',
    'project.create', 'project.read', 'project.write',
    'task.create', 'task.view', 'task.edit', 'task.assign',
    'file.upload', 'file.download', 'file.view', 'file.share',
    'chat.send', 'chat.create_room',
    'approval.submit',
    'dashboard.create', 'dashboard.view', 'dashboard.edit'
  ],

  viewer: [
    'knowledge.read', 'project.read', 'task.view',
    'file.view', 'file.download',
    'chat.send', 'dashboard.view'
  ]
};
```

---

## 五、实施计划（18周）

### Phase 1: 工作区与任务管理（4周）
- Week 1-2: 后端开发（数据库迁移、管理器模块、IPC接口）
- Week 3: 前端开发（工作区组件、任务看板、任务详情页）
- Week 4: 测试与优化

### Phase 2: 文件共享与版本控制（3周）
- Week 5-6: 后端开发（文件管理增强、版本控制、权限系统）
- Week 7: 前端开发（文件浏览器、上传下载、版本查看器）

### Phase 3: 团队聊天与即时通讯（4周）
- Week 8-9: 后端开发（聊天室管理、消息路由、P2P协议）
- Week 10-11: 前端开发（聊天室UI、消息组件、实时通知）

### Phase 4: 审批流程（3周）
- Week 12-13: 后端开发（审批管理器、工作流引擎、表单构建器）
- Week 14: 前端开发（审批模板编辑器、申请表单、审批列表）

### Phase 5: 仪表盘与报表（2周）
- Week 15: 后端开发（统计数据聚合、定时任务）
- Week 16: 前端开发（仪表盘编辑器、图表组件、报表导出）

### Phase 6: 集成测试与上线（2周）
- Week 17: 集成测试（端到端测试、压力测试、安全审计）
- Week 18: 文档与上线（API文档、用户手册、部署指南）

---

## 六、技术选型

### 6.1 前端技术栈
- Vue 3.4 + TypeScript
- Ant Design Vue 4.1
- Pinia 2.1.7
- ECharts 5.x
- Tiptap / Milkdown（富文本）
- Vue Draggable Plus（拖拽）

### 6.2 后端技术栈
- Electron 39.2.6 + Node.js
- Better-SQLite3 / SQLCipher
- Spring Boot 3.1.11 + MyBatis Plus 3.5.9
- FastAPI + Ollama + Qdrant
- libp2p 3.1.2
- Signal Protocol

---

## 七、里程碑验收标准

### Milestone 1: 工作区与任务管理（Week 4）
- [ ] 创建/编辑/删除工作区
- [ ] 工作区成员管理
- [ ] 任务CRUD操作
- [ ] 任务看板拖拽
- [ ] 任务评论功能
- [ ] 单元测试覆盖率 > 80%

### Milestone 2: 文件共享（Week 7）
- [ ] 文件上传/下载
- [ ] 文件版本控制
- [ ] 文件权限管理
- [ ] 文件锁定机制
- [ ] 支持100MB+文件

### Milestone 3: 团队聊天（Week 11）
- [ ] 创建聊天室
- [ ] 发送/接收消息
- [ ] @提及功能
- [ ] 消息已读未读状态
- [ ] 实时推送延迟 < 500ms

### Milestone 4: 审批流程（Week 14）
- [ ] 创建审批模板
- [ ] 提交审批申请
- [ ] 审批/拒绝操作
- [ ] 审批历史查看
- [ ] 邮件/通知提醒

### Milestone 5: 仪表盘（Week 16）
- [ ] 创建自定义仪表盘
- [ ] 5种以上统计图表
- [ ] 数据导出功能
- [ ] 响应式布局

### Milestone 6: 生产就绪（Week 18）
- [ ] 所有功能测试通过
- [ ] 性能测试达标（支持100+成员组织）
- [ ] 安全审计通过
- [ ] 文档完整
- [ ] 部署成功

---

## 八、总结

本设计方案在**已有85%完成度**的企业协作基础上，通过补充：

1. ✅ 团队工作区（7个IPC接口）
2. ✅ 任务管理（15个IPC接口）
3. ✅ 文件共享（12个IPC接口）
4. ✅ 团队聊天（16个IPC接口）
5. ✅ 审批流程（13个IPC接口）
6. ✅ 仪表盘报表（13个IPC接口）
7. ✅ 通知系统（10个IPC接口）
8. ✅ 搜索与过滤（8个IPC接口）

**新增109个IPC接口**，**23张数据库表**，预计**18周（4.5个月）**完成，将ChainlessChain企业协作功能从85%提升到**100%生产可用**。

### 核心竞争力
1. 去中心化架构 - 数据完全掌控
2. 硬件级安全 - U-Key + SQLCipher
3. 多身份隔离 - 个人+多组织数据隔离
4. P2P实时同步 - 无需中心服务器
5. 企业级权限 - RBAC + 自定义角色
6. AI深度集成 - 智能推荐、自动摘要

---

**文档状态**: ✅ 已完成
**联系人**: ChainlessChain开发团队
**最后更新**: 2025-12-31
