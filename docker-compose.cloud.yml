# Docker Compose - 云端算力模式
# 适用于没有本地GPU的用户，使用云端LLM API服务

version: '3.8'

services:
  # Qdrant向量数据库（保留本地部署）
  qdrant:
    image: qdrant/qdrant:latest
    container_name: chainlesschain_qdrant
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - ./data/qdrant:/qdrant/storage
    networks:
      - chainlesschain_network
    restart: unless-stopped

  # PostgreSQL数据库
  postgres:
    image: postgres:16-alpine
    container_name: chainlesschain_postgres
    environment:
      POSTGRES_DB: ${DB_NAME:-chainlesschain}
      POSTGRES_USER: ${DB_USER:-chainlesschain}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-chainlesschain123}
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    networks:
      - chainlesschain_network
    restart: unless-stopped

  # Redis缓存
  redis:
    image: redis:7-alpine
    container_name: chainlesschain_redis
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis123}
    ports:
      - "6379:6379"
    volumes:
      - ./data/redis:/data
    networks:
      - chainlesschain_network
    restart: unless-stopped

  # AI Service（使用云端LLM API）
  ai-service:
    build: ./backend/ai-service
    container_name: chainlesschain_ai_service
    ports:
      - "8001:8000"
    environment:
      # 使用云端LLM服务
      LLM_PROVIDER: ${LLM_PROVIDER:-openai}  # openai, dashscope, qwen, zhipu
      LLM_MODEL: ${LLM_MODEL:-gpt-3.5-turbo}

      # OpenAI兼容API配置
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      OPENAI_BASE_URL: ${OPENAI_BASE_URL:-https://api.openai.com/v1}

      # 阿里云DashScope（通义千问）
      DASHSCOPE_API_KEY: ${DASHSCOPE_API_KEY}

      # 智谱AI
      ZHIPU_API_KEY: ${ZHIPU_API_KEY}
      # Volcengine
      VOLCENGINE_API_KEY: ${VOLCENGINE_API_KEY}
      VOLCENGINE_MODEL: ${VOLCENGINE_MODEL}

      # Qdrant配置
      QDRANT_HOST: qdrant
      QDRANT_PORT: 6333

      # Embedding模型（可选：使用云端或本地）
      EMBEDDING_MODEL: ${EMBEDDING_MODEL:-BAAI/bge-base-zh-v1.5}
      EMBEDDING_PROVIDER: ${EMBEDDING_PROVIDER:-local}  # local或cloud

      # Redis配置
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123}
    volumes:
      - ./backend/ai-service:/app
      - ./data/models:/models  # 本地模型缓存
    depends_on:
      - qdrant
      - redis
    networks:
      - chainlesschain_network
    restart: unless-stopped

  # Project Service
  project-service:
    build: ./backend/project-service
    container_name: chainlesschain_project_service
    ports:
      - "9090:9090"
    environment:
      DB_HOST: postgres
      DB_PORT: 5432
      DB_NAME: ${DB_NAME:-chainlesschain}
      DB_USER: ${DB_USER:-chainlesschain}
      DB_PASSWORD: ${DB_PASSWORD:-chainlesschain123}

      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-redis123}

      AI_SERVICE_URL: http://ai-service:8000

      PROJECTS_ROOT_PATH: /data/projects
    volumes:
      - ./data/projects:/data/projects
    depends_on:
      - postgres
      - redis
      - ai-service
    networks:
      - chainlesschain_network
    restart: unless-stopped

networks:
  chainlesschain_network:
    driver: bridge

volumes:
  postgres_data:
  redis_data:
  qdrant_data:
