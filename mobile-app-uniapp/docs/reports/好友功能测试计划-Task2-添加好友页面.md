# 好友功能测试计划 - Task 2: 添加好友页面

**测试日期**: 2025-12-31
**测试范围**: mobile-app-uniapp/pages/social/friends/add.vue
**任务**: Task 2 - 添加好友页面实现

## 一、功能概述

添加好友页面是去中心化社交系统的核心功能之一，支持通过以下方式添加好友：
1. 手动输入 DID 搜索
2. 扫描好友二维码（APP-PLUS）
3. 显示自己的 DID 二维码供他人扫描

## 二、已实现功能清单

### 2.1 DID 搜索功能
- ✅ DID 输入框（支持格式验证）
- ✅ 搜索按钮（带加载状态）
- ✅ DID 格式验证（must start with `did:chainlesschain:`）
- ✅ 搜索结果显示
- ✅ 用户状态检查（已是好友、已拉黑）

### 2.2 二维码扫描功能
- ✅ 扫码按钮（仅 APP-PLUS 平台显示）
- ✅ 调用 uni.scanCode API
- ✅ 二维码内容验证
- ✅ 扫码后自动填充并搜索

### 2.3 好友请求功能
- ✅ 显示搜索结果（头像、DID、状态）
- ✅ 验证消息输入（可选，最多 200 字符）
- ✅ 字符计数显示
- ✅ 发送好友请求
- ✅ 请求成功后返回上一页

### 2.4 我的二维码功能
- ✅ "我的二维码"按钮（固定在底部）
- ✅ 二维码弹窗模态框
- ✅ Canvas 绘制二维码（占位符实现）
- ✅ 显示完整 DID
- ✅ 复制 DID 功能
- ✅ 二维码使用提示

### 2.5 特殊状态处理
- ✅ 已是好友状态 - 显示"查看好友资料"按钮
- ✅ 已拉黑状态 - 显示"解除拉黑"按钮
- ✅ 空状态提示
- ✅ 加载状态提示

### 2.6 错误处理
- ✅ DID 格式错误提示
- ✅ DID 不存在提示
- ✅ 已发送请求提示
- ✅ 黑名单限制提示
- ✅ 未创建身份提示

## 三、测试用例

### 3.1 基础功能测试

#### 测试用例 1: 页面加载
- **测试步骤**:
  1. 打开添加好友页面
  2. 检查页面元素是否正常显示
- **预期结果**:
  - 页面标题显示"添加好友"
  - DID 输入框正常显示
  - 搜索按钮显示
  - 空状态提示显示
  - "我的二维码"按钮显示在底部

#### 测试用例 2: DID 格式验证
- **测试步骤**:
  1. 输入无效的 DID（如 "abc123"）
  2. 点击搜索按钮
- **预期结果**:
  - 显示 toast 提示"无效的DID格式"
  - 不执行搜索操作

#### 测试用例 3: 搜索不存在的 DID
- **测试步骤**:
  1. 输入格式正确但不存在的 DID（如 "did:chainlesschain:test123456"）
  2. 点击搜索按钮
- **预期结果**:
  - 显示 toast 提示"DID不存在"
  - 不显示搜索结果

#### 测试用例 4: 搜索已存在的 DID
- **测试步骤**:
  1. 输入已存在的有效 DID
  2. 点击搜索按钮
- **预期结果**:
  - 显示用户信息卡片
  - 显示用户头像（基于 DID 后两位）
  - 显示完整或简化的 DID
  - 显示 DID 文档信息
  - 显示好友请求表单（如果不是好友）

### 3.2 好友请求测试

#### 测试用例 5: 发送好友请求
- **测试步骤**:
  1. 搜索一个非好友用户
  2. 输入验证消息（可选）
  3. 点击"发送好友请求"
- **预期结果**:
  - 按钮显示"发送中..."
  - 请求成功后显示 toast "好友请求已发送"
  - 1.5 秒后自动返回上一页

#### 测试用例 6: 重复发送请求
- **测试步骤**:
  1. 搜索已发送过请求的用户
  2. 尝试再次发送请求
- **预期结果**:
  - 显示 toast "您已发送过好友请求"
  - 请求不会被重复发送

#### 测试用例 7: 验证消息字符限制
- **测试步骤**:
  1. 在验证消息输入框中输入超过 200 字符
  2. 观察字符计数
- **预期结果**:
  - 字符计数实时更新
  - 输入框限制最多 200 字符
  - 字符计数显示 "X/200"

### 3.3 特殊状态测试

#### 测试用例 8: 搜索已是好友的用户
- **测试步骤**:
  1. 搜索已是好友的用户 DID
  2. 查看显示结果
- **预期结果**:
  - 显示"✓ 已是好友"徽章
  - 显示"查看好友资料"按钮
  - 不显示好友请求表单
  - 点击"查看好友资料"跳转到资料页

#### 测试用例 9: 搜索被拉黑的用户
- **测试步骤**:
  1. 搜索已被拉黑的用户 DID
  2. 查看显示结果
- **预期结果**:
  - 显示"🚫 已拉黑"徽章
  - 显示"解除拉黑"按钮
  - 不显示好友请求表单

#### 测试用例 10: 解除拉黑操作
- **测试步骤**:
  1. 搜索已拉黑的用户
  2. 点击"解除拉黑"按钮
- **预期结果**:
  - 显示 toast "已解除拉黑"
  - 自动重新搜索该用户
  - 显示可以发送好友请求的状态

### 3.4 二维码扫描测试（APP-PLUS）

#### 测试用例 11: 扫描有效的 DID 二维码
- **测试步骤**:
  1. 点击"扫码添加"按钮
  2. 扫描包含有效 DID 的二维码
- **预期结果**:
  - 调起系统扫码界面
  - 扫码成功后自动填充 DID 到输入框
  - 自动执行搜索

#### 测试用例 12: 扫描无效的二维码
- **测试步骤**:
  1. 点击"扫码添加"按钮
  2. 扫描不包含 DID 的二维码
- **预期结果**:
  - 显示 toast "无效的二维码"
  - DID 输入框不变

### 3.5 我的二维码测试

#### 测试用例 13: 显示我的二维码
- **测试步骤**:
  1. 点击底部"我的二维码"按钮
  2. 观察弹窗内容
- **预期结果**:
  - 弹出模态框
  - 显示二维码 Canvas（目前为占位符）
  - 显示完整的当前用户 DID
  - 显示"复制DID"按钮
  - 显示使用提示

#### 测试用例 14: 复制 DID
- **测试步骤**:
  1. 打开我的二维码弹窗
  2. 点击"复制DID"按钮
- **预期结果**:
  - 显示 toast "已复制DID"
  - DID 已复制到剪贴板

#### 测试用例 15: 关闭二维码弹窗
- **测试步骤**:
  1. 打开我的二维码弹窗
  2. 点击右上角关闭按钮 或 点击遮罩层
- **预期结果**:
  - 弹窗关闭
  - 返回到添加好友页面

#### 测试用例 16: 未创建身份时显示二维码
- **测试步骤**:
  1. 在未创建 DID 身份的状态下
  2. 点击"我的二维码"按钮
- **预期结果**:
  - 显示 toast "请先创建DID身份"
  - 弹窗不显示

### 3.6 UI/UX 测试

#### 测试用例 17: 按钮禁用状态
- **测试步骤**:
  1. DID 输入框为空时点击搜索
  2. 请求发送中时再次点击发送
- **预期结果**:
  - 输入框为空时，搜索按钮禁用（视觉上半透明）
  - 发送中时，发送按钮禁用

#### 测试用例 18: DID 格式化显示
- **测试步骤**:
  1. 搜索一个 DID 长度超过 32 的用户
  2. 观察 DID 显示
- **预期结果**:
  - 长 DID 被截断为 `前24个字符...后8个字符`
  - 短 DID 完整显示

#### 测试用例 19: 响应式布局
- **测试步骤**:
  1. 在不同屏幕尺寸下测试页面
  2. 滚动页面查看布局
- **预期结果**:
  - 所有元素正常显示
  - "我的二维码"按钮固定在底部
  - 模态框居中显示

## 四、依赖服务测试

### 4.1 friendService 依赖
- ✅ `searchUserByDid()` - 搜索用户
- ✅ `sendFriendRequest()` - 发送好友请求
- ✅ `unblockUser()` - 解除拉黑

### 4.2 didService 依赖
- ✅ `getCurrentIdentity()` - 获取当前身份
- ✅ `resolveDID()` - 解析 DID 文档

## 五、已知问题和改进点

### 5.1 待优化项
1. **二维码生成**: 当前使用占位符绘制，需要集成真实的 QR Code 生成库（建议使用 uQRCode）
2. **二维码内容**: 应该生成完整的 DID 信息 JSON，而不仅仅是 DID 字符串
3. **PIN 码处理**: 当前使用硬编码的默认 PIN（123456），应从安全存储获取
4. **网络请求**: DID 解析暂时只从本地数据库查询，需要实现网络查询

### 5.2 性能优化
1. 搜索去抖动（debounce）
2. DID 文档缓存
3. 二维码生成缓存

### 5.3 用户体验改进
1. 添加搜索历史记录
2. 添加好友推荐功能
3. 支持批量导入好友
4. 优化加载动画

## 六、测试环境要求

### 6.1 运行环境
- uni-app 运行时
- 支持的平台：
  - ✅ H5
  - ✅ APP-PLUS (Android/iOS)
  - ✅ 微信小程序

### 6.2 数据库要求
- SQLite 数据库已初始化
- `did_identities` 表已创建
- `contacts` 表已创建
- `friend_requests` 表已创建
- `blocked_users` 表已创建

### 6.3 依赖库
- friendService
- didService
- database
- uni-app API（scanCode, setClipboardData, createCanvasContext）

## 七、测试检查清单

- [ ] 页面加载正常
- [ ] DID 格式验证正常
- [ ] 搜索功能正常
- [ ] 好友请求发送成功
- [ ] 已是好友状态正确显示
- [ ] 已拉黑状态正确显示
- [ ] 解除拉黑功能正常
- [ ] 扫码功能正常（APP-PLUS）
- [ ] 我的二维码显示正常
- [ ] 复制 DID 功能正常
- [ ] 错误提示准确
- [ ] 加载状态显示正确
- [ ] UI 布局无异常
- [ ] 所有按钮响应正常
- [ ] 返回上一页正常

## 八、测试报告模板

```markdown
### 测试执行报告

**测试人员**: [姓名]
**测试日期**: [日期]
**测试环境**: [H5/APP-PLUS/小程序]
**测试版本**: v0.16.0

#### 测试结果汇总
- 总用例数: 19
- 通过数: __
- 失败数: __
- 阻塞数: __

#### 失败用例详情
| 用例ID | 用例名称 | 失败原因 | 严重级别 |
|--------|----------|----------|----------|
|        |          |          |          |

#### 发现的 Bug
1. [Bug 描述]
2. [Bug 描述]

#### 改进建议
1. [建议内容]
2. [建议内容]
```

## 九、下一步计划

1. ✅ 完成 Task 2 代码实现
2. ⏳ 执行完整测试
3. ⏳ 修复发现的 Bug
4. ⏳ 集成真实的二维码生成库
5. ⏳ 优化用户体验
6. ⏳ 进入 Task 3: 好友请求页面

---

**文档创建**: 2025-12-31
**最后更新**: 2025-12-31
**状态**: ✅ 开发完成，待测试
